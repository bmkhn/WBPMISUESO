{% extends "base_internal.html" %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.css"/>
<link href="https://fonts.googleapis.com/css?family=Inter:400,700,800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'templates/dashboard.css' %}" rel="stylesheet">
</head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<body>
    <div class="main-container">
        <div class="container-1">
            <div class="container-1A">
                <div class="container-1A-row">
                    <div class="welcome-text">Welcome</div>
                    <div class="ueso-text">to UESO MIS</div>
                </div>
                {% if user.role == "COORDINATOR" %}
                    <div class="viewing-text">You are currently viewing as a coordinator.</div>
                {% elif user.role == "PROGRAM_HEAD" %}
                    <div class="viewing-text">You are currently viewing as a program head.</div>
                {% elif user.role == "DEAN" %}
                    <div class="viewing-text">You are currently viewing as a dean.</div>
                {% elif user.role == "UESO" %}
                    <div class="viewing-text">You are currently viewing as a UESO member.</div>
                {% elif user.role == "VP" %}
                    <div class="viewing-text">You are currently viewing as a vice president.</div>
                {% elif user.role == "DIRECTOR" %}
                    <div class="viewing-text">You are currently viewing as a director.</div>
                {% endif %}
            </div>
            <div class="container-1B">
                <div class="dropdown" style="margin-left: 1.5rem;">
                    <button id="dateRangeBtn" class="dropdown-btn">
                    </button>
                    <div id="popupOverlay" class="popup-overlay">
                        <div id="datePopup" class="date-popup">
                            <h4>Select Date Range</h4>

                            <label for="startDate">Start Date:</label>
                            <input type="date" id="startDate" class="date-input">

                            <label for="endDate">End Date:</label>
                            <input type="date" id="endDate" class="date-input">

                            <div class="popup-actions">
                                <button id="confirmExport" class="confirm-btn">Confirm</button>
                                <button id="cancelExport" class="cancel-btn">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overview Section -->
        <div class="overview-section">
            <div class="container-2">
                {% if request.user.role == "UESO" or request.user.role == "VP" or request.user.role == "DIRECTOR" %}
                <a class="container-2A" href="{% url 'request_dispatcher' %}?status=PENDING">
                    <div class="card-icon-wrapper">
                        <div class="circle">
                            <i class="fas fa-clipboard-list"></i> 
                        </div>
                    </div>
                    <div class="container-2A-number">{{ pending_requests.count }}</div>
                    <div class="container-2A-name">Request Pending</div>
                </a>
                {% endif %}

                <a class="container-2A" href="{% url 'project_dispatcher' %}?status=IN_PROGRESS">
                    <div class="card-icon-wrapper">
                        <div class="circle">
                            <i class="fas fa-cogs"></i> 
                        </div>
                    </div>
                    <div class="container-2A-number">{{ inprogress_projects.count }}</div>
                    <div class="container-2A-name">Ongoing Projects</div>
                </a>
                <a class="container-2A" href="{% url 'experts' %}">
                    <div class="card-icon-wrapper">
                        <div class="circle">
                            <i class="fas fa-users"></i> 
                        </div>
                    </div>
                    <div class="container-2A-number">{{ expert_users.count }}</div>
                    <div class="container-2A-name">Experts Active</div>
                </a>

                {% if request.user.role == "UESO" or request.user.role == "VP" or request.user.role == "DIRECTOR" %}
                <a class="container-2A" href="{% url 'calendar' %}">
                    <div class="card-icon-wrapper">
                        <div class="circle"><i class="fas fa-calendar-alt"></i></div>
                    </div>
                    <div class="container-2A-number">{{ events_in_calendar }}</div>
                    <div class="container-2A-name">Events in Calendar</div>
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section" style="overflow: visible;">
            <div class="container-3" style="overflow: visible;">
                
                <div class="chart-container" style="max-height: 225px; overflow: visible;">
                    <h3>Project Status Overview</h3>
                    <canvas id="projectStatusChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Submission Status Breakdown</h3>
                    <canvas id="submissionStatusChart" style="max-height: 250px;"></canvas>
                </div>

                <div class="calendar-container">
                    <div class="mini-calendar-widget">
                        <div class="mini-calendar-header">
                            <button class="prev-month" title="Previous Month">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="current-month-year">October 2025</div>
                            <button class="next-month" title="Next Month">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="mini-calendar-body">
                            <div class="weekdays">
                                <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                            </div>
                            <div class="days-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
            <div class="summary-text" style="margin-bottom: -2rem ;">Projects</div>
            <table class="user-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Leader</th>
                    <th>College/Unit</th>
                    <th>Last Updated</th>
                    <th>Start Date</th>
                    <th>Progress</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for project in projects %}
                <tr>
                    <td>
                        <a href="{% url 'project_profile' project.id %}" class="name-link" title="{{ project.title }}">
                            {{ project.title|truncatechars:20 }}
                        </a>
                    </td>
                    <td><a href="{% url 'user_profile' project.project_leader.id %}" class="name-link">{{ project.project_leader.get_full_name }}</a></td>
                    <td>{% if project.project_leader.college %}{{ project.project_leader.college.name }}{% else %}<em>-</em>{% endif %}</td>
                    <td>{{ project.updated_at|date:"Y-m-d" }}</td>
                    <td>{{ project.start_date|date:"Y-m-d" }}</td>
                    <td>{{ project.progress_display }}</td>
                    <td>{{ project.get_status_display }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="7" style="text-align:center;">No projects found.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Goal Section (keep existing goals for VP/Director) -->
        {% if vpde_content %}
        <div class="goal-section">
            <div class="goal-text">Goals <span style="color:gray; font-size:medium;">(Not yet implemented)</span></div>
            <div class="goal-card-container">
            <div class="goal-card">
                <div class="goal-card-kebab"> <svg class="kebab-svg"><use href="#kebab-icon"/></svg> </div>
                <div class="goal-card-percent">75%</div>
                <div class="goal-card-title">100 Extension Projects for 2025</div>
            </div>
            <div class="goal-card">
                <div class="goal-card-kebab"> <svg class="kebab-svg"><use href="#kebab-icon"/></svg> </div>
                <div class="goal-card-percent">30%</div>
                <div class="goal-card-title">10 SDG Extension Projects for 2025</div>
            </div>
            <div class="goal-card">
                <div class="goal-card-kebab"> <svg class="kebab-svg"><use href="#kebab-icon"/></svg> </div>
                <div class="goal-card-percent">90%</div>
                <div class="goal-card-title">5 Student Involved Extension Projects for 2025</div>
            </div>
            <div class="goal-card">
                <div class="goal-card-kebab"> <svg class="kebab-svg"><use href="#kebab-icon"/></svg> </div>
                <div class="goal-card-percent">50%</div>
                <div class="goal-card-title">10 Eco-Tourism Projects for 2025</div>
            </div>
            </div>
        </div>
        {% endif %}
</body>

</div>
<!-- SVG Sprite Section -->
<svg style="display:none;">

    <!-- Expand -->
    <symbol id="icon-expand" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M15.35 5.43923V1M15.35 1H10.8656M15.35 1L9.96875 6.26404M5.48438 15.2055L1 15.226V10.7663M6.38125 9.87846L1 15.2055" stroke="black" stroke-width="0.9" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>

    <!-- Dropdown -->
    <symbol id="icon-dropdown" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <polyline points="4,6 8,10 12,6" fill="none" stroke="#000" stroke-width="2"/>
    </symbol>

    <!-- Kebab -->
    <symbol id="kebab-icon" viewBox="0 0 4 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M2 16C1.45 16 0.979167 15.8042 0.5875 15.4125C0.195833 15.0208 0 14.55 0 14C0 13.45 0.195833 12.9792 0.5875 12.5875C0.979167 12.1958 1.45 12 2 12C2.55 12 3.02083 12.1958 3.4125 12.5875C3.80417 12.9792 4 13.45 4 14C4 14.55 3.80417 15.0208 3.4125 15.4125C3.02083 15.8042 2.55 16 2 16ZM2 10C1.45 10 0.979167 9.80417 0.5875 9.4125C0.195833 9.02083 0 8.55 0 8C0 7.45 0.195833 6.97917 0.5875 6.5875C0.979167 6.19583 1.45 6 2 6C2.55 6 3.02083 6.19583 3.4125 6.5875C3.80417 6.97917 4 7.45 4 8C4 8.55 3.80417 9.02083 3.4125 9.4125C3.02083 9.80417 2.55 10 2 10ZM2 4C1.45 4 0.979167 3.80417 0.5875 3.4125C0.195833 3.02083 0 2.55 0 2C0 1.45 0.195833 0.979167 0.5875 0.5875C0.979167 0.195833 1.45 0 2 0C2.55 0 3.02083 0.195833 3.4125 0.5875C3.80417 0.979167 4 1.45 4 2C4 2.55 3.80417 3.02083 3.4125 3.4125C3.02083 3.80417 2.55 4 2 4Z" fill="#1D1B20"/>
    </symbol>
</svg>

<script>
    // DEFINE GLOBAL EVENT DATA (e.g., from Django context variable events_json)
    const EVENTS_DATA = {{ events_json|safe }}; 
    
    // The rest of the calendar script goes here:
    
    (function() {
        // Use a set for quick date lookup
        const eventDates = new Set();
        if (EVENTS_DATA && typeof EVENTS_DATA === 'object') {
            Object.keys(EVENTS_DATA).forEach(date => eventDates.add(date));
        }

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        let currentDate = new Date();

        const headerEl = document.querySelector('.current-month-year');
        const daysGridEl = document.querySelector('.days-grid');
        const prevButton = document.querySelector('.prev-month');
        const nextButton = document.querySelector('.next-month');
        
        function renderCalendar() {
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth();
            
            headerEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            daysGridEl.innerHTML = ''; 

            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay(); // 0 (Sun) - 6 (Sat)
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            
            // Render empty cells for preceding month days
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('day-cell', 'empty-day');
                daysGridEl.appendChild(emptyCell);
            }

            // Render days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('day-cell');
                dayCell.textContent = day;

                const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Mark today's date
                if (currentYear === today.getFullYear() && currentMonth === today.getMonth() && day === today.getDate()) {
                    dayCell.classList.add('today');
                }
                
                // Mark event dates
                if (eventDates.has(dateString)) {
                    dayCell.classList.add('has-event');
                    // Add an invisible link/data for utility, pointing to the full calendar view
                    dayCell.setAttribute('data-event-date', dateString);
                    dayCell.title = "Events scheduled today. Click for full calendar."
                }
                
                // Navigation to the full calendar view (assuming URL is /calendar/)
                dayCell.addEventListener('click', () => {
                     if (!dayCell.classList.contains('empty-day')) {
                        const targetDate = dayCell.getAttribute('data-event-date') || dateString;
                        window.location.href = `/calendar/?date=${targetDate}`;
                     }
                });


                daysGridEl.appendChild(dayCell);
            }
        }

        prevButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        // Initial render
        renderCalendar();
    })();

</script>

 
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log('=== CHART DEBUGGING START ===');

    // --- 1. Define chart variables ---
    let submissionChart = null;
    let projectChart = null;
    
    // --- 2. Reusable hover function ---
    const customOnHover = (event, chartElement) => {
        const canvas = event.native.target;
        if (chartElement.length > 0) {
            canvas.style.cursor = 'pointer';
        } else {
            canvas.style.cursor = 'default';
        }
    };

    // --- 3. The "Master Function" ---
    function updateDashboard(startStr, endStr) {
        
        console.log(`Updating dashboard for: ${startStr || 'default'} to ${endStr || 'default'}`);

        const subApiUrl = `/dashboard/api/chart/submission-status/?start=${startStr}&end=${endStr}`;
        const projApiUrl = `/dashboard/api/chart/project-status/?start=${startStr}&end=${endStr}`;

        // -----------------------------------------------------------------
        // Chart 1: Submission Status Breakdown
        // -----------------------------------------------------------------
        const subCanvas = document.getElementById('submissionStatusChart');
        if (!subCanvas) return;
        const subCtx = subCanvas.getContext('2d');
        
        fetch(subApiUrl)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (submissionChart) {
                    submissionChart.destroy();
                }
                
                submissionChart = new Chart(subCtx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Number of Submissions',
                            data: data.counts,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 
                                'rgba(255, 206, 86, 0.6)', 'rgba(75, 192, 192, 0.6)', 
                                'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1,
                            hoverBackgroundColor: [
                                'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'
                            ],
                            hoverBorderColor: [
                                'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'
                            ],
                            hoverBorderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',  
                        onHover: customOnHover,
                        scales: { x: { beginAtZero: true }, y: { ticks: { display: false } } },
                        plugins: { legend: { display: false } }
                    }
                });
            })
            .catch(error => console.error('Error fetching submission chart data:', error));

        // -----------------------------------------------------------------
        // Chart 2: Project Status Overview
        // -----------------------------------------------------------------
        const projCanvas = document.getElementById('projectStatusChart');
        if (!projCanvas) return;
        const projCtx = projCanvas.getContext('2d');

        fetch(projApiUrl)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (projectChart) {
                    projectChart.destroy();
                }
                
                const pieColors = [
                    'rgba(255, 99, 132, 0.7)',  'rgba(54, 162, 235, 0.7)',
                    'rgba(75, 192, 192, 0.7)', 'rgba(255, 206, 86, 0.7)',
                    'rgba(153, 102, 255, 0.7)'
                ];
                const pieHoverColors = [
                    'rgba(255, 119, 152, 1)', 'rgba(74, 182, 255, 1)',
                    'rgba(95, 212, 212, 1)', 'rgba(255, 216, 106, 1)',
                    'rgba(173, 122, 255, 1)'
                ];
                
                projectChart = new Chart(projCtx, {
                    type: 'pie',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Project Status',
                            data: data.counts,
                            backgroundColor: pieColors,
                            hoverBackgroundColor: pieHoverColors,
                            hoverOffset: 20,
                            hoverBorderColor: '#fff',
                            hoverBorderWidth: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onHover: customOnHover,
                        plugins: { legend: { display: false } }
                    }
                });
            })
            .catch(error => console.error('Error fetching project chart data:', error));
    }

    // --- 4. NEW: Logic for your Custom Popup (with Button Text) ---
    
    const openBtn = document.getElementById('dateRangeBtn');
    const overlay = document.getElementById('popupOverlay');
    const popup = document.getElementById('datePopup');
    const confirmBtn = document.getElementById('confirmExport');
    const cancelBtn = document.getElementById('cancelExport');
    
    if (openBtn && overlay && popup && confirmBtn && cancelBtn) {
        
        // Helper function to format YYYY-MM-DD to "Mmm D, YYYY"
        const formatDate = (dateStr) => {
            if (!dateStr) return null;
            const [year, month, day] = dateStr.split('-');
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        };

        const showPopup = (show) => {
            if (show) {
                overlay.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            } else {
                popup.classList.remove('show');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 250);
            }
        };

        openBtn.addEventListener('click', () => {
            showPopup(true);
        });
        
        cancelBtn.addEventListener('click', () => {
            showPopup(false);
        });
        
        overlay.addEventListener('click', (event) => {
            if (event.target === overlay) {
                showPopup(false);
            }
        });
        
        // 'Confirm' button logic is updated
        confirmBtn.addEventListener('click', () => {
            const startStr = document.getElementById('startDate').value;
            const endStr = document.getElementById('endDate').value;
            
            // --- NEW: Update Button Text ---
            const formattedStart = formatDate(startStr);
            const formattedEnd = formatDate(endStr);
            
            if (formattedStart && formattedEnd) {
                openBtn.textContent = `${formattedStart} - ${formattedEnd} ▾`;
            } else if (formattedStart) {
                openBtn.textContent = `From ${formattedStart} ▾`;
            } else if (formattedEnd) {
                openBtn.textContent = `Until ${formattedEnd} ▾`;
            } else {
                openBtn.textContent = 'All Time (Default) ▾';
            }
            
            updateDashboard(startStr, endStr);
            showPopup(false);
        });
    }

    updateDashboard('', ''); 
    openBtn.textContent = 'Last 300 Days ▾';
    
    console.log('=== CHART DEBUGGING END ===');
});
</script>
 
<script> 
    const openBtn = document.getElementById('dateRangeBtn');
    const overlay = document.getElementById('popupOverlay');
    const popup = document.getElementById('datePopup');
    const confirmBtn = document.getElementById('confirmExport');
    const cancelBtn = document.getElementById('cancelExport');
    
    // Get the date input elements
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    
    if (openBtn && overlay && popup && confirmBtn && cancelBtn && startDateInput && endDateInput) {
        
        // --- NEW: Date Validation Logic ---
        startDateInput.addEventListener('change', () => {
            // When start date changes, end date cannot be before it
            if (startDateInput.value) {
                endDateInput.min = startDateInput.value;
            }
        });
        
        endDateInput.addEventListener('change', () => {
            // When end date changes, start date cannot be after it
            if (endDateInput.value) {
                startDateInput.max = endDateInput.value;
            }
        });
        // --- End of New Logic ---

        const showPopup = (show) => {
            if (show) {
                overlay.style.display = 'flex';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            } else {
                popup.classList.remove('show');
                setTimeout(() => {
                    overlay.style.display = 'none';
                    // Clear min/max on close so it resets for next time
                    startDateInput.max = '';
                    endDateInput.min = '';
                }, 250); // Matches your CSS transition time
            }
        };

        openBtn.addEventListener('click', () => {
            showPopup(true);
        });
        
        cancelBtn.addEventListener('click', () => {
            showPopup(false);
        });
        
        overlay.addEventListener('click', (event) => {
            if (event.target === overlay) {
                showPopup(false);
            }
        });
        
        confirmBtn.addEventListener('click', () => {
            const startStr = startDateInput.value;
            const endStr = endDateInput.value;
            
            // Helper function to format YYYY-MM-DD to "Mmm D, YYYY"
            const formatDate = (dateStr) => {
                if (!dateStr) return null;
                // Add a check for invalid date string
                const date = new Date(dateStr + 'T00:00:00'); // Use T00:00:00 to avoid timezone issues
                if (isNaN(date)) return null;
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    timeZone: 'UTC' // Ensure consistent formatting
                });
            };
            
            const formattedStart = formatDate(startStr);
            const formattedEnd = formatDate(endStr);
            
            if (formattedStart && formattedEnd) {
                openBtn.textContent = `${formattedStart} - ${formattedEnd} ▾`;
            } else if (formattedStart) {
                openBtn.textContent = `From ${formattedStart} ▾`;
            } else if (formattedEnd) {
                openBtn.textContent = `Until ${formattedEnd} ▾`;
            } else {
                // Keep the default text if no dates are set
                openBtn.textContent = 'Last 300 Days ▾';
            }
            
            updateDashboard(startStr, endStr);
            showPopup(false);
        });
    }

    // --- 5. Initial Load ---
    // Load with defaults and set button text
    updateDashboard('', ''); 
    if (openBtn) {
        openBtn.textContent = 'Last 300 Days ▾';
    }
    
    console.log('=== CHART DEBUGGING END ===');
</script> 

</body>
</html>

{% endblock %}