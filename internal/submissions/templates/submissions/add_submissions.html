{% extends "base_internal.html" %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Add Submission</title>

<link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/styles.css' %}" rel="stylesheet">
</head>
<body>
    <div class="main-container">
        <div class="user-details-title">
            <h2>Add Submission</h2> 
            <p>Input all fields correctly and assign new submission.</p>
        </div>
        <form class="submission-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="user-details-section"> 
                <div class="user-details-category">  
                    <i class="fa-regular fa-address-card subtitle-icon"></i>
                    Details
                </div>
                <div class="form-group">
                    <label class="user-details-label" for="id_project">Project: <span class="required">*</span></label>
                    <select class="user-details-value" name="project" id="id_project" required {% if preselected_project %}data-preselected="true"{% endif %}>
                        <option value="">Select Project</option>
                        {% for project in projects %}
                            <option value="{{ project.id }}" {% if preselected_project and preselected_project.id == project.id %}selected{% endif %}>{{ project.title }}</option>
                        {% endfor %}
                    </select>
                </div>

            <div class="form-group">
                <label class="user-details-label">Choose Form/s: <span class="required">*</span></label>
                <div class="downloadable-checkboxes">
                    {% for downloadable in downloadables %}
                        <div class="checkbox-item" 
                             data-project-dependent="{% if downloadable.submission_type == 'event' %}true{% else %}false{% endif %}"
                             data-submission-type="{{ downloadable.submission_type }}"
                             data-downloadable-id="{{ downloadable.id }}">
                            <input type="checkbox" name="downloadables" id="downloadable_{{ downloadable.id }}" value="{{ downloadable.id }}">
                            <label for="downloadable_{{ downloadable.id }}">{{ downloadable.name }}</label>
                            {% if downloadable.submission_type == 'event' %}
                                <span class="event-status" id="event_status_{{ downloadable.id }}">Select a project first</span>
                            {% elif downloadable.submission_type == 'final' %}
                                <span class="final-status" id="final_status_{{ downloadable.id }}" style="color:#888;font-size:0.875rem;display:none;" title="Final submissions are only available when all activities are completed">
                                    <i class="fa-solid fa-info-circle"></i> Requires all activities completed
                                </span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Event Selection (shown only when event-type downloadable is selected) -->
            <div class="form-group" id="event-selection-group" style="display:none;">
                <label class="user-details-label">Select Event: <span class="required">*</span></label>
                <select class="form-input user-details-value" name="selected_event" id="id_selected_event">
                    <option value="">Choose an event</option>
                </select>
            </div>

            <div class="form-group">
                <label class="user-details-label" for="id_deadline">Deadline: <span class="required">*</span></label>
                <input class="form-input user-details-value" type="datetime-local" name="deadline" id="id_deadline">
                <small style="color:#666;font-size:0.875rem;margin-top:0.25rem;display:block;" id="deadline-hint">Must be after project start date</small>
            </div>

            <div class="form-group">
                <label class="user-details-label" for="id_notes">Notes:</label>
                <textarea class="form-input user-details-value" name="notes" id="id_notes"></textarea>
            </div> 


            <div class="form-actions">
                <a href="{% url 'submissions_admin' %}" class="back btn">Cancel</a>
                <button type="submit" class="save btn">Add Requirement</button>
            </div>
        </form>
    </div>

<!-- SVG Sprite Section -->
<svg style="display:none;" xmlns="http://www.w3.org/2000/svg">
    <symbol id="icon-add" viewBox="0 0 16 16">
        <path d="M6.80039 14.4004C6.80039 14.7187 6.92682 15.0239 7.15186 15.2489C7.37691 15.474 7.68213 15.6004 8.00039 15.6004C8.31865 15.6004 8.62388 15.474 8.84892 15.2489C9.07396 15.0239 9.20039 14.7187 9.20039 14.4004V9.20039H14.4004C14.7187 9.20039 15.0239 9.07396 15.2489 8.84892C15.474 8.62388 15.6004 8.31865 15.6004 8.00039C15.6004 7.68213 15.474 7.37691 15.2489 7.15186C15.0239 6.92682 14.7187 6.80039 14.4004 6.80039H9.20039V1.60039C9.20039 1.28213 9.07396 0.976906 8.84892 0.751863C8.62388 0.526819 8.31865 0.400391 8.00039 0.400391C7.68213 0.400391 7.37691 0.526819 7.15186 0.751863C6.92682 0.976906 6.80039 1.28213 6.80039 1.60039V6.80039H1.60039C1.28213 6.80039 0.976906 6.92682 0.751863 7.15186C0.526819 7.37691 0.400391 7.68213 0.400391 8.00039C0.400391 8.31865 0.526819 8.62388 0.751863 8.84892C0.976906 9.07396 1.28213 9.20039 1.60039 9.20039H6.80039V14.4004Z" fill="black"/>
    </symbol>
</svg>

<script>
    // Form Validation for Required Fields (Submission Requirement)
    document.querySelector('.submission-form').addEventListener('submit', function(e) {
        let valid = true;
        // Remove Previous Error States
        let downloadableError = document.getElementById('downloadable-error');
        let deadlineError = document.getElementById('deadline-error');
        let eventError = document.getElementById('event-error');
        if (downloadableError) downloadableError.remove();
        if (deadlineError) deadlineError.remove();
        if (eventError) eventError.remove();

        // Validate Downloadables (checkboxes)
        const selectedDownloadables = Array.from(document.querySelectorAll('input[name="downloadables"]:checked')).map(i => i.value);
        if (selectedDownloadables.length === 0) {
            valid = false;
            const checkboxContainer = document.querySelector('.downloadable-checkboxes');
            const err = document.createElement('div');
            err.id = 'downloadable-error';
            err.textContent = 'At least one form must be selected.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            err.style.marginTop = '0.5rem';
            checkboxContainer.appendChild(err);
        }
        
        // Validate Event Selection (if event downloadable is selected)
        const eventCheckboxes = document.querySelectorAll('.checkbox-item[data-project-dependent="true"] input[type="checkbox"]:checked');
        if (eventCheckboxes.length > 0) {
            const selectedEvent = document.getElementById('id_selected_event').value;
            if (!selectedEvent) {
                valid = false;
                const eventGroup = document.getElementById('event-selection-group');
                const err = document.createElement('div');
                err.id = 'event-error';
                err.textContent = 'Please select an event for the event submission.';
                err.style.color = '#E53E3E';
                err.style.fontSize = '0.95rem';
                err.style.marginTop = '0.5rem';
                eventGroup.appendChild(err);
            }
        }
        // Validate Deadline
        const deadlineInput = document.getElementById('id_deadline');
        deadlineInput.classList.remove('error-input');
        if (!deadlineInput.value) {
            valid = false;
            deadlineInput.classList.add('error-input');
            const err = document.createElement('div');
            err.id = 'deadline-error';
            err.textContent = 'Deadline is required.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            err.style.marginTop = '0.85rem';
            deadlineInput.parentNode.appendChild(err);
        }
        if (!valid) {
            e.preventDefault();
        }
    });

    // Project Event Availability Data
    const projectEventAvailability = {{ project_event_availability_json|safe }};

    // Handle project selection change to update event availability and final submission eligibility
    document.getElementById('id_project').addEventListener('change', function() {
        const selectedProjectId = this.value;
        const eventSelectionGroup = document.getElementById('event-selection-group');
        const eventSelect = document.getElementById('id_selected_event');
        const deadlineInput = document.getElementById('id_deadline');
        const deadlineHint = document.getElementById('deadline-hint');
        
        // Update deadline minimum based on project
        if (!selectedProjectId) {
            deadlineInput.removeAttribute('min');
            deadlineHint.textContent = 'Must be after project start date';
        } else {
            const availability = projectEventAvailability[selectedProjectId];
            if (availability && availability.start_date) {
                const projectStartDate = new Date(availability.start_date);
                const minDeadline = projectStartDate.toISOString().slice(0, 16);
                deadlineInput.setAttribute('min', minDeadline);
                const formattedDate = new Date(availability.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                deadlineHint.textContent = `Must be after project start date (${formattedDate})`;
            }
        }
        
        // Update event-dependent downloadables
        document.querySelectorAll('.checkbox-item[data-project-dependent="true"]').forEach(function(checkboxItem) {
            const checkbox = checkboxItem.querySelector('input[type="checkbox"]');
            const eventStatus = checkboxItem.querySelector('.event-status');
            
            if (!selectedProjectId) {
                // No project selected
                checkboxItem.classList.add('disabled');
                checkbox.disabled = true;
                checkbox.checked = false;
                eventStatus.textContent = 'Select a project first';
                eventStatus.className = 'event-status pending';
                eventSelectionGroup.style.display = 'none';
            } else {
                const availability = projectEventAvailability[selectedProjectId];
                
                if (availability && availability.has_available_events) {
                    // Has available events
                    checkboxItem.classList.remove('disabled');
                    checkbox.disabled = false;
                    eventStatus.textContent = `${availability.available_events.length} event(s) available`;
                    eventStatus.className = 'event-status has-events';
                    
                    // Populate event selection dropdown
                    eventSelect.innerHTML = '<option value="">Choose an event</option>';
                    availability.available_events.forEach(function(event) {
                        const option = document.createElement('option');
                        option.value = event.id;
                        option.textContent = `${event.title} - ${event.datetime}`;
                        eventSelect.appendChild(option);
                    });
                } else {
                    // No available events
                    checkboxItem.classList.add('disabled');
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    eventStatus.textContent = 'No Available Events';
                    eventStatus.className = 'event-status no-events';
                    eventSelectionGroup.style.display = 'none';
                }
            }
        });
        
        // Update final submission type downloadables // FIXED?
        document.querySelectorAll('.checkbox-item[data-submission-type="final"]').forEach(function(checkboxItem) {
            const checkbox = checkboxItem.querySelector('input[type="checkbox"]');
            const finalStatus = checkboxItem.querySelector('.final-status');
            
            if (!selectedProjectId) {
                checkboxItem.classList.add('disabled');
                checkbox.disabled = true;
                checkbox.checked = false;
                if (finalStatus) finalStatus.style.display = 'none';
            } else {
                const availability = projectEventAvailability[selectedProjectId];
                
                if (availability && availability.all_events_completed) {
                    // All events completed - enable final submission
                    checkboxItem.classList.remove('disabled');
                    checkbox.disabled = false;
                    if (finalStatus) finalStatus.style.display = 'none';
                } else {
                    // Not all events completed - disable final submission
                    checkboxItem.classList.add('disabled');
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    if (finalStatus) {
                        finalStatus.style.display = 'inline';
                        const progress = availability ? `${availability.event_progress}/${availability.estimated_events}` : '0/0';
                        finalStatus.innerHTML = `<i class="fa-solid fa-info-circle"></i> Requires all events completed (${progress})`;
                    }
                }
            }
        });
        
        // Check if event selection should be shown
        updateEventSelectionVisibility();
    });

    // Handle downloadable checkbox changes to show/hide event selection
    function updateEventSelectionVisibility() {
        const eventCheckboxes = document.querySelectorAll('.checkbox-item[data-project-dependent="true"] input[type="checkbox"]:checked');
        const eventSelectionGroup = document.getElementById('event-selection-group');
        
        if (eventCheckboxes.length > 0) {
            eventSelectionGroup.style.display = 'flex';
        } else {
            eventSelectionGroup.style.display = 'none';
        }
    }

    // Update deadline minimum when event is selected
    document.getElementById('id_selected_event').addEventListener('change', function() {
        const eventId = this.value;
        const deadlineInput = document.getElementById('id_deadline');
        const deadlineHint = document.getElementById('deadline-hint');
        const selectedProjectId = document.getElementById('id_project').value;
        
        if (eventId && selectedProjectId) {
            const availability = projectEventAvailability[selectedProjectId];
            const selectedEvent = availability.available_events.find(e => e.id == eventId);
            
            if (selectedEvent && selectedEvent.datetime) {
                const eventDateTime = new Date(selectedEvent.datetime);
                const minDeadline = eventDateTime.toISOString().slice(0, 16);
                deadlineInput.setAttribute('min', minDeadline);
                const formattedDate = eventDateTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
                deadlineHint.textContent = `Must be after event date (${formattedDate})`;
            }
        } else if (selectedProjectId) {
            // Reset to project start date if no event selected
            const availability = projectEventAvailability[selectedProjectId];
            if (availability && availability.start_date) {
                const projectStartDate = new Date(availability.start_date);
                const minDeadline = projectStartDate.toISOString().slice(0, 16);
                deadlineInput.setAttribute('min', minDeadline);
                const formattedDate = new Date(availability.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                deadlineHint.textContent = `Must be after project start date (${formattedDate})`;
            }
        }
    });

    // Add event listeners to downloadable checkboxes
    document.addEventListener('DOMContentLoaded', function() {
        // Add change listeners to all downloadable checkboxes
        document.querySelectorAll('input[name="downloadables"]').forEach(function(checkbox) {
            checkbox.addEventListener('change', updateEventSelectionVisibility);
        });
        
        // Initialize event status display (especially important when project is preselected)
        // Use setTimeout to ensure DOM is fully ready
        const projectSelect = document.getElementById('id_project');
        setTimeout(function() {
            if (projectSelect.value) {
                projectSelect.dispatchEvent(new Event('change'));
            }
        }, 100);
    });
</script>

</body>
</html>

{% endblock %}