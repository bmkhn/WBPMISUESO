{% extends "base_internal.html" %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Add Submission</title>

<link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/styles.css' %}" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
        transition: opacity 0.2s;
    }
    
    .checkbox-item.disabled {
        opacity: 0.5;
        pointer-events: none;
        cursor: not-allowed !important;
    }
    
    .checkbox-item.disabled input[type="checkbox"] {
        cursor: not-allowed !important;
    }
    
    .checkbox-item.disabled label {
        cursor: not-allowed !important;
        color: #999 !important;
    }
    
    .event-status, .final-status {
        font-size: 0.875rem;
        margin-left: 8px;
        font-weight: 500;
    }
    
    .event-status.pending {
        color: #888;
    }
    
    .event-status.has-events {
        color: #16a34a;
    }
    
    .event-status.no-events {
        color: #dc2626;
    }
    
    .final-status {
        color: #ea580c;
    }

    /* Style adjustment for Select2 to match other form elements */
    .select2-container .select2-selection--single {
        height: 40px !important;
        display: flex;
        align-items: center;
        border: 1px solid #ccc !important;
        border-radius: 4px !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 40px;
        padding-left: 12px;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 38px;
    }

    /* Ensure the search box appears even with few results */
    .select2-dropdown .select2-search--dropdown {
        display: block !important;
    }
</style>
</head>
<body>
    <div class="main-container">
        <div class="user-details-title">
            <h2>Add Submission</h2> 
            <p>Input all fields correctly and assign new submission.</p>
        </div>

        <form class="submission-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="user-details-section"> 
                <div class="user-details-category">  
                    <i class="fa-regular fa-address-card subtitle-icon"></i>
                    Details
                </div>
                <div class="form-group">
                    <label class="user-details-label" for="id_project">Project: <span class="required">*</span></label>
                    <select class="user-details-value" name="project" id="id_project" required {% if preselected_project %}data-preselected="true"{% endif %}>
                        <option value="">Select Project</option>
                        {% for project in projects %}
                            <option value="{{ project.id }}" {% if preselected_project and preselected_project.id == project.id %}selected{% endif %}>{{ project.title }}</option>
                        {% endfor %}
                    </select>
                </div>

            <div class="form-group">
                <label class="user-details-label">Choose Form/s: <span class="required">*</span></label>
                <div class="downloadable-checkboxes">
                    {% for downloadable in downloadables %}
                        <div class="checkbox-item disabled" 
                             data-submission-type="{{ downloadable.submission_type }}"
                             data-downloadable-id="{{ downloadable.id }}">
                            <input type="checkbox" name="downloadables" id="downloadable_{{ downloadable.id }}" value="{{ downloadable.id }}">
                            <label for="downloadable_{{ downloadable.id }}">{{ downloadable.name }}</label>
                            {% if downloadable.submission_type == 'event' %}
                                <span class="event-status pending" id="event_status_{{ downloadable.id }}">Select a project first</span>
                            {% elif downloadable.submission_type == 'final' %}
                                <span class="final-status" id="final_status_{{ downloadable.id }}" style="display:none;" title="Final submissions are only available when all activities are completed">
                                    <i class="fa-solid fa-info-circle"></i> Requires all activities completed
                                </span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group" id="event-selection-group" style="display:none;">
                <label class="user-details-label" for="id_selected_event">Select Event: <span class="required">*</span></label>
                <select class="form-input user-details-value" name="selected_event" id="id_selected_event">
                    <option value="">Choose an event</option>
                </select>
            </div>

            <div class="form-group">
                <label class="user-details-label" for="id_deadline">Deadline: <span class="required">*</span></label>
                <input class="form-input user-details-value" type="datetime-local" name="deadline" id="id_deadline">
                <small style="color:#666;font-size:0.875rem;margin-top:0.25rem;display:block;" id="deadline-hint">Must be after project start date</small>
            </div>

            <div class="form-group">
                <label class="user-details-label" for="id_notes">Notes:</label>
                <textarea class="form-input user-details-value" name="notes" id="id_notes"></textarea>
            </div> 


            <div class="form-actions">
                <a href="{% url 'submissions_admin' %}" class="back btn">Cancel</a>
                <button type="submit" class="save btn">Add Requirement</button>
            </div>
        </form>
    </div>

<svg style="display:none;" xmlns="http://www.w3.org/2000/svg">
    <symbol id="icon-add" viewBox="0 0 16 16">
        <path d="M6.80039 14.4004C6.80039 14.7187 6.92682 15.0239 7.15186 15.2489C7.37691 15.474 7.68213 15.6004 8.00039 15.6004C8.31865 15.6004 8.62388 15.474 8.84892 15.2489C9.07396 15.0239 9.20039 14.7187 9.20039 14.4004V9.20039H14.4004C14.7187 9.20039 15.0239 9.07396 15.2489 8.84892C15.474 8.62388 15.6004 8.31865 15.6004 8.00039C15.6004 7.68213 15.474 7.37691 15.2489 7.15186C15.0239 6.92682 14.7187 6.80039 14.4004 6.80039H9.20039V1.60039C9.20039 1.28213 9.07396 0.976906 8.84892 0.751863C8.62388 0.526819 8.31865 0.400391 8.00039 0.400391C7.68213 0.400391 7.37691 0.526819 7.15186 0.751863C6.92682 0.976906 6.80039 1.28213 6.80039 1.60039V6.80039H1.60039C1.28213 6.80039 0.976906 6.92682 0.751863 7.15186C0.526819 7.37691 0.400391 7.68213 0.400391 8.00039C0.400391 8.31865 0.526819 8.62388 0.751863 8.84892C0.976906 9.07396 1.28213 9.20039 1.60039 9.20039H6.80039V14.4004Z" fill="black"/>
    </symbol>
</svg>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<script>
    // Form Validation for Required Fields (Submission Requirement)
    document.querySelector('.submission-form').addEventListener('submit', function(e) {
        let valid = true;
        // Remove Previous Error States
        let downloadableError = document.getElementById('downloadable-error');
        let deadlineError = document.getElementById('deadline-error');
        let eventError = document.getElementById('event-error');
        if (downloadableError) downloadableError.remove();
        if (deadlineError) deadlineError.remove();
        if (eventError) eventError.remove();

        // Validate Downloadables (checkboxes)
        const selectedDownloadables = Array.from(document.querySelectorAll('input[name="downloadables"]:checked')).map(i => i.value);
        if (selectedDownloadables.length === 0) {
            valid = false;
            const checkboxContainer = document.querySelector('.downloadable-checkboxes');
            const err = document.createElement('div');
            err.id = 'downloadable-error';
            err.textContent = 'At least one form must be selected.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            err.style.marginTop = '0.5rem';
            checkboxContainer.appendChild(err);
        }
        
        // Validate Event Selection (if event downloadable is selected)
        const eventCheckboxes = document.querySelectorAll('.checkbox-item[data-project-dependent="true"] input[type="checkbox"]:checked');
        if (eventCheckboxes.length > 0) {
            const selectedEvent = document.getElementById('id_selected_event').value;
            if (!selectedEvent) {
                valid = false;
                const eventGroup = document.getElementById('event-selection-group');
                const err = document.createElement('div');
                err.id = 'event-error';
                err.textContent = 'Please select an activity for the activity submission.';
                err.style.color = '#E53E3E';
                err.style.fontSize = '0.95rem';
                err.style.marginTop = '0.5rem';
                eventGroup.appendChild(err);
            }
        }
        // Validate Deadline
        const deadlineInput = document.getElementById('id_deadline');
        deadlineInput.classList.remove('error-input');
        if (!deadlineInput.value) {
            valid = false;
            deadlineInput.classList.add('error-input');
            const err = document.createElement('div');
            err.id = 'deadline-error';
            err.textContent = 'Deadline is required.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            err.style.marginTop = '0.85rem';
            deadlineInput.parentNode.appendChild(err);
        }
        if (!valid) {
            e.preventDefault();
        }
    });

    // Project Event Availability Data
    const projectEventAvailability = {{ project_event_availability_json|safe }};

    // Fix Select2: Use jQuery event for project select
    $('#id_project').on('change', function() {
        const selectedProjectId = $(this).val();
        const eventSelectionGroup = document.getElementById('event-selection-group');
        const eventSelect = document.getElementById('id_selected_event');
        const deadlineInput = document.getElementById('id_deadline');
        const deadlineHint = document.getElementById('deadline-hint');

        // Clear event selection when project changes
        eventSelect.innerHTML = '<option value="">Choose an event</option>';
        eventSelectionGroup.style.display = 'none';

        // Update deadline minimum based on project
        if (!selectedProjectId) {
            deadlineInput.removeAttribute('min');
            deadlineInput.value = '';
            deadlineHint.textContent = 'Must be after project start date';
        } else {
            const availability = projectEventAvailability[selectedProjectId];
            if (availability && availability.start_date) {
                const projectStartDate = new Date(availability.start_date);
                const minDeadline = projectStartDate.toISOString().slice(0, 16);
                deadlineInput.setAttribute('min', minDeadline);
                const formattedDate = new Date(availability.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                deadlineHint.textContent = `Must be after project start date (${formattedDate})`;
            }
        }

        // Update event-dependent downloadables (submission_type = 'event')
        document.querySelectorAll('.checkbox-item[data-submission-type="event"]').forEach(function(checkboxItem) {
            const checkbox = checkboxItem.querySelector('input[type="checkbox"]');
            const eventStatus = checkboxItem.querySelector('.event-status');

            if (!selectedProjectId) {
                // No project selected - disable event downloadables
                checkboxItem.classList.add('disabled');
                checkbox.disabled = true;
                checkbox.checked = false;
                if (eventStatus) {
                    eventStatus.textContent = 'Select a project first';
                    eventStatus.className = 'event-status pending';
                }
            } else {
                const availability = projectEventAvailability[selectedProjectId];

                if (availability && availability.has_available_events) {
                    // Has available events - enable checkbox
                    checkboxItem.classList.remove('disabled');
                    checkbox.disabled = false;
                    if (eventStatus) {
                        eventStatus.textContent = `${availability.available_events.length} event(s) available`;
                        eventStatus.className = 'event-status has-events';
                    }

                    // Populate event selection dropdown
                    availability.available_events.forEach(function(event) {
                        const option = document.createElement('option');
                        option.value = event.id;
                        option.textContent = `${event.title} - ${event.datetime}`;
                        eventSelect.appendChild(option);
                    });
                } else {
                    // No available events - disable checkbox
                    checkboxItem.classList.add('disabled');
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    if (eventStatus) {
                        eventStatus.textContent = 'No available activities';
                        eventStatus.className = 'event-status no-events';
                    }
                }
            }
        });

        // Update final submission type downloadables (submission_type = 'final')
        document.querySelectorAll('.checkbox-item[data-submission-type="final"]').forEach(function(checkboxItem) {
            const checkbox = checkboxItem.querySelector('input[type="checkbox"]');
            const finalStatus = checkboxItem.querySelector('.final-status');

            if (!selectedProjectId) {
                // No project selected - disable final submissions
                checkboxItem.classList.add('disabled');
                checkbox.disabled = true;
                checkbox.checked = false;
                if (finalStatus) {
                    finalStatus.style.display = 'none';
                }
            } else {
                const availability = projectEventAvailability[selectedProjectId];

                if (availability && availability.all_events_completed) {
                    // All events completed - enable final submission
                    checkboxItem.classList.remove('disabled');
                    checkbox.disabled = false;
                    if (finalStatus) {
                        finalStatus.style.display = 'none';
                    }
                } else {
                    // Not all events completed - disable final submission
                    const progress = availability ? `${availability.event_progress}/${availability.estimated_events}` : '0/0';
                    checkboxItem.classList.add('disabled');
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    if (finalStatus) {
                        finalStatus.style.display = 'inline';
                        finalStatus.innerHTML = `<i class="fa-solid fa-info-circle"></i> Requires all activities completed (${progress})`;
                    }
                }
            }
        });

        // Update file-type downloadables (submission_type = 'file') - always enabled when project is selected
        document.querySelectorAll('.checkbox-item[data-submission-type="file"]').forEach(function(checkboxItem) {
            const checkbox = checkboxItem.querySelector('input[type="checkbox"]');

            if (!selectedProjectId) {
                checkboxItem.classList.add('disabled');
                checkbox.disabled = true;
                checkbox.checked = false;
            } else {
                checkboxItem.classList.remove('disabled');
                checkbox.disabled = false;
            }
        });

        // Check if event selection should be shown
        updateEventSelectionVisibility();
    });

    // Handle downloadable checkbox changes to show/hide event selection
    function updateEventSelectionVisibility() {
        const eventCheckboxes = document.querySelectorAll('.checkbox-item[data-submission-type="event"] input[type="checkbox"]:checked:not(:disabled)');
        const eventSelectionGroup = document.getElementById('event-selection-group');
        
        if (eventCheckboxes.length > 0) {
            eventSelectionGroup.style.display = 'block';
        } else {
            eventSelectionGroup.style.display = 'none';
            document.getElementById('id_selected_event').value = '';
        }
    }

    // Update deadline minimum when event is selected
    document.getElementById('id_selected_event').addEventListener('change', function() {
        const eventId = this.value;
        const deadlineInput = document.getElementById('id_deadline');
        const deadlineHint = document.getElementById('deadline-hint');
        const selectedProjectId = document.getElementById('id_project').value;
        
        if (eventId && selectedProjectId) {
            const availability = projectEventAvailability[selectedProjectId];
            const selectedEvent = availability.available_events.find(e => e.id == eventId);
            
            if (selectedEvent && selectedEvent.datetime) {
                const eventDateTime = new Date(selectedEvent.datetime);
                const minDeadline = eventDateTime.toISOString().slice(0, 16);
                deadlineInput.setAttribute('min', minDeadline);
                const formattedDate = eventDateTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
                deadlineHint.textContent = `Must be after event date (${formattedDate})`;
            }
        } else if (selectedProjectId) {
            // Reset to project start date if no event selected
            const availability = projectEventAvailability[selectedProjectId];
            if (availability && availability.start_date) {
                const projectStartDate = new Date(availability.start_date);
                const minDeadline = projectStartDate.toISOString().slice(0, 16);
                deadlineInput.setAttribute('min', minDeadline);
                const formattedDate = new Date(availability.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                deadlineHint.textContent = `Must be after project start date (${formattedDate})`;
            }
        }
    });

    // Initialize Select2 and other DOM content
    $(document).ready(function() {
        // 1. Initialize Select2 on the Project dropdown for search functionality
        $('#id_project').select2({
            placeholder: "Search or select an Extension Project",
            allowClear: false,
            minimumResultsForSearch: 0 
        });

        // 2. Add change listeners to all downloadable checkboxes
        document.querySelectorAll('input[name="downloadables"]').forEach(function(checkbox) {
            checkbox.addEventListener('change', updateEventSelectionVisibility);
        });
        
        // 3. Trigger the change event if a project is preselected
        const projectSelect = document.getElementById('id_project');
        if (projectSelect.value && projectSelect.getAttribute('data-preselected') === 'true') {
            // Trigger change to update downloadables and event availability
            $('#id_project').trigger('change');
        }
        
        // 4. Initialize all downloadables as disabled until project is selected
        if (!projectSelect.value) {
            document.querySelectorAll('.checkbox-item').forEach(function(item) {
                item.classList.add('disabled');
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.disabled = true;
            });
        }
    });
</script>

</body>
</html>

{% endblock %}