{% extends "base_internal.html" %}
{% block content %}

<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="">
    <title>Goals</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.css' rel='stylesheet'/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.js'></script>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0rem;
        padding: 0rem;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        font-family: Helvetica, Arial, sans-serif;
        background-color: #f9f9f9;
    }
    /* Use base sidebar; avoid overriding its styles here */

    .content {
        margin-left: 0;
        padding: 0 20px 20px 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 1.25rem; 
        margin: 0;
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid #e0e0e0;
        background-color: #f5f5f5;
        position: sticky;
        top: 0;
        z-index: 100;
        width: 100%;
    } 

    header a {
        color: #111;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
    }

    header i {
        font-size: 1.75rem;
        line-height: 1;
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    header i:hover {
        transform: scale(1.1);
    }
    
    header img {
        border-radius: 50%; 
        border: 4px solid #e4c600;
        margin-right: 0.75rem;
        width: 3.25rem;
        height: 3.25rem;
        object-fit: cover;
        cursor: pointer;
        transition: transform 0.2s ease;
    }  

    header img:hover {
        transform: scale(1.05);
    }

    .ellipsis-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.3rem; 
        color: #090909;
        transition: color 0.2s;
        z-index: 1; /* keep below global menus like profile dropdown */
    }

    .goals-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .goals-header h1 {
        font-size: 1.75rem;
        font-weight: 500;
        margin: 10 0 1.25rem 0;
    }

    .ListView-header h1 {
        font-size: 1.75rem;
        font-weight: 500;
        margin: 10 0 1.25rem 0;
    }

    .add-goal {
      background: #004225;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
    }

    .add-goal:hover {
        background: #006633;
    }

    /* Mirror Agenda add button */
    .add-user-btn {
        font-family: 'Inter', sans-serif;
        background-color: #00681a;
        color: #F5F5F5;
        font-size: 0.85rem;
        font-weight: 500;
        padding: 0.6rem 1.6rem;
        border-radius: 2rem;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease;
        text-decoration: none;
    }
    .add-user-btn:hover { background-color: #444; color: #fff; transform: translateY(-1px); }
    .add-user-btn i { cursor: pointer; margin-right: 0.3rem; }

    /* ===== Goals Carousel (mirrors Agenda) ===== */
    .goals-carousel-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        position: relative;
        margin: 0.7rem;   
        height: 30rem;
    }

    .goals-carousel {
        overflow: hidden;
        width: 960px;
        position: relative;
        margin: -0.5rem auto 0 auto;
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        padding: 15px 0; 
    }

    .goals-carousel-track {
        display: flex;
        transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        gap: 24px;
        will-change: transform;
    }

    .goal-card {
        position: relative;
        width: 100%; 
        height: 25rem;
        padding: 24px 24px 48px 24px; 
        border-radius: 12px;
        border-top: 1px solid rgba(0, 0, 0, 0.1); 
        border-left: 1px solid rgba(0, 0, 0, 0.1);
        background-color: #ffffff;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08), 
                    0 2px 4px rgba(0, 0, 0, 0.04);
        transform: rotate(-0.5deg); 
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
        box-sizing: border-box;
        vertical-align: top; 
        flex: 0 0 calc(((960px - 2 * 24px) / 3) - 7px);
        width: calc(((960px - 2 * 24px) / 3) - 7px);
    }

    .goal-card:hover {
        transform: translateY(-16px) rotate(0deg); 
        flex: 0 0 calc((((960px - 2 * 24px) / 3) - 7px) * 2 + 24px);
        width: calc((((960px - 2 * 24px) / 3) - 7px) * 2 + 24px);
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.25),
                    0 4px 8px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(187, 187, 187, 0.8);
    }

    .goal-card.expand-left:hover {
        transform: translateY(-16px) translateX(calc((((960px - 2 * 24px) / 3) - 7px) * -1 - 24px)) rotate(0deg); 
    }

    .goal-card.shift-previous {
        transform: translateX(calc((((960px - 2 * 24px) / 3) - 7px) * -1 - 24px)); 
    }

    .carousel-arrow {
        background: #ffffff;
        border: none;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
        z-index: 10;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        border-radius: 999px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    .carousel-arrow:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.18); }
    .left-arrow { left: 0; }
    .right-arrow { right: 0; }
    .carousel-arrow:active { background: #f3f4f6; transform: translateY(-50%) scale(0.95); }
    .carousel-arrow:disabled { opacity: 0.4; cursor: default; box-shadow: none; }
    .carousel-arrow svg { display: block; }

    /* Ellipsis dropdown menu */
    .goal-menu {
        position: absolute;
        top: 2.25rem;
        right: 1rem;
        background: #ffffff;
        border: 1px solid #ccc;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        border-radius: 8px;
        min-width: 140px;
        z-index: 200;
        display: none;
        overflow: hidden;
    }

    .goal-menu.open {
        display: block;
    }

    .goal-menu .options-item {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        padding: 10px 14px;
        text-align: left;
        background: white;
        border: none;
        cursor: pointer;
        font-size: 14px;
        color: #555555;
    }
    .goal-menu .options-item:hover { background: #F3F4F6; }
    .goal-menu .options-item svg { width: 16px; height: 16px; }
    .goal-menu .edit-option { color: #1f7c57; }
    .goal-menu .delete-option { color: #DC2626; }

    .goal-card canvas {
        width: 75% !important;
        height: 75% !important;
    }

    .goal-card .goal-title {
        margin-top: 0rem;
        text-align: center;
        font-size: 12px;
        font-weight: 300;
        max-width: 80%;   
        word-wrap: break-word;
        font-family: Helvetica;
    }

    .ellipsis-btn:hover {
        color: gray;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        overflow: hidden;
        border: 1px solid gray;
    }

    th, td {
        text-align: left;
        padding: 8px;
        font-size: 0.95rem;
    }

    .ListView-btn {
        border: none;
        padding: 0;
        background: none;
        font-family: Arial, sans-serif;
        color: #0077B6;
        cursor: pointer;
    }

    .ListView-btn:hover {
        color: blue;
    }

    .table-header {
        border-collapse: collapse;
        border: 1px solid gray;
    }

    /* Per-goal list styles, mirroring agenda */
    .title-expand-container {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        margin-top: 30px;
    }
    .table-title-text {
        font-family: 'Inter', Arial, sans-serif;
        font-weight: 400;
        font-size: 1.25rem;
        color: #000000;
    }
    .goal-progress-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-left: 10px;
        padding: 4px 10px;
        font-size: 0.8rem;
        font-weight: 700;
        color: #065f46;
        background: #d1fae5;
        border: 1px solid #86efac;
        border-radius: 999px;
    }
    .view-more {
        font-family: 'Inter', sans-serif;
        font-weight: 400;
        font-size: 0.75rem;
        color: #2EA8FF;
        text-decoration: none;
        margin-top: 10px;
        cursor: pointer;
    }
    .view-more:hover { text-decoration: underline; }
    .user-table {
        width: 100%;
        border-collapse: collapse;
        background: #FFFFFF; 
        border-radius: 8px; 
        overflow: auto;  
        box-shadow: 0 0 0 1px #dfdfdf, 0 0 15px rgba(0, 0, 0, 0.08); 
    }
    .user-table th {
        font-size: 0.95rem;
        font-weight: 600; 
        background: #eeeeee; 
        border-bottom: 1px solid #E0E0E0; 
        padding: 16px 18px; 
        text-align: left;
        font-family: 'Inter', Arial, sans-serif;
        color: #333333; 
        box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.05); 
        transition: padding 0.2s ease-in-out; 
    }
    .user-table td {
        font-size: 14px; 
        font-weight: 400;
        border: none;
        border-bottom: 1px solid #E0E0E0; 
        padding: 14px 18px; 
        text-align: left;
        font-family: 'Inter', Arial, sans-serif;
        color: #555555; 
        transition: padding 0.2s ease-in-out; 
    }
    .user-table tr:last-child td { border-bottom: none; }
    .user-table tr:nth-child(even) { background-color: #f8f8f8; }
    .name-link { color: #0099FF; text-decoration: none; }
    .name-link:hover { text-decoration: underline; }

    /* Remove old sidebar helper classes to prevent collisions */

    /* Overlay modal styles */
    .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }

    .overlay.open {
        display: flex;
    }

    .overlay-card {
        background: #fff;
        width: 100%;
        max-width: 1000px;
        max-height: 90vh;
        border-radius: 14px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 50px rgba(0,0,0,0.25);
    }

    .overlay-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
    }

    .overlay-title {
        font-size: 26px;
        font-weight: 600;
    }

    .overlay-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .btn-export {
        background: #0052cc;
        color: #fff;
        padding: 10px 18px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 600;
    }

    .btn-export:hover { background: #003f9e; }

    .overlay-close {
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 8px;
    }

    .overlay-body {
        overflow: auto;
    }

    .qualifiers-table {
        width: 100%;
        border-collapse: collapse;
    }

    .qualifiers-table th,
    .qualifiers-table td {
        padding: 18px 20px;
        border-bottom: 1px solid #e5e7eb;
        vertical-align: middle;
        font-size: 15px;
    }

    .qualifiers-table thead th {
        background: #f9fafb;
        text-align: left;
        font-weight: 600;
        color: #111827;
    }

    .table-settings { text-align: right; width: 70px; position: relative; }

    .row-ellipsis {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        line-height: 1;
        padding: 6px 8px;
        color: #111827;
    }

    .row-ellipsis:hover { color: #374151; }

    .row-menu {
        position: absolute;
        top: 2.25rem;
        right: 0.75rem;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        border-radius: 8px;
        min-width: 140px;
        z-index: 10;
        display: none;
        overflow: hidden;
    }

    .row-menu.open { display: block; }

    .row-menu button {
        width: 100%;
        padding: 10px 12px;
        text-align: left;
        background: white;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }

    .row-menu button:hover { background: #f3f4f6; }

    .pagination {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: center;
        padding: 14px 20px;
    }

    .page-btn,
    .page-num {
        background: transparent;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        color: #374151;
    }

    .page-num.active { background: #111827; color: #fff; }

    .page-btn.disabled,
    .page-num.disabled {
        opacity: 0.4;
        pointer-events: none;
    }

    /* Add Goal modal */
    .goal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1100;
        padding: 20px;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .goal-overlay.open { 
        display: flex; 
        opacity: 1;
        animation: overlayFadeIn 0.3s ease-out;
    }

    @keyframes overlayFadeIn {
        from {
            opacity: 0;
            backdrop-filter: blur(0px);
        }
        to {
            opacity: 1;
            backdrop-filter: blur(8px);
        }
    }

    .goal-card {
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        width: 100%;
        max-width: 900px;
        max-height: 95vh;
        border-radius: 24px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 
            0 32px 80px rgba(0,0,0,0.15),
            0 16px 40px rgba(0,0,0,0.1),
            0 0 0 1px rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.2);
        backdrop-filter: blur(10px);
        position: relative;
        transform: scale(0.9) translateY(20px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .goal-overlay.open .goal-card {
        transform: scale(1) translateY(0);
        animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes modalSlideIn {
        from {
            transform: scale(0.9) translateY(20px);
            opacity: 0;
        }
        to {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
    }

    .goal-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #004225 0%, #32CD32 50%, #004225 100%);
        border-radius: 24px 24px 0 0;
    }

    .goal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 32px 32px 16px 32px;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-bottom: 1px solid rgba(0,66,37,0.1);
        position: relative;
    }

    .goal-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 32px;
        right: 32px;
        height: 1px;
        background: linear-gradient(90deg, transparent 0%, #004225 50%, transparent 100%);
        opacity: 0.3;
    }

    .goal-modal-title {
        font-size: 36px;
        line-height: 1.2;
        font-weight: 800;
        letter-spacing: -0.5px;
        color: #111827;
        display: flex;
        align-items: center;
        gap: 12px;
        background: linear-gradient(135deg, #004225 0%, #32CD32 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }



    .goal-close {
        background: linear-gradient(145deg, #f3f4f6 0%, #e5e7eb 100%);
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 12px;
        color: #6b7280;
        border-radius: 12px;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .goal-close:hover {
        background: linear-gradient(145deg, #ef4444 0%, #dc2626 100%);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(239,68,68,0.3);
    }

    .goal-body {
        padding: 32px;
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        overflow-y: auto;
        max-height: calc(95vh - 120px);
    }

    .goal-body::-webkit-scrollbar {
        width: 6px;
    }

    .goal-body::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }

    .goal-body::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #004225 0%, #32CD32 100%);
        border-radius: 3px;
    }

    .goal-body::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #003018 0%, #28a745 100%);
    }

    .field-label {
        font-size: 18px;
        font-weight: 700;
        margin: 24px 0 12px 0;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
    }

    .field-label::before {
        content: '';
        width: 4px;
        height: 20px;
        background: linear-gradient(180deg, #004225 0%, #32CD32 100%);
        border-radius: 2px;
        margin-right: 4px;
    }

    .field-label:first-child {
        margin-top: 0;
    }

    .select-input, .text-input, .date-input {
        width: 100%;
        box-sizing: border-box;
        display: block;
        padding: 16px 20px;
        border-radius: 16px;
        border: 2px solid #e2e8f0;
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        font-size: 16px;
        line-height: 1.4;
        height: 60px;
        min-height: 60px;
        outline: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 
            0 1px 3px rgba(0,0,0,0.1),
            inset 0 1px 0 rgba(255,255,255,0.6);
        position: relative;
    }

    .select-input:focus, .text-input:focus, .date-input:focus {
        border-color: #004225;
        box-shadow: 
            0 0 0 4px rgba(0,66,37,0.1),
            0 4px 12px rgba(0,66,37,0.15),
            inset 0 1px 0 rgba(255,255,255,0.6);
        background: #ffffff;
        transform: translateY(-1px);
    }

    .select-input:hover, .text-input:hover, .date-input:hover {
        border-color: #cbd5e1;
        box-shadow: 
            0 2px 8px rgba(0,0,0,0.1),
            inset 0 1px 0 rgba(255,255,255,0.6);
        transform: translateY(-1px);
    }

    .text-input::placeholder {
        color: #94a3b8;
        font-style: italic;
        transition: color 0.2s ease;
    }

    .text-input:focus::placeholder {
        color: #cbd5e1;
    }

    .row-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 6px;
    }

    .row-2 > div { min-width: 0; }

    @media (max-width: 700px) {
        .row-2 { grid-template-columns: 1fr; }
    }

    /* Normalize native controls */
    .select-input {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none; /* keep plain look (screenshot shows simple caret) */
    }

    .date-input {
        -webkit-appearance: none;
        appearance: none;
    }

    .btn-submit {
        display: block;
        margin: 32px auto 8px auto;
        background: linear-gradient(135deg, #004225 0%, #32CD32 100%);
        color: #fff;
        font-weight: 700;
        font-size: 20px;
        padding: 18px 48px;
        border-radius: 50px;
        border: none;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 
            0 8px 25px rgba(0,66,37,0.3),
            0 4px 12px rgba(0,66,37,0.2);
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        min-width: 200px;
    }

    .btn-submit::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn-submit:hover {
        background: linear-gradient(135deg, #003018 0%, #28a745 100%);
        transform: translateY(-2px);
        box-shadow: 
            0 12px 35px rgba(0,66,37,0.4),
            0 6px 16px rgba(0,66,37,0.3);
    }

    .btn-submit:hover::before {
        left: 100%;
    }

    .btn-submit:active {
        transform: translateY(-1px);
        box-shadow: 
            0 6px 20px rgba(0,66,37,0.3),
            0 3px 8px rgba(0,66,37,0.2);
    }

    /* Filter Section Styles */
    .filter-section {
        margin: 24px 0;
        padding: 28px;
        background: linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
        border-radius: 20px;
        border: 1px solid rgba(0,66,37,0.1);
        box-shadow: 
            0 4px 16px rgba(0,0,0,0.05),
            inset 0 1px 0 rgba(255,255,255,0.6);
        position: relative;
        overflow: hidden;
    }

    .filter-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #004225 0%, #32CD32 50%, #004225 100%);
    }

    .filter-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-top: 12px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .filter-label {
        font-size: 14px;
        font-weight: 700;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0;
    }

    .filter-select {
        width: 100%;
        padding: 14px 16px;
        border-radius: 12px;
        border: 2px solid #cbd5e1;
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        font-size: 15px;
        color: #374151;
        outline: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        box-shadow: 
            0 1px 3px rgba(0,0,0,0.1),
            inset 0 1px 0 rgba(255,255,255,0.6);
    }

    .filter-select:focus {
        border-color: #004225;
        box-shadow: 
            0 0 0 4px rgba(0,66,37,0.1),
            0 4px 12px rgba(0,66,37,0.15),
            inset 0 1px 0 rgba(255,255,255,0.6);
        background: #ffffff;
        transform: translateY(-1px);
    }

    .filter-select:hover {
        border-color: #94a3b8;
        box-shadow: 
            0 2px 8px rgba(0,0,0,0.1),
            inset 0 1px 0 rgba(255,255,255,0.6);
        transform: translateY(-1px);
    }

    /* Filter status indicators */
    .filter-status {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
        padding: 8px 12px;
        background: #f3f4f6;
        border-radius: 6px;
        font-size: 13px;
        color: #6b7280;
    }

    .filter-status.active {
        background: #dcfce7;
        color: #166534;
    }

    .filter-status .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #9ca3af;
    }

    .filter-status.active .status-dot {
        background: #16a34a;
    }

    /* Responsive adjustments */
    @media (max-width: 900px) {
        .filter-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }
    }

    @media (max-width: 700px) {
        .filter-section {
            padding: 16px;
        }
        
        .filter-select {
            font-size: 14px;
            padding: 10px 12px;
        }
    }

    /* Reset Filters Button */
    .reset-filters-btn {
        margin-top: 20px;
        padding: 12px 24px;
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: block;
        margin-left: auto;
        margin-right: auto;
        box-shadow: 
            0 4px 12px rgba(107,114,128,0.3),
            0 2px 6px rgba(107,114,128,0.2);
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        min-width: 140px;
    }

    .reset-filters-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .reset-filters-btn:hover {
        background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
        transform: translateY(-2px);
        box-shadow: 
            0 6px 16px rgba(107,114,128,0.4),
            0 3px 8px rgba(107,114,128,0.3);
    }

    .reset-filters-btn:hover::before {
        left: 100%;
    }

    .reset-filters-btn:active {
        transform: translateY(-1px);
        box-shadow: 
            0 4px 12px rgba(107,114,128,0.3),
            0 2px 6px rgba(107,114,128,0.2);
    }
</style>
</head>
<body>
    

    <!-- Add Goal Modal removed; using server-rendered add/edit pages -->

    <div class="content">

    <main>
        <div>
            <div class="goals-header">
                <h1>Goals</h1>
                <a href="{% url 'add_goal' %}"><button class="add-user-btn">
                    <i class="fa-solid fa-bars-progress"></i>
                    Add Goal
                </button></a>
            </div> 
            <div class="goals-carousel-wrapper">
                <button class="carousel-arrow left-arrow" type="button" onclick="scrollGoals(-1)">
                    <svg width="32" height="32" viewBox="0 0 32 32"><path d="M20 8l-8 8 8 8" stroke="#063A1C" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <div class="goals-carousel">
                    <div class="goals-carousel-track" id="goalsTrack">
                        <!-- Goals will be dynamically loaded here -->
                    </div>
                </div>
                <button class="carousel-arrow right-arrow" type="button" onclick="scrollGoals(1)">
                    <svg width="32" height="32" viewBox="0 0 32 32"><path d="M12 8l8 8-8 8" stroke="#063A1C" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
            </div>
        </div>
        <div>
            <div class="ListView-header">
                <h1>List View</h1>
            </div>
            <div class="table-container">
                <div id="goalsError" style="display:none; margin: 0 0 12px 0; padding: 12px 14px; border-radius: 8px; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca;"></div>
                <div id="goalsTablesContainer"></div>
            </div>
        </div>
    </main>
    </div>

    <!-- Overlay Modal -->
    <div class="overlay" id="qualifiersOverlay" aria-hidden="true">
        <div class="overlay-card" role="dialog" aria-modal="true" aria-labelledby="overlayTitle">
            <div class="overlay-header">
                <div class="overlay-title" id="overlayTitle">List of Qualifiers</div>
                <div class="overlay-actions">
                    <button class="btn-export">Export</button>
                    <button class="overlay-close" id="overlayClose" title="Close">‚úï</button>
                </div>
            </div>
            <div class="overlay-body">
                <table class="qualifiers-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Team Leader</th>
                            <th>Start Date</th>
                            <th>Status</th>
                            <th class="table-settings">Settings</th>
                        </tr>
                    </thead>
                    <tbody id="qualifiersTbody">
                        <!-- rows injected via JS -->
                    </tbody>
                </table>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>

    <script>
        // Endpoint helpers resolved by Django
        const API_GOALS_URL = "{% url 'api_goals' %}";
        const API_GOAL_DETAIL_URL_TEMPLATE = "{% url 'api_goal_detail' 0 %}"; // replace 0 with id
        const API_GOAL_QUALIFIERS_URL_TEMPLATE = "{% url 'api_goal_qualifiers' 0 %}"; // replace 0 with id
        const EDIT_GOAL_URL_TEMPLATE = "{% url 'edit_goal' 0 %}"; // replace 0 with id
        function goalDetailUrl(id) { return API_GOAL_DETAIL_URL_TEMPLATE.replace('/0/', `/${id}/`); }
        function goalQualifiersUrl(id) { return API_GOAL_QUALIFIERS_URL_TEMPLATE.replace('/0/', `/${id}/`); }
        function editGoalUrl(id) { return EDIT_GOAL_URL_TEMPLATE.replace('/0/', `/${id}/`); }
        // Export function for qualifiers
        document.addEventListener('click', (e) => {
            if (e.target.closest('.btn-export')) {
                exportQualifiersToCSV();
            }
        });

        function exportQualifiersToCSV() {
            if (dataset.length === 0) {
                alert('No data to export');
                return;
            }

            // Create CSV content
            const headers = ['Title', 'Team Leader', 'Start Date', 'Status'];
            const csvRows = [headers.join(',')];

            dataset.forEach(row => {
                const values = [
                    `"${row.title}"`,
                    `"${row.lead}"`,
                    `"${row.start}"`,
                    `"${row.status}"`
                ];
                csvRows.push(values.join(','));
            });

            const csvContent = csvRows.join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'goal_qualifiers.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Plugin to draw percentage text inside the chart (with subtle shadow)
        const centerTextPlugin = {
            id: 'centerText',
            beforeDraw(chart) {
                const { width, height, ctx } = chart;
                ctx.save();
                const dataset = chart.data.datasets[0].data;
                const value = dataset[0];

                // Ensure value is valid for display
                const displayValue = (value !== null && value !== undefined && !isNaN(value)) ? value : 0;

                // Drop shadow for text for better contrast
                ctx.shadowColor = 'rgba(0,0,0,0.18)';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetY = 2;

                ctx.font = '700 3.2rem Arial'; 
                ctx.fillStyle = '#1f2937'; 
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(displayValue + '%', width / 2, height / 1.78);
                ctx.restore();
            }
        };
        // Subtle arc shadow plugin (applies to the progress arc only)
        const arcShadowPlugin = {
            id: 'arcShadow',
            beforeDatasetDraw(chart, args) {
                if (args.index !== 0) return;
                const { ctx } = chart;
                ctx.save();
                ctx.shadowColor = 'rgba(0,0,0,0.20)';
                ctx.shadowBlur = 14;
                ctx.shadowOffsetY = 6;
            },
            afterDatasetDraw(chart, args) {
                if (args.index !== 0) return;
                chart.ctx.restore();
            }
        };
        function createHalfDoughnut(ctx, value, title) {
            // Ensure value is a valid number, default to 0 if undefined/null
            const progressValue = (value !== null && value !== undefined && !isNaN(value)) ? value : 0;

            // Choose color palette by progress bucket
            let startColor, endColor;
            if (progressValue < 34) {
                startColor = '#ef4444'; // red
                endColor   = '#f87171';
            } else if (progressValue < 67) {
                startColor = '#f59e0b'; // amber
                endColor   = '#fbbf24';
            } else {
                startColor = '#10b981'; // green
                endColor   = '#22c55e';
            }

            // Gradient for the progress arc
            const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
            gradient.addColorStop(0, startColor);
            gradient.addColorStop(1, endColor);

            return new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [progressValue, 100 - progressValue],
                        backgroundColor: [gradient, 'rgba(229,231,235,0.9)'],
                        borderWidth: 0,
                        borderRadius: 14,
                        hoverOffset: 4
                    }]
                },
                options: {
                rotation: -90,
                circumference: 180,
                responsive: true,
                maintainAspectRatio: false,
                cutout: '78%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false },
                    title: { display: false },
                    subtitle: { display: false},
                    padding: { top: 10 }
                    },
                animation: {
                    animateRotate: true,
                    duration: 1200,
                    easing: 'easeOutCubic'
                    }
                },
                plugins: [arcShadowPlugin, centerTextPlugin] 
            });
        }

        // === Carousel logic (mirrors Agenda) ===
        const GOAL_CARD_BACKGROUNDS = [
            'linear-gradient(to bottom, #FFC4A8 0%, #ffffff 100%)',
            'linear-gradient(to bottom, #B6F3D7 0%, #ffffff 100%)',
            'linear-gradient(to bottom, #B8D9FF 0%, #ffffff 100%)',
            'linear-gradient(to bottom, #D0B8FF 0%, #ffffff 100%)',
            'linear-gradient(to bottom, #FFF3B8 0%, #ffffff 100%)',
            'linear-gradient(to bottom, #FFB8D9 0%, #ffffff 100%)',
            'linear-gradient(to bottom, #A8FFF0 0%, #ffffff 100%)',
            'linear-gradient(to bottom, #FFC0B8 0%, #ffffff 100%)',
            'linear-gradient(to bottom, #D9D9F8 0%, #ffffff 100%)',
        ];

        let goalsIndex = 0;
        const goalsCardsToShow = 3;

        function getGoalCards() {
            return document.querySelectorAll('.goals-carousel-track .goal-card');
        }

        function applyGoalColors() {
            const cards = getGoalCards();
            cards.forEach((card, index) => {
                const colorIndex = index % GOAL_CARD_BACKGROUNDS.length;
                card.style.backgroundImage = GOAL_CARD_BACKGROUNDS[colorIndex];
            });
        }

        function updateGoalsCarousel() {
            const track = document.querySelector('.goals-carousel-track');
            const cards = getGoalCards();
            const totalCards = cards.length;
            if (!track || totalCards === 0) return;

            if (goalsIndex < 0) goalsIndex = 0;
            if (goalsIndex > totalCards - goalsCardsToShow) {
                goalsIndex = Math.max(totalCards - goalsCardsToShow, 0);
            }

            const cardWidth = cards.length > 0 ? cards[0].offsetWidth : 0;
            const gap = parseInt(window.getComputedStyle(track).gap) || 24;
            const offset = goalsIndex * (cardWidth + gap);
            track.style.transform = `translateX(-${offset}px)`;

            const leftArrow = document.querySelector('.goals-carousel-wrapper .left-arrow');
            const rightArrow = document.querySelector('.goals-carousel-wrapper .right-arrow');
            if (leftArrow) leftArrow.disabled = goalsIndex === 0;
            if (rightArrow) rightArrow.disabled = goalsIndex >= totalCards - goalsCardsToShow;

            const lastVisibleIndex = goalsIndex + goalsCardsToShow - 1;
            cards.forEach((card, index) => {
                card.classList.remove('expand-left');
                if (index === lastVisibleIndex && index < totalCards) {
                    card.classList.add('expand-left');
                }
            });

            setupGoalHoverShift();
            applyGoalColors();
        }

        function scrollGoals(dir) {
            goalsIndex += dir;
            updateGoalsCarousel();
        }

        function setupGoalHoverShift() {
            const cards = getGoalCards();
            cards.forEach(card => card.classList.remove('shift-previous'));
            cards.forEach((card, index) => {
                if (card.classList.contains('expand-left')) {
                    const previousCard = cards[index - 1];
                    if (previousCard) {
                        const over = () => { previousCard.classList.add('shift-previous'); };
                        const out = () => { previousCard.classList.remove('shift-previous'); };
                        card.onmouseover = over;
                        card.onmouseout = out;
                    }
                } else {
                    card.onmouseover = null;
                    card.onmouseout = null;
                }
            });
        }

        // Ellipsis dropdown behavior - REMOVED CONFLICTING EVENT DELEGATION
        // Now using onclick handlers directly on buttons
        
        // Close menus when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.goal-menu') && !e.target.closest('.ellipsis-btn')) {
                document.querySelectorAll('.goal-menu').forEach(menu => {
                    menu.classList.remove('open');
                });
            }
        });

        // Delegate menu actions (Edit/Delete) - REMOVED OLD DELETE LOGIC
        document.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.menu-edit');
            if (editBtn) {
                const card = editBtn.closest('.goal-card');
                const title = card?.querySelector('.goal-title')?.textContent?.trim() || '';
                alert('Edit: ' + title);
            }
            // Delete button now uses onclick handlers, not event delegation
        });

        // Modal logic
        const overlay = document.getElementById('qualifiersOverlay');
        const overlayClose = document.getElementById('overlayClose');
        function openOverlay() { overlay.classList.add('open'); }
        function closeOverlay() { overlay.classList.remove('open'); }
        overlayClose.addEventListener('click', closeOverlay);
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeOverlay();
        });

        // Removed modal wiring; using server-rendered add/edit pages

        // Removed modal submission code

        // Notification functions
        function showSuccessMessage(message) {
            // Create a beautiful success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
                z-index: 10000;
                font-weight: 600;
                font-size: 16px;
                display: flex;
                align-items: center;
                gap: 12px;
                animation: slideInRight 0.3s ease-out;
                max-width: 400px;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 24px;">‚úÖ</div>
                <div>${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        function showErrorMessage(message) {
            // Create a beautiful error notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3);
                z-index: 10000;
                font-weight: 600;
                font-size: 16px;
                display: flex;
                align-items: center;
                gap: 12px;
                animation: slideInRight 0.3s ease-out;
                max-width: 400px;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 24px;">‚ùå</div>
                <div>${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Add CSS animations for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Removed modal filter helpers

        // Add reset filters button functionality (optional)
        function addResetFiltersButton() {
            const filterSection = document.querySelector('.filter-section');
            const resetButton = document.createElement('button');
            resetButton.textContent = 'Reset Filters';
            resetButton.className = 'reset-filters-btn';
            resetButton.style.cssText = `
                margin-top: 12px;
                padding: 8px 16px;
                background: #6b7280;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                transition: background 0.2s;
            `;
            resetButton.addEventListener('click', resetFilters);
            resetButton.addEventListener('mouseenter', () => {
                resetButton.style.background = '#4b5563';
            });
            resetButton.addEventListener('mouseleave', () => {
                resetButton.style.background = '#6b7280';
            });
            
            filterSection.appendChild(resetButton);
        }

        // Removed calls to undefined filter helpers to avoid halting script

        // Load goals when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set CSRF token in meta tag
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                if (csrfMeta) {
                    csrfMeta.setAttribute('content', csrfToken);
                }
            }
            
            loadGoals();
            window.addEventListener('resize', updateGoalsCarousel);
        });

        // Database integration functions
        let goals = []; // Store goals data

        // Load goals from database
        async function loadGoals() {
            try {
                console.log('=== LOADING GOALS FROM API ===');
                const response = await fetch(API_GOALS_URL, { credentials: 'same-origin' });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 300)}`);
                }
                const data = await response.json();
                
                console.log('API Response:', data);
                
                if (data.success === false) {
                    showGoalsError(data.error || 'Failed to load goals');
                    goals = [];
                    renderEmptyState(true);
                    renderQualifiersTables();
                    return;
                }

                if (data.goals && data.goals.length > 0) {
                    console.log('Raw goals from API:', data.goals);
                    
                    // Validate and normalize goal data
                    goals = data.goals.map(goal => ({
                        ...goal,
                        progress: (goal.progress !== null && goal.progress !== undefined && !isNaN(goal.progress)) ? goal.progress : 0,
                        goal_number: goal.goal_number || 0,
                        title: goal.title || 'Untitled Goal'
                    }));
                    
                    console.log('Processed goals array:', goals);
                    console.log('Goals array length:', goals.length);
                    
                    renderGoals();
                    renderQualifiersTables();
                } else {
                    console.log('No goals found in API response');
                    // No goals in database - show demo tiles so UI remains visible
                    goals = [];
                    renderEmptyState(false);
                    renderQualifiersTables();
                }
            } catch (error) {
                console.error('Error loading goals from database:', error);
                showGoalsError('Error loading goals: ' + (error?.message || error));
                // API failed - show demo tiles instead of hiding the section
                goals = [];
                renderEmptyState(false);
                renderQualifiersTables();
            }
        }

        // Fetch and populate dynamic filters from backend
        // Removed loadFilters

        // Render empty state when no goals exist
        function renderEmptyState(hasError = false) {
            const goalContainer = document.getElementById('goalsContainer');
            if (!goalContainer) return;
            goalContainer.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 3rem 2rem; color: #6b7280;">
                    <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">${hasError ? '‚ö†Ô∏è' : 'üìã'}</div>
                    <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: #374151;">${hasError ? 'Unable to Load Goals' : 'No Goals Yet'}</h3>
                    <p style="font-size: 1rem; margin-bottom: 1.5rem; max-width: 400px; margin-left: auto; margin-right: auto;">${hasError ? 'There was an error loading goals from the database. Please check your connection and try again.' : 'Start by adding your first goal using the "Add Goal" button above. Your goals will appear here once created.'}</p>
                    ${!hasError ? '<a href="/goals/add/" class="add-goal" style="margin-top: 1rem; display:inline-block;"><i class="fa-solid fa-plus" style="margin-right: 0.5rem;"></i>Add Your First Goal</a>' : ''}
                </div>
            `;
        }

        // Render goals in the UI
        function renderGoals() {
            const goalContainer = document.getElementById('goalsContainer');
            const track = document.getElementById('goalsTrack');
            if (!track) return;

            // Clear existing goals
            track.innerHTML = '';

            // If no goals, show empty state
            if (goals.length === 0) {
                // If empty, center message inside carousel
                const empty = document.createElement('div');
                empty.style.cssText = 'width:960px;text-align:center;padding:40px;color:#888;font-size:18px;margin:0 auto;';
                empty.textContent = 'No goals found.';
                track.appendChild(empty);
                return;
            }

            // Render all goals as carousel cards
            const goalsToShow = goals;
            
            goalsToShow.forEach((goal, index) => {
                console.log(`Rendering goal ${index}: ID=${goal.id}, Title="${goal.title}"`);
                const card = document.createElement('div');
                card.className = 'goal-card';
                card.innerHTML = `
                    <button class=\"ellipsis-btn\" onclick=\"toggleGoalMenu(${index})\">...</button>
                    <div class=\"goal-menu\" id=\"goal-menu-${index}\">\n\
                        <button class=\"options-item edit-option\" onclick=\"editGoal(${goal.id})\">\n\
                            <svg viewBox=\"0 0 24 24\" fill=\"currentColor\"><path d=\"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\"></path><path d=\"m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z\"></path></svg>
                            Edit\n\
                        </button>\n\
                        <button class=\"options-item delete-option\" onclick=\"deleteGoal(${goal.id})\">\n\
                            <svg viewBox=\"0 0 24 24\" fill=\"currentColor\"><polyline points=\"3,6 5,6 21,6\"></polyline><path d=\"m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2\"></path></svg>
                            Delete\n\
                        </button>\n\
                    </div>
                    <canvas id=\"goal${index + 1}\"></canvas>
                    <div class=\"goal-title\">${goal.title}</div>
                `;
                track.appendChild(card);

                // Create chart for this goal
                setTimeout(() => {
                    createHalfDoughnut(
                        document.getElementById(`goal${index + 1}`).getContext('2d'), 
                        goal.progress, 
                        goal.title
                    );
                }, 100);
            });

            // Initialize carousel after rendering
            updateGoalsCarousel();
        }

        // Update list view with real data
        function updateListView() {
            const tbody = document.getElementById('goalsListTbody');
            if (!tbody) return;

            tbody.innerHTML = '';
            
            if (goals.length === 0) {
                // Show empty state in table
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="3" style="text-align: center; padding: 2rem; color: #6b7280; font-style: italic;">
                        No goals available. Add a goal to see it here.
                    </td>
                `;
                tbody.appendChild(emptyRow);
                return;
            }

            goals.forEach(goal => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${goal.title}</td>
                    <td><button class="ListView-btn" onclick="viewQualifiers(${goal.id})">View List</button></td>
                    <td class="progress">${goal.progress}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Add new goal to database
        async function addGoalToDatabase(goalData) {
            try {
                console.log('Attempting to add goal:', goalData);
                
                const csrfToken = getCSRFToken();
                console.log('CSRF Token:', csrfToken ? 'Found' : 'Not found');
                
                const response = await fetch(API_GOALS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(goalData)
                });

                console.log('Add goal response status:', response.status);
                console.log('Add goal response headers:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('Add goal response:', result);
                
                if (result.success) {
                    // Reload goals from database for real-time update
                    await loadGoals();
                    return true;
                } else {
                    console.error('Error adding goal:', result.error);
                    showErrorMessage('Error adding goal: ' + (result.error || 'Unknown error'));
                    return false;
                }
            } catch (error) {
                console.error('Error adding goal:', error);
                showErrorMessage('Error adding goal: ' + error.message);
                return false;
            }
        }

        // Delete goal from database
        async function deleteGoalFromDatabase(goalId) {
            try {
                console.log('Attempting to delete goal ID:', goalId);
                console.log('CSRF Token:', getCSRFToken() ? 'Found' : 'Not found');
                
                const response = await fetch(goalDetailUrl(goalId), {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    }
                });

                console.log('Delete response status:', response.status);
                console.log('Delete response headers:', response.headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Delete response error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Delete response:', result);
                
                if (result.success) {
                    // Reload goals from database for real-time update
                    await loadGoals();
                    return true;
                } else {
                    console.error('Error deleting goal:', result.error);
                    showErrorMessage('Error deleting goal: ' + result.error);
                    return false;
                }
            } catch (error) {
                console.error('Error deleting goal:', error);
                showErrorMessage('Error deleting goal: ' + error.message);
                return false;
            }
        }

        // Get CSRF token
        function getCSRFToken() {
            // Try to get CSRF token from cookies
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            
            // Try to get CSRF token from meta tag
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            if (csrfMeta) {
                return csrfMeta.getAttribute('content');
            }
            
            // Try to get CSRF token from form
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (csrfInput) {
                return csrfInput.value;
            }
            
            console.warn('CSRF token not found');
            return '';
        }

        // Enhanced goal menu functions
        function toggleGoalMenu(index) {
            console.log('toggleGoalMenu called with index:', index);
            // Close all menus
            document.querySelectorAll('.goal-menu').forEach(menu => {
                menu.classList.remove('open');
            });
            
            // Toggle current menu
            const menu = document.getElementById(`goal-menu-${index}`);
            console.log('Found menu element:', menu);
            if (menu) {
                menu.classList.toggle('open');
                console.log('Menu toggled, is open:', menu.classList.contains('open'));
            }
        }

        // Edit goal function
        function editGoal(goalId) {
            window.location.href = editGoalUrl(goalId);
        }

        // Delete goal function
        async function deleteGoal(goalId) {
            console.log('=== DELETE DEBUG START ===');
            console.log('deleteGoal called with ID:', goalId, 'Type:', typeof goalId);
            console.log('Current goals array:', goals);
            console.log('Goals array length:', goals.length);
            console.log('Looking for goal with ID:', parseInt(goalId));
            
            // Log all goal IDs for comparison
            goals.forEach((g, index) => {
                console.log(`Goal ${index}: ID=${g.id} (type: ${typeof g.id}), Title="${g.title}"`);
            });
            
            const goal = goals.find(g => g.id === parseInt(goalId)); // Convert string to number
            console.log('Found goal:', goal);
            
            if (goal) {
                console.log('Goal found! Showing custom confirmation dialog...');
                const confirmed = await showDeleteConfirmation(goal.title);
                console.log('User confirmation result:', confirmed);
                
                if (confirmed) {
                    console.log('User confirmed deletion');
                    const success = await deleteGoalFromDatabase(goalId);
                    if (success) {
                        showSuccessMessage('Goal deleted successfully!');
                    }
                } else {
                    console.log('User cancelled deletion');
                }
            } else {
                console.log('‚ùå Goal not found in array');
                console.log('Available goal IDs:', goals.map(g => g.id));
                console.log('Looking for ID:', parseInt(goalId));
            }
            console.log('=== DELETE DEBUG END ===');
        }

        // Custom delete confirmation dialog
        function showDeleteConfirmation(goalTitle) {
            return new Promise((resolve) => {
                // Create overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.3s ease-out;
                `;
                
                // Create dialog
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: white;
                    border-radius: 16px;
                    padding: 32px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
                    text-align: center;
                    animation: slideIn 0.3s ease-out;
                `;
                
                dialog.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                    <h3 style="margin: 0 0 16px 0; color: #1f2937; font-size: 20px;">Delete Goal</h3>
                    <p style="margin: 0 0 24px 0; color: #6b7280; line-height: 1.5;">
                        Are you sure you want to delete<br>
                        <strong style="color: #1f2937;">"${goalTitle}"</strong>?
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button id="cancelDelete" style="
                            background: #6b7280;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            transition: background 0.2s;
                        ">Cancel</button>
                        <button id="confirmDelete" style="
                            background: #dc2626;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            transition: background 0.2s;
                        ">Delete</button>
                    </div>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                // Add CSS animations
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { transform: translateY(-20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
                
                // Event listeners
                document.getElementById('cancelDelete').addEventListener('click', () => {
                    overlay.remove();
                    style.remove();
                    resolve(false);
                });
                
                document.getElementById('confirmDelete').addEventListener('click', () => {
                    overlay.remove();
                    style.remove();
                    resolve(true);
                });
                
                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        style.remove();
                        resolve(false);
                    }
                });
                
                // Close on Escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        overlay.remove();
                        style.remove();
                        document.removeEventListener('keydown', handleEscape);
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            });
        }

        // View qualifiers function
        async function viewQualifiers(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (goal) {
                // Update overlay title
                document.getElementById('overlayTitle').textContent = `Qualifiers for: ${goal.title}`;
                
                // Show loading state
                const tbody = document.getElementById('qualifiersTbody');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">Loading...</td></tr>';
                
                openOverlay();
                
                try {
                    // Fetch projects that match this goal's criteria
                    const response = await fetch(goalQualifiersUrl(goalId));
                    const data = await response.json();
                    
                    if (data.success && data.projects) {
                        // Update the dataset with real project data
                        dataset = data.projects.map(project => ({
                            title: project.title,
                            lead: project.team_leader,
                            start: project.start_date,
                            status: project.status
                        }));
                        
                        // Render the first page
                        renderTablePage(1);
                    } else {
                        // Show error state
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #dc2626;">Error loading projects</td></tr>';
                    }
                } catch (error) {
                    console.error('Error fetching qualifiers:', error);
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #dc2626;">Error loading projects: ' + error.message + '</td></tr>';
                }
            }
        }
        
        // Make functions globally accessible
        window.deleteGoal = deleteGoal;
        window.editGoal = editGoal;
        window.toggleGoalMenu = toggleGoalMenu;
        window.viewQualifiers = viewQualifiers;

        function showGoalsError(message) {
            const box = document.getElementById('goalsError');
            if (!box) return;
            box.textContent = message;
            box.style.display = 'block';
        }

        // Render per-goal qualifiers tables similar to agenda
        async function renderQualifiersTables() {
            const container = document.getElementById('goalsTablesContainer');
            if (!container) return;
            container.innerHTML = '';

            if (!goals || goals.length === 0) {
                const empty = document.createElement('div');
                empty.style.cssText = 'text-align:center; padding: 2rem; color:#6b7280;';
                empty.textContent = 'No goals available.';
                container.appendChild(empty);
                return;
            }

            for (const goal of goals) {
                const section = document.createElement('div');
                section.className = 'goal-qualifiers-section';
                section.innerHTML = `
                    <div class="title-expand-container">
                        <span class="table-title-text">${goal.title}<span class="goal-progress-badge">${goal.progress}%</span></span>
                        <a href="/projects/?goal=${goal.id}" class="view-more" data-goal-id="${goal.id}">View More</a>
                    </div>
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Team Leader</th>
                                <th>Start Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody class="goal-tbody" data-goal-id="${goal.id}">
                            <tr><td colspan="4" style="text-align:center; padding: 1rem;">Loading...</td></tr>
                        </tbody>
                    </table>
                `;
                container.appendChild(section);

                // Fetch qualifiers for this goal
                try {
                    const resp = await fetch(goalQualifiersUrl(goal.id));
                    const data = await resp.json();
                    const tbody = section.querySelector('.goal-tbody');
                    tbody.innerHTML = '';

                    if (data.success && Array.isArray(data.projects) && data.projects.length > 0) {
                        const total = data.projects.length;
                        const rows = data.projects.slice(0, 10);
                        rows.forEach(project => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${project.title}</td>
                                <td>${project.team_leader}</td>
                                <td>${project.start_date || ''}</td>
                                <td>${project.status || ''}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                        const link = section.querySelector('.view-more');
                        if (link) {
                            link.style.display = '';
                        }
                    } else {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td colspan="4" style="text-align:center; padding: 1rem; color:#6b7280;">No qualifiers for this goal.</td>`;
                        tbody.appendChild(tr);
                        const link = section.querySelector('.view-more');
                        if (link) link.style.display = '';
                    }
                } catch (e) {
                    const tbody = section.querySelector('.goal-tbody');
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 1rem; color:#dc2626;">Error loading qualifiers</td></tr>`;
                    const link = section.querySelector('.view-more');
                    if (link) link.style.display = '';
                }
            }
        }

        // Client-side pagination
        const PAGE_SIZE = 5;
        let currentPage = 1;
        let dataset = [];

        function renderTablePage(page) {
            currentPage = page;
            const start = (page - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const slice = dataset.slice(start, end);
            const tbody = document.getElementById('qualifiersTbody');
            tbody.innerHTML = slice.map((row, idx) => `
                <tr>
                    <td>${row.title}</td>
                    <td>${row.lead}</td>
                    <td>${row.start}</td>
                    <td>${row.status}</td>
                    <td class="table-settings">
                        <button class="row-ellipsis" aria-haspopup="true" aria-expanded="false">¬∑¬∑¬∑</button>
                        <div class="row-menu">
                            <button class="row-edit">Edit</button>
                            <button class="row-delete" style="color:#d2042d;">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.max(1, Math.ceil(dataset.length / PAGE_SIZE));
            const container = document.getElementById('pagination');
            const btnPrev = `<button class="page-btn ${currentPage === 1 ? 'disabled' : ''}" data-page="prev">‚Üê Previous</button>`;
            const btnNext = `<button class="page-btn ${currentPage === totalPages ? 'disabled' : ''}" data-page="next">Next ‚Üí</button>`;

            // Build numbered pages with ellipses
            const pages = [];
            const windowSize = 2; // neighbors around current
            for (let p = 1; p <= totalPages; p++) {
                const isEdge = p === 1 || p === totalPages;
                const inWindow = Math.abs(p - currentPage) <= windowSize;
                if (isEdge || inWindow) {
                    pages.push(p);
                }
            }
            // insert ellipses
            const uniquePages = [...new Set(pages)].sort((a,b)=>a-b);
            const parts = [];
            uniquePages.forEach((p, idx) => {
                if (idx > 0 && p - uniquePages[idx-1] > 1) parts.push('<span>‚Ä¶</span>');
                parts.push(`<button class="page-num ${p === currentPage ? 'active' : ''}" data-page="${p}">${p}</button>`);
            });

            container.innerHTML = btnPrev + parts.join('') + btnNext;
        }

        document.getElementById('pagination').addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const totalPages = Math.max(1, Math.ceil(dataset.length / PAGE_SIZE));
            const tag = btn.getAttribute('data-page');
            if (tag === 'prev' && currentPage > 1) renderTablePage(currentPage - 1);
            else if (tag === 'next' && currentPage < totalPages) renderTablePage(currentPage + 1);
            else if (!isNaN(parseInt(tag))) renderTablePage(parseInt(tag));
        });

        // Row ellipsis menu interactions for Settings column
        document.addEventListener('click', (e) => {
            const ellipsis = e.target.closest('.row-ellipsis');
            const anyMenus = document.querySelectorAll('.row-menu');
            // Close all menus by default
            anyMenus.forEach(m => m.classList.remove('open'));
            if (ellipsis) {
                const cell = ellipsis.parentElement;
                const menu = cell.querySelector('.row-menu');
                if (menu) {
                    menu.classList.add('open');
                }
            }
        });

        // Handle Edit/Delete in Settings column
        document.addEventListener('click', (e) => {
            const edit = e.target.closest('.row-edit');
            const del = e.target.closest('.row-delete');
            if (edit) {
                const row = edit.closest('tr');
                const title = row?.children?.[0]?.textContent?.trim() || '';
                alert('Edit qualifier: ' + title);
            }
            if (del) {
                const row = del.closest('tr');
                const title = row?.children?.[0]?.textContent?.trim() || '';
                const ok = confirm('Delete this qualifier?\n\n' + title);
                if (ok) row?.remove();
            }
        });

        // Note: View List buttons are now handled by viewQualifiers function
        // The onclick handlers are set directly in the HTML when rows are rendered
    </script>
</body>
</html>

{% endblock %}