{% extends "base_internal.html" %}
{% block content %}
{% load static%}
<!DOCTYPE HTML>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="csrf-token" content="">
<title>Goals</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.css' rel='stylesheet'/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'internal/goals/styles.css' %}" rel="stylesheet">
</head>
<body>
    

    <div class="content">

    <main>
        <div>
            <div class="goals-header">
                <h1>Goals</h1>
                <a href="{% url 'add_goal' %}"><button class="add-user-btn">
                    <i class="fa-solid fa-bars-progress"></i>
                    Add Goal
                </button></a>
            </div> 
            <div class="goals-carousel-wrapper">
                <button class="carousel-arrow left-arrow" type="button" onclick="scrollGoals(-1)">
                    <svg width="32" height="32" viewBox="0 0 32 32"><path d="M20 8l-8 8 8 8" stroke="#063A1C" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <div class="goals-carousel">
                    <div class="goals-carousel-track" id="goalsTrack">
                        </div>
                </div>
                <button class="carousel-arrow right-arrow" type="button" onclick="scrollGoals(1)">
                    <svg width="32" height="32" viewBox="0 0 32 32"><path d="M12 8l8 8-8 8" stroke="#063A1C" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
            </div>
        </div>
        <div>
            <div class="table-container">
                <div id="goalsError" style="display:none; margin: 0 0 12px 0; padding: 12px 14px; border-radius: 8px; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca;"></div>
                <div id="goalsTablesContainer"></div>
            </div>
        </div>
    </main>
    </div>

    <script>
        // Endpoint helpers resolved by Django
        const API_GOALS_URL = "{% url 'api_goals' %}";
        const API_GOAL_DETAIL_URL_TEMPLATE = "{% url 'api_goal_detail' 0 %}"; 
        const API_GOAL_QUALIFIERS_URL_TEMPLATE = "{% url 'api_goal_qualifiers' 0 %}";
        const EDIT_GOAL_URL_TEMPLATE = "{% url 'edit_goal' 0 %}";
        function goalDetailUrl(id) { return API_GOAL_DETAIL_URL_TEMPLATE.replace('/0/', `/${id}/`); }
        function goalQualifiersUrl(id) { return API_GOAL_QUALIFIERS_URL_TEMPLATE.replace('/0/', `/${id}/`); }
        function editGoalUrl(id) { return EDIT_GOAL_URL_TEMPLATE.replace('/0/', `/${id}/`); }
        
        // --- Carousel logic (adapted for 2x2 groups) ---

        let goalsIndex = 0;
        const goalsGroupsToShow = 1; // Show 1 group of 4 cards at a time

        function getGoalCards() {
            return document.querySelectorAll('.goals-carousel-track .goal-card-group .goal-card');
        }
        
        function getGoalGroups() {
            return document.querySelectorAll('.goals-carousel-track .goal-card-group');
        }

        function applyGoalColors() {
            // Function no longer applies colors but is kept to preserve logic flow.
            // Colors/backgrounds are applied via CSS based on data-index attribute.
        }

        function updateGoalsCarousel() {
            const track = document.getElementById('goalsTrack');
            const groups = getGoalGroups();
            const totalGroups = groups.length;
            if (!track || totalGroups === 0) return;

            // 1. Clamp index
            if (goalsIndex < 0) goalsIndex = 0;
            if (goalsIndex > totalGroups - goalsGroupsToShow) {
                goalsIndex = Math.max(totalGroups - goalsGroupsToShow, 0);
            }

            // 2. Calculate offset and scroll using group width
            const groupsArray = Array.from(groups);
            const groupWidth = groupsArray.length > 0 ? groupsArray[0].offsetWidth : 0;
            const trackStyle = window.getComputedStyle(track);
            const gap = parseInt(trackStyle.gap) || 4;
            const offset = goalsIndex * (groupWidth + gap);
            track.style.transform = `translateX(-${offset}px)`;

            // 3. Arrow enable/disable
            const leftArrow = document.querySelector('.goals-carousel-wrapper .left-arrow');
            const rightArrow = document.querySelector('.goals-carousel-wrapper .right-arrow');
            if (leftArrow) leftArrow.disabled = goalsIndex === 0;
            if (rightArrow) rightArrow.disabled = goalsIndex >= totalGroups - goalsGroupsToShow;

            // 4. Cleanup old hover classes
            setupGoalHoverShift();
            applyGoalColors();
        }

        function scrollGoals(dir) {
            goalsIndex += dir;
            updateGoalsCarousel();
        }

        function setupGoalHoverShift() {
            const cards = getGoalCards();
            cards.forEach(card => {
                card.classList.remove('expand-left', 'shift-previous');
                card.onmouseover = null;
                card.onmouseout = null;
            });
        }

        // Ellipsis dropdown behavior
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.goal-menu') && !e.target.closest('.ellipsis-btn')) {
                document.querySelectorAll('.goal-menu').forEach(menu => {
                    menu.classList.remove('open');
                });
            }
        });

        // Notification functions (kept for completeness)
        function showSuccessMessage(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3); z-index: 10000; font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 12px; animation: slideInRight 0.3s ease-out; max-width: 400px;`;
            notification.innerHTML = `<div style="font-size: 24px;">‚úÖ</div><div>${message}</div>`;
            document.body.appendChild(notification);
            setTimeout(() => { notification.style.animation = 'slideOutRight 0.3s ease-in'; setTimeout(() => notification.remove(), 300); }, 4000);
        }

        function showErrorMessage(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3); z-index: 10000; font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 12px; animation: slideInRight 0.3s ease-out; max-width: 400px;`;
            notification.innerHTML = `<div style="font-size: 24px;">‚ùå</div><div>${message}</div>`;
            document.body.appendChild(notification);
            setTimeout(() => { notification.style.animation = 'slideOutRight 0.3s ease-in'; setTimeout(() => notification.remove(), 300); }, 5000);
        }

        // Add CSS animations for notifications (kept for completeness)
        const style = document.createElement('style');
        style.textContent = `@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }`;
        document.head.appendChild(style);

        // Load goals when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                    if (csrfMeta) {
                        csrfMeta.setAttribute('content', csrfToken);
                    }
                }
            
            loadGoals();
            window.addEventListener('resize', updateGoalsCarousel);
        });

        // Database integration functions
        let goals = [];

        async function loadGoals() {
            try {
                const response = await fetch(API_GOALS_URL, { credentials: 'same-origin' });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 300)}`);
                }
                const data = await response.json();
                
                if (data.success === false) {
                    showGoalsError(data.error || 'Failed to load goals');
                    goals = [];
                    renderGoals();
                    renderQualifiersTables();
                    return;
                }

                if (data.goals && data.goals.length > 0) {
                    goals = data.goals.map(goal => ({
                        ...goal,
                        progress: (goal.progress !== null && goal.progress !== undefined && !isNaN(goal.progress)) ? goal.progress : 0,
                        goal_number: goal.goal_number || 0,
                        title: goal.title || 'Untitled Goal'
                    }));
                    
                    renderGoals();
                    renderQualifiersTables();
                } else {
                    goals = [];
                    renderGoals();
                    renderQualifiersTables();
                }
            } catch (error) {
                showGoalsError('Error loading goals: ' + (error?.message || error));
                goals = [];
                renderGoals();
                renderQualifiersTables();
            }
        }


        function renderEmptyState(hasError = false) {
            const track = document.getElementById('goalsTrack');
            if (!track) return;
            
            // Ensures the empty state spans the carousel width (804px)
            const emptyStateContent = `<div style="width: 804px; text-align: center; padding: 3rem 2rem; color: #6b7280; flex-shrink: 0;">
                <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">${hasError ? '‚ö†Ô∏è' : 'üìã'}</div>
                <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: #374151;">${hasError ? 'Unable to Load Goals' : 'No Goals Yet'}</h3>
                <p style="font-size: 1rem; margin-bottom: 1.5rem; max-width: 400px; margin-left: auto; margin-right: auto;">${hasError ? 'There was an error loading goals from the database. Please check your connection and try again.' : 'Start by adding your first goal using the "Add Goal" button above. Your goals will appear here once created.'}</p>
                ${!hasError ? '<a href="{% url "add_goal" %}" class="add-goal" style="margin-top: 1rem; display:inline-block;"><i class="fa-solid fa-plus" style="margin-right: 0.5rem;"></i>Add Your First Goal</a>' : ''}
            </div>`;

            const emptyContainer = document.createElement('div');
            emptyContainer.innerHTML = emptyStateContent;
            track.appendChild(emptyContainer.firstChild);
        }

        // Render goals in the UI (modified for 2x2 grid and X/Y format)
        async function renderGoals() {
            const track = document.getElementById('goalsTrack');
            if (!track) return;

            track.innerHTML = '';

            if (goals.length === 0) {
                renderEmptyState(false);
                return;
            }

            let group = null;
            const totalGoals = goals.length;
            
            goals.forEach((goal, index) => {
                const cardIndex = index % 4; // Used for CSS geometric background pattern

                // Create a new group for every 4 goals
                if (cardIndex === 0) {
                    group = document.createElement('div');
                    group.className = 'goal-card-group';
                    track.appendChild(group);
                }

                const card = document.createElement('div');
                card.className = 'goal-card';
                card.setAttribute('data-index', cardIndex); // Set data-index for CSS styling
                card.innerHTML = `
                    <button class=\"ellipsis-btn\" onclick=\"toggleGoalMenu(${index})\">...</button>
                    <div class=\"goal-menu\" id=\"goal-menu-${index}\">\n\
                        <button class=\"options-item edit-option\" onclick=\"editGoal(${goal.id})\">\n\
                            <svg viewBox=\"0 0 24 24\" fill=\"currentColor\"><path d=\"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\"></path><path d=\"m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z\"></path></svg>
                            Edit\n\
                        </button>\n\
                        <button class=\"options-item delete-option\" onclick=\"deleteGoal(${goal.id})\">\n\
                            <svg viewBox=\"0 0 24 24\" fill=\"currentColor\"><polyline points=\"3,6 5,6 21,6\"></polyline><path d=\"m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2\"></path></svg>
                            Delete\n\
                        </button>\n\
                    </div>
                    <div class=\"goal-number\">${index + 1}/${totalGoals}</div>
                    <div class=\"goal-title\">${goal.title}</div>
                `;
                group.appendChild(card);
            });

            updateGoalsCarousel();
        }


        // Get CSRF token (kept for completeness)
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            if (csrfMeta) {
                return csrfMeta.getAttribute('content');
            }
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (csrfInput) {
                return csrfInput.value;
            }
            return '';
        }

        // Enhanced goal menu functions
        function toggleGoalMenu(index) {
            document.querySelectorAll('.goal-menu').forEach(menu => {
                menu.classList.remove('open');
            });
            
            const menu = document.getElementById(`goal-menu-${index}`);
            if (menu) {
                menu.classList.toggle('open');
            }
        }

        // Edit goal function
        function editGoal(goalId) {
            window.location.href = editGoalUrl(goalId);
        }

        // Delete goal function (kept for completeness)
        async function deleteGoal(goalId) {
            const goal = goals.find(g => g.id === parseInt(goalId));
            
            if (goal) {
                const confirmed = await showDeleteConfirmation(goal.title);
                
                if (confirmed) {
                    const success = await deleteGoalFromDatabase(goalId);
                    if (success) {
                        showSuccessMessage('Goal deleted successfully!');
                    }
                }
            }
        }

        // Custom delete confirmation dialog (kept for completeness)
        function showDeleteConfirmation(goalTitle) {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease-out;`;
                
                const dialog = document.createElement('div');
                dialog.style.cssText = `background: white; border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); text-align: center; animation: slideIn 0.3s ease-out;`;
                
                dialog.innerHTML = `<div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div><h3 style="margin: 0 0 16px 0; color: #1f2937; font-size: 20px;">Delete Goal</h3><p style="margin: 0 0 24px 0; color: #6b7280; line-height: 1.5;">Are you sure you want to delete<br><strong style="color: #1f2937;">"${goalTitle}"</strong>?</p><div style="display: flex; gap: 12px; justify-content: center;"><button id="cancelDelete" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.2s;">Cancel</button><button id="confirmDelete" style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.2s;">Delete</button></div>`;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                const style = document.createElement('style');
                style.textContent = `@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }`;
                document.head.appendChild(style);
                
                const cleanup = (result) => { overlay.remove(); style.remove(); resolve(result); };
                document.getElementById('cancelDelete').addEventListener('click', () => cleanup(false));
                document.getElementById('confirmDelete').addEventListener('click', () => cleanup(true));
                overlay.addEventListener('click', (e) => { if (e.target === overlay) cleanup(false); });
                const handleEscape = (e) => { if (e.key === 'Escape') { document.removeEventListener('keydown', handleEscape); cleanup(false); } };
                document.addEventListener('keydown', handleEscape);
            });
        }
        
        function showGoalsError(message) {
            const box = document.getElementById('goalsError');
            if (!box) return;
            box.textContent = message;
            box.style.display = 'block';
        }

        // Render per-goal qualifiers tables similar to agenda (kept for completeness)
        async function renderQualifiersTables() {
            const container = document.getElementById('goalsTablesContainer');
            if (!container) return;
            container.innerHTML = '';

            if (!goals || goals.length === 0) {
                const empty = document.createElement('div');
                empty.style.cssText = 'text-align:center; padding: 2rem; color:#6b7280;';
                empty.textContent = 'No goals available to display in list view.';
                container.appendChild(empty);
                return;
            }

            for (const goal of goals) {
                const section = document.createElement('div');
                section.className = 'goal-qualifiers-section';
                section.innerHTML = `
                    <div class="title-expand-container">
                        <span class="table-title-text">${goal.title}<span class="goal-progress-badge">${goal.progress}%</span></span>
                        <a href="/projects/?goal=${goal.id}" class="view-more" data-goal-id="${goal.id}">View More</a>
                    </div>
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Team Leader</th>
                                <th>Start Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody class="goal-tbody" data-goal-id="${goal.id}">
                            <tr><td colspan="4" style="text-align:center; padding: 1rem;">Loading...</td></tr>
                        </tbody>
                    </table>
                `;
                container.appendChild(section);

                try {
                    const resp = await fetch(goalQualifiersUrl(goal.id));
                    const data = await resp.json();
                    const tbody = section.querySelector('.goal-tbody');
                    tbody.innerHTML = '';

                    if (data.success && Array.isArray(data.projects) && data.projects.length > 0) {
                        const rows = data.projects.slice(0, 10);
                        rows.forEach(project => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td><a href="/projects/${project.id}" class="name-link">${project.title}</a></td>
                                <td><a href="/users/${project.team_leader_id}" class="name-link">${project.team_leader}</a></td>
                                <td>${project.start_date || ''}</td>
                                <td>${project.status || ''}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                        const link = section.querySelector('.view-more');
                        if (link) {
                            link.style.display = '';
                        }
                    } else {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td colspan="4" style="text-align:center; padding: 1rem; color:#6b7280;">No qualifiers for this goal.</td>`;
                        tbody.appendChild(tr);
                        const link = section.querySelector('.view-more');
                        if (link) link.style.display = '';
                    }
                } catch (e) {
                    const tbody = section.querySelector('.goal-tbody');
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 1rem; color:#dc2626;">Error loading qualifiers</td></tr>`;
                    const link = section.querySelector('.view-more');
                    if (link) link.style.display = '';
                }
            }
        }

        // Make functions globally accessible
        window.deleteGoal = deleteGoal;
        window.editGoal = editGoal;
        window.toggleGoalMenu = toggleGoalMenu;
    </script>
</body>
</html>

{% endblock %}