{% extends "base_internal.html" %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pool of Experts</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'internal/experts/styles.css' %}" rel="stylesheet">
</head> 
<body>
	<div class="main-container">

		<!-- Search + Form Controls -->

        <!-- Search Bar & Filter (3x2 Grid) -->
        <div class="search-container" style="box-shadow: none;">
            <form class="search-bar" style="box-shadow: 0 0 15px rgba(0, 0, 0, 0.08);" method="get" action="">
                <svg width="16" height="16" style="margin-right:10px;"> <use href="#icon-search"></use> </svg>
				<input type="text" name="search" placeholder="Search" value="{{ search_query|default:'' }}"/>
                <button type="button" id="filterBtn" style="background:none;border:none;padding:0;margin-right:5px;cursor:pointer;">
                    <svg width="16" height="16"> <use href="#icon-filter"></use> </svg>
                </button>
                <div id="filterDropdown" class="filter-dropdown" style="top:55px; right:120px;">
                    <div class="filter-grid" style="grid-template-columns: repeat(2, 1fr);">
                        <!-- Sort By -->
                        <label>Sort By
                            <select name="sort_by">
                                <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name</option>
                                <option value="projects" {% if sort_by == 'projects' %}selected{% endif %}>No. of Projects</option>
                                <option value="campus" {% if sort_by == 'campus' %}selected{% endif %}>Campus</option>
                                <option value="college" {% if sort_by == 'college' %}selected{% endif %}>College</option>
                            </select>
                        </label>
                        <!-- Order By -->
                        <label>Order
                            <select name="order">
                                <option value="asc" {% if order == 'asc' %}selected{% endif %}>Ascending</option>
                                <option value="desc" {% if order == 'desc' %}selected{% endif %}>Descending</option>
                            </select>
                        </label>
                        <!-- Campus Filter -->
                        <label>Campus
                            <select name="campus">
                                <option value="">All Campuses</option>
                                {% for campus in campuses %}
                                <option value="{{ campus.id }}" {% if campus_filter == campus.id|stringformat:"s" %}selected{% endif %}>{{ campus.name }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <!-- College Filter -->
                        <label>College
                            <select name="college">
                                <option value="">All Colleges</option>
                                {% for college in colleges %}
                                <option value="{{ college.id }}" {% if college_filter == college.id|stringformat:"s" %}selected{% endif %}>{{ college.name }}</option>
                                {% endfor %}
                            </select>
                        </label>
                    </div>
                    <div class="filter-actions">
                        <button type="submit" class="filter-apply">Apply</button>
                        <button type="button" id="closeFilter" class="filter-close">Clear Filters</button>
                    </div>
                </div>
            </form>

			<div class="view-buttons">
				<svg class="view-btn active" id="gridViewBtn" width="28" height="28"><use id="gridIconUse" href="#icon-grid-active"></use></svg>
				<svg class="view-btn" id="listViewBtn" width="28" height="28"><use id="listIconUse" href="#icon-list"></use></svg>
			</div>
		</div> 
		 
		<div class="container-a">
			<div class="project-text">Pool of Experts</div>
			<div>
				<button class="generate-btn" id="openModalBtn">Generate Team</button>
			</div>
		</div>

		<!-- Expert Grid -->
		<div class="expert-container visible" id="expertGrid">
		{% for expert in experts %}
		<a href="{% url 'expert_profile' expert.id %}" class="expert-card" style="text-decoration:none; color:inherit;">

			{% if expert.campus %}
			<div class="campus-tag">{{ expert.get_campus_display|default:"" }}</div>
			{% else %}
			<div class="campus-tag" style="display:none;"></div>
			{% endif %}

			{% if expert.college and expert.college.logo %}
			<img src="{{ expert.college.logo.url }}" class="college-logo" alt="{{ expert.college.name }}">
			{% else %}
			<div class="college-logo" style="background:none;"></div>
			{% endif %}

		<img src="{{ expert.profile_picture_or_initial }}" class="profile-icon" alt="{{ expert.get_full_name }}">
		<div class="expert-name">{{ expert.last_name }}, {{ expert.given_name }}{% if expert.middle_initial %} {{ expert.middle_initial }}.{% endif %}{% if expert.suffix %} {{ expert.suffix }}{% endif %}</div>
		<div class="expert-degree">{{ expert.degree|default:"No Degree Listed" }}</div>
		<div class="expert-projects">Projects: {{ expert.total_completed }}</div>
	</a>
	{% empty %}
	<div style="grid-column: 1 / -1; text-align:center; padding:40px; color:#666;">No experts found.</div>
	{% endfor %}
	</div>		<!-- Pagination for Grid View -->
		<div class="pagination-container" id="gridPagination">
			{% if page_obj.has_previous %}
				<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page=1">First</a>
				<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
			{% else %}
				<button class="pagination-button" disabled>First</button>
				<button class="pagination-button" disabled>Previous</button>
			{% endif %}

			{% for num in page_range %}
				{% if num == page_obj.number %}
					<button class="pagination-button current" disabled>{{ num }}</button>
				{% else %}
					<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ num }}">{{ num }}</a>
				{% endif %}
			{% endfor %}

			{% if page_obj.has_next %}
				<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
				<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ paginator.num_pages }}">Last</a>
			{% else %}
				<button class="pagination-button" disabled>Next</button>
				<button class="pagination-button" disabled>Last</button>
			{% endif %}
		</div>

		<!-- Expert List (toggle alternative) -->
		<table class="user-table" id="expertList">
			<thead>
				<tr>
					<th>Name</th>
					<th>Campus</th>
					<th>College</th>
					<th>No. of Projects</th>
				</tr>
			</thead>
			<tbody>
				{% for expert in experts %}
				<tr>
					<td><a href="{% url 'expert_profile' expert.id %}" class="name-link">{{ expert.get_full_name }}</a></td>
					<td>{{ expert.get_campus_display|default:"-" }}</td>
					<td>{{ expert.college.name|default:"-" }}</td>
					<td>{{ expert.total_completed }}</td>
				</tr>
				{% empty %}
				<tr>
				<td colspan="4" style="text-align:center; color:#666;">No experts found.</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>		
	
		<!-- Pagination for List View -->
		<div class="pagination-container" id="listPagination">
			{% if page_obj.has_previous %}
				<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page=1">First</a>
				<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
			{% else %}
				<button class="pagination-button" disabled>First</button>
				<button class="pagination-button" disabled>Previous</button>
			{% endif %}

			{% for num in page_range %}
				{% if num == page_obj.number %}
					<button class="pagination-button active" disabled>{{ num }}</button>
				{% else %}
					<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ num }}">{{ num }}</a>
				{% endif %}
			{% endfor %}

			{% if page_obj.has_next %}
				<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
				<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ paginator.num_pages }}">Last</a>
			{% else %}
				<button class="pagination-button" disabled>Next</button>
				<button class="pagination-button" disabled>Last</button>
			{% endif %}
		</div>

		<!-- Pagination -->
		<div class="pagination hidden">
			<button>1</button>
			<button>2</button>
			<button>3</button>
		</div>

	</div>

	<!-- Modal Overlay -->
	<div class="modal-overlay" id="modalOverlay"></div>

	<!-- Modal -->
	<div class="modal-container" id="generateModal">
		<div class="modal-header">
			<div class="modal-title">AI Team Generator</div>
			<button class="modal-close" id="closeModalBtn">&times;</button>
		</div>

		<!-- Form View -->
		<div class="form-view" id="formView">
			<form id="generateTeamForm">
				{% csrf_token %}
				<div class="form-group">
					<label for="keywords">Keywords <span class="required">*</span></label>
					<input type="text" id="keywords" name="keywords" placeholder="e.g., marine life, agriculture, education" required>
				</div>

				<div class="form-group" style="display: flex; gap: 16px; align-items: flex-end;">
					<div style="flex:1;">
						<label for="campus">Campus (Optional)</label>
						<select id="campus" name="campus">
							<option value="">All Campuses</option>
							{% for campus in campuses %}
								<option value="{{ campus.id }}">{{ campus.name }}</option>
							{% endfor %}
						</select>
					</div>
					<div style="flex:1;">
						<label for="college">College (Optional)</label>
						<select id="college" name="college">
							<option value="">All Colleges</option>
							{% for college in colleges %}
								<option value="{{ college.id }}">{{ college.name }}</option>
							{% endfor %}
						</select>
					</div>
				</div>

				<div class="form-group">
					<label for="num_participants">Number of Participants <span class="required">*</span></label>
					<input type="number" id="num_participants" name="num_participants" min="1" max="20" value="5" required>
				</div>

				<button type="submit" class="generate-team-btn" id="submitBtn">Generate Team</button>
			</form>

			<div class="loading-spinner" id="loadingSpinner">
				<div class="spinner-icon"></div>
				Generating team recommendations...
			</div>

			<div class="error-message" id="errorMessage"></div>
		</div>

		<!-- Results View -->
		<div class="results-view" id="resultsView">
			<button class="back-btn" id="backToFormBtn">
				<i class="fa-solid fa-arrow-left"></i> Back to Search
			</button>

			{% if can_create_projects %}
			<button class="create-project-btn" id="createProjectBtn">
				Create Project with Selected Team
			</button>
			{% endif %}

			<div class="results-header" id="resultsHeader">
				Found <strong id="resultsCount">0</strong> team members for "<strong id="searchKeyword"></strong>"
			</div>

			<div class="results-content">
				<div class="team-members-list" id="teamMembersList"></div>
				
				<div class="details-panel-placeholder" id="detailsPlaceholder">
					<i class="fa-solid fa-arrow-left"></i> Select a team member to view details
				</div>
				
				<div class="details-panel" id="detailsPanel"></div>
			</div>
		</div>
	</div>

<!-- SVG Sprite Section -->

<svg style="display:none;">

	<!-- Search -->
	<symbol id="icon-search" viewBox="0 0 21 21" fill="none">
		<path d="M8.89152 15.9057C9.75056 15.9057 10.6012 15.7365 11.3948 15.4077C12.1885 15.079 12.9096 14.5972 13.5171 13.9897C14.1245 13.3823 14.6064 12.6612 14.9351 11.8675C15.2638 11.0739 15.433 10.2232 15.433 9.36417C15.433 8.50513 15.2638 7.6545 14.9351 6.86084C14.6064 6.06719 14.1245 5.34606 13.5171 4.73862C12.9096 4.13119 12.1885 3.64934 11.3948 3.3206C10.6012 2.99186 9.75056 2.82266 8.89152 2.82266C7.1566 2.82266 5.49274 3.51185 4.26597 4.73862C3.03919 5.9654 2.35 7.62926 2.35 9.36417C2.35 11.0991 3.03919 12.763 4.26597 13.9897C5.49274 15.2165 7.1566 15.9057 8.89152 15.9057V15.9057ZM15.7819 14.713L19.685 18.6161C19.7891 18.7167 19.872 18.8371 19.9291 18.9701C19.9861 19.1032 20.0161 19.2463 20.0173 19.391C20.0184 19.5358 19.9907 19.6793 19.9358 19.8133C19.8809 19.9472 19.7999 20.0689 19.6974 20.1712C19.595 20.2735 19.4732 20.3544 19.3392 20.4091C19.2052 20.4638 19.0616 20.4913 18.9168 20.4899C18.772 20.4886 18.629 20.4584 18.496 20.4012C18.3631 20.3439 18.2428 20.2608 18.1423 20.1566L14.2392 16.2535C12.4866 17.614 10.2814 18.2554 8.07247 18.0472C5.86357 17.839 3.81705 16.7968 2.34951 15.1328C0.881971 13.4688 0.103735 11.308 0.173229 9.09044C0.242723 6.87284 1.15472 4.76508 2.72357 3.19623C4.29242 1.62738 6.40018 0.715379 8.61778 0.645885C10.8354 0.576391 12.9961 1.35463 14.6601 2.82217C16.3241 4.28971 17.3663 6.33623 17.5745 8.54513C17.7827 10.754 17.1413 12.9592 15.7808 14.7119L15.7819 14.713Z" fill="#5A5252"/>
	</symbol>

	<!-- Filter -->
	<symbol id="icon-filter" viewBox="0 0 23 22" fill="none">
		<path opacity="0.9" d="M21.5399 1.92871H1.37988L9.44388 11.4644V18.0567L13.4759 20.0727V11.4644L21.5399 1.92871Z" stroke="#1E1E1E" stroke-width="2.016" stroke-linecap="round" stroke-linejoin="round"/>
	</symbol>

	<!-- List -->
	<symbol id="icon-list" viewBox="0 0 34 24" fill="none">
		<path d="M10.3712 2.05664H31.9153M10.3712 12H31.9153M10.3712 21.9436H31.9153M2.08496 2.05664H2.10153M2.08496 12H2.10153M2.08496 21.9436H2.10153" stroke="black" stroke-width="3.31448" stroke-linecap="round" stroke-linejoin="round"/>
	</symbol>

	<!-- List (Active) -->
	<symbol id="icon-list-active" viewBox="0 0 34 24" fill="none">
		<path d="M10.3712 2.05664H31.9153M10.3712 12H31.9153M10.3712 21.9436H31.9153M2.08496 2.05664H2.10153M2.08496 12H2.10153M2.08496 21.9436H2.10153" stroke="white" stroke-width="3.31448" stroke-linecap="round" stroke-linejoin="round"/>
	</symbol>

	<!-- Grid -->
	<symbol id="icon-grid" viewBox="0 0 32 32" fill="none">
		<path d="M12.9331 2.19922H2.19971V12.9326H12.9331V2.19922Z" stroke="black" stroke-width="3.04932" stroke-linecap="round" stroke-linejoin="round"/>
		<path d="M29.8 2.19932H19.0666V12.9327H29.8V2.19932Z" stroke="black" stroke-width="3.04932" stroke-linecap="round" stroke-linejoin="round"/>
		<path d="M29.7998 19.0664H19.0664V29.7998H29.7998V19.0664Z" stroke="black" stroke-width="3.04932" stroke-linecap="round" stroke-linejoin="round"/>
		<path d="M12.9331 19.0664H2.19971V29.7998H12.9331V19.0664Z" stroke="black" stroke-width="3.04932" stroke-linecap="round" stroke-linejoin="round"/>
	</symbol>

	<!-- Grid (Active) -->
	<symbol id="icon-grid-active" viewBox="0 0 32 32" fill="none">
		<path d="M12.9331 2.19922H2.19971V12.9326H12.9331V2.19922Z" stroke="white" stroke-width="3.04932" stroke-linecap="round" stroke-linejoin="round"/>
		<path d="M29.8 2.19932H19.0666V12.9327H29.8V2.19932Z" stroke="white" stroke-width="3.04932" stroke-linecap="round" stroke-linejoin="round"/>
		<path d="M29.7998 19.0664H19.0664V29.7998H29.7998V19.0664Z" stroke="white" stroke-width="3.04932" stroke-linecap="round" stroke-linejoin="round"/>
		<path d="M12.9331 19.0664H2.19971V29.7998H12.9331V19.0664Z" stroke="white" stroke-width="3.04932" stroke-linecap="round" stroke-linejoin="round"/>
	</symbol>

	<!-- Settings (3 dots) -->
	<symbol id="icon-settings" viewBox="0 0 16 4" fill="none" xmlns="http://www.w3.org/2000/svg">
		<path d="M2 4C1.45 4 0.979167 3.80417 0.5875 3.4125C0.195833 3.02083 0 2.55 0 2C0 1.45 0.195833 0.979167 0.5875 0.5875C0.979167 0.195833 1.45 0 2 0C2.55 0 3.02083 0.195833 3.4125 0.5875C3.80417 0.979167 4 1.45 4 2C4 2.55 3.80417 3.02083 3.4125 3.4125C3.02083 3.80417 2.55 4 2 4ZM8 4C7.45 4 6.97917 3.80417 6.5875 3.4125C6.19583 3.02083 6 2.55 6 2C6 1.45 6.19583 0.979167 6.5875 0.5875C6.97917 0.195833 7.45 0 8 0C8.55 0 9.02083 0.195833 9.4125 0.5875C9.80417 0.979167 10 1.45 10 2C10 2.55 9.80417 3.02083 9.4125 3.4125C9.02083 3.80417 8.55 4 8 4ZM14 4C13.45 4 12.9792 3.80417 12.5875 3.4125C12.1958 3.02083 12 2.55 12 2C12 1.45 12.1958 0.979167 12.5875 0.5875C12.9792 0.195833 13.45 0 14 0C14.55 0 15.0208 0.195833 15.4125 0.5875C15.8042 0.979167 16 1.45 16 2C16 2.55 15.8042 3.02083 15.4125 3.4125C15.0208 3.80417 14.55 4 14 4Z" fill="#1D1B20"/>
	</symbol>

	<!-- Settings -->
	 
</svg>

<script>

    // Filter dropdown logic
    const filterBtn = document.getElementById('filterBtn');
    const filterDropdown = document.getElementById('filterDropdown');
    const closeFilter = document.getElementById('closeFilter');
    const searchForm = document.querySelector('.search-bar');
    
    if (filterBtn && filterDropdown) {
        filterBtn.addEventListener('click', function(e) {
            e.preventDefault();
            filterDropdown.style.display = 'block';
        });
    }
    
    if (closeFilter && filterDropdown) {
        closeFilter.addEventListener('click', function(e) {
            e.preventDefault();
            // Clear filters by redirecting to base URL without query parameters
            window.location.href = window.location.pathname;
        });
    }
    
    // Prevent form submission when dropdowns change (only submit via Apply button)
    if (filterDropdown && searchForm) {
        const filterSelects = filterDropdown.querySelectorAll('select');
        filterSelects.forEach(function(select) {
            select.addEventListener('change', function(e) {
                e.stopPropagation(); // Prevent any parent handlers
            });
        });
        
        // Prevent Enter key from submitting form in dropdowns
        filterDropdown.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.tagName === 'SELECT') {
                e.preventDefault();
            }
        });
    }
    
    // Hide dropdown when clicking outside
    document.addEventListener('mousedown', function(e) {
        if (filterDropdown && !filterDropdown.contains(e.target) && e.target !== filterBtn) {
            filterDropdown.style.display = 'none';
        }
    });

    // View toggle functionality for experts
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    const expertGrid = document.getElementById('expertGrid');
    const expertList = document.getElementById('expertList');
    const gridPagination = document.getElementById('gridPagination');
    const listPagination = document.getElementById('listPagination');

    // Function to update URL with view parameter
    function updateViewParam(viewType) {
        const url = new URL(window.location);
        url.searchParams.set('view', viewType);
        window.history.replaceState({}, '', url);
    }
    
    // Update icons based on current view
    const gridIconUse = document.getElementById('gridIconUse');
    const listIconUse = document.getElementById('listIconUse');
    
    function updateIcons(viewType) {
        if (viewType === 'grid') {
            gridIconUse.setAttribute('href', '#icon-grid-active');
            listIconUse.setAttribute('href', '#icon-list');
        } else {
            gridIconUse.setAttribute('href', '#icon-grid');
            listIconUse.setAttribute('href', '#icon-list-active');
        }
    }


	function reloadWithView(viewType) {
		const url = new URL(window.location);
		url.searchParams.set('view', viewType);
		window.location.href = url;
	}

	gridViewBtn.addEventListener('click', function() {
		reloadWithView('grid');
	});

	listViewBtn.addEventListener('click', function() {
		reloadWithView('list');
	});

    // Set view on page load based on URL parameter
    document.addEventListener('DOMContentLoaded', function() {
		const currentView = '{{ view|default:"grid" }}';
		// Always hide both views and paginations first
		expertGrid.classList.add('hidden');
		expertList.classList.add('hidden');
		expertGrid.style.display = 'none';
		expertList.style.display = 'none';

		if (currentView === 'list') {
			listViewBtn.classList.add('active');
			gridViewBtn.classList.remove('active');

			expertList.classList.remove('hidden');
			expertList.style.display = '';

			expertGrid.classList.add('hidden');
			expertGrid.classList.remove('visible');
			expertGrid.style.display = 'none';
			
			if (listPagination) {
				listPagination.classList.remove('hidden');
			}
			if (gridPagination) {
				gridPagination.classList.add('hidden');
			}
		} else {
			gridViewBtn.classList.add('active');
			listViewBtn.classList.remove('active');
			
			expertGrid.classList.remove('hidden');
			expertGrid.style.display = 'block';
			
			expertList.classList.add('hidden');
			expertList.classList.remove('visible');
			expertList.style.display = 'none';
			
			if (gridPagination) {
				gridPagination.classList.remove('hidden');
			}
			if (listPagination) {
				listPagination.classList.add('hidden');
			}
		}
		// Update icons
		updateIcons(currentView);
	});

	// Modal functionality
	const openModalBtn = document.getElementById('openModalBtn');
	const closeModalBtn = document.getElementById('closeModalBtn');
	const modalOverlay = document.getElementById('modalOverlay');
	const generateModal = document.getElementById('generateModal');
	const generateTeamForm = document.getElementById('generateTeamForm');
	const loadingSpinner = document.getElementById('loadingSpinner');
	const errorMessage = document.getElementById('errorMessage');
	const submitBtn = document.getElementById('submitBtn');
	
	// Views
	const formView = document.getElementById('formView');
	const resultsView = document.getElementById('resultsView');
	const backToFormBtn = document.getElementById('backToFormBtn');
	const teamMembersList = document.getElementById('teamMembersList');
	const detailsPanel = document.getElementById('detailsPanel');
	const detailsPlaceholder = document.getElementById('detailsPlaceholder');
	const resultsCount = document.getElementById('resultsCount');
	const searchKeyword = document.getElementById('searchKeyword');

	let currentTeamMembers = [];

	// Open modal
	openModalBtn.addEventListener('click', function() {
		modalOverlay.classList.add('show');
		generateModal.classList.add('show');
		// Reset to form view
		showFormView();
		generateTeamForm.reset();
		errorMessage.classList.remove('show');
	});

	// Close modal
	function closeModal() {
		modalOverlay.classList.remove('show');
		generateModal.classList.remove('show');
	}

	closeModalBtn.addEventListener('click', closeModal);
	modalOverlay.addEventListener('click', closeModal);

	// Back to form
	backToFormBtn.addEventListener('click', function() {
		showFormView();
	});

	function showFormView() {
		formView.classList.remove('hidden');
		resultsView.classList.remove('show');
		loadingSpinner.classList.remove('show');
		
		// NEW: Set modal to narrow width (40%)
		generateModal.classList.remove('wide'); 
		
		// Reset selections
		selectedMembers = [];
		updateCreateButton();
	}

	// Show results view
	function showResultsView() {
		formView.classList.add('hidden');
		resultsView.classList.add('show');
		
		// NEW: Set modal to wide width (80%)
		generateModal.classList.add('wide'); 
	}

	// Form submission
	generateTeamForm.addEventListener('submit', async function(e) {
		e.preventDefault();

		// Get form data
		const keywords = document.getElementById('keywords').value;
		const formData = {
			keywords: keywords,
			campus: document.getElementById('campus').value,
			college: document.getElementById('college').value,
			num_participants: document.getElementById('num_participants').value
		};

		// Show loading
		loadingSpinner.classList.add('show');
		errorMessage.classList.remove('show');
		submitBtn.disabled = true;

		try {
			// Get CSRF token
			const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
							  getCookie('csrftoken');

			const response = await fetch('{% url "generate_team" %}', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': csrfToken
				},
				body: JSON.stringify(formData)
			});

			const data = await response.json();

			if (data.success) {
				// Update search keyword
				searchKeyword.textContent = keywords;
				resultsCount.textContent = data.team_members.length;
				
				// Display results
				displayResults(data.team_members);
				showResultsView();
			} else {
				// Show error
				errorMessage.textContent = data.error || 'An error occurred';
				errorMessage.classList.add('show');
			}
		} catch (error) {
			console.error('Error:', error);
			errorMessage.textContent = 'Failed to generate team. Please try again.';
			errorMessage.classList.add('show');
		} finally {
			loadingSpinner.classList.remove('show');
			submitBtn.disabled = false;
		}
	});

	// Track selected team members
	let selectedMembers = [];
	const createProjectBtn = document.getElementById('createProjectBtn');
	const canCreateProjects = {% if can_create_projects %}true{% else %}false{% endif %};

	// Display results with side panel layout
	function displayResults(teamMembers) {
		currentTeamMembers = teamMembers;
		selectedMembers = [];
		teamMembersList.innerHTML = '';
		detailsPanel.classList.remove('show');
		detailsPlaceholder.style.display = 'flex';
		updateCreateButton();
		
		if (teamMembers.length === 0) {
			teamMembersList.innerHTML = '<div class="no-results">No experts found matching your criteria.</div>';
			return;
		}

		teamMembers.forEach((member, index) => {
			// Get initials for avatar
			const initials = member.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
			
			const memberItem = document.createElement('div');
			memberItem.className = 'member-item';
			memberItem.dataset.memberId = member.id;
			
			// Only show checkbox if user can create projects
			const checkboxHTML = canCreateProjects 
				? `<input type="checkbox" class="member-checkbox" data-user-id="${member.id}">`
				: '';
			
			memberItem.innerHTML = `
				${checkboxHTML}
				<div class="member-avatar">
					${member.profile_picture ? `<img src="${member.profile_picture}" alt="${member.name}">` : initials}
				</div>
				<div class="member-info">
					<div class="member-name">${member.name}</div>

				</div>
				<span class="leader-badge">ðŸ‘‘ Leader</span>
			`;

			// THIS IS COMMENTED OUT FOR NOW - CAN BE ADDED BACK LATER IF DETAILED SCORES ARE NEEDED
					// <div class="member-score">Match: ${(member.final_score * 100).toFixed(1)}%</div>
			
			// Checkbox click handler (only if checkbox exists)
			if (canCreateProjects) {
				const checkbox = memberItem.querySelector('.member-checkbox');
				checkbox.addEventListener('click', (e) => {
					e.stopPropagation();
					handleMemberSelection(member.id, checkbox.checked);
				});
			}
			
			// Member item click handler (for details)
			memberItem.addEventListener('click', (e) => {
				if (!e.target.classList.contains('member-checkbox')) {
					showMemberDetails(member, memberItem);
				}
			});
			
			teamMembersList.appendChild(memberItem);
		});
	}

	// Handle member selection
	function handleMemberSelection(userId, isChecked) {
		if (isChecked) {
			// Add to selected members
			selectedMembers.push(userId);
		} else {
			// Remove from selected members
			const index = selectedMembers.indexOf(userId);
			if (index > -1) {
				selectedMembers.splice(index, 1);
			}
		}
		
		// Update UI
		updateMemberStyles();
		updateCreateButton();
	}

	// Update member item styles based on selection
	function updateMemberStyles() {
		document.querySelectorAll('.member-item').forEach(item => {
			const userId = parseInt(item.dataset.memberId);
			const checkbox = item.querySelector('.member-checkbox');
			
			item.classList.remove('selected', 'leader');
			
			if (selectedMembers.includes(userId)) {
				item.classList.add('selected');
				
				// First selected member is the leader
				if (selectedMembers[0] === userId) {
					item.classList.add('leader');
				}
			}
		});
	}

	// Update create project button visibility
	function updateCreateButton() {
		if (!createProjectBtn) return; // Button doesn't exist for non-privileged users
		
		if (selectedMembers.length > 0) {
			createProjectBtn.classList.add('show');
		} else {
			createProjectBtn.classList.remove('show');
		}
	}

	// Create project button click handler (only if button exists)
	if (createProjectBtn) {
		createProjectBtn.addEventListener('click', () => {
			if (selectedMembers.length === 0) return;
			
			const leader = selectedMembers[0];
			const providers = selectedMembers.slice(1);
			
			// Store team data in localStorage
			const teamData = {
				leader: leader,
				providers: providers,
				timestamp: Date.now()
			};
			localStorage.setItem('aiTeamSelection', JSON.stringify(teamData));
			
			// Redirect to add project page
			window.location.href = '{% url "add_project" %}';
		});
	}

	// Show member details in side panel
	function showMemberDetails(member, memberItem) {
		// Update active state
		document.querySelectorAll('.member-item').forEach(item => {
			item.classList.remove('active');
		});
		if (memberItem) {
			memberItem.classList.add('active');
		}
		
		// Hide placeholder, show panel
		detailsPlaceholder.style.display = 'none';
		detailsPanel.classList.add('show');
		
		// Get initials for avatar
		const initials = member.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
		
		// Calculate weighted scores (capped at 0 minimum for display)
		const semanticWeighted = Math.max(0, member.semantic_score * 0.70);
		const ratingWeighted = Math.max(0, member.normalized_rating * 0.15);
		const availabilityWeighted = Math.max(0, member.availability_score * 0.15);
		
		// Calculate bar widths (0-100%, but never below 0)
		const semanticBarWidth = Math.max(0, Math.min(100, member.semantic_score * 100));
		const ratingBarWidth = Math.max(0, Math.min(100, member.normalized_rating * 100));
		const availabilityBarWidth = Math.max(0, Math.min(100, member.availability_score * 100));
		const finalBarWidth = Math.max(0, Math.min(100, member.final_score * 100));
		
		detailsPanel.innerHTML = `
			<div class="panel-header">
				<div class="panel-name">${member.name}</div>

			</div>
			
			<div class="details-grid">
				<div style="display: flex;">
					<div class="detail-item" style="flex:1;">
						<span class="detail-label">Campus</span>
						<span class="detail-value">${member.campus || 'N/A'}</span>
					</div>
					<div class="detail-item" style="flex:1;">
						<span class="detail-label">College</span>
						<span class="detail-value">${member.college || 'N/A'}</span>
					</div>
				</div>

				<div class="detail-item">
					<span class="detail-label">Degree</span>
					<span class="detail-value">${member.degree || 'N/A'}</span>
				</div>
				<div class="detail-item">
					<span class="detail-label">Expertise</span>
					<span class="detail-value">${member.expertise || 'N/A'}</span>
				</div>
				<div style="display: flex;">
					<div class="detail-item" style="flex:1;">
						<span class="detail-label">Total Projects</span>
						<span class="detail-value">${member.total_projects}</span>
					</div>
					<div class="detail-item" style="flex:1;">
						<span class="detail-label">Ongoing Projects</span>
						<span class="detail-value">${member.ongoing_projects}</span>
					</div>
				</div>
				<div class="detail-item">
					<span class="detail-label">Average Evaluation Score</span>
					<span class="detail-value">${member.avg_rating % 1 === 0 ? member.avg_rating.toFixed(0) : member.avg_rating.toFixed(1)}/5</span>
				</div>
			</div>
		
		`;
	}

	// THIS IS IN COMMENTED OUT FOR NOW - CAN BE ADDED BACK LATER IF DETAILED SCORES ARE NEEDED

				// <div class="panel-score">Final Score: ${member.final_score.toFixed(3)}</div>



			// <div class="scores-section">
			// 	<div class="scores-title">Scoring Breakdown</div>
				
			// 	<div class="score-item">
			// 		<div class="score-header">
			// 			<span class="score-label">Semantic Match (70%)</span>
			// 			<div class="score-values">
			// 				<span class="score-raw">${member.semantic_score.toFixed(3)}</span> <i class="fa-solid fa-arrow-right"></i>
							 
			// 				<span class="score-weighted">${semanticWeighted.toFixed(3)}</span>
			// 			</div>
			// 		</div>
			// 		<div class="score-bar-bg">
			// 			<div class="score-bar-fill score-bar-semantic" style="width: ${semanticBarWidth}%"></div>
			// 		</div>
			// 	</div>
				
			// 	<div class="score-item">
			// 		<div class="score-header">
			// 			<span class="score-label">Rating Score (15%)</span>
			// 			<div class="score-values">
			// 				<span class="score-raw">${member.normalized_rating.toFixed(3)}</span> <i class="fa-solid fa-arrow-right"></i>
			// 				<span class="score-weighted">${ratingWeighted.toFixed(3)}</span>
			// 			</div>
			// 		</div>
			// 		<div class="score-bar-bg">
			// 			<div class="score-bar-fill score-bar-rating" style="width: ${ratingBarWidth}%"></div>
			// 		</div>
			// 	</div>
				
			// 	<div class="score-item">
			// 		<div class="score-header">
			// 			<span class="score-label">Availability (15%)</span>
			// 			<div class="score-values">
			// 				<span class="score-raw">${member.availability_score.toFixed(3)}</span> <i class="fa-solid fa-arrow-right"></i>
			// 				<span class="score-weighted">${availabilityWeighted.toFixed(3)}</span>
			// 			</div>
			// 		</div>
			// 		<div class="score-bar-bg">
			// 			<div class="score-bar-fill score-bar-availability" style="width: ${availabilityBarWidth}%"></div>
			// 		</div>
			// 	</div>
				
			// 	<div class="score-item final-score-item">
			// 		<div class="score-header">
			// 			<span class="score-label"><strong>Final Score</strong></span>
			// 			<div class="score-values">
			// 				<span class="score-weighted" style="font-size: 16px;">${member.final_score.toFixed(3)}</span>
			// 			</div>
			// 		</div>
			// 		<div class="score-bar-bg">
			// 			<div class="score-bar-fill score-bar-final" style="width: ${finalBarWidth}%"></div>
			// 		</div>
			// 	</div>
			// </div>

	// Get CSRF token from cookie
	function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}
</script>

{% endblock %}