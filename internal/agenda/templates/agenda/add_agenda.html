{% extends "base_internal.html" %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Add Agenda</title>

<link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/styles.css' %}" rel="stylesheet">
</head>
<body>
    <div class="main-container">
        <div class="user-details-title">
            <h2>Add Agenda</h2> 
            <p>Input all fields correctly and create a new agenda.</p>
        </div>
        
        {% if success %}
            <div class="success-message">Agenda added successfully!</div>
        {% endif %}

        <form class="agenda-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
             
            <div class="user-details-section"> 
                <div class="user-details-category">  
                    <i class="fa-regular fa-address-card subtitle-icon"></i>
                    Details
                </div>
                <div class="form-group">
                    <label class="user-details-label" for="id_name">Name: <span class="required">*</span></label>
                    <input class="user-details-value" type="text" name="name" id="id_name" value="{{ form.name.value|default:'' }}">
                </div>

                <div class="form-group">
                    <label class="user-details-label" for="id_description">Description: <span class="required">*</span></label>
                    <textarea class="form-input user-details-value" maxlength="400" name="description" id="id_description">{{ form.description.value|default:'' }}</textarea>
                </div>

                <div class="form-group">
                    <label class="user-details-label">Concerned Colleges: <span class="required">*</span></label>
                    <div id="tag-row" class="tag-row" style="background: white;">
                    </div>
                    <select id="options-template" style="display:none;">
                        {% for college in form.fields.concerned_colleges.queryset %}
                            <option value="{{ college.id }}">{{ college.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
 
            <div class="form-actions">
                <a href="{% url 'agenda' %}" class=" back btn">Back</a>
                <button type="submit" class="save btn">Add Agenda</button>
            </div>
        </form>
    </div>

<!-- SVG Sprite Section -->
<svg style="display:none;" xmlns="http://www.w3.org/2000/svg">
    <symbol id="icon-add" viewBox="0 0 16 16">
        <path d="M6.80039 14.4004C6.80039 14.7187 6.92682 15.0239 7.15186 15.2489C7.37691 15.474 7.68213 15.6004 8.00039 15.6004C8.31865 15.6004 8.62388 15.474 8.84892 15.2489C9.07396 15.0239 9.20039 14.7187 9.20039 14.4004V9.20039H14.4004C14.7187 9.20039 15.0239 9.07396 15.2489 8.84892C15.474 8.62388 15.6004 8.31865 15.6004 8.00039C15.6004 7.68213 15.474 7.37691 15.2489 7.15186C15.0239 6.92682 14.7187 6.80039 14.4004 6.80039H9.20039V1.60039C9.20039 1.28213 9.07396 0.976906 8.84892 0.751863C8.62388 0.526819 8.31865 0.400391 8.00039 0.400391C7.68213 0.400391 7.37691 0.526819 7.15186 0.751863C6.92682 0.976906 6.80039 1.28213 6.80039 1.60039V6.80039H1.60039C1.28213 6.80039 0.976906 6.92682 0.751863 7.15186C0.526819 7.37691 0.400391 7.68213 0.400391 8.00039C0.400391 8.31865 0.526819 8.62388 0.751863 8.84892C0.976906 9.07396 1.28213 9.20039 1.60039 9.20039H6.80039V14.4004Z" fill="black"/>
    </symbol>
</svg>

<script>
    // Form Validation for Required Fields (Agenda)
    document.querySelector('.agenda-form').addEventListener('submit', function(e) {
        let valid = true;
        const nameInput = document.getElementById('id_name');
        const descInput = document.getElementById('id_description');

        // Remove Previous Error States
        nameInput.classList.remove('error-input');
        descInput.classList.remove('error-input');
        let nameError = document.getElementById('name-error');
        let descError = document.getElementById('desc-error');
        let collegeError = document.getElementById('error');
        if (nameError) nameError.remove();
        if (descError) descError.remove();
        if (collegeError) collegeError.remove();

        if (!nameInput.value.trim()) {
            valid = false;
            nameInput.classList.add('error-input');
            const err = document.createElement('div');
            err.id = 'name-error';
            err.textContent = 'Name is required.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            err.style.marginTop = '0.25rem';
            nameInput.parentNode.appendChild(err);
        }
        if (!descInput.value.trim()) {
            valid = false;
            descInput.classList.add('error-input');
            const err = document.createElement('div');
            err.id = 'desc-error';
            err.textContent = 'Description is required.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            err.style.marginTop = '0.25rem';
            descInput.parentNode.appendChild(err);
        }

        // Validate At Least One College Selected
        const selectedColleges = Array.from(document.querySelectorAll('input[name="concerned_colleges"]')).map(i => i.value);
        if (selectedColleges.length === 0) {
            valid = false;
            const tagRow = document.getElementById('tag-row');
            const err = document.createElement('div');
            err.id = 'error';
            err.textContent = 'At least one college must be selected.';
            err.style.color = '#E53E3E';
            err.style.fontSize = '0.95rem';
            tagRow.appendChild(err);
        }

        if (!valid) {
            e.preventDefault();
        }
    });

    // Tag UI for Concerned Colleges
    const collegeTagRow = document.getElementById('tag-row');
    const collegeOptionsTemplate = document.getElementById('options-template');
    const collegeSelectDropdown = document.createElement('select');
    collegeSelectDropdown.id = 'select-dropdown';
    collegeSelectDropdown.style.display = 'none';
    collegeSelectDropdown.style.position = 'absolute';
    collegeSelectDropdown.style.top = '44px';
    collegeSelectDropdown.style.left = '0';
    collegeSelectDropdown.style.fontFamily = "Inter, Arial, sans-serif";
    collegeSelectDropdown.style.fontSize = "13px";
    collegeSelectDropdown.style.padding = "8px 16px";
    collegeSelectDropdown.style.borderRadius = "6px";
    collegeSelectDropdown.style.appearance = "none";
    collegeSelectDropdown.style.background = "white url('data:image/svg+xml;utf8,<svg fill=\"none\" height=\"16\" viewBox=\"0 0 16 16\" width=\"16\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M4 6L8 10L12 6\" stroke=\"%23374151\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>') no-repeat right 18px center/16px 16px";
    collegeSelectDropdown.style.paddingRight = "5px";

    Array.from(collegeOptionsTemplate.options).forEach(opt => {
        collegeSelectDropdown.appendChild(opt.cloneNode(true));
    });

    // Get Colleges From Select Options
    const colleges = Array.from(collegeSelectDropdown.options)
        .filter(opt => opt.value)
        .map(opt => ({id: opt.value, name: opt.text}));

    let selectedColleges = [];
    const collegesDataScript = document.getElementById('colleges-data');
    if (collegesDataScript) {
        selectedColleges = JSON.parse(collegesDataScript.textContent);
    }

    // Render Tags Function
    function renderTags() {
        collegeTagRow.innerHTML = '';
        selectedColleges.forEach(id => {
            const college = colleges.find(c => c.id === id);
            if (college) {
                const tag = document.createElement('span');
                tag.className = 'college-tag';
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-x';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = function() {
                    selectedColleges = selectedColleges.filter(cid => cid !== id);
                    renderTags();
                };
                tag.appendChild(removeBtn);
                tag.appendChild(document.createTextNode(college.name));
                collegeTagRow.appendChild(tag);
            }
        });

        const addCollegeBtn = document.createElement('button');
        addCollegeBtn.type = 'button';
        addCollegeBtn.id = 'add-btn';
        addCollegeBtn.className = 'add-college-btn';
        addCollegeBtn.style.marginLeft = '8px';
        addCollegeBtn.innerHTML = `<svg width="16" height="16"><use href="#icon-add" /></svg>`;
        addCollegeBtn.onclick = function(e) {
            const btnRect = addCollegeBtn.getBoundingClientRect();
            collegeSelectDropdown.style.display = 'block';
            collegeSelectDropdown.style.position = 'fixed';
            collegeSelectDropdown.style.left = (btnRect.left) + 'px';
            collegeSelectDropdown.style.top = (btnRect.bottom + 4) + 'px';
            collegeSelectDropdown.innerHTML = '';
            const templateOptions = Array.from(document.getElementById('options-template').options);
            templateOptions.forEach(opt => {
                if (!opt.value || !selectedColleges.includes(opt.value)) {
                    collegeSelectDropdown.appendChild(opt.cloneNode(true));
                }
            });

            collegeSelectDropdown.focus();
        };
        collegeTagRow.appendChild(addCollegeBtn);
        if (!document.body.contains(collegeSelectDropdown)) {
            document.body.appendChild(collegeSelectDropdown);
        }

        selectedColleges.forEach(cid => {
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'concerned_colleges';
            hidden.value = cid;
            collegeTagRow.appendChild(hidden);
        });
    }

    renderTags();

    collegeSelectDropdown.onchange = function() {
        const selectedId = collegeSelectDropdown.value;
        if (selectedId && !selectedColleges.includes(selectedId)) {
            selectedColleges.push(selectedId);
            renderTags();
        }
        collegeSelectDropdown.value = '';
        collegeSelectDropdown.style.display = 'none';
    };

    document.addEventListener('mousedown', function(e) {
        if (!collegeSelectDropdown.contains(e.target) && e.target.id !== 'add-btn') {
            collegeSelectDropdown.style.display = 'none';
        }
    });
</script>

</body>
</html>

{% endblock %}