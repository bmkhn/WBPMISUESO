{% extends "base_internal.html" %}
{% block content %}
{% load custom_tags %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agenda</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'internal/agenda/styles.css' %}" rel="stylesheet">
</head> 

<body> 
      
    <!-- Delete Confirmation Modal - PLACE THIS RIGHT BEFORE </body> -->
    <div id="deleteAgendaModal">
        <div class="modal-content">
            <div class="modal-title">Confirm Deletion</div>
            <div id="deleteAgendaModalMsg" class="modal-message"></div>
            <div class="modal-buttons">
                <button id="cancelDeleteAgendaBtn" class="modal-btn modal-btn-cancel">Cancel</button>
                <button id="confirmDeleteAgendaBtn" class="modal-btn modal-btn-delete">Delete</button>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <!-- Container for Page Title and Add Agenda Button -->
        <div class="container-a">
            <div class="project-text">Agenda</div>
            <a href="{% url 'add_agenda' %}"><button class="add-user-btn">  
                <i class="fa-solid fa-bars-progress"></i>
                Add Agenda  
            </button > 
            </a>
        </div>

        <!-- Agenda Cards -->
        <div class="agenda-carousel-wrapper">
            <button class="carousel-arrow left-arrow" type="button" onclick="scrollAgenda(-1)">
                <svg width="32" height="32" viewBox="0 0 32 32"><path d="M20 8l-8 8 8 8" stroke="#063A1C" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <div class="agenda-carousel">
                <div class="agenda-carousel-track">
                    {% for agenda in agendas %}
                    <div class="agenda-card">
                        <div class="agenda-card-kebab" onclick="toggleOptions(event, '{{ agenda.id }}')" title="More options">
                            <svg class="kebab-svg"><use href="#kebab-icon"/></svg>
                            <div class="options-dropdown" id="options-{{ agenda.id }}">
                                <a class="options-item edit-option" href="{% url 'edit_agenda' agenda.id %}">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    Edit
                                </a>
                                <a href="#" class="options-item delete-option delete-modal-link" data-delete-url="{% url 'delete_agenda' agenda.id %}" data-agenda-name="{{ agenda.name }}" style="color:#DC2626;">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <polyline points="3,6 5,6 21,6"></polyline>
                                        <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                    </svg>
                                    Delete
                                </a>
                            </div>
                        </div>
                        <div class="agenda-card-text" onclick="cardClick(event, '{{ agenda.id }}')" style="cursor:pointer;">{{ agenda.name }}</div>
                        <div class="agenda-card-desc" onclick="cardClick(event, '{{ agenda.id }}')" style="cursor:pointer;">
                            {{ agenda.description }}
                        </div>
                        <div style="margin-bottom: 10px;"></div>
                    </div>
                    {% empty %}
                    <style>.agenda-carousel { justify-content: center; align-items: center; }</style>
                    <div style="color: #888; font-size: 18px; padding: 40px;">No agendas found.</div>
                    {% endfor %}
                </div>
            </div>
            <button class="carousel-arrow right-arrow" type="button" onclick="scrollAgenda(1)">
                <svg width="32" height="32" viewBox="0 0 32 32"><path d="M12 8l8 8-8 8" stroke="#063A1C" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
        </div>

        <!-- Table View -->
        <div class="table-view-container">
        {% for agenda in agendas %}
            <div class="title-expand-container">
                <span class="table-title-text">{{ agenda.name }}</span>
                <a href="{% url 'project_dispatcher' %}?agenda={{ agenda.id }}" class="view-more">View More</a>
            </div>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Leader</th>
                        <th>College/Unit</th>
                        <th>Last Updated</th>
                        <th>Start Date</th>
                        <th>Progress</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in agenda_projects|get_item:agenda.id %}
                    <tr>
                        <td>
                            <a href="{% url 'project_profile' project.id %}" class="name-link" title="{{ project.title }}">
                                {{ project.title|truncatechars:20 }}
                            </a>
                        </td>
                        <td>{{ project.project_leader.get_full_name }}</td>
                        <td>{% if project.project_leader.college %}{{ project.project_leader.college.name }}{% else %}<em>-</em>{% endif %}</td>
                        <td>{{ project.updated_at|date:"Y-m-d" }}</td>
                        <td>{{ project.start_date|date:"Y-m-d" }}</td>
                        <td>{{ project.progress_display }}</td>
                        <td>{{ project.get_status_display }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" style="text-align:center;">No projects under this agenda.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endfor %}
        </div>

<!-- SVG Sprite Section -->
<svg style="display:none;">
    <!-- Settings -->
    <symbol id="settings-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M2 4C1.45 4 0.979167 3.80417 0.5875 3.4125C0.195833 3.02083 0 2.55 0 2C0 1.45 0.195833 0.979167 0.5875 0.5875C0.979167 0.195833 1.45 0 2 0C2.55 0 3.02083 0.195833 3.4125 0.5875C3.80417 0.979167 4 1.45 4 2C4 2.55 3.80417 3.02083 3.4125 3.4125C3.02083 3.80417 2.55 4 2 4ZM8 4C7.45 4 6.97917 3.80417 6.5875 3.4125C6.19583 3.02083 6 2.55 6 2C6 1.45 6.19583 0.979167 6.5875 0.5875C6.97917 0.195833 7.45 0 8 0C8.55 0 9.02083 0.195833 9.4125 0.5875C9.80417 0.979167 10 1.45 10 2C10 2.55 9.80417 3.02083 9.4125 3.4125C9.02083 3.80417 8.55 4 8 4ZM14 4C13.45 4 12.9792 3.80417 12.5875 3.4125C12.1958 3.02083 12 2.55 12 2C12 1.45 12.1958 0.979167 12.5875 0.5875C12.9792 0.195833 13.45 0 14 0C14.55 0 15.0208 0.195833 15.4125 0.5875C15.8042 0.979167 16 1.45 16 2C16 2.55 15.8042 3.02083 15.4125 3.4125C15.0208 3.80417 14.55 4 14 4Z" fill="#1D1B20"/>
    </symbol>
    <!-- Expand -->
    <symbol id="expand-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14.0661 5.36872V1M14.0661 1H9.98295M14.0661 1L9.16632 6.18043M5.08316 14.9799L1 15V10.6112M5.89979 9.73744L1 14.9799" stroke="black" stroke-width="0.972" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <!-- Kebab -->
    <symbol id="kebab-icon" viewBox="0 0 4 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M2 16C1.45 16 0.979167 15.8042 0.5875 15.4125C0.195833 15.0208 0 14.55 0 14C0 13.45 0.195833 12.9792 0.5875 12.5875C0.979167 12.1958 1.45 12 2 12C2.55 12 3.02083 12.1958 3.4125 12.5875C3.80417 12.9792 4 13.45 4 14C4 14.55 3.80417 15.0208 3.4125 15.4125C3.02083 15.8042 2.55 16 2 16ZM2 10C1.45 10 0.979167 9.80417 0.5875 9.4125C0.195833 9.02083 0 8.55 0 8C0 7.45 0.195833 6.97917 0.5875 6.5875C0.979167 6.19583 1.45 6 2 6C2.55 6 3.02083 6.19583 3.4125 6.5875C3.80417 6.97917 4 7.45 4 8C4 8.55 3.80417 9.02083 3.4125 9.4125C3.02083 9.80417 2.55 10 2 10ZM2 4C1.45 4 0.979167 3.80417 0.5875 3.4125C0.195833 3.02083 0 2.55 0 2C0 1.45 0.195833 0.979167 0.5875 0.5875C0.979167 0.195833 1.45 0 2 0C2.55 0 3.02083 0.195833 3.4125 0.5875C3.80417 0.979167 4 1.45 4 2C4 2.55 3.80417 3.02083 3.4125 3.4125C3.02083 3.80417 2.55 4 2 4Z" fill="#1D1B20"/>
    </symbol>
</svg>

<script>
    // CSRF Token (Helper remains in global scope)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Options Dropdown (Global Scope)
    let activeDropdown = null;
    function toggleOptions(e, id) {
        e.stopPropagation(); 
        const dropdown = document.getElementById('options-' + id);
        if (!dropdown) return;
        
        if (activeDropdown && activeDropdown !== dropdown) {
            activeDropdown.classList.remove('show');
        }
        dropdown.classList.toggle('show');
        activeDropdown = dropdown.classList.contains('show') ? dropdown : null;
    }

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.agenda-card-kebab') && !e.target.closest('#deleteAgendaModal')) {
            if (activeDropdown) {
                activeDropdown.classList.remove('show');
                activeDropdown = null;
            }
        }
    });

    // Card Click
    function cardClick(event, id) {
        if (event.target.closest('.agenda-card-kebab') || event.target.closest('.delete-modal-link')) {
            return;
        }
        window.location.href = '/agenda/details/' + id + '/';
    }

    // --- COLOR PALETTE ---
    const CARD_BACKGROUNDS = [
        'linear-gradient(to bottom, #FFC4A8 0%, #ffffff 100%)', // Soft Coral / Peach
        'linear-gradient(to bottom, #B6F3D7 0%, #ffffff 100%)', // Soft Mint Green
        'linear-gradient(to bottom, #B8D9FF 0%, #ffffff 100%)', // Soft Sky Blue
        'linear-gradient(to bottom, #D0B8FF 0%, #ffffff 100%)', // Soft Lavender
        'linear-gradient(to bottom, #FFF3B8 0%, #ffffff 100%)', // Soft Creamy Yellow
        'linear-gradient(to bottom, #FFB8D9 0%, #ffffff 100%)', // Soft Rose Pink
        'linear-gradient(to bottom, #A8FFF0 0%, #ffffff 100%)', // Soft Aqua
        'linear-gradient(to bottom, #FFC0B8 0%, #ffffff 100%)', // Pale Salmon
        'linear-gradient(to bottom, #D9D9F8 0%, #ffffff 100%)', // Soft Periwinkle
    ];

    // --- CAROUSEL LOGIC ---
    let agendaIndex = 0;
    const cardsToShow = 3; 

    function getAgendaCards() {
        return document.querySelectorAll('.agenda-carousel-track .agenda-card');
    }

    function applyRandomColors() {
        const cards = getAgendaCards();
        cards.forEach((card, index) => {
            const colorIndex = index % CARD_BACKGROUNDS.length;
            card.style.backgroundImage = CARD_BACKGROUNDS[colorIndex];
        });
    }

    function updateAgendaCarousel() {
        const track = document.querySelector('.agenda-carousel-track');
        const cards = getAgendaCards();
        const totalCards = cards.length;
        if (!track || totalCards === 0) return;

        // 1. Clamp index
        if (agendaIndex < 0) {
            agendaIndex = 0;
        }
        if (agendaIndex > totalCards - cardsToShow) {
            agendaIndex = Math.max(totalCards - cardsToShow, 0);
        }

        // 2. Calculate offset and scroll
        const cardWidth = cards.length > 0 ? cards[0].offsetWidth : 0; 
        const gap = parseInt(window.getComputedStyle(track).gap) || 24;
        const offset = agendaIndex * (cardWidth + gap);
        track.style.transform = `translateX(-${offset}px)`;

        // 3. Arrow enable/disable
        const leftArrow = document.querySelector('.left-arrow');
        const rightArrow = document.querySelector('.right-arrow');
        if (leftArrow) leftArrow.disabled = agendaIndex === 0;
        if (rightArrow) rightArrow.disabled = agendaIndex >= totalCards - cardsToShow;

        // 4. DYNAMIC CLIPPING FIX: Apply 'expand-left' class 
        const lastVisibleIndex = agendaIndex + cardsToShow - 1;
        
        cards.forEach((card, index) => {
            card.classList.remove('expand-left');
            if (index === lastVisibleIndex && index < totalCards) {
                card.classList.add('expand-left');
            }
        });

        // 5. DYNAMIC SHIFT FIX: Setup hover listeners for preceding card
        setupHoverShift(); 
    }

    function scrollAgenda(dir) {
        agendaIndex += dir;
        updateAgendaCarousel();
    }

    // --- Dynamic Shifting (Hover) Logic ---
    function setupHoverShift() {
        const cards = getAgendaCards();

        cards.forEach(card => {
            card.classList.remove('shift-previous'); 
        });

        cards.forEach((card, index) => {
            if (card.classList.contains('expand-left')) {
                const previousCard = cards[index - 1];

                if (previousCard) {
                    // Use named functions for listeners for better removal
                    const mouseOverHandler = () => { previousCard.classList.add('shift-previous'); };
                    const mouseOutHandler = () => { previousCard.classList.remove('shift-previous'); };

                    // Remove existing listeners before setting new ones
                    card.onmouseover = null;
                    card.onmouseout = null;
                    
                    card.onmouseover = mouseOverHandler;
                    card.onmouseout = mouseOutHandler;
                }
            } else {
                card.onmouseover = null;
                card.onmouseout = null;
            }
        });
        
        // Re-apply colors
        applyRandomColors(); 

        // CRITICAL: Re-attach modal listeners
        setupModalLinks();
    }


    // ===============================================
    // *** MODAL/LISTENER FIX START ***
    // ===============================================
    // Declare the critical variables in a high scope (module scope)
    let agendaDeleteUrl = '';
    let modal = null;
    let modalMsg = null;

    // This function handles attaching listeners to the DELETE links on the agenda cards
    function setupModalLinks() {
        // Remove old listeners to prevent duplication
        document.querySelectorAll('.delete-modal-link').forEach(function(link) {
            if (link._deleteListener) {
                link.removeEventListener('click', link._deleteListener);
                link._deleteListener = null;
            }
        });

        // Attach fresh listeners
        document.querySelectorAll('.delete-modal-link').forEach(function(link) {
            const listener = function(e) {
                e.stopPropagation(); 
                e.preventDefault(); 
                
                if (activeDropdown) {
                    activeDropdown.classList.remove('show');
                    activeDropdown = null;
                }

                // Set the HIGH-SCOPED agendaDeleteUrl
                agendaDeleteUrl = link.getAttribute('data-delete-url');
                const agendaName = link.getAttribute('data-agenda-name');
                
                modalMsg.innerHTML = 'Are you sure you want to delete the agenda <strong>' + agendaName + '</strong>? This action cannot be undone.';
                modal.classList.add('is-open'); 
            };
            
            link.addEventListener('click', listener);
            link._deleteListener = listener; // Store reference for removal later
        });
    }

    // --- Initialization ---
    window.addEventListener('resize', updateAgendaCarousel);

    document.addEventListener('DOMContentLoaded', function() {
        
        // Assign modal DOM elements once in DOMContentLoaded
        modal = document.getElementById('deleteAgendaModal');
        modalMsg = document.getElementById('deleteAgendaModalMsg');

        // ===============================================
        // *** MODAL BUTTON LISTENERS (ATTACHED ONCE) ***
        // These use the high-scoped agendaDeleteUrl variable
        // ===============================================

        document.getElementById('cancelDeleteAgendaBtn').addEventListener('click', function() {
            modal.classList.remove('is-open'); 
            agendaDeleteUrl = '';
        });

        document.getElementById('confirmDeleteAgendaBtn').addEventListener('click', function() {
            if (agendaDeleteUrl) {
                fetch(agendaDeleteUrl, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                })
                .then(response => {
                    if (response.ok || response.status === 204) {
                        window.location.reload();
                    } else {
                        alert('Error deleting agenda.');
                        modal.classList.remove('is-open'); 
                    }
                })
                .catch(error => {
                    alert('Network error occurred.');
                    modal.classList.remove('is-open'); 
                });
            }
        });

        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.remove('is-open'); 
                agendaDeleteUrl = '';
            }
        });

        // Initial setup for carousel (this triggers setupHoverShift -> setupModalLinks)
        updateAgendaCarousel(); 
    });
</script>
</body>
</html>

{% endblock %}