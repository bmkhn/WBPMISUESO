{% extends "base_internal.html" %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Projects</title>

<link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/a_module_styles.css' %}" rel="stylesheet">
</head>
<body>
	<div class="main-container">

        <!-- Search Bar & Filter (4x2 Grid) -->
        <div class="search-container">
            <form class="search-bar" method="get" action="">
                <svg width="16" height="16" style="margin-right:10px;"> <use href="#icon-search"></use> </svg>
                <input type="text" name="search" placeholder="Search Project Title" value="{{ search|default:'' }}"/>
                <button type="button" id="filterBtn" style="background:none;border:none;padding:0;margin-right:5px;cursor:pointer;">
                    <svg width="16" height="16"> <use href="#icon-filter"></use> </svg>
                </button>
                <div id="filterDropdown" class="filter-dropdown">
                    <div class="filter-grid" style="grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(2, 1fr);">
                        <!-- Row 1 -->
                        <label>Sort By
                            <select name="sort_by">
                                <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Title</option>
                                <option value="last_updated" {% if sort_by == 'last_updated' %}selected{% endif %}>Last Updated</option>
                                <option value="start_date" {% if sort_by == 'start_date' %}selected{% endif %}>Start Date</option>
                                <option value="progress" {% if sort_by == 'progress' %}selected{% endif %}>Progress</option>
                            </select>
                        </label>
                        <label>Order By
                            <select name="order">
                                <option value="asc" {% if order == 'asc' %}selected{% endif %}>Ascending</option>
                                <option value="desc" {% if order == 'desc' %}selected{% endif %}>Descending</option>
                            </select>
                        </label>
                        <label>College (Leader)
                            <select name="college">
                                <option value="">All Colleges</option>
                                {% for c in colleges %}
                                <option value="{{ c.id }}" {% if college == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <label>Campus (Leader)
                            <select name="campus">
                                <option value="">All Campuses</option>
                                {% for c in campuses %}
                                <option value="{{ c.0 }}" {% if campus == c.0 %}selected{% endif %}>{{ c.1 }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <label>Agenda
                            <select name="agenda">
                                <option value="">All Agendas</option>
                                {% for a in agendas %}
                                <option value="{{ a.id }}" {% if agenda == a.id|stringformat:'s' %}selected{% endif %}>{{ a.name }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <!-- Row 2 -->
                        <label>Status
                            <select name="status">
                                <option value="">All Statuses</option>
                                {% for s in status_choices %}
                                <option value="{{ s.0 }}" {% if status == s.0 %}selected{% endif %}>{{ s.1 }}</option>
                                {% endfor %}
                            </select>
                        </label>

                        <label>Year
                            <select name="year">
                                <option value="">All Years</option>
                                {% for y in years %}
                                <option value="{{ y }}" {% if year == y|stringformat:'s' %}selected{% endif %}>{{ y }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <label>Quarter
                            <select name="quarter">
                                <option value="">All Quarters</option>
                                <option value="1" {% if quarter == '1' %}selected{% endif %}>Q1</option>
                                <option value="2" {% if quarter == '2' %}selected{% endif %}>Q2</option>
                                <option value="3" {% if quarter == '3' %}selected{% endif %}>Q3</option>
                                <option value="4" {% if quarter == '4' %}selected{% endif %}>Q4</option>
                            </select>
                        </label>
                        <label>Date From
                            <input type="date" name="date_from" value="{{ date_from|default:'' }}" style="width: 87%"/>
                        </label>
                        <label>Date To
                            <input type="date" name="date_to" value="{{ date_to|default:'' }}" style="width: 87%"/>
                        </label>
                    </div>
                    <div class="filter-actions">
                        <button type="submit" class="filter-apply">Apply</button>
                        <button type="button" id="closeFilter" class="filter-close">Clear Filters</button>
                    </div>
                </div>
            </form>
        </div> 
         
        <div class="container-a">
            <div class="text-sort-container">
                <div class="project-text">Extension Projects</div>
            </div>
            <div class="button-container">
                {% if request.user.role in ADMIN_ROLES %}
                <a class="add-user-btn" href="{% url 'add_project' %}">  
                    <i class="fa-solid fa-diagram-project"></i>
                    Add Project 
                </a>
                {% endif %}
                <button class="export-btn" id="exportProjectBtn" type="button">  
                    <i class="fa-solid fa-download"></i>
                    Export 
                </button>
            </div>
		</div>

        <!-- Table Section -->
        <table class="user-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Leader</th>
                    <th>College/Unit</th>
                    <th>Last Updated</th>
                    <th>Start Date</th>
                    <th>Progress</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for project in projects %}
                <tr>
                    <td style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                        <a href="{% url 'project_profile' project.id %}" class="name-link" title="{{ project.title }}" style="display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                            {{ project.title }}
                        </a>
                    </td>
                    <td><a href="{% url 'user_profile' project.project_leader.id %}" class="name-link">{{ project.project_leader.get_full_name }}</a></td>
                    <td>{% if project.project_leader.college %}{{ project.project_leader.college.name }}{% else %}<em>-</em>{% endif %}</td>
                    <td style="white-space:nowrap;">{{ project.updated_at|date:"Y-m-d" }}</td>
                    <td style="white-space:nowrap;">{{ project.start_date|date:"Y-m-d" }}</td>
                    <td style="white-space:nowrap;">{{ project.progress_display }}</td>
                    <td>{{ project.get_status_display }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="7" style="text-align:center;">No projects found.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pagination -->
		<div class="pagination-container">
			{% if page_obj.has_previous %}
				<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page=1">First</a>
				<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
			{% else %}
				<button class="pagination-button" disabled>First</button>
				<button class="pagination-button" disabled>Previous</button>
			{% endif %}

			{% for num in page_range %}
				{% if num == page_obj.number %}
					<button class="pagination-button active" disabled>{{ num }}</button>
				{% else %}
					<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ num }}">{{ num }}</a>
				{% endif %}
			{% endfor %}

			{% if page_obj.has_next %}
				<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
				<a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ paginator.num_pages }}">Last</a>
			{% else %}
				<button class="pagination-button" disabled>Next</button>
				<button class="pagination-button" disabled>Last</button>
			{% endif %}
		</div>

	</div>

<!-- SVG Sprite Section -->
<svg style="display:none;">

    <!-- Delete -->
    <symbol id="delete-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <polyline points="3,6 5,6 21,6"></polyline>
        <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
    </symbol>

    <!-- Settings -->
    <symbol id="settings-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M2 4C1.45 4 0.979167 3.80417 0.5875 3.4125C0.195833 3.02083 0 2.55 0 2C0 1.45 0.195833 0.979167 0.5875 0.5875C0.979167 0.195833 1.45 0 2 0C2.55 0 3.02083 0.195833 3.4125 0.5875C3.80417 0.979167 4 1.45 4 2C4 2.55 3.80417 3.02083 3.4125 3.4125C3.02083 3.80417 2.55 4 2 4ZM8 4C7.45 4 6.97917 3.80417 6.5875 3.4125C6.19583 3.02083 6 2.55 6 2C6 1.45 6.19583 0.979167 6.5875 0.5875C6.97917 0.195833 7.45 0 8 0C8.55 0 9.02083 0.195833 9.4125 0.5875C9.80417 0.979167 10 1.45 10 2C10 2.55 9.80417 3.02083 9.4125 3.4125C9.02083 3.80417 8.55 4 8 4ZM14 4C13.45 4 12.9792 3.80417 12.5875 3.4125C12.1958 3.02083 12 2.55 12 2C12 1.45 12.1958 0.979167 12.5875 0.5875C12.9792 0.195833 13.45 0 14 0C14.55 0 15.0208 0.195833 15.4125 0.5875C15.8042 0.979167 16 1.45 16 2C16 2.55 15.8042 3.02083 15.4125 3.4125C15.0208 3.80417 14.55 4 14 4Z" fill="#1D1B20"/>
    </symbol>

    <!-- Sort -->
    <symbol id="sort-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M9.97066 18.8067V1.13672M9.97066 1.13672L18.8057 9.97172M9.97066 1.13672L1.13566 9.97172" stroke="black" stroke-width="1.97904" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>

    <!-- Dropdown -->
    <symbol id="dropdown-icon" viewBox="0 0 15 10" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.11427 6.46831L12.3293 1.25327C12.4265 1.15265 12.5427 1.07239 12.6713 1.01717C12.7998 0.961959 12.9381 0.932896 13.0779 0.93168C13.2178 0.930465 13.3566 0.957121 13.486 1.01009C13.6155 1.06307 13.7331 1.1413 13.8321 1.24022C13.931 1.33914 14.0092 1.45677 14.0622 1.58624C14.1152 1.71572 14.1418 1.85445 14.1406 1.99434C14.1394 2.13423 14.1103 2.27247 14.0551 2.40101C13.9999 2.52954 13.9196 2.6458 13.819 2.74298L7.85912 8.70287C7.66155 8.90038 7.39363 9.01133 7.11427 9.01133C6.8349 9.01133 6.56698 8.90038 6.36941 8.70287L0.409525 2.74298C0.308901 2.6458 0.228639 2.52954 0.173424 2.40101C0.118209 2.27247 0.089146 2.13423 0.0879304 1.99434C0.0867148 1.85445 0.113371 1.71572 0.166344 1.58624C0.219317 1.45677 0.297546 1.33914 0.396466 1.24022C0.495386 1.1413 0.613016 1.06307 0.742492 1.01009C0.871969 0.957121 1.0107 0.930465 1.15059 0.93168C1.29048 0.932896 1.42872 0.961959 1.55726 1.01717C1.68579 1.07239 1.80205 1.15265 1.89923 1.25327L7.11427 6.46831Z" fill="black"/>
    </symbol>

    <!-- Search -->
	<symbol id="icon-search" viewBox="0 0 21 21" fill="none">
		<path d="M8.89152 15.9057C9.75056 15.9057 10.6012 15.7365 11.3948 15.4077C12.1885 15.079 12.9096 14.5972 13.5171 13.9897C14.1245 13.3823 14.6064 12.6612 14.9351 11.8675C15.2638 11.0739 15.433 10.2232 15.433 9.36417C15.433 8.50513 15.2638 7.6545 14.9351 6.86084C14.6064 6.06719 14.1245 5.34606 13.5171 4.73862C12.9096 4.13119 12.1885 3.64934 11.3948 3.3206C10.6012 2.99186 9.75056 2.82266 8.89152 2.82266C7.1566 2.82266 5.49274 3.51185 4.26597 4.73862C3.03919 5.9654 2.35 7.62926 2.35 9.36417C2.35 11.0991 3.03919 12.763 4.26597 13.9897C5.49274 15.2165 7.1566 15.9057 8.89152 15.9057V15.9057ZM15.7819 14.713L19.685 18.6161C19.7891 18.7167 19.872 18.8371 19.9291 18.9701C19.9861 19.1032 20.0161 19.2463 20.0173 19.391C20.0184 19.5358 19.9907 19.6793 19.9358 19.8133C19.8809 19.9472 19.7999 20.0689 19.6974 20.1712C19.595 20.2735 19.4732 20.3544 19.3392 20.4091C19.2052 20.4638 19.0616 20.4913 18.9168 20.4899C18.772 20.4886 18.629 20.4584 18.496 20.4012C18.3631 20.3439 18.2428 20.2608 18.1423 20.1566L14.2392 16.2535C12.4866 17.614 10.2814 18.2554 8.07247 18.0472C5.86357 17.839 3.81705 16.7968 2.34951 15.1328C0.881971 13.4688 0.103735 11.308 0.173229 9.09044C0.242723 6.87284 1.15472 4.76508 2.72357 3.19623C4.29242 1.62738 6.40018 0.715379 8.61778 0.645885C10.8354 0.576391 12.9961 1.35463 14.6601 2.82217C16.3241 4.28971 17.3663 6.33623 17.5745 8.54513C17.7827 10.754 17.1413 12.9592 15.7808 14.7119L15.7819 14.713Z" fill="#5A5252"/>
	</symbol>

	<!-- Filter -->
	<symbol id="icon-filter" viewBox="0 0 23 22" fill="none">
		<path opacity="0.9" d="M21.5399 1.92871H1.37988L9.44388 11.4644V18.0567L13.4759 20.0727V11.4644L21.5399 1.92871Z" stroke="#1E1E1E" stroke-width="2.016" stroke-linecap="round" stroke-linejoin="round"/>
	</symbol>

    <!-- Info Icon -->
    <symbol id="info-icon" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M11 9V17M11 5V7M11 21C16.523 21 21 16.523 21 11C21 5.477 16.523 1 11 1C5.477 1 1 5.477 1 11C1 16.523 5.477 21 11 21Z" stroke="#00538E" stroke-width="2"/>
    </symbol>

	<!-- Edit -->
	<symbol id="edit-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
		<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
		<path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
	</symbol>

</svg>

<!-- Export Request Submitted Modal -->
<div id="exportRequestModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:white;padding:2rem 2.5rem;border-radius:16px;box-shadow:0 4px 32px rgba(0,0,0,0.18);max-width:350px;margin:auto;display:flex;flex-direction:column;align-items:center;">
        <div style="font-size:1.25rem;font-weight:600;color:#00538E;margin-bottom:1rem;">Export Request Submitted</div>
        <div style="font-size:1rem;color:#444;margin-bottom:2rem;text-align:center;">Your export request has been submitted for approval.</div>
        <div style="display:flex;gap:1rem;">
            <button id="closeExportRequestModalBtn" style="background:#e5e7eb;color:#374151;padding:0.75rem 1.5rem;border-radius:8px;font-size:1rem;font-weight:500;border:none;cursor:pointer;">Close</button>
        </div>
    </div>
</div>
<script>
function showExportRequestModal() {
    var modal = document.getElementById('exportRequestModal');
    if (modal) {
        modal.style.display = 'flex';
    }
    var closeBtn = document.getElementById('closeExportRequestModalBtn');
    if (closeBtn) {
        closeBtn.onclick = function() {
            modal.style.display = 'none';
        };
    }
    // Optional: close modal on background click
    modal.onclick = function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    };
}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.settings-dropdown-toggle').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                // Hide all other dropdowns
                document.querySelectorAll('.settings-dropdown-menu').forEach(function(menu) {
                    menu.style.display = 'none';
                });
                // Show this dropdown
                var menu = btn.parentElement.querySelector('.settings-dropdown-menu');
                if (menu) {
                    menu.style.display = 'block';
                }
            });
        });
        // Hide dropdown when clicking outside
        document.addEventListener('click', function() {
            document.querySelectorAll('.settings-dropdown-menu').forEach(function(menu) {
                menu.style.display = 'none';
            });
        });
    });

    // Filter dropdown logic
    const filterBtn = document.getElementById('filterBtn');
    const filterDropdown = document.getElementById('filterDropdown');
    const closeFilter = document.getElementById('closeFilter');
    if (filterBtn && filterDropdown) {
        filterBtn.addEventListener('click', function(e) {
            e.preventDefault();
            filterDropdown.style.display = 'block';
        });
    }
    if (closeFilter && filterDropdown) {
        closeFilter.addEventListener('click', function(e) {
            e.preventDefault();
            // Clear filters by redirecting to base URL without query parameters
            window.location.href = window.location.pathname;
        });
    }
    // Hide dropdown when clicking outside
    document.addEventListener('mousedown', function(e) {
        if (filterDropdown && !filterDropdown.contains(e.target) && e.target !== filterBtn) {
            filterDropdown.style.display = 'none';
        }
    });
</script>

<script>
// Export button AJAX logic
function getExportUrl() {
    // Build the export URL with current querystring
    var baseUrl = "{% url 'export_project' %}";
    var query = "{{ querystring|escapejs }}";
    return query ? baseUrl + "?" + query : baseUrl;
}

document.addEventListener('DOMContentLoaded', function() {
    var exportBtn = document.getElementById('exportProjectBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function(e) {
            e.preventDefault();
            var url = getExportUrl();
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin',
            })
            .then(async response => {
                if (response.status === 202) {
                    showExportRequestModal();
                } else if (response.ok) {
                    // XLSX file download
                    const blob = await response.blob();
                    const disposition = response.headers.get('Content-Disposition');
                    let filename = 'projects_export.xlsx';
                    if (disposition && disposition.indexOf('filename=') !== -1) {
                        filename = disposition.split('filename=')[1].replace(/\"/g, '').replace(/;/g, '').trim();
                    }
                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    response.json().then(data => {
                        alert(data.error || 'Export failed.');
                    });
                }
            })
            .catch(() => {
                alert('Export failed.');
            });
        });
    }
});
</script>

<!-- Success Toast -->
<div id="successToast" style="display:none;position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:1rem 1.5rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:10000;font-size:1rem;font-weight:500;min-width:300px;">
    <div style="display:flex;align-items:center;gap:0.75rem;">
        <i class="fa-solid fa-check-circle" style="font-size:1.5rem;"></i>
        <div>
            <div style="font-weight:600;margin-bottom:0.25rem;">Project Created Successfully!</div>
            <div id="toastProjectTitle" style="font-size:0.875rem;opacity:0.9;"></div>
        </div>
    </div>
</div>

<!-- Add Events Modal -->
<div id="addEventsModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:white;padding:2rem 2.5rem;border-radius:16px;box-shadow:0 4px 32px rgba(0,0,0,0.25);max-width:500px;margin:auto;display:flex;flex-direction:column;">
        <div style="font-size:1.5rem;font-weight:600;color:#00538E;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;">
            <i class="fa-solid fa-calendar-days"></i>
            Set Up Project Events
        </div>
        <div style="font-size:1rem;color:#444;margin-bottom:2rem;line-height:1.6;">
            Would you like to add events to "<span id="modalProjectTitle" style="font-weight:600;color:#00538E;"></span>" now? 
            You can set up event details and schedule submissions for each event.
        </div>
        <div style="display:flex;gap:1rem;justify-content:flex-end;">
            <button id="skipEventsBtn" style="background:#e5e7eb;color:#374151;padding:0.75rem 1.5rem;border-radius:8px;font-size:1rem;font-weight:500;border:none;cursor:pointer;transition:all 0.2s;" 
                onmouseover="this.style.background='#d1d5db'" onmouseout="this.style.background='#e5e7eb'">
                Skip for Now
            </button>
            <button id="addEventsBtn" style="background:#00538E;color:white;padding:0.75rem 1.5rem;border-radius:8px;font-size:1rem;font-weight:500;border:none;cursor:pointer;transition:all 0.2s;"
                onmouseover="this.style.background='#004070'" onmouseout="this.style.background='#00538E'">
                <i class="fa-solid fa-plus"></i> Add Events
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if success parameter exists
    const urlParams = new URLSearchParams(window.location.search);
    const success = urlParams.get('success');
    const newProjectId = urlParams.get('new_project_id');
    const projectTitle = urlParams.get('project_title');

    if (success === 'true' && newProjectId && projectTitle) {
        // Show success toast
        const toast = document.getElementById('successToast');
        const toastTitle = document.getElementById('toastProjectTitle');
        toastTitle.textContent = projectTitle;
        toast.style.display = 'block';

        // Auto-hide toast after 4 seconds
        setTimeout(function() {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s';
            setTimeout(function() {
                toast.style.display = 'none';
                toast.style.opacity = '1';
            }, 300);
        }, 4000);

        // Show add events modal after a short delay
        setTimeout(function() {
            const modal = document.getElementById('addEventsModal');
            const modalTitle = document.getElementById('modalProjectTitle');
            modalTitle.textContent = projectTitle;
            modal.style.display = 'flex';

            // Add Events button
            document.getElementById('addEventsBtn').onclick = function() {
                window.location.href = '/projects/' + newProjectId + '/events/';
            };

            // Skip button
            document.getElementById('skipEventsBtn').onclick = function() {
                modal.style.display = 'none';
                // Clean URL
                window.history.replaceState({}, document.title, '/projects/');
            };

            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    window.history.replaceState({}, document.title, '/projects/');
                }
            };
        }, 500);
    }
});
</script>

</body>
</html>

{% endblock %}