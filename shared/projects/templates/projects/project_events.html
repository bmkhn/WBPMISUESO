{% extends "projects/base_project_profile.html" %}
{% block profile_content %}
{% load static %} 
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/view.css' %}" rel="stylesheet">

<div class="card-header">
    <h3>Activities Pipeline Status</h3>
    {% if request.user.role in ADMIN_ROLES and not project.has_final_submission %}
        {% if project.events.count < project.estimated_events %}
        <button class="admin-button edit" type="button" id="openAddEventModal">Add Activity</button>
        {% else %}
        <button class="admin-button edit" type="button" disabled style="opacity:0.6;cursor:not-allowed;" title="Activity limit reached ({{ project.events.count }}/{{ project.estimated_events }})">Activity Limit Reached</button>
        {% endif %}
    {% endif %}
</div>

<div class="card-body">
    <div class="tracker-box">
        <div class="progress">
            <div class="progress-bar" style="width: {{ percent|default_if_none:'0' }}%;"></div>
        </div>
        <p class="status-text">{{ completed }}/{{ total }} activities completed</p>
    </div>
</div>
    <section class="events-section">
        <div class="event-card">
            {% for event in events %}
            <!-- Activity display -->
            <div class="event-details">
                <div class="event-info">
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        <h4 style="margin:0;">{{ event.title }}</h4>
                        {% if event.related_submissions %}
                            {% if event.related_submissions.status == 'PENDING' or event.related_submissions.status == 'REVISION_REQUESTED' %}
                                <span style="background:#FEF3C7;color:#D97706;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:500;">Submission Required</span>
                            {% elif event.related_submissions.status == 'SUBMITTED' %}
                                <span style="background:#DBEAFE;color:#1D4ED8;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:500;">Under Review</span>
                            {% elif event.related_submissions.status == 'FORWARDED' %}
                                <span style="background:#E0E7FF;color:#6366F1;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:500;">Forwarded</span>
                            {% elif event.related_submissions.status == 'APPROVED' %}
                                <span style="background:#D1FAE5;color:#059669;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:500;">Completed</span>
                            {% elif event.related_submissions.status == 'REJECTED' %}
                                <span style="background:#FEE2E2;color:#DC2626;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:500;">Rejected</span>
                            {% elif event.related_submissions.status == 'OVERDUE' %}
                                <span style="background:#FEE2E2;color:#DC2626;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:500;">Overdue</span>
                            {% endif %}
                        {% endif %}
                        {% if request.user.role in ADMIN_ROLES and not project.has_final_submission %}
                        <button type="button" style="background:none;border:none;cursor:pointer;padding:0;" onclick="document.getElementById('edit-event-modal-{{ event.id }}').style.display='flex'">
                            <i class="fa-solid fa-pen-to-square" style="color:#0A6C44;"></i>
                        </button>
                        <button type="button" title="Delete Activity" style="background:none;border:none;cursor:pointer;padding:0;" onclick="openDeleteEventModal('{{ event.id }}')">
                            <i class="fa-solid fa-trash" style="color:#E53E3E;"></i>
                        </button>
                        {% endif %}
                    </div>
                    <p>{{ event.description|default:'No description.' }}</p>
                    <p>{{ event.datetime|date:'F d, Y' }} at {{ event.datetime|date:'g:i A' }}</p>
                    {% if event.location %}<p><strong>Location:</strong> {{ event.location }}</p>{% endif %}
                </div>
                <div style="height:15rem;display:flex; text-align: center; align-items: center; justify-content: center;">
                {% if event.image %}
                    <img src="{{ event.image.url }}" alt="Activity Photo" style="width:100%;height:100%;object-fit:cover;border-radius:0.75rem;border:0.08rem solid #525252;">
                {% else %}
                    <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#F3F4F6;border:0.08rem solid #D1D5DB;border-radius:0.75rem;">
                        <span style="color:#6B7280;font-weight:500;font-size:1rem;width:30rem;">No Image Yet</span>
                    </div>
                {% endif %}
                </div>
            </div>

            <!-- Edit Activity Modal for this specific activity -->
            {% if request.user.role in ADMIN_ROLES and not project.has_final_submission %}
            <div id="edit-event-modal-{{ event.id }}" class="event-modal modal" style="display:none;">
                <div class="event-modal-content">
                    <span class="close" onclick="document.getElementById('edit-event-modal-{{ event.id }}').style.display='none'">&times;</span>
                    <h2>Edit Activity</h2>
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="event_id" value="{{ event.id }}">
                        <div class="form-group">
                            <label class="form-label">Title <span class="required">*</span></label>
                            <input class="user-details-value" type="text" name="title" value="{{ event.title }}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date Time <span class="required">*</span></label>
                            <input class="user-details-value event-datetime-input" type="datetime-local" name="datetime" value="{{ event.datetime|date:'Y-m-d\\TH:i' }}" required data-event-id="{{ event.id }}">
                            <small style="color:#666;font-size:0.875rem;margin-top:0.25rem;display:block;">Must be within project dates ({{ project.start_date|date:'M d, Y' }} - {{ project.estimated_end_date|date:'M d, Y' }})</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location <span class="required">*</span></label>
                            <input class="user-details-value" type="text" name="location" value="{{ event.location }}" required>
                        </div>
                        <div class="form-actions" style="justify-content:flex-end;">
                            <button type="button" class="back admin-button" onclick="document.getElementById('edit-event-modal-{{ event.id }}').style.display='none'">Cancel</button>
                            <button type="submit" class="save admin-button">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            <script>
                document.getElementById('edit-event-modal-{{ event.id }}').onclick = function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                };
            </script>
            {% endif %}

            {% empty %}
            <style>.event-details { display: flex; flex-direction: column; align-items: center; }</style>
            <section><div class="event-details"><div class="event-info" style="width: 100%;"><h4 style="text-align: center;">No activities scheduled.</h4></div></div></section>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Add Activity Modal -->
<div id="add-event-modal" class="event-modal modal" style="display:none;">
    <div class="event-modal-content">
        <span class="close" id="close-add-event-modal">&times;</span>
        <h2 style="margin-top:0;">Add New Activity</h2>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="add_event" value="1">
            <div class="form-group">
                <label class="form-label">Activity Name <span class="required">*</span></label>
                <input class="user-details-value" type="text" name="add_event_title" required>
            </div>
            <div class="form-group">
                <label class="form-label">Date Time <span class="required">*</span></label>
                <input class="user-details-value" type="datetime-local" name="add_event_datetime" id="add_event_datetime" required>
                <small style="color:#666;font-size:0.875rem;margin-top:0.25rem;display:block;">Must be within project dates ({{ project.start_date|date:'M d, Y' }} - {{ project.estimated_end_date|date:'M d, Y' }})</small>
            </div>
            <div class="form-group">
                <label class="form-label">Location <span class="required">*</span></label>
                <input class="user-details-value" type="text" name="add_event_location" required>
            </div>
            <div class="form-actions" style="justify-content:center;">
                <button type="button" class="back admin-button" id="cancel-add-event-modal">Cancel</button>
                <button type="submit" class="save admin-button">Add Activity</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Project date constraints for event validation
    const projectStartDate = new Date('{{ project.start_date|date:"Y-m-d" }}');
    const projectEndDate = new Date('{{ project.estimated_end_date|date:"Y-m-d" }}');
    projectEndDate.setHours(23, 59, 59, 999); // Set to end of day
    
    // Format dates for datetime-local input (YYYY-MM-DDTHH:MM)
    const minDateTime = projectStartDate.toISOString().slice(0, 16);
    const maxDateTime = projectEndDate.toISOString().slice(0, 16);
    
    // Add Activity Modal logic
    document.getElementById('openAddEventModal').onclick = function() {
        document.getElementById('add-event-modal').style.display = 'flex';
    };
    document.getElementById('close-add-event-modal').onclick = function() {
        document.getElementById('add-event-modal').style.display = 'none';
    };
    document.getElementById('cancel-add-event-modal').onclick = function() {
        document.getElementById('add-event-modal').style.display = 'none';
    };
    document.getElementById('add-event-modal').onclick = function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    };
    
    // Set min/max for add event datetime
    const addEventDateTimeInput = document.getElementById('add_event_datetime');
    if (addEventDateTimeInput) {
        addEventDateTimeInput.setAttribute('min', minDateTime);
        addEventDateTimeInput.setAttribute('max', maxDateTime);
    }
    
    // Set min/max for edit event datetime inputs
    document.querySelectorAll('.event-datetime-input').forEach(function(input) {
        input.setAttribute('min', minDateTime);
        input.setAttribute('max', maxDateTime);
    });
    
    // Validate on form submit
    document.querySelectorAll('form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            const datetimeInputs = form.querySelectorAll('input[type="datetime-local"]');
            datetimeInputs.forEach(function(input) {
                if (input.value) {
                    const selectedDate = new Date(input.value);
                    if (selectedDate < projectStartDate || selectedDate > projectEndDate) {
                        e.preventDefault();
                        alert('Activity date must be within project dates ({{ project.start_date|date:"M d, Y" }} - {{ project.estimated_end_date|date:"M d, Y" }})');
                        input.focus();
                    }
                }
            });
        });
    });
</script>

<!-- Delete Activity Confirmation Modal -->
<div id="delete-event-modal" class="event-modal modal" style="display:none;">
    <div class="event-modal-content" style="min-width:320px;max-width:95vw;">
        <span class="close" id="close-delete-event-modal">&times;</span>
        <h2 style="margin-top:0;font-size:1.3rem;text-align:center;">Delete Activity</h2>
        <p style="text-align:center;">Are you sure you want to delete this activity?</p>
        <p style="text-align:center;color:#DC2626;font-weight:500;margin-top:1rem;">⚠️ Warning: All submissions related to this activity will also be deleted permanently.</p>
        <form id="delete-event-confirm-form" method="post" style="margin-top:2rem;gap:15px;display:flex;align-items:center;justify-content:center">
            {% csrf_token %}
            <input type="hidden" name="delete_event_id" id="delete_event_id_input" value="">
            <button type="button" class="back admin-button" id="cancel-delete-event-modal">Cancel</button>
            <button type="submit" class="save admin-button">Confirm Delete</button>
        </form>
    </div>
</div>

<script>
    // Delete Activity Modal logic
    function openDeleteEventModal(eventId) {
        document.getElementById('delete_event_id_input').value = eventId;
        document.getElementById('delete-event-modal').style.display = 'flex';
    }
    document.getElementById('close-delete-event-modal').onclick = function() {
        document.getElementById('delete-event-modal').style.display = 'none';
    };
    document.getElementById('cancel-delete-event-modal').onclick = function() {
        document.getElementById('delete-event-modal').style.display = 'none';
    };
    document.getElementById('delete-event-modal').onclick = function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    };
</script>




{% endblock %}