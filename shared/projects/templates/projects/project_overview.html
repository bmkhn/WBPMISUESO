{% extends "projects/base_project_profile.html" %}
{% block profile_content %}
{% load static %} 
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/view.css' %}" rel="stylesheet">

<div class="card-header">
    <h3>Overview</h3>
    {% if request.user.role in ADMIN_ROLES and not project.has_final_submission %}
        <button class="admin-button edit" onclick="openEditProjectModal()">Edit</button>
    {% endif %}
</div>

<div class="card">
    <div class="card-body">
        <div class="infoseg">
            <div>
                <span class="detail-icon">
                    <svg width="24" height="24"><use href="#detail-icon"/></svg>
                    <span class="detail-tooltip">When this project was created.</span>
                </span>
                <strong>Date Added</strong>
            </div>
            <div>{{ project.created_at|date:'F d, Y' }}</div>
            
            <div>
                <span class="detail-icon">
                    <svg width="24" height="24"><use href="#detail-icon"/></svg>
                    <span class="detail-tooltip">When this project was last modified.</span>
                </span>
                <strong>Last Updated</strong>
            </div>
            <div>{{ project.updated_at|date:'F d, Y' }}</div>

            <div>
                <span class="detail-icon">
                    <svg width="24" height="24"><use href="#detail-icon"/></svg>
                    <span class="detail-tooltip">Current status of the project.</span>
                </span>
                <strong>Project Status</strong>
            </div>
            <div>{{ project.get_status_display }}</div>
            
            <div>
                <span class="detail-icon">
                    <svg width="24" height="24"><use href="#detail-icon"/></svg>
                    <span class="detail-tooltip">Category or classification of the project.</span>
                </span>
                <strong>Project Type</strong>
            </div>
            <div>{{ project.get_project_type_display|default:project.project_type }}</div>

            <div>
                <span class="detail-icon">
                    <svg width="24" height="24"><use href="#detail-icon"/></svg>
                    <span class="detail-tooltip">The agenda this project addresses.</span>
                </span>
                <strong>Agenda</strong>
            </div>
            <div>{{ project.agenda }}</div>
            
            <div>
                <span class="detail-icon">
                    <svg width="24" height="24"><use href="#detail-icon"/></svg>
                    <span class="detail-tooltip">Sustainable Development Goals aligned with this project.</span>
                </span>
                <strong>SDGs</strong>
            </div>
            <div style="flex-direction:column; align-items:flex-start; display:flex;">
                {% for sdg in project.sdgs.all %}
                    <span class="badge bg-success" style="align-self:flex-start;">{{ sdg.name }}{% if not forloop.last %}, {% endif %}</span>
                {% empty %}
                    <span class="text-muted" style="align-self:flex-start;">None</span>
                {% endfor %}
            </div>

            <div>
                <span class="detail-icon">
                    <svg width="24" height="24"><use href="#detail-icon"/></svg>
                    <span class="detail-tooltip">Primary group or community who will benefit.</span>
                </span>
                <strong>Beneficiary</strong>
            </div>
            <div>{{ project.primary_beneficiary }}</div>
            
            <div>
                <span class="detail-icon">
                    <svg width="24" height="24"><use href="#detail-icon"/></svg>
                    <span class="detail-tooltip">Expected number of activities to be conducted.</span>
                </span>
                <strong>Estimated Activities</strong>
            </div>
            <div>{{ project.estimated_events }}</div>

            <div>
                <span class="detail-icon">
                    <svg width="24" height="24"><use href="#detail-icon"/></svg>
                    <span class="detail-tooltip">Primary location where the project will take place.</span>
                </span>
                <strong>Location</strong>
            </div>
            <div>{{ project.primary_location }}</div>
            
            <div>
                <span class="detail-icon">
                    <svg width="24" height="24"><use href="#detail-icon"/></svg>
                    <span class="detail-tooltip">Expected number of individuals to be trained.</span>
                </span>
                <strong>Estimated Trained Individuals</strong>
            </div>
            <div>
                {{ project.estimated_trainees }}
                {% if request.user.role in ADMIN_ROLES or request.user == project.project_leader or request.user in project.providers.all %}
                    <span style="color:#6B7280;font-size:0.875rem;">({{ project.total_trained_individuals|default:0 }}/{{ project.estimated_trainees }})</span>
                {% endif %}
            </div>
          
            <div style="white-space:nowrap;">
                <span class="detail-icon">
                    <svg width="24" height="24"><use href="#detail-icon"/></svg>
                    <span class="detail-tooltip">When the project is scheduled to begin.</span>
                </span>
                <strong>Start Date</strong>
            </div>
            <div>{{ project.start_date|date:'F d, Y' }}</div>
            
            <div style="white-space:nowrap;">
                <span class="detail-icon">
                    <svg width="24" height="24"><use href="#detail-icon"/></svg>
                    <span class="detail-tooltip">Expected completion date of the project.</span>
                </span>
                <strong>Estimated End</strong>
            </div>
            <div>{{ project.estimated_end_date|date:'F d, Y' }}</div>

        </div>
    </div>
</div>


<!-- Edit Overview Modal -->
<div id="edit-project-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="close-edit-project-modal">&times;</span>
        <h2>Edit Project</h2>
        <form id="edit-project-form" method="post" enctype="multipart/form-data" action="" novalidate>

            {% csrf_token %}
            <div class="form-group">
                <label class="form-label">Title <span class="required">*</span></label>
                <input class="user-details-value" type="text" name="title" id="edit_project_title" value="{{ project.title }}" required style="flex:1;">
            </div>

            <div class="form-grid-2x2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0px 30px;">
                <div class="form-group">
                    <label class="form-label">Start Date <span class="required">*</span></label>
                    <div style="display:flex; flex-direction:column;flex:1;">
                        <input class="user-details-value" type="date" name="start_date" id="edit_project_start_date" value="{{ project.start_date|date:'Y-m-d' }}" required>
                        <small style="color:#666;font-size:0.875rem;margin-top:0.25rem;">Cannot be in the past</small>                        
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Estimated End <span class="required">*</span></label>
                    <div style="display:flex; flex-direction:column; flex:1;">
                        <input class="user-details-value" type="date" name="estimated_end_date" id="edit_project_end_date" value="{{ project.estimated_end_date|date:'Y-m-d' }}" required>
                        <small style="color:#666;font-size:0.875rem;margin-top:0.25rem;">Must be after start date</small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Agenda <span class="required">*</span></label>
                    <select class="user-details-value" name="agenda" id="edit_project_agenda" style="flex:1;">
                        {% for agenda in agendas %}
                            <option value="{{ agenda.id }}" {% if project.agenda and project.agenda.id == agenda.id %}selected{% endif %}>{{ agenda.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Project Type <span class="required">*</span></label>
                    <select class="user-details-value" name="project_type" id="edit_project_type" required style="flex:1;">
                        {% for pt in project_types %}
                            <option value="{{ pt.id }}" {% if project.project_type.id==pt.id %}selected{% endif %}>
                                {{ pt.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">SDGs <span class="required">*</span></label>
                <div id="edit-sdgs-tag-row" class="college-row" data-selected-sdgs="{% for sdg in project.sdgs.all %}{{ sdg.id }}{% if not forloop.last %},{% endif %}{% endfor %}"></div>
                <!-- Hidden select template for SDG options -->
                <select class="user-details-value" id="edit-sdgs-options-template" style="display:none;">
                    {% for sdg in all_sdgs %}
                        <option value="{{ sdg.id }}">{{ sdg.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-grid-2x2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0px 30px;">
                <div class="form-group">
                    <label class="form-label">Beneficiary <span class="required">*</span></label>
                    <input class="user-details-value" type="text" name="primary_beneficiary" id="edit_project_beneficiary" value="{{ project.primary_beneficiary }}" style="flex:1;">
                </div>

                <div class="form-group">
                    <label class="form-label">Expected Activities <span class="required">*</span></label>
                    <input class="user-details-value" type="number" name="estimated_events" id="edit_project_events" value="{{ project.estimated_events }}" style="flex:1;">
                </div>

                <div class="form-group">
                    <label class="form-label">Location <span class="required">*</span></label>
                    <input class="user-details-value" type="text" name="primary_location" id="edit_project_location" value="{{ project.primary_location }}" style="flex:1;">
                </div>

                <div class="form-group">
                    <label class="form-label">Expected Trained Individuals <span class="required">*</span></label>
                    <input class="user-details-value" type="number" name="estimated_trainees" id="edit_project_trainees" value="{{ project.estimated_trainees }}" style="flex:1;">
                </div>

            </div> <div class="form-actions" style="justify-content:center;">
                <button type="button" class="back-btn back" id="cancel-edit-project-modal">Cancel</button>
                <button type="submit" class="submit-btn save">Save Changes</button>
            </div>
        </form>
    </div>
</div>


<!-- SVG Sprite Section -->
<svg style="display:none;" xmlns="http://www.w3.org/2000/svg">

    <!-- Add Icon -->
    <symbol id="icon-add" viewBox="0 0 16 16">
        <path d="M6.80039 14.4004C6.80039 14.7187 6.92682 15.0239 7.15186 15.2489C7.37691 15.474 7.68213 15.6004 8.00039 15.6004C8.31865 15.6004 8.62388 15.474 8.84892 15.2489C9.07396 15.0239 9.20039 14.7187 9.20039 14.4004V9.20039H14.4004C14.7187 9.20039 15.0239 9.07396 15.2489 8.84892C15.474 8.62388 15.6004 8.31865 15.6004 8.00039C15.6004 7.68213 15.474 7.37691 15.2489 7.15186C15.0239 6.92682 14.7187 6.80039 14.4004 6.80039H9.20039V1.60039C9.20039 1.28213 9.07396 0.976906 8.84892 0.751863C8.62388 0.526819 8.31865 0.400391 8.00039 0.400391C7.68213 0.400391 7.37691 0.526819 7.15186 0.751863C6.92682 0.976906 6.80039 1.28213 6.80039 1.60039V6.80039H1.60039C1.28213 6.80039 0.976906 6.92682 0.751863 7.15186C0.526819 7.37691 0.400391 7.68213 0.400391 8.00039C0.400391 8.31865 0.526819 8.62388 0.751863 8.84892C0.976906 9.07396 1.28213 9.20039 1.60039 9.20039H6.80039V14.4004Z" fill="black"/>
    </symbol>
    
    <symbol xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" id="detail-icon" viewBox="0 0 16 16">
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
    </symbol>

</svg>

<script>
    function openEditProjectModal() {
        document.getElementById('edit-project-modal').style.display = 'flex';
    }
    document.getElementById('close-edit-project-modal').onclick = function() {
        document.getElementById('edit-project-modal').style.display = 'none';
    };
    document.getElementById('cancel-edit-project-modal').onclick = function() {
        document.getElementById('edit-project-modal').style.display = 'none';
    };
    document.getElementById('edit-project-modal').onclick = function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    };

    // --- Tag-based SDG selector logic (adapted from add_project.html) ---
    function setupTagUI(rowId, optionsTemplateId, inputName, selectedIds) {
        const tagRow = document.getElementById(rowId);
        const optionsTemplate = document.getElementById(optionsTemplateId);
        const selectDropdown = document.createElement('select');
        selectDropdown.id = rowId + '-dropdown';
        selectDropdown.style.display = 'none';
        selectDropdown.style.position = 'absolute';
        selectDropdown.style.appearance = "none";
        selectDropdown.style.background = "white";
        selectDropdown.style.width = "auto";

        Array.from(optionsTemplate.options).forEach(opt => {
            selectDropdown.appendChild(opt.cloneNode(true));
        });

        // Get options
        const options = Array.from(selectDropdown.options)
            .filter(opt => opt.value)
            .map(opt => ({id: opt.value, name: opt.text}));

        let selected = Array.isArray(selectedIds) ? selectedIds.slice() : [];

        function renderTags() {
            tagRow.innerHTML = '';
            selected.forEach(id => {
                const obj = options.find(o => o.id == id);
                if (!obj) return;
                const tag = document.createElement('span');
                tag.className = 'college-tag';
                tag.textContent = obj.name;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'âœ•';
                removeBtn.type = 'button';
                removeBtn.className = 'remove-x';
                removeBtn.onclick = function() {
                    selected = selected.filter(sid => sid != id);
                    renderTags();
                };
                tag.appendChild(removeBtn);
                tagRow.appendChild(tag);
                // Hidden input for form submission
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = inputName + '[]';
                hidden.value = id;
                tagRow.appendChild(hidden);
            });
            // Add button
            if (selected.length < options.length) {
                // Filter dropdown options to exclude already selected
                Array.from(selectDropdown.options).forEach(opt => {
                    opt.style.display = selected.includes(opt.value) ? 'none' : '';
                });
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'add-college-btn';
                addBtn.innerHTML = '<svg width="16" height="16"><use href="#icon-add"></use></svg>';
                addBtn.onclick = function(e) {
                    e.stopPropagation();
                    selectDropdown.style.display = 'block';
                    selectDropdown.style.left = addBtn.offsetLeft + 'px';
                    selectDropdown.style.top = (addBtn.offsetTop + addBtn.offsetHeight) + 'px';
                    selectDropdown.size = Math.min(6, options.length - selected.length);
                    tagRow.appendChild(selectDropdown);
                    selectDropdown.focus();
                };
                tagRow.appendChild(addBtn);
            }
        }
        renderTags();
        selectDropdown.onchange = function() {
            const selectedId = selectDropdown.value;
            if (selectedId && !selected.includes(selectedId)) {
                selected.push(selectedId);
                renderTags();
            }
            selectDropdown.value = '';
            selectDropdown.style.display = 'none';
        };
        document.addEventListener('mousedown', function(e) {
            if (selectDropdown && !selectDropdown.contains(e.target) && (!e.target.classList || !e.target.classList.contains('add-college-btn'))) {
                selectDropdown.style.display = 'none';
            }
        });
    }

    // On modal open, initialize SDG tag UI with current SDGs
    document.addEventListener('DOMContentLoaded', function() {
        // Get selected SDG ids from data attribute
        var tagRow = document.getElementById('edit-sdgs-tag-row');
        var selectedSdgs = [];
        if (tagRow && tagRow.dataset.selectedSdgs) {
            selectedSdgs = tagRow.dataset.selectedSdgs.split(',').filter(Boolean);
        }
        setupTagUI('edit-sdgs-tag-row', 'edit-sdgs-options-template', 'sdgs', selectedSdgs);
        
        // Date validation for Edit Project
        const editStartDateInput = document.getElementById('edit_project_start_date');
        const editEndDateInput = document.getElementById('edit_project_end_date');
        
        if (editStartDateInput && editEndDateInput) {
            // No minimum date restriction for start_date since project may have already started
            
            // Update end date minimum when start date changes
            editStartDateInput.addEventListener('change', function() {
                if (this.value) {
                    editEndDateInput.setAttribute('min', this.value);
                    // If end date is before start date, clear it
                    if (editEndDateInput.value && editEndDateInput.value < this.value) {
                        editEndDateInput.value = '';
                    }
                }
            });
            
            // Set initial minimum for end date based on current start date
            if (editStartDateInput.value) {
                editEndDateInput.setAttribute('min', editStartDateInput.value);
            }
            
            // Validate on form submit
            const editForm = editStartDateInput.closest('form');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    let valid = true;
                    let firstError = null;
                    
                    // Remove previous errors
                    document.querySelectorAll('.field-validation-error').forEach(err => err.remove());
                    document.querySelectorAll('.error-input').forEach(field => field.classList.remove('error-input'));
                    
                    // Helper to show field error
                    function showError(field, message) {
                        const err = document.createElement('div');
                        err.className = 'field-validation-error';
                        err.textContent = message;
                        err.style.color = '#E53E3E';
                        err.style.fontSize = '0.95rem';
                        err.style.marginTop = '0.25rem';
                        err.style.marginLeft = '1rem';
                        err.style.alignSelf = 'center';
                        field.parentNode.appendChild(err);
                    }
                    
                    // Validate Title
                    const titleInput = document.getElementById('edit_project_title');
                    if (!titleInput || !titleInput.value.trim()) {
                        valid = false;
                        if (titleInput) {
                            titleInput.classList.add('error-input');
                            showError(titleInput, 'Title is required.');
                            if (!firstError) firstError = titleInput;
                        }
                    }
                    
                    // Validate Agenda
                    const agendaSelect = document.getElementById('edit_project_agenda');
                    if (!agendaSelect || !agendaSelect.value) {
                        valid = false;
                        if (agendaSelect) {
                            agendaSelect.classList.add('error-input');
                            showError(agendaSelect, 'Agenda is required.');
                            if (!firstError) firstError = agendaSelect;
                        }
                    }
                    
                    // Validate Project Type
                    const typeSelect = document.getElementById('edit_project_type');
                    if (!typeSelect || !typeSelect.value) {
                        valid = false;
                        if (typeSelect) {
                            typeSelect.classList.add('error-input');
                            showError(typeSelect, 'Project Type is required.');
                            if (!firstError) firstError = typeSelect;
                        }
                    }
                    
                    // Validate SDG tag row
                    const sdgTagRow = document.getElementById('edit-sdgs-tag-row');
                    const sdgTags = sdgTagRow ? sdgTagRow.querySelectorAll('input[type="hidden"]') : [];
                    if (sdgTags.length === 0) {
                        valid = false;
                        if (sdgTagRow) {
                            showError(sdgTagRow, 'At least one SDG is required.');
                            if (!firstError) firstError = sdgTagRow;
                        }
                    }
                    
                    // Validate Primary Beneficiary
                    const beneficiaryInput = document.getElementById('edit_project_beneficiary');
                    if (!beneficiaryInput || !beneficiaryInput.value.trim()) {
                        valid = false;
                        if (beneficiaryInput) {
                            beneficiaryInput.classList.add('error-input');
                            showError(beneficiaryInput, 'Primary Beneficiary is required.');
                            if (!firstError) firstError = beneficiaryInput;
                        }
                    }
                    
                    // Validate Estimated Events
                    const eventsInput = document.getElementById('edit_project_events');
                    if (!eventsInput || !eventsInput.value || eventsInput.value <= 0) {
                        valid = false;
                        if (eventsInput) {
                            eventsInput.classList.add('error-input');
                            showError(eventsInput, 'Expected Activities is required.');
                            if (!firstError) firstError = eventsInput;
                        }
                    }
                    
                    // Validate Primary Location
                    const locationInput = document.getElementById('edit_project_location');
                    if (!locationInput || !locationInput.value.trim()) {
                        valid = false;
                        if (locationInput) {
                            locationInput.classList.add('error-input');
                            showError(locationInput, 'Location is required.');
                            if (!firstError) firstError = locationInput;
                        }
                    }
                    
                    // Validate Estimated Trainees
                    const traineesInput = document.getElementById('edit_project_trainees');
                    if (!traineesInput || !traineesInput.value || traineesInput.value <= 0) {
                        valid = false;
                        if (traineesInput) {
                            traineesInput.classList.add('error-input');
                            showError(traineesInput, 'Expected Trained Individuals is required.');
                            if (!firstError) firstError = traineesInput;
                        }
                    }
                    
                    // Validate Start Date
                    if (!editStartDateInput || !editStartDateInput.value) {
                        valid = false;
                        if (editStartDateInput) {
                            editStartDateInput.classList.add('error-input');
                            showError(editStartDateInput, 'Start Date is required.');
                            if (!firstError) firstError = editStartDateInput;
                        }
                    }
                    
                    // Validate Estimated End Date
                    if (!editEndDateInput || !editEndDateInput.value) {
                        valid = false;
                        if (editEndDateInput) {
                            editEndDateInput.classList.add('error-input');
                            showError(editEndDateInput, 'Estimated End Date is required.');
                            if (!firstError) firstError = editEndDateInput;
                        }
                    } else if (editStartDateInput && editStartDateInput.value) {
                        const startDate = new Date(editStartDateInput.value);
                        const endDate = new Date(editEndDateInput.value);
                        if (endDate <= startDate) {
                            valid = false;
                            editEndDateInput.classList.add('error-input');
                            showError(editEndDateInput, 'Estimated end date must be after the start date.');
                            if (!firstError) firstError = editEndDateInput;
                        }
                    }
                    
                    if (!valid) {
                        e.preventDefault();
                        if (firstError) {
                            if (typeof firstError.focus === 'function') {
                                firstError.focus();
                            } else {
                                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }
                        return false;
                    }
                });
            }
        }
    });
</script>



{% endblock %}
