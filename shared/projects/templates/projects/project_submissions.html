{% extends "projects/base_project_profile.html" %}
{% block profile_content %}
{% load static %} 
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/view.css' %}" rel="stylesheet">

<div class="card-header">
    <div style="display:flex;align-items:center;gap:1rem;">
        <h3 style="margin:0;">Submissions</h3>
        <form method="get" id="status-filter-form" style="display:inline;">
            <select name="status" id="submission-filter" class="submission-dropdown user-details-value" onchange="this.form.submit()">
                <option value="">All Statuses</option>
                {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </form>
    </div>
    {% if request.user.role in ADMIN_ROLES and project.status != 'COMPLETED' %}
        <a href="{% url 'add_submission' project.id %}" class="admin-button edit">Add Submission</a>
    {% endif %}
</div>
<div class="card-body">
    {% if submissions %}
        <div class="submission-list">
            {% for sub in submissions %}
            <div class="submission-card submission-card-clickable" style="position:relative; cursor:pointer; width:100%" data-submission-id="{{ sub.id }}" data-submission-type="{{ sub.downloadable.submission_type }}" data-submission-status="{{ sub.status }}">
                <h4>{{ sub.downloadable.name }}</h4>
                <p>Assigned on: <strong>{{ sub.created_at|date:'M d, Y' }}</strong></p>
                {% if sub.notes %}<p title="{{ sub.notes }}"><strong>Notes:</strong> {{ sub.notes|truncatechars:50 }}</p>{% endif %}
                <div style="position:absolute; top:1.5rem; right:1.5rem; text-align:right;">
                    {% if sub.deadline %}
                        <span title="{{ sub.deadline|date:'Y-m-d H:i' }}">
                        {% if sub.deadline > now %}
                            <span style="color:#006400;font-weight:600;">{{ sub.deadline|timeuntil }} left</span>
                        {% elif sub.is_late_submission %}
                            <span style="color:#D5110A;font-weight:600;">Late Submission</span>
                        {% else %}
                            <span style="color:#555;font-weight:600;">Deadline Passed</span>
                        {% endif %}
                        </span>
                    {% endif %}
                    <br>
                    <span>{{ sub.get_status_display }}{% if sub.is_late_submission %} <span style="color:#D5110A;font-weight:600;">(Late)</span>{% endif %}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p style="color:#888;font-size:1.1rem;">No submissions found.</p>
    {% endif %}

    <!-- Pagination -->
    <div class="pagination-container">
        {% if page_obj.has_previous %}
            <a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page=1">First</a>
            <a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
        {% else %}
            <button class="pagination-button" disabled>First</button>
            <button class="pagination-button" disabled>Previous</button>
        {% endif %}

        {% for num in page_range %}
            {% if num == page_obj.number %}
                <button class="pagination-button active" disabled>{{ num }}</button>
            {% else %}
                <a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ num }}">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
            <a class="pagination-button" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ paginator.num_pages }}">Last</a>
        {% else %}
            <button class="pagination-button" disabled>Next</button>
            <button class="pagination-button" disabled>Last</button>
        {% endif %}

    </div>
</div>

<!-- Form -->
<style>
    .form-group {
		display: flex;
		align-items: flex-start;
		gap: 1rem;
        margin-bottom: 0.5rem;
	}

	.form-label {
		font-weight: 600;
		color: #374151;
		font-size: 0.95rem;
	}

    .required {
        color: #DC2626;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .submit-btn {
        background-color: #0A6C44;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
    }

    .submit-btn:hover {
        background-color: #07532F;
    }

    .back-btn {
        background-color: #E5E7EB;
        color: #374151;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
    }

    .back-btn:hover {
        background-color: #D1D5DB;
    }

    textarea {
        resize: none;
    }

    .submission-modal h2 {
        margin-top: 0;
        font-size: 1.5rem;
        color: #000;
        font-weight: 400;
    }

    input[type="text"], input[type="date"], textarea, input[type="file"], input[type="datetime-local"], input[type="number"] {
        flex: 1;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        padding: 0.75rem;
        font-size: 1rem;
        font-family: 'Inter', sans-serif;
    }

    select {
        flex: 1;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        padding: 0.75rem;
        font-size: 1rem;
        font-family: 'Inter', sans-serif;
		appearance: none;
		-webkit-appearance: none;
		-moz-appearance: none;
		padding-right: 2rem;
		background: url("data:image/svg+xml;utf8,<svg width='16' height='11' viewBox='0 0 16 11' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M7.99976 7.19417L13.9025 1.29147C14.0125 1.17758 14.144 1.08674 14.2895 1.02424C14.435 0.961746 14.5915 0.92885 14.7498 0.927474C14.9082 0.926098 15.0652 0.95627 15.2117 1.01623C15.3583 1.07619 15.4914 1.16473 15.6034 1.27669C15.7153 1.38866 15.8039 1.5218 15.8638 1.66835C15.9238 1.8149 15.954 1.97192 15.9526 2.13026C15.9512 2.28859 15.9183 2.44506 15.8558 2.59055C15.7933 2.73604 15.7025 2.86762 15.5886 2.97762L8.84283 9.72339C8.61921 9.94694 8.31596 10.0725 7.99976 10.0725C7.68356 10.0725 7.38031 9.94694 7.15669 9.72339L0.41092 2.97762C0.297028 2.86762 0.206183 2.73604 0.143687 2.59055C0.0811915 2.44506 0.0482959 2.28859 0.04692 2.13026C0.0455441 1.97192 0.0757155 1.8149 0.135674 1.66835C0.195632 1.5218 0.284176 1.38866 0.39614 1.27669C0.508103 1.16473 0.641244 1.07619 0.787794 1.01623C0.934343 0.95627 1.09137 0.926098 1.2497 0.927474C1.40804 0.92885 1.56451 0.961746 1.71 1.02424C1.85548 1.08674 1.98706 1.17758 2.09706 1.29147L7.99976 7.19417Z' fill='%23374151'/></svg>")
        		no-repeat right 0.75rem center;
  		background-size: 13px 8px;
    }
</style>

<!-- Submission [Final] -->
<div id="modal-final" class="submission-modal" style="display:none;">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 style="margin-bottom:1rem;">Final Submission</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="submission_id" value="{{ submission.id }}" />
            <input type="hidden" name="action" value="submit" />
            <div class="form-group">
                <label class="form-label">File:</label>
                <input type="file" name="final_file" required accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
            </div>

            <div class="form-group">
                <label><input type="checkbox" name="for_product_production"> For Product Production</label><br>
                <label><input type="checkbox" name="for_research"> For Research</label><br>
                <label><input type="checkbox" name="for_extension"> For Extension</label>
            </div>

            <div class="form-actions" style="justify-content:flex-end;">
                <button type="button" class="back-btn">Cancel</button>
                <button type="submit" class="submit-btn">Submit</button>
            </div>
        </form>
    </div>
</div>

<!-- Submission [Event] -->
<div id="modal-event" class="submission-modal" style="display:none;">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 style="margin-bottom:1rem;">Event Submission</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="submission_id" value="{{ submission.id }}" />
            <input type="hidden" name="action" value="submit" />
            <div class="form-group">
                <label class="form-label">Event <span class="required">*</span></label><br>
                <select name="event" required>
                    <option value="" disabled selected>Select event</option>
                    {% for event in events %}
                        <option value="{{ event.id }}">{{ event.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">No. of Trained Individuals <span class="required">*</span></label><br>
                <input type="number" name="num_trained_individuals" min="0" required>
            </div>
            <div class="form-group">
                <label class="form-label">Image File <span class="required">*</span></label><br>
                <input type="file" name="image_event" accept="image/jpeg,image/png,image/jpg,image/gif,image/webp,application/pdf" required>
            </div>
            <div class="form-group">
                <label class="form-label">Description of Picture <span class="required">*</span></label><br>
                <textarea name="image_description" rows="3" required></textarea>
            </div>

            <div class="form-actions" style="justify-content:flex-end;">
                <button type="button" class="back-btn">Cancel</button>
                <button type="submit" class="submit-btn">Submit</button>
            </div>
        </form>
    </div>
</div>

<!-- Submission [File] -->
<div id="modal-file" class="submission-modal" style="display:none;">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 style="margin-bottom:1rem;">File Submission</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="submission_id" value="{{ submission.id }}" />
            <input type="hidden" name="action" value="submit" />
            <div class="form-group">
                <label class="form-label">File <span class="required">*</span></label>
                <input type="file" name="file_file" required accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
            </div>

            <div class="form-actions" style="justify-content:flex-end;">
                <button type="button" class="back-btn">Cancel</button>
                <button type="submit" class="submit-btn">Submit</button>
            </div>
        </form>
    </div>
</div>


<!-- Confirmation Modals -->
<div id="modal-bg-action" class="modal-bg" style="display:none;">
    <div class="modal" id="modal-confirm-revision" style="display:none;">
        <div class="modal-title">Confirm Request Revision</div>
        <div class="modal-content">Are you sure you want to request a revision for this submission?</div>
        <form method="post" style="width:100%;">
            {% csrf_token %}
            <input type="hidden" name="submission_id" value="" />
            <input type="hidden" name="action" value="request_revision" />
            <div class="modal-actions">
                <button type="button" class="back-btn" id="cancel-revision">Cancel</button>
                <button type="submit" class="submit-btn" style="background:#f59e42;">Request Revision</button>
            </div>
        </form>
    </div>
    <div class="modal" id="modal-confirm-forward" style="display:none;">
        <div class="modal-title">Confirm Forward to UESO</div>
        <div class="modal-content">Are you sure you want to forward this submission to UESO?</div>
        <form method="post" style="width:100%;">
            {% csrf_token %}
            <input type="hidden" name="submission_id" value="" />
            <input type="hidden" name="action" value="forward_to_ueso" />
            <div class="modal-actions">
                <button type="button" class="back-btn" id="cancel-forward">Cancel</button>
                <button type="submit" class="submit-btn" style="background:#0A6C44;">Forward to UESO</button>
            </div>
        </form>
    </div>
    <div class="modal" id="modal-confirm-reject" style="display:none;">
        <div class="modal-title">Confirm Reject</div>
        <div class="modal-content">Are you sure you want to reject this submission?</div>
        <form method="post" style="width:100%;">
            {% csrf_token %}
            <input type="hidden" name="submission_id" value="" />
            <input type="hidden" name="action" value="reject" />
            <div class="modal-actions">
                <button type="button" class="back-btn" id="cancel-reject">Cancel</button>
                <button type="submit" class="submit-btn" style="background:#dc2626;">Reject</button>
            </div>
        </form>
    </div>
    <div class="modal" id="modal-confirm-accept" style="display:none;">
        <div class="modal-title">Confirm Accept</div>
        <div class="modal-content">Are you sure you want to accept this submission?</div>
        <form method="post" style="width:100%;">
            {% csrf_token %}
            <input type="hidden" name="submission_id" value="" />
            <input type="hidden" name="action" value="accept" />
            <div class="modal-actions">
                <button type="button" class="back-btn" id="cancel-accept">Cancel</button>
                <button type="submit" class="submit-btn" style="background:#0A6C44;">Accept</button>
            </div>
        </form>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Action confirmation modal logic
        function showActionModal(which, subId) {
            document.getElementById('modal-bg-action').style.display = 'flex';
            ['modal-confirm-revision','modal-confirm-forward','modal-confirm-reject','modal-confirm-accept'].forEach(function(mid){
                document.getElementById(mid).style.display = (mid === which) ? 'flex' : 'none';
            });
            // Set submission_id in the modal form
            var modal = document.getElementById(which);
            if (modal) {
                modal.querySelectorAll('input[name="submission_id"]').forEach(function(inp){ inp.value = subId; });
            }
        }
        function hideActionModal() {
            document.getElementById('modal-bg-action').style.display = 'none';
            ['modal-confirm-revision','modal-confirm-forward','modal-confirm-reject','modal-confirm-accept'].forEach(function(mid){
                document.getElementById(mid).style.display = 'none';
            });
        }
        // Fix: Always redirect to details page when clicking submission cards
        document.querySelectorAll('.submission-card-clickable').forEach(function(card) {
            card.addEventListener('click', function() {
                var type = card.getAttribute('data-submission-type');
                var status = card.getAttribute('data-submission-status');
                var subId = card.getAttribute('data-submission-id');
                
                // Always redirect to submission details
                window.location.href = '/projects/{{ project.id }}/submission/' + subId + '/';
            });
        });

        // Hide modal when clicking outside
        document.getElementById('modal-bg-action').addEventListener('click', function(e) {
            if (e.target === this) hideActionModal();
        });
        // Close modal on X
        document.querySelectorAll('.close-modal').forEach(function(btn) {
            btn.addEventListener('click', function() {
                btn.closest('.submission-modal').style.display = 'none';
            });
        });
        // Close modal on Cancel button
        document.querySelectorAll('.back-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                btn.closest('.submission-modal').style.display = 'none';
            });
        });
        // Close modal on clicking outside modal-content
        document.querySelectorAll('.submission-modal').forEach(function(modal) {
            modal.addEventListener('mousedown', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
        // Close modal on Escape key
        window.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.submission-modal').forEach(function(modal) {
                    modal.style.display = 'none';
                });
            }
        });
    });


    // Success Toast
	document.addEventListener('DOMContentLoaded', function() {
		const urlParams = new URLSearchParams(window.location.search);
		const success = urlParams.get('success');
		const action = urlParams.get('action');
		const title = urlParams.get('title');

		if (success === 'true' && action) {
			const actionMessages = {
				'submit': 'Submission Submitted Successfully!',
				'unsubmit': 'Submission Unsubmitted Successfully!',
				'forward': 'Submission Forwarded Successfully!',
				'request_revision': 'Revision Requested Successfully!',
				'accept': 'Submission Accepted Successfully!',
				'reject': 'Submission Rejected Successfully!',
				'deleted': 'Submission Requirement Deleted Successfully!'
			};

			const message = actionMessages[action] || 'Action Completed Successfully!';
			const bgColor = action === 'deleted' ? '#ef4444' : '#10b981';
			const icon = action === 'deleted' ? 'fa-trash-can' : 'fa-check-circle';

			const toast = document.createElement('div');
			toast.id = 'successToast';
			toast.style.cssText = `display:block;position:fixed;top:20px;right:20px;background:${bgColor};color:white;padding:1rem 1.5rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:10000;font-size:1rem;font-weight:500;min-width:300px;`;
			toast.innerHTML = `
				<div style="display:flex;align-items:center;gap:0.75rem;">
					<i class="fa-solid ${icon}" style="font-size:1.5rem;"></i>
					<div>
						<div style="font-weight:600;margin-bottom:0.25rem;">${message}</div>
						<div style="font-size:0.875rem;opacity:0.9;">${title ? decodeURIComponent(title) : 'Submission'}</div>
					</div>
				</div>
			`;
			document.body.appendChild(toast);

			// Auto-hide after 4 seconds
			setTimeout(function() {
				toast.style.opacity = '0';
				toast.style.transition = 'opacity 0.3s';
				setTimeout(function() {
					toast.remove();
					// Clean URL
					window.history.replaceState({}, document.title, window.location.pathname);
				}, 300);
			}, 4000);
		}

	});
</script>

{% endblock %}