{% extends "projects/base_project_profile.html" %}
{% block profile_content %}
{% load static humanize %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/view.css' %}" rel="stylesheet">

<div class="card-header">
    <h3>Expenses</h3>
    {% if request.user.role in ADMIN_ROLES or request.user == project.project_leader or request.user in project.providers.all %}
      <button type="button" id="openExpense" class="admin-button edit">Add Expense</button>
    {% endif %}
</div>

<div class="project-grid">
  <section>
    <div class="donut-wrap">
      <div class="chart-container" style="width:16rem;height:16rem">
        <canvas id="expenseDonut" width="256" height="256" data-percentage="{{ percent_remaining|default:0 }}"></canvas>
      </div>
      {% if remaining_total is not None %}
        <div class="cash-available">Current Budget: <strong>₱ {{ remaining_total|floatformat:2|intcomma }}</strong></div>
      {% endif %}
    </div>
  </section>
  <section>
    <div class="expense-card">
      <div class="expense-header">
        <div>Reason</div>
        <div class="expense-amount">Amount</div>
        <div class="expense-date">Date</div>
      </div>
      <div class="expense-body" id="expensesBody">
        {% for expense in expenses %}
          <div class="expense-row">
            <div class="expense-reason">{{ expense.title|default:expense.reason }}</div>
            <div class="expense-amount">₱ {{ expense.amount|floatformat:2|intcomma }}</div>
            <div class="expense-date">{{ expense.date_incurred|date:"m/d/Y" }}</div>
          </div>
        {% empty %}
          <div class="expense-empty">No expenses recorded yet.</div>
        {% endfor %}
      </div>
    </div>
  </section>
</div>

<div class="submission-modal" id="overlay">
  <div class="modal-content">
    <h2>Add Expense</h2>

    <form class="expenseForm" id="expenseForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.7rem">
        <div class="form-field-col">
          <label class="form-label">Reason <span class="required">*</span></label>
          {# Retain value if post failed #}
          <input type="text" name="reason" placeholder="Meals" required aria-required="true" class="user-details-value" value="{{ request.POST.reason }}">
        </div>
        <div class="form-field-col">
          <label class="form-label">Total Expense (₱) <span class="required">*</span></label>
          {# Added ID for JS targeting #}
          <input type="number" name="amount" id="expenseAmountInput" step="0.01" placeholder="100.00" required aria-required="true" class="user-details-value" value="{{ request.POST.amount }}">
        </div>
      </div>
      <div class="form-field-col">
        <label class="form-label">Upload Receipt <span class="required">*</span></label>
        <div style="width: 100%;">
            {# Renamed ID to 'receipt' for consistency, and set file types #}
            <div class="upload-area" onclick="document.getElementById('receipt').click()">
                <svg class="icon-upload" width="24" height="24"><use href="#icon-upload"></use></svg>
                <span class="upload-text">Click to upload</span>
                {# FIX: Corrected ID to 'receipt' and limited accept types #}
                <input style="display: none;" type="file" name="receipt" id="receipt" required accept="image/*,.pdf">
            </div>
            <div class="file-preview" id="file-preview" style="display: none; margin-top: 0.75rem;">
                <div class="file-info">
                    <svg width="16" height="16"><use href="#icon-upload"></use></svg>
                    <span id="file-name"></span>
                </div>
            </div> 
        </div>
      </div>
      <div class="form-field-col">
        <label class="form-label">Notes <span class="required">*</span></label>
        {# Retain value if post failed #}
        <textarea name="notes" rows="3" placeholder="(e.g. Bento box)" required aria-required="true" class="user-details-value">{{ request.POST.notes }}</textarea>
      </div>
      <div class="form-actions" style="justify-content: center; gap: 0.7rem;">
        <button type="submit" class="admin-button save" >Save</button>
        <button type="button" id="closeOverlay" class="admin-button not">Cancel</button>
      </div>
    </form>
  </div>
</div>

<svg style="display:none;" xmlns="http://www.w3.org/2000/svg">

    <symbol id="icon-add" viewBox="0 0 16 16" fill="currentColor">
        <path d="M6.80039 14.4004C6.80039 14.7187 6.92682 15.0239 7.15186 15.2489C7.37691 15.474 7.68213 15.6004 8.00039 15.6004C8.31865 15.6004 8.62388 15.474 8.84892 15.2489C9.07396 15.0239 9.20039 14.7187 9.20039 14.4004V9.20039H14.4004C14.7187 9.20039 15.0239 9.07396 15.2489 8.84892C15.474 8.62388 15.6004 8.31865 15.6004 8.00039C15.6004 7.68213 15.474 7.37691 15.2489 7.15186C15.0239 6.92682 14.7187 6.80039 14.4004 6.80039H9.20039V1.60039C9.20039 1.28213 9.07396 0.976906 8.84892 0.751863C8.62388 0.526819 8.31865 0.400391 8.00039 0.400391C7.68213 0.400391 7.37691 0.526819 7.15186 0.751863C6.92682 0.976906 6.80039 1.28213 6.80039 1.60039V6.80039H1.60039C1.28213 6.80039 0.976906 6.92682 0.751863 7.15186C0.526819 7.37691 0.400391 7.68213 0.400391 8.00039C0.400391 8.31865 0.526819 8.62388 0.751863 8.84892C0.976906 9.07396 1.28213 9.20039 1.60039 9.20039H6.80039V14.4004Z" fill="black"/>
    </symbol>

    <symbol id="icon-edit" viewBox="0 0 18 18" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
    <path d="M2 16H3.425L13.2 6.225L11.775 4.8L2 14.575V16ZM1 18C0.716667 18 0.479333 17.904 0.288 17.712C0.0966668 17.52 0.000666667 17.2827 0 17V14.575C0 14.3083 0.0500001 14.054 0.15 13.812C0.25 13.57 0.391667 13.3577 0.575 13.175L13.2 0.575C13.4 0.391667 13.621 0.25 13.863 0.15C14.105 0.0500001 14.359 0 14.625 0C14.891 0 15.1493 0.0500001 15.4 0.15C15.6507 0.25 15.8673 0.4 16.05 0.6L17.425 2C17.625 2.18333 17.7707 2.4 17.862 2.65C17.9533 2.9 17.9993 3.15 18 3.4C18 3.66667 17.954 3.921 17.862 4.163C17.77 4.405 17.6243 4.62567 17.425 4.825L4.825 17.425C4.64167 17.6083 4.429 17.75 4.187 17.85C3.945 17.95 3.691 18 3.425 18H1ZM12.475 5.525L11.775 4.8L13.2 6.225L12.475 5.525Z" fill="black"/>
    </symbol>

    <symbol id="icon-upload" viewBox="0 0 24 24" fill="currentColor">
        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
        <path d="M12,11L8,15H16L12,11Z" />
    </symbol>

</svg>

<script>
  // Donut chart
  (function(){
    const canvas = document.getElementById('expenseDonut');
    if (!canvas || !window.Chart) return;
    let value = Number(canvas.getAttribute('data-percentage')) || 0;
    value = Math.max(0, Math.min(100, Math.round(value)));
    
    // MODIFICATION 1: Center Text Plugin - Increased font size to 36px
    const centerText = { 
      id: 'centerText', 
      afterDraw(chart){ 
        const {ctx, chartArea:{left,right,top,bottom}} = chart; 
        const x=(left+right)/2, y=(top+bottom)/2; 
        ctx.save(); 
        // Font size increased for a bigger percentage text
        ctx.font='bold 36px Arial'; 
        ctx.fillStyle='#111'; 
        ctx.textAlign='center'; 
        ctx.textBaseline='middle'; 
        ctx.fillText(`${value}%`, x, y); 
        ctx.restore(); 
      } 
    };

    new Chart(canvas.getContext('2d'), { 
      type:'doughnut', 
      data:{ 
        datasets:[{ 
          data:[value, Math.max(0,100-value)], 
          // MODIFICATION 2: Background Colors - 0.7 transparency (RGBA)
          backgroundColor:['rgba(16, 185, 129, 0.7)','rgba(17, 17, 17, 0.7)'], 
          // MODIFICATION 3: Border - Added solid border width 2
          borderColor: ['#10b981', '#111111'], 
          borderWidth: 2 
        }] 
      }, 
      options:{ 
        rotation:-90, 
        circumference:360, 
        responsive:true, 
        maintainAspectRatio:false, 
        cutout:'65%', 
        plugins:{ 
          legend:{display:false}, 
          tooltip:{enabled:false} 
        } 
      }, 
      plugins:[centerText] 
    });
  })();

  // Overlay open/close (triggered by header button)
  (function(){
    const headerBtn = document.getElementById('openExpense');
    const overlay = document.getElementById('overlay');
    const closeBtn = document.getElementById('closeOverlay');
    const closeX = document.getElementById('closeX');
    const expenseAmountInput = document.getElementById('expenseAmountInput');
    const errorMessageDiv = document.getElementById('budgetErrorMessage'); 

    const closeOverlay = () => {
        overlay.style.display = 'none';
        if (expenseAmountInput) {
            expenseAmountInput.classList.remove('error-input');
        }
    };
    
    const openOverlay = () => {
        overlay.style.display = 'flex';
    };

    if (errorMessageDiv) {
        openOverlay();
        const errorText = errorMessageDiv.textContent || errorMessageDiv.innerText;
        if (expenseAmountInput && (errorText.includes('budget') || errorText.includes('exceeds'))) {
            expenseAmountInput.classList.add('error-input');
        }
    }

    if (headerBtn) headerBtn.addEventListener('click', openOverlay);
    if (closeBtn) closeBtn.addEventListener('click', closeOverlay);
    if (closeX) closeX.addEventListener('click', closeOverlay);

    // FIX: Upload functionality to correctly target the 'receipt' input for preview.
    const fileInput = document.getElementById('receipt');
    const fileNameDisplay = document.getElementById('file-name');
    const filePreview = document.getElementById('file-preview');
    const uploadText = document.querySelector('.upload-text');

    // Show preview if file exists after a failed POST (due to server-side errors)
    if (fileInput && fileInput.files.length > 0) {
        const file = fileInput.files[0];
        fileNameDisplay.textContent = file.name;
        filePreview.style.display = 'flex';
        uploadText.textContent = 'Change file';
        uploadText.style.color = '#1a4a2e';
    }

    if (fileInput) {
        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                fileNameDisplay.textContent = file.name;
                filePreview.style.display = 'flex'; // Show the preview area
                uploadText.textContent = 'Change file'; // Update prompt text
                uploadText.style.color = '#1a4a2e';
            } else {
                fileNameDisplay.textContent = '';
                filePreview.style.display = 'none'; // Hide if no file is selected
                uploadText.textContent = 'Click to upload'; // Reset prompt text
                uploadText.style.color = '';
            }
        });
    }
  })();
</script>

{% endblock %}