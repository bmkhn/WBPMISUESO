{% extends "projects/base_project_profile.html" %}
{% block profile_content %}
{% load static %} 
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/view.css' %}" rel="stylesheet">


<div class="card-header">
    <h3>Expenses</h3>
    {% if is_project_member and not project.has_final_submission %}
        <button class="admin-button edit" type="button" id="openAddExpenseModal">Add Expense</button>
    {% endif %}
</div>

<div class="card-body">
    <div class="table-container">
        <table class="user-table">
            <thead>
                <tr>
                    <th>Reason</th>
                    <th>Description</th>
                    <th style="text-align: center;">Amount</th>
                    <th style="text-align: center;">Date</th>
                    <th style="text-align: center;">Receipt</th>
                    <th style="text-align: center;">Added By</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr>
                    <td>{{ expense.reason }}</td>
                    <td>{{ expense.description|default:"—" }}</td>
                    <td style="text-align: center;">₱{{ expense.amount|floatformat:2 }}</td>
                    <td style="text-align: center;">{{ expense.expense_date|date:'M d, Y' }}</td>
                    <td style="text-align: center;">
                        {% if expense.receipt_img %}
                            <a href="{{ expense.receipt_img.url }}" target="_blank" class="name-link" style="text-decoration: none;">
                                <i class="fa-solid fa-receipt" style="color:#0A6C44;"></i> View
                            </a>
                        {% else %}
                            <span style="color:#aaa;font-size:0.95rem;">No receipt</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        {% if expense.created_by %}
                            <a href="{% url 'user_profile' expense.created_by.id %}" class="name-link">
                                {{ expense.created_by.get_full_name|default:expense.created_by.username }}
                            </a>
                        {% else %}
                            <span style="color:#aaa;">Unknown</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" style="text-align:center;color:#888;font-size:1.1rem;padding:2rem;">No expenses found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Expense Modal -->
{% if is_project_member and not project.has_final_submission %}
<div id="add-expense-modal" class="event-modal modal" style="display:none;">
    <div class="event-modal-content">
        <span class="close" onclick="document.getElementById('add-expense-modal').style.display='none'">&times;</span>
        <h2 style="margin-bottom:1.5rem;">Add Expense</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label class="form-label">Reason<span class="required">*</span></label>
                <input class="user-details-value" type="text" name="reason" required placeholder="e.g., Venue Rental, Equipment Purchase">
            </div>
            <div class="form-group">
                <label class="form-label">Amount (₱)<span class="required">*</span></label>
                <input class="user-details-value" type="number" name="amount" step="0.01" min="0" required placeholder="0.00">
            </div>
            <div class="form-group">
                <label class="form-label">Expense Date<span class="required">*</span></label>
                <input class="user-details-value" type="date" name="expense_date" required>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="user-details-value" name="description" rows="3" placeholder="Additional details about the expense (optional)"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Receipt Image</label>
                <input class="user-details-value" type="file" name="receipt_img" accept="image/*">
                <small style="color:#666;font-size:0.85rem;display:flex;align-items:center;margin-left:1rem;">Upload a photo or scan of the receipt (optional)</small>
            </div>
            <div class="form-actions" style="justify-content:flex-end;margin-top:1.5rem;">
                <button type="button" class="back admin-button" onclick="document.getElementById('add-expense-modal').style.display='none'">Cancel</button>
                <button type="submit" class="save admin-button">Add Expense</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Open Add Expense Modal
    document.getElementById('openAddExpenseModal').onclick = function() {
        document.getElementById('add-expense-modal').style.display = 'flex';
    };

    // Close modal when clicking outside
    document.getElementById('add-expense-modal').onclick = function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    };
</script>
{% endif %}

{% endblock %}
