{% extends "projects/base_project_profile.html" %}
{% block profile_content %}
{% load static humanize %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/view.css' %}" rel="stylesheet">

<style>
    .project-grid{display:grid;grid-template-columns:1fr 1.3fr;gap:1rem;margin-top:2rem}
    .chart-container{width:100%;height:260px}
    .expense-card{background:#fff;border:1px solid #e5e7eb;border-radius:.8rem;overflow:hidden;box-shadow:0 1px 2px rgba(0,0,0,0.04);width:100%;font-size:.9rem}
    .expense-header,.expense-row{display:grid;grid-template-columns:minmax(240px,1fr) 150px 170px;column-gap:10px;align-items:center}
    .expense-header{background:#f7f8fa;color:#111;font-weight:600;padding:.6rem .8rem;border-bottom:1px solid #e5e7eb}
    .expense-row{padding:.6rem .8rem;border-bottom:1px solid #eef0f3}
    .expense-row:last-child{border-bottom:none}
    .expense-reason{word-break:break-word;white-space:normal}
    .expense-amount,.expense-date{text-align:right;white-space:nowrap}
    .expense-empty{padding:1rem;color:#6b7280}
    .donut-wrap{display:flex;flex-direction:column;align-items:center;gap:.5rem}
    .cash-available{font-size:1.05rem}
    
    /* --- NEW STYLES FOR ERROR HANDLING --- */
    .error-input {
      border: 2px solid #dc2626 !important; /* Red border for amount input */
    }
    .form-error-message {
      background: #fee2e2; /* Light red background */
      color: #dc2626;      /* Darker red text */
      padding: .75rem;
      border-radius: .5rem;
      margin-bottom: 1rem;
      font-weight: 500;
      /* Hidden by default, displayed by Django messages or JS */
    }
    /* -------------------------------------- */
</style>

<div class="card-header">
    <h3>Expenses</h3>
    {% if request.user.role in ADMIN_ROLES or request.user == project.project_leader or request.user in project.providers.all %}
      <button type="button" id="openExpense" class="admin-button edit">Add Expense</button>
    {% endif %}
</div>

<div class="project-grid">
  <section>
    <div class="donut-wrap">
      <div class="chart-container" style="width:16rem;height:16rem">
        <canvas id="expenseDonut" width="256" height="256" data-percentage="{{ percent_remaining|default:0 }}"></canvas>
      </div>
      {% if remaining_total is not None %}
        <div class="cash-available">Current Budget: <strong>₱ {{ remaining_total|floatformat:2|intcomma }}</strong></div>
      {% endif %}
    </div>
  </section>
  <section>
    <div class="expense-card">
      <div class="expense-header">
        <div>Reason</div>
        <div class="expense-amount">Amount</div>
        <div class="expense-date">Date</div>
      </div>
      <div class="expense-body" id="expensesBody">
        {% for expense in expenses %}
          <div class="expense-row">
            <div class="expense-reason">{{ expense.title|default:expense.reason }}</div>
            <div class="expense-amount">₱ {{ expense.amount|floatformat:2|intcomma }}</div>
            <div class="expense-date">{{ expense.date_incurred|date:"m/d/Y" }}</div>
          </div>
        {% empty %}
          <div class="expense-empty">No expenses recorded yet.</div>
        {% endfor %}
      </div>
    </div>
  </section>
</div>

{# Real overlay with form posting to this URL #}
<div class="overlay" id="overlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5)">
  <div class="overlay-content" style="background:#fff;border-radius:1rem;padding:1.25rem;width:45rem;max-width:95%;position:relative">
    <button type="button" class="close-x" id="closeX" aria-label="Close" style="position:absolute;right:1rem;top:1rem;background:none;border:none;font-size:1.5rem;cursor:pointer">&times;</button>
    <h2 style="margin:0 0 1rem 0;font-weight:500">Add Expense</h2>
    
    {# --- Django Messages container for Errors (will automatically open modal via JS) --- #}
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'error' %}
                <div class="form-error-message active" id="budgetErrorMessage">
                    <p>{{ message }}</p>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}
    {# -------------------------------------------------------------------------------- #}

    <form class="expenseForm" id="expenseForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        <div style="display:flex;flex-direction:column">
          <label style="font-weight:500;margin-bottom:.25rem">Reason <span style="color:#dc2626">*</span></label>
          {# Retain value if post failed #}
          <input type="text" name="reason" placeholder="Meals" required aria-required="true" style="padding:.8rem;border:1px solid #868686;border-radius:.5rem;background:#e9e9e9" value="{{ request.POST.reason }}">
        </div>
        <div style="display:flex;flex-direction:column">
          <label style="font-weight:500;margin-bottom:.25rem">Total Expense (₱) <span style="color:#dc2626">*</span></label>
          {# Added ID for JS targeting #}
          <input type="number" name="amount" id="expenseAmountInput" step="0.01" placeholder="100.00" required aria-required="true" style="padding:.8rem;border:1px solid #868686;border-radius:.5rem;background:#e9e9e9" value="{{ request.POST.amount }}">
        </div>
      </div>
      <div style="margin-top:1rem;display:flex;flex-direction:column">
        <label style="font-weight:500;margin-bottom:.25rem">Upload Receipt <span style="color:#dc2626">*</span></label>
        <div id="uploadBox" class="upload-container" style="background:#f8f9fa;border:2px dashed #245F3E;padding:1.25rem;display:flex;align-items:center;border-radius:.75rem;cursor:pointer">
          <input id="receipt" name="receipt" type="file" accept="image/*,.pdf" required aria-required="true" style="display:none" />
          <span id="uploadText" style="font-weight:600;color:#245F3E">Click to upload</span>
        </div>
      </div>
      <div style="margin-top:1rem;display:flex;flex-direction:column">
        <label style="font-weight:500;margin-bottom:.25rem">Notes <span style="color:#dc2626">*</span></label>
        {# Retain value if post failed #}
        <textarea name="notes" rows="3" placeholder="(e.g. Bento box)" required aria-required="true" style="padding:.8rem;border:1px solid #868686;border-radius:.5rem;background:#e9e9e9">{{ request.POST.notes }}</textarea>
      </div>
      <div style="margin-top:1rem;display:flex;gap:.75rem">
        <button type="submit" class="btn" style="background:#245F3E;color:#fff;border:none;border-radius:.5rem;padding:.6rem 1rem;cursor:pointer">Save</button>
        <button type="button" id="closeOverlay" style="background:#6b7280;color:#fff;border:none;border-radius:.5rem;padding:.6rem 1rem;cursor:pointer">Cancel</button>
      </div>
    </form>
  </div>
  
</div>

<script>
  // Donut chart
  (function(){
    const canvas = document.getElementById('expenseDonut');
    if (!canvas || !window.Chart) return;
    let value = Number(canvas.getAttribute('data-percentage')) || 0;
    value = Math.max(0, Math.min(100, Math.round(value)));
    const centerText = { id: 'centerText', afterDraw(chart){ const {ctx, chartArea:{left,right,top,bottom}} = chart; const x=(left+right)/2, y=(top+bottom)/2; ctx.save(); ctx.font='bold 18px Arial'; ctx.fillStyle='#111'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(`${value}%`, x, y); ctx.restore(); } };
    new Chart(canvas.getContext('2d'), { type:'doughnut', data:{ datasets:[{ data:[value, Math.max(0,100-value)], backgroundColor:['#10b981','#111111'], borderWidth:0 }] }, options:{ rotation:-90, circumference:360, responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{ legend:{display:false}, tooltip:{enabled:false} } }, plugins:[centerText] });
  })();

  // Overlay open/close (triggered by header button)
  (function(){
    const headerBtn = document.getElementById('openExpense');
    const overlay = document.getElementById('overlay');
    const closeBtn = document.getElementById('closeOverlay');
    const closeX = document.getElementById('closeX');
    // ID added to target the amount input
    const expenseAmountInput = document.getElementById('expenseAmountInput');
    // Check for the presence of a server-side error message
    const errorMessageDiv = document.getElementById('budgetErrorMessage'); 

    // Function to close the overlay
    const closeOverlay = () => {
        overlay.style.display = 'none';
        // Clear red border on close
        if (expenseAmountInput) {
            expenseAmountInput.classList.remove('error-input');
        }
    };
    
    // Function to open the overlay
    const openOverlay = () => {
        overlay.style.display = 'flex';
    };

    // 1. Initial State Check: If an error message is present after a redirect, open the modal
    if (errorMessageDiv) {
        openOverlay();
        // 2. Highlight Input: If the error is present and related to budget (assuming the view sends a budget-related error message), highlight the amount field.
        // We assume the error message text from the view will contain 'budget' or 'exceeds'.
        const errorText = errorMessageDiv.textContent || errorMessageDiv.innerText;
        if (expenseAmountInput && (errorText.includes('budget') || errorText.includes('exceeds'))) {
            expenseAmountInput.classList.add('error-input');
        }
    }

    if (headerBtn) headerBtn.addEventListener('click', openOverlay);
    if (closeBtn) closeBtn.addEventListener('click', closeOverlay);
    if (closeX) closeX.addEventListener('click', closeOverlay);

    const uploadBox = document.getElementById('uploadBox');
    const receiptInput = document.getElementById('receipt');
    const uploadText = document.getElementById('uploadText');
    if (uploadBox && receiptInput){
      uploadBox.addEventListener('click', ()=> receiptInput.click());
      receiptInput.addEventListener('change', ()=>{
        const f = receiptInput.files && receiptInput.files[0];
        if (f && uploadText){ uploadText.textContent = f.name; uploadText.style.color = '#1a4a2e'; }
      });
    }
  })();
</script>

{% endblock %}