{% extends "base_internal.html" %}
{% block content %} 
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add Project</title>

<link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/styles.css' %}" rel="stylesheet">
</head>

<body>
<form method="post" enctype="multipart/form-data" id="addProjectForm">
    {% csrf_token %}
    <div class="user-details-container">
        <div class="user-details-title">
            <h2>
                Create New Extension Project
            </h2> 
            <p>Input all fields correctly and launch new project.</p>
        </div>

        {% if success %}
        <div id="add-success-msg" class="success-message">Project added successfully.</div>
        {% endif %}

        {% if form and form.errors %}
        <div class="error-message">
            <ul>
            {% for field, errors in form.errors.items %}
                {% for err in errors %}
                    <li><strong>{{ field|capfirst }}:</strong> {{ err }}</li>
                {% endfor %}
            {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="user-details-section">
            <div class="user-details-category">  
                <i class="fa-regular fa-address-card subtitle-icon"></i>
                Project Profile 
            </div>
            <div class="user-details-row cols-1">
                <div>
                    <div class="user-details-label">Title <span class="required">*</span></div>
                    <input type="text" name="title" class="user-details-value">
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Project Leader <span class="required">*</span></div>
                    <div id="project-leader-tag-row" class="college-row"></div>
                    <select id="project-leader-options-template" style="display:none;">
                        <option value="">Select Leader</option>
                        {% for user in faculty_users %}
                        <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <div class="user-details-label">Provider/s (Members)</div>
                    <div id="providers-tag-row" class="college-row"></div>
                    <select id="providers-options-template" style="display:none;" multiple>
                        <option value="">Select Provider</option>
                        {% for user in provider_users %}
                        <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Agenda <span class="required">*</span></div>
                    <select name="agenda" class="user-details-value">
                        <option value="" selected disabled>Select Agenda</option>
                        {% for agenda in agendas %}
                        <option value="{{ agenda.id }}">{{ agenda.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <div class="user-details-label">Project Type <span class="required">*</span></div>
                    <select name="project_type" class="user-details-value">
                        <option value="" selected disabled>Select Type</option>
                        <option value="NEEDS_BASED">Needs Based</option>
                        <option value="RESEARCH_BASED">Research Based</option>
                    </select>
                </div>
            </div>

            <div class="user-details-row cols-1">
                <div>
                    <div class="user-details-label">Sustainable Development Goals <span class="required">*</span></div>
                    <div id="sdgs-tag-row" class="college-row"></div>
                    <select id="sdgs-options-template" style="display:none;" multiple>
                        <option value="">Select SDG</option>
                        {% for sdg in sdgs %}
                        <option value="{{ sdg.id }}">{{ sdg.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="user-details-section">
            <div class="user-details-category">
                <i class="fa-solid fa-gears"></i>
                Beneficiary
            </div>
            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Primary Beneficiary <span class="required">*</span></div>
                    <input type="text" name="primary_beneficiary" class="user-details-value">
                </div>
                <div>
                    <div class="user-details-label">No. of Estimated Events <span class="required">*</span></div>
                    <input type="number" name="estimated_events" class="user-details-value" min="0">
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Primary Location <span class="required">*</span></div>
                    <input type="text" name="primary_location" class="user-details-value">
                </div>
                <div>
                    <div class="user-details-label">No. of Estimated Trainees <span class="required">*</span></div>
                    <input type="number" name="estimated_trainees" class="user-details-value" min="0">
                </div>
            </div>
        </div>

        <div class="user-details-section">
            <div class="user-details-category">
                <i class="fa-solid fa-chart-simple"></i>
                Logistics
            </div>

            <!-- Logistics Type -->
            <div class="user-details-choice">
                <div class="user-details-label">
                    <span class="info-icon">    
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
                        </svg>
                    <span class="info-tooltip">Choose Internal if project is funded solely by PalSU, External if funded solely by a sponsor, and Both if funded by both.</span>
                </div>
                </span>
                <select name="logistics_type" class="user-details-value">
                    <option value="BOTH">Both</option>
                    <option value="INTERNAL">Internal</option>
                    <option value="EXTERNAL">External</option>
                </select><span class="required">*</span>
            </div>

            <!-- BOTH -->
            <div id="logistics-both" {% if logistics_type == 'BOTH' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">Internal Budget Assigned <span class="required">*</span></div>
                        <input type="number" name="internal_budget" class="user-details-value" min="0" step="0.01">
                    </div>
                    <div>
                        <div class="user-details-label">External Budget Assigned <span class="required">*</span></div>
                        <input type="number" name="external_budget" class="user-details-value" min="0" step="0.01">
                    </div>
                </div>

                <div class="user-details-row cols-1">
                    <div>
                        <div class="user-details-label">Sponsor Name <span class="required">*</span></div>
                        <input type="text" name="sponsor_name" class="user-details-value">
                    </div>
                </div>
            </div>

            <!-- Internal -->
            <div id="logistics-internal" {% if project.logistics_type == 'INTERNAL' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">Internal Budget Assigned <span class="required">*</span></div>
                        <input type="number" name="internal_budget" class="user-details-value" min="0" step="0.01">
                    </div>
                    <div></div>
                </div>
            </div>

            <!-- External -->
            <div id="logistics-external" {% if project.logistics_type == 'EXTERNAL' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">External Budget Assigned <span class="required">*</span></div>
                        <input type="number" name="external_budget" class="user-details-value" min="0" step="0.01">
                    </div>
                    <div>
                        <div class="user-details-label">Sponsor Name <span class="required">*</span></div>
                        <input type="text" name="sponsor_name" class="user-details-value">
                    </div>
                </div>
            </div>

            <!-- Date and Document Upload -->
            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Start Date <span class="required">*</span></div>
                    <input type="date" name="start_date" class="user-details-value">
                </div>
                <div>
                    <div class="user-details-label">Estimated End Date <span class="required">*</span></div>
                    <input type="date" name="estimated_end_date" class="user-details-value">
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="form-group">
                        <div class="user-details-label">Proposal Document <span class="required">*</span></div>
                        <div class="upload-area" onclick="document.getElementById('id_proposal_document').click()">
                            <svg class="upload-icon"><use href="#icon-upload"></use></svg>
                            <span class="upload-text">Click to upload</span>
                            <input class="file-input" type="file" name="proposal_document" id="id_proposal_document" style="display:none;" accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                        </div>
                    </div>
                    <div class="file-preview" id="proposal-file-preview" style="display:none;">
                        <div class="file-info" style="flex:1;">
                            <svg width="16" height="16"><use href="#icon-upload"></use></svg>
                            <span id="proposal-file-name"></span>
                        </div>
                        <button type="button" id="remove-proposal-file" class="remove-x">✕</button>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <div class="user-details-label">Additional Documents <span class="required">*</span></div>
                        <div class="upload-area" onclick="document.getElementById('id_additional_documents').click()">
                            <svg class="upload-icon"><use href="#icon-upload"></use></svg>
                            <span class="upload-text">Click to upload</span>
                            <input class="file-input" type="file" name="additional_documents" id="id_additional_documents" style="display:none;" multiple accept="*/*">
                        </div>
                    </div>
                    <div id="additional-files-list"></div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <a href="{% url 'project_dispatcher' %}" class="back btn">Cancel</a>
            <button type="submit" class="save btn">Add Project</button>
        </div>
    </div>
</form>


<!-- SVG Sprite Section -->
<svg style="display:none;" xmlns="http://www.w3.org/2000/svg">

    <!-- Add Icon -->
    <symbol id="icon-add" viewBox="0 0 16 16" fill="currentColor">
        <path d="M6.80039 14.4004C6.80039 14.7187 6.92682 15.0239 7.15186 15.2489C7.37691 15.474 7.68213 15.6004 8.00039 15.6004C8.31865 15.6004 8.62388 15.474 8.84892 15.2489C9.07396 15.0239 9.20039 14.7187 9.20039 14.4004V9.20039H14.4004C14.7187 9.20039 15.0239 9.07396 15.2489 8.84892C15.474 8.62388 15.6004 8.31865 15.6004 8.00039C15.6004 7.68213 15.474 7.37691 15.2489 7.15186C15.0239 6.92682 14.7187 6.80039 14.4004 6.80039H9.20039V1.60039C9.20039 1.28213 9.07396 0.976906 8.84892 0.751863C8.62388 0.526819 8.31865 0.400391 8.00039 0.400391C7.68213 0.400391 7.37691 0.526819 7.15186 0.751863C6.92682 0.976906 6.80039 1.28213 6.80039 1.60039V6.80039H1.60039C1.28213 6.80039 0.976906 6.92682 0.751863 7.15186C0.526819 7.37691 0.400391 7.68213 0.400391 8.00039C0.400391 8.31865 0.526819 8.62388 0.751863 8.84892C0.976906 9.07396 1.28213 9.20039 1.60039 9.20039H6.80039V14.4004Z" fill="black"/>
    </symbol>

    <!-- Edit Icon -->
    <symbol id="icon-edit" viewBox="0 0 18 18" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
    <path d="M2 16H3.425L13.2 6.225L11.775 4.8L2 14.575V16ZM1 18C0.716667 18 0.479333 17.904 0.288 17.712C0.0966668 17.52 0.000666667 17.2827 0 17V14.575C0 14.3083 0.0500001 14.054 0.15 13.812C0.25 13.57 0.391667 13.3577 0.575 13.175L13.2 0.575C13.4 0.391667 13.621 0.25 13.863 0.15C14.105 0.0500001 14.359 0 14.625 0C14.891 0 15.1493 0.0500001 15.4 0.15C15.6507 0.25 15.8673 0.4 16.05 0.6L17.425 2C17.625 2.18333 17.7707 2.4 17.862 2.65C17.9533 2.9 17.9993 3.15 18 3.4C18 3.66667 17.954 3.921 17.862 4.163C17.77 4.405 17.6243 4.62567 17.425 4.825L4.825 17.425C4.64167 17.6083 4.429 17.75 4.187 17.85C3.945 17.95 3.691 18 3.425 18H1ZM12.475 5.525L11.775 4.8L13.2 6.225L12.475 5.525Z" fill="black"/>
    </symbol>

    <!-- Upload Icon -->
    <symbol id="icon-upload" viewBox="0 0 24 24" fill="currentColor">
        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
        <path d="M12,11L8,15H16L12,11Z" />
    </symbol>

</svg>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Global error catcher for form submission
        var form = document.getElementById('addProjectForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Remove previous error states and messages
                let valid = true;
                // Remove all previous error states/messages for inputs, selects, textareas
                const fields = Array.from(form.querySelectorAll('input, select, textarea'));
                fields.forEach(field => {
                    field.classList.remove('error-input');
                    let err = field.parentNode.querySelector('.field-error');
                    if (err) err.remove();
                });
                // Remove custom errors for tag UIs and files
                function removeError(tagRow, errorId) {
                    let err = document.getElementById(errorId);
                    if (err) err.remove();
                    if (tagRow) tagRow.classList.remove('error-input');
                }
                removeError(document.getElementById('project-leader-tag-row'), 'leader-error');
                removeError(document.getElementById('sdgs-tag-row'), 'sdgs-error');
                removeError(document.getElementById('id_proposal_document'), 'proposal-error');
                removeError(document.getElementById('id_additional_documents'), 'additional-error');

                // Validate all required fields except providers and logistics-dependent
                // For logistics-dependent, only validate if visible
                fields.forEach(field => {
                    if (field.name === 'providers' || field.name === 'providers[]') return;
                    // Only validate visible fields
                    if (field.offsetParent === null) return;
                    // Validate required fields
                    if ((field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') && !field.value.trim()) {
                        valid = false;
                        field.classList.add('error-input');
                        let err = document.createElement('div');
                        err.className = 'field-error';
                        err.textContent = 'This field is required.';
                        err.style.color = '#E53E3E';
                        err.style.fontSize = '0.75rem';
                        err.style.marginTop = '0.25rem';
                        field.parentNode.appendChild(err);
                    }
                    if (field.tagName === 'SELECT' && (!field.value || field.value === '' || field.value === field.querySelector('option[disabled]')?.value)) {
                        valid = false;
                        field.classList.add('error-select');
                        let err = document.createElement('div');
                        err.className = 'field-error';
                        err.textContent = 'This field is required.';
                        err.style.color = '#E53E3E';
                        err.style.fontSize = '0.75rem';
                        err.style.marginTop = '0.25rem';
                        field.parentNode.appendChild(err);
                    }
                });

                // Validate Project Leader
                var leaderTagRow = document.getElementById('project-leader-tag-row');
                var leaderSelected = leaderTagRow && leaderTagRow.querySelectorAll('.college-tag').length > 0;
                if (!leaderSelected) {
                    valid = false;
                    leaderTagRow.classList.add('error-input');
                    let err = document.createElement('div');
                    err.id = 'leader-error';
                    err.textContent = 'Project Leader is required.';
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    leaderTagRow.appendChild(err);
                }

                // Validate SDGs
                var sdgsTagRow = document.getElementById('sdgs-tag-row');
                var sdgsSelected = sdgsTagRow && sdgsTagRow.querySelectorAll('.college-tag').length > 0;
                if (!sdgsSelected) {
                    valid = false;
                    sdgsTagRow.classList.add('error-input');
                    let err = document.createElement('div');
                    err.id = 'sdgs-error';
                    err.textContent = 'At least one SDG is required.';
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    sdgsTagRow.appendChild(err);
                }

                // Validate Proposal Document
                var proposalInput = document.getElementById('id_proposal_document');
                var proposalSelected = proposalInput && proposalInput.files && proposalInput.files.length > 0;
                if (!proposalSelected) {
                    valid = false;
                    proposalInput.classList.add('error-input');
                    let err = document.createElement('div');
                    err.id = 'proposal-error';
                    err.textContent = 'Proposal Document is required.';
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    proposalInput.parentNode.appendChild(err);
                }

                // Validate Additional Documents
                var additionalInput = document.getElementById('id_additional_documents');
                var additionalSelected = additionalInput && typeof additionalFiles !== 'undefined' && additionalFiles.length > 0;
                if (!additionalSelected) {
                    valid = false;
                    additionalInput.classList.add('error-input');
                    let err = document.createElement('div');
                    err.id = 'additional-error';
                    err.textContent = 'At least one Additional Document is required.';
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    additionalInput.parentNode.appendChild(err);
                }

                if (!valid) {
                    e.preventDefault();
                    return;
                }
            });
        }
    });

    // File Input Change Handler
    const proposalInput = document.getElementById('id_proposal_document');
    const proposalPreview = document.getElementById('proposal-file-preview');
    const proposalNameSpan = document.getElementById('proposal-file-name');
    const removeProposalBtn = document.getElementById('remove-proposal-file');

    proposalInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            proposalNameSpan.textContent = file.name;
            if (proposalPreview) proposalPreview.style.display = 'flex';
            if (removeProposalBtn) removeProposalBtn.style.display = 'inline-block';
        } else {
            proposalNameSpan.textContent = '';
            if (proposalPreview) proposalPreview.style.display = 'none';
            if (removeProposalBtn) removeProposalBtn.style.display = 'none';
        }
    });

    removeProposalBtn.addEventListener('click', function() {
        proposalInput.value = '';
        proposalNameSpan.textContent = '';
    if (proposalPreview) proposalPreview.style.display = 'none';
    if (removeProposalBtn) removeProposalBtn.style.display = 'none';
    });

    // Additional Documents Preview (show all file names with remove buttons)
    const additionalInput = document.getElementById('id_additional_documents');
    const additionalPreview = document.getElementById('additional-file-preview');
    const additionalFilesList = document.getElementById('additional-files-list');
    let additionalFiles = [];

    // Allow adding more files to the list, not replacing
    additionalInput.addEventListener('change', function(e) {
        const newFiles = Array.from(e.target.files);
        // Only add files that aren't already present (by name and size)
        newFiles.forEach(f => {
            if (!additionalFiles.some(existing => existing.name === f.name && existing.size === f.size)) {
                additionalFiles.push(f);
            }
        });
        updateAdditionalInput();
        renderAdditionalFiles();
    });

    function renderAdditionalFiles() {
        additionalFilesList.innerHTML = '';
        if (additionalFiles.length > 0) {
            additionalFiles.forEach((file, idx) => {
                // Create a separate file-preview block for each file
                const preview = document.createElement('div');
                preview.className = 'file-preview';
                if (preview) preview.style.display = 'flex';
                preview.style.alignItems = 'center';
                preview.style.justifyContent = 'space-between';
                const info = document.createElement('div');
                info.className = 'file-info';
                info.innerHTML = `<svg width="16" height="16"><use href="#icon-upload"></use></svg> <span>${file.name}</span>`;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '✕';
                removeBtn.type = 'button';
                removeBtn.className = 'remove-x';
                removeBtn.onclick = function() {
                    additionalFiles.splice(idx, 1);
                    updateAdditionalInput();
                    renderAdditionalFiles();
                };
                preview.appendChild(info);
                preview.appendChild(removeBtn);
                additionalFilesList.appendChild(preview);
            });
            if (additionalPreview) additionalPreview.style.display = 'block';
        } else {
            if (additionalPreview) additionalPreview.style.display = 'none';
        }
    }

    function updateAdditionalInput() {
        // Create a new DataTransfer to update the input's files
        const dt = new DataTransfer();
        additionalFiles.forEach(file => dt.items.add(file));
        additionalInput.files = dt.files;
    }

    // Enhanced Tag UI logic for Project Leader, Providers, SDGs
    function setupTagUI(rowId, optionsTemplateId, inputName, single=false, excludeIds=[]) {
        const tagRow = document.getElementById(rowId);
        const optionsTemplate = document.getElementById(optionsTemplateId);
        const selectDropdown = document.createElement('select');
        selectDropdown.id = rowId + '-dropdown';
    if (selectDropdown) selectDropdown.style.display = 'none';
        selectDropdown.style.position = 'fixed';
        selectDropdown.style.fontFamily = "Inter, Arial, sans-serif";
        selectDropdown.style.fontSize = "13px";
        selectDropdown.style.padding = "8px 30px 8px 16px";
        selectDropdown.style.borderRadius = "6px";
        selectDropdown.style.appearance = "none";
        selectDropdown.style.background = "white url('data:image/svg+xml;utf8,<svg fill=\"none\" height=\"16\" viewBox=\"0 0 16 16\" width=\"16\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M4 6L8 10L12 6\" stroke=\"%23374151\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>') no-repeat right 10px center/16px 16px";

        Array.from(optionsTemplate.options).forEach(opt => {
            selectDropdown.appendChild(opt.cloneNode(true));
        });

        // Get options
        const options = Array.from(selectDropdown.options)
            .filter(opt => opt.value)
            .map(opt => ({id: opt.value, name: opt.text}));

        let selected = [];
            function renderTags() {
                // Always update providers' exclude when rendering leader
                if (rowId === 'project-leader-tag-row' && typeof updateProvidersExclude === 'function') {
                    updateProvidersExclude(selected[0] || null);
                }
            tagRow.innerHTML = '';
            selected.forEach(id => {
                const obj = options.find(o => o.id === id);
                if (obj) {
                    const tag = document.createElement('span');
                    tag.className = 'college-tag';
                    if (single) {
                        // Show red x for removal only
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'remove-x';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.onclick = function() {
                            selected = [];
                            renderTags();
                        };
                        tag.appendChild(removeBtn);
                    } else {
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'remove-x';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.onclick = function() {
                            selected = selected.filter(cid => cid !== id);
                            renderTags();
                        };
                        tag.appendChild(removeBtn);
                    }
                    tag.appendChild(document.createTextNode(obj.name));
                    tagRow.appendChild(tag);
                }
            });
            if (!single || selected.length === 0) {
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.id = rowId + '-add-btn';
                addBtn.className = 'add-college-btn';
                addBtn.style.marginLeft = '8px';
                addBtn.innerHTML = `<svg width="16" height="16"><use href="#icon-add" /></svg>`;
                addBtn.onclick = function(e) {
                    const btnRect = addBtn.getBoundingClientRect();
                    if (selectDropdown) selectDropdown.style.display = 'block';
                    selectDropdown.style.position = 'fixed';
                    selectDropdown.style.left = (btnRect.left) + 'px';
                    selectDropdown.style.top = (btnRect.bottom + 4) + 'px';
                    selectDropdown.innerHTML = '';
                    const templateOptions = Array.from(optionsTemplate.options);
                    let exclude = excludeIds.slice();
                    if (rowId === 'project-leader-tag-row') {
                        // Exclude providers from leader options
                        const providerTagRow = document.getElementById('providers-tag-row');
                        if (providerTagRow) {
                            const providerInputs = providerTagRow.querySelectorAll('input[name="providers[]"]');
                            providerInputs.forEach(input => {
                                if (input.value && !exclude.includes(input.value)) exclude.push(input.value);
                            });
                        }
                    } else if (rowId === 'providers-tag-row') {
                        // Exclude leader from provider options
                        const leaderTagRow = document.getElementById('project-leader-tag-row');
                        if (leaderTagRow) {
                            const leaderInput = leaderTagRow.querySelector('input[name="project_leader"]');
                            if (leaderInput && leaderInput.value && !exclude.includes(leaderInput.value)) {
                                exclude.push(leaderInput.value);
                            }
                        }
                    }
                    templateOptions.forEach(opt => {
                        if (!opt.value || (!selected.includes(opt.value) && !exclude.includes(opt.value))) {
                            selectDropdown.appendChild(opt.cloneNode(true));
                        }
                    });
                    selectDropdown.focus();
                };
                tagRow.appendChild(addBtn);
            } else if (single && selected.length === 1) {
                // Show edit button outside the tag, same position as add
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.id = rowId + '-edit-btn';
                editBtn.className = 'add-college-btn';
                editBtn.style.marginLeft = '8px';
                editBtn.innerHTML = `<svg width="16" height="16"><use href="#icon-edit" /></svg>`;
                editBtn.title = 'Change';
                editBtn.onclick = function() {
                    const btnRect = editBtn.getBoundingClientRect();
                    if (selectDropdown) selectDropdown.style.display = 'block';
                    selectDropdown.style.position = 'fixed';
                    selectDropdown.style.left = (btnRect.left) + 'px';
                    selectDropdown.style.top = (btnRect.bottom + 4) + 'px';
                    selectDropdown.innerHTML = '';
                    const templateOptions = Array.from(optionsTemplate.options);
                        let exclude = excludeIds.slice();
                        if (rowId === 'project-leader-tag-row') {
                            // Exclude providers from leader options
                            const providerTagRow = document.getElementById('providers-tag-row');
                            if (providerTagRow) {
                                const providerInputs = providerTagRow.querySelectorAll('input[name="providers[]"]');
                                providerInputs.forEach(input => {
                                    if (input.value && !exclude.includes(input.value)) exclude.push(input.value);
                                });
                            }
                        } else if (rowId === 'providers-tag-row') {
                            // Exclude leader from provider options
                            const leaderTagRow = document.getElementById('project-leader-tag-row');
                            if (leaderTagRow) {
                                const leaderInput = leaderTagRow.querySelector('input[name="project_leader"]');
                                if (leaderInput && leaderInput.value && !exclude.includes(leaderInput.value)) {
                                    exclude.push(leaderInput.value);
                                }
                            }
                        }
                        templateOptions.forEach(opt => {
                            if (!opt.value || (!selected.includes(opt.value) && !exclude.includes(opt.value))) {
                                selectDropdown.appendChild(opt.cloneNode(true));
                            }
                        });
                    selectDropdown.focus();
                };
                tagRow.appendChild(editBtn);
            }
            if (!document.body.contains(selectDropdown)) {
                document.body.appendChild(selectDropdown);
            }
            selected.forEach(cid => {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = inputName + (single ? '' : '[]');
                hidden.value = cid;
                tagRow.appendChild(hidden);
            });
        }
        renderTags();
        selectDropdown.onchange = function() {
            const selectedId = selectDropdown.value;
            if (selectedId && !selected.includes(selectedId)) {
                if (single) {
                    selected = [selectedId];
                } else {
                    selected.push(selectedId);
                }
                renderTags();
            }
            selectDropdown.value = '';
            if (selectDropdown) selectDropdown.style.display = 'none';
                // If project leader changed, update providers (handled in renderTags now)
        };
        document.addEventListener('mousedown', function(e) {
            if (selectDropdown && !selectDropdown.contains(e.target) && e.target.id !== rowId + '-add-btn' && e.target.id !== rowId + '-edit-btn') {
                if (selectDropdown) selectDropdown.style.display = 'none';
            }
        });
        return {
            getSelected: () => selected.slice(),
            setExclude: (ids) => { excludeIds = ids; renderTags(); },
            setSelected: (ids) => { 
                selected = ids.slice(); 
                renderTags(); 
            },
        };
    }

    // Setup tag UIs
    var leaderTagUI = setupTagUI('project-leader-tag-row', 'project-leader-options-template', 'project_leader', true);
    var providersTagUI = setupTagUI('providers-tag-row', 'providers-options-template', 'providers');
    setupTagUI('sdgs-tag-row', 'sdgs-options-template', 'sdgs');

    // Load AI team selection from localStorage if available
    try {
        const aiTeamData = localStorage.getItem('aiTeamSelection');
        if (aiTeamData) {
            const teamData = JSON.parse(aiTeamData);
            // Check if data is recent (within last 5 minutes)
            const fiveMinutes = 5 * 60 * 1000;
            if (Date.now() - teamData.timestamp < fiveMinutes) {
                // Pre-select leader
                if (teamData.leader) {
                    leaderTagUI.setSelected([teamData.leader.toString()]);
                }
                // Pre-select providers
                if (teamData.providers && teamData.providers.length > 0) {
                    providersTagUI.setSelected(teamData.providers.map(p => p.toString()));
                }
            }
            // Clear the data after using it
            localStorage.removeItem('aiTeamSelection');
        }
    } catch (e) {
        console.error('Error loading AI team selection:', e);
    }

    // Update providers to exclude selected leader
    function updateProvidersExclude(leaderId) {
        if (providersTagUI) {
            providersTagUI.setExclude(leaderId ? [leaderId] : []);
        }
    }

    // Logistics Block Logic with custom required
    document.addEventListener('DOMContentLoaded', function() {
        var logisticsSelects = document.querySelector('select[name="logistics_type"]');
        var logisticsBlock = {
            'BOTH': document.getElementById('logistics-both'),
            'INTERNAL': document.getElementById('logistics-internal'),
            'EXTERNAL': document.getElementById('logistics-external'),
        };
        function updateLogisticsBlocks() {
            if (!logisticsSelects) return;
            var selected = logisticsSelects.value;
            Object.keys(logisticsBlock).forEach(function(logistics_type) {
                var block = logisticsBlock[logistics_type];
                if (!block) return;
                if (logistics_type === selected) {
                    if (block) block.style.display = 'block';
                    // Add required to all inputs/selects in this block with data-logistics-required
                    Array.from(block.querySelectorAll('input,select,textarea')).forEach(function(el) {
                        if (el.hasAttribute('data-logistics-required')) {
                            el.required = true;
                        }
                    });
                } else {
                    if (block) block.style.display = 'none';
                    // Remove required from all inputs/selects in this block with data-logistics-required
                    Array.from(block.querySelectorAll('input,select,textarea')).forEach(function(el) {
                        if (el.hasAttribute('data-logistics-required')) {
                            el.required = false;
                        }
                    });
                }
            });
        }
        if (logisticsSelects) {
            logisticsSelects.addEventListener('change', updateLogisticsBlocks);
            updateLogisticsBlocks();
        }
    });
</script>

{% endblock %}