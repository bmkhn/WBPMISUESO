{% extends "base_internal.html" %}
{% block content %} 
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add Project</title>

<link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/styles.css' %}" rel="stylesheet">
<style>
    .custom-dropdown-container {
        display: none;
        position: absolute; 
        background: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        z-index: 1000; 
        min-width: 250px;
        max-height: 350px;
        overflow-y: auto;
        padding: 8px;
    }
    .custom-dropdown-container input[type="text"] {
        width: 100%;
        padding: 8px 10px;
        margin-bottom: 8px;
        box-sizing: border-box;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
        font-size: 14px;
    }
    .custom-dropdown-option {
        padding: 8px 10px;
        cursor: pointer;
        font-size: 13px;
        border-radius: 4px;
    }
    .custom-dropdown-option:hover {
        background-color: #f0f0f0;
    }
</style>
</head>

<body>
<form method="post" enctype="multipart/form-data" id="addProjectForm" novalidate>
    {% csrf_token %}
    <div class="user-details-container">
        <div class="user-details-title">
            <h2>
                Create New Extension Project
            </h2> 
            <p>Input all fields correctly and launch new project.</p>
            
            {% if error %}
            <div style="background:#FFF5F5;color:#C53030;padding:1rem;border-radius:8px;margin-top:1rem;border-left:4px solid #E53E3E;">
                <strong>Error:</strong> {{ error }}
            </div>
            {% endif %}
        </div>

        <div class="user-details-section">
            <div class="user-details-category">  
                <i class="fa-regular fa-address-card subtitle-icon"></i>
                Project Profile 
            </div>
            <div class="user-details-row cols-1">
                <div>
                    <div class="user-details-label">Title <span class="required">*</span></div>
                    <input type="text" name="title" class="user-details-value" required>
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Project Leader <span class="required">*</span></div>
                    <div id="project-leader-tag-row" class="college-row"></div>
                    <select id="project-leader-options-template" style="display:none;">
                        <option value="">Select Leader</option>
                        {% for user in faculty_users %}
                        <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <div class="user-details-label">Provider/s (Members)</div>
                    <div id="providers-tag-row" class="college-row"></div>
                    <select id="providers-options-template" style="display:none;" multiple>
                        <option value="">Select Provider</option>
                        {% for user in provider_users %}
                        <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Agenda <span class="required">*</span></div>
                    <select name="agenda" class="user-details-value" style="transition: none;"  required>
                        <option value="" selected disabled>Select Agenda</option>
                        {% for agenda in agendas %}
                        <option value="{{ agenda.id }}">{{ agenda.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <div class="user-details-label">Project Type <span class="required">*</span></div>
                    <select name="project_type" class="user-details-value" required>
                        <option value="" selected disabled>Select Type</option>
                        {% for pt in project_types %}
                        <option value="{{ pt.id }}">{{ pt.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="user-details-row cols-1">
                <div>
                    <div class="user-details-label">Sustainable Development Goals <span class="required">*</span></div>
                    <div id="sdgs-tag-row" class="college-row"></div>
                    <select id="sdgs-options-template" style="display:none;" multiple>
                        <option value="">Select SDG</option>
                        {% for sdg in sdgs %}
                        <option value="{{ sdg.id }}">{{ sdg.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="user-details-section">
            <div class="user-details-category"><i class="fa-solid fa-gears"></i>Beneficiary</div>
            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Primary Beneficiary <span class="required">*</span></div>
                    <input type="text" name="primary_beneficiary" class="user-details-value" required>
                </div>
                <div>
                    <div class="user-details-label">No. of Estimated Events <span class="required">*</span></div>
                    <input type="number" name="estimated_events" class="user-details-value" min="0" step="1" required>
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Primary Location <span class="required">*</span></div>
                    <input type="text" name="primary_location" class="user-details-value" required>
                </div>
                <div>
                    <div class="user-details-label">No. of Estimated Trainees <span class="required">*</span></div>
                    <input type="number" name="estimated_trainees" class="user-details-value" min="0" step="1" required>
                </div>
            </div>
        </div>

        <div class="user-details-section">
            <div class="user-details-category">
                <i class="fa-solid fa-chart-simple"></i>
                Logistics
            </div>

            <div class="user-details-choice">
                <div class="user-details-label">
                    <span class="info-icon">    
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
                        </svg>
                    <span class="info-tooltip">Choose Internal if project is funded solely by PalSU, External if funded solely by a sponsor, and Both if funded by both.</span>
                </div>
                </span>
                <select name="logistics_type" class="user-details-value" style="transition: none;">
                    <option value="BOTH">Both</option>
                    <option value="INTERNAL">Internal</option>
                    <option value="EXTERNAL">External</option>
                </select><span class="required">*</span>
            </div>

            <div id="logistics-both" {% if logistics_type == 'BOTH' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">Internal Budget Assigned <span class="required">*</span></div>
                        <input type="number" name="internal_budget" id="internal-budget-both" class="user-details-value internal-budget-input" min="0" step="1" data-logistics-required>
                        <div id="budget-status-both" style="margin-top:0.5rem;font-size:0.9rem;min-height:20px;"></div>
                    </div>
                    <div>
                        <div class="user-details-label">External Budget Assigned <span class="required">*</span></div>
                        <input type="number" name="external_budget" class="user-details-value" min="0" step="1" data-logistics-required>
                    </div>
                </div>

                <div class="user-details-row cols-1">
                    <div>
                        <div class="user-details-label">Sponsor Name <span class="required">*</span></div>
                        <input type="text" name="sponsor_name" class="user-details-value" data-logistics-required>
                    </div>
                </div>
            </div>

            <div id="logistics-internal" {% if project.logistics_type == 'INTERNAL' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">Internal Budget Assigned <span class="required">*</span></div>
                        <input type="number" name="internal_budget" id="internal-budget-internal" class="user-details-value internal-budget-input" min="0" step="0.01" data-logistics-required>
                        <div id="budget-status-internal" style="margin-top:0.5rem;font-size:0.9rem;min-height:20px;"></div>
                    </div>
                    <div></div>
                </div>
            </div>

            <div id="logistics-external" {% if project.logistics_type == 'EXTERNAL' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
                <div class="user-details-row cols-2">
                    <div>
                        <div class="user-details-label">External Budget Assigned <span class="required">*</span></div>
                        <input type="number" name="external_budget" class="user-details-value" min="0" step="0.01" data-logistics-required>
                    </div>
                    <div>
                        <div class="user-details-label">Sponsor Name <span class="required">*</span></div>
                        <input type="text" name="sponsor_name" class="user-details-value" data-logistics-required>
                    </div>
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Start Date <span class="required">*</span></div>
                    <input type="date" name="start_date" id="id_start_date" class="user-details-value" required>
                    <small style="color:#666;font-size:0.875rem;margin-top:0.25rem;display:block;">Cannot be in the past</small>
                </div>
                <div>
                    <div class="user-details-label">Estimated End Date <span class="required">*</span></div>
                    <input type="date" name="estimated_end_date" id="id_estimated_end_date" class="user-details-value" required>
                    <small style="color:#666;font-size:0.875rem;margin-top:0.25rem;display:block;">Must be after start date</small>
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="form-group">
                        <div class="user-details-label">Proposal Document <span class="required">*</span></div>
                        <div class="upload-area" onclick="document.getElementById('id_proposal_document').click()">
                            <svg class="upload-icon"><use href="#icon-upload"></use></svg>
                            <span class="upload-text">Click to upload</span>
                            <input class="file-input" type="file" name="proposal_document" id="id_proposal_document" style="display:none;" accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                        </div>
                    </div>
                    <div class="file-preview" id="proposal-file-preview" style="display:none;margin-top:15px;">
                        <div class="file-info" style="flex:1;">
                            <svg width="16" height="16"><use href="#icon-upload"></use></svg>
                            <span id="proposal-file-name"></span>
                        </div>
                        <button type="button" id="remove-proposal-file" class="remove-x">✕</button>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <div class="user-details-label">Additional Documents <span class="required">*</span></div>
                        <div class="upload-area" onclick="document.getElementById('id_additional_documents').click()">
                            <svg class="upload-icon"><use href="#icon-upload"></use></svg>
                            <span class="upload-text">Click to upload</span>
                            <input class="file-input" type="file" name="additional_documents" id="id_additional_documents" style="display:none;" multiple accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/jpeg,image/png,image/jpg,image/gif,image/webp">
                        </div>
                    </div>
                    <div id="additional-files-list"></div>
                </div>
            </div>
        </div>

        <div class="user-details-section">
            <div class="user-details-category">
                <i class="fa-solid fa-receipt"></i> Expense Breakdown
            </div>
            <p style="color:#666;font-size:0.9rem;margin-bottom:1rem;">Add initial expense items for this project. At least one expense is required.</p>
            
            <div style="overflow-x:auto;">
                <table id="expenses-table" style="width:100%;border-collapse:collapse;margin-bottom:1rem;">
                    <thead>
                        <tr style="background:#f7f9fc;border-bottom:2px solid #e2e8f0;">
                            <th style="padding:12px;text-align:left;font-weight:600;color:#2B4360;width:25%;">Title <span class="required">*</span></th>
                            <th style="padding:12px;text-align:left;font-weight:600;color:#2B4360;width:35%;">Reason <span class="required">*</span></th>
                            <th style="padding:12px;text-align:left;font-weight:600;color:#2B4360;width:25%;">Amount (₱) <span class="required">*</span></th>
                            <th style="padding:12px;text-align:center;font-weight:600;color:#2B4360;width:15%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-tbody">
                        <tr class="expense-row" data-row-index="0">
                            <td style="padding:8px;">
                                <input type="text" name="expense_title_0" class="expense-title user-details-value" placeholder="e.g., Venue Rental" required style="width:100%;">
                            </td>
                            <td style="padding:8px;">
                                <input type="text" name="expense_reason_0" class="expense-reason user-details-value" placeholder="e.g., For workshop event" required style="width:100%;">
                            </td>
                            <td style="padding:8px;">
                                <input type="number" name="expense_amount_0" class="expense-amount user-details-value" placeholder="0.00" min="0.01" step="0.01" required style="width:100%;">
                            </td>
                            <td style="padding:8px;text-align:center;">
                                <button type="button" class="remove-expense-btn" style="background:#E53E3E;color:white;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;font-size:0.875rem;display:none;">Remove</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem;">
                <button type="button" id="add-expense-row-btn" style="background:#3182CE;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:6px;font-family:'Inter',sans-serif;">
                    <i class="fa-solid fa-plus"></i> Add Another Expense
                </button>
                <div id="expense-total-display" style="font-weight:600;color:#2B4360;font-size:1.1rem;">
                    Total: ₱<span id="expense-total-amount">0.00</span>
                </div>
            </div>
            
            <div id="expense-error-message" style="color:#E53E3E;margin-top:1rem;display:none;padding:10px;background:#FFF5F5;border-radius:6px;border-left:4px solid #E53E3E;">
            </div>
        </div>

        <div class="form-actions">
            <a href="{% url 'project_dispatcher' %}" class="back btn">Cancel</a>
            <button type="submit" class="save btn">Add Project</button>
        </div>
    </div>
</form>

<!-- Confirmation Modal -->
<div id="add-confirm-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0, 0, 0, 0.18);z-index:2000;align-items:center;justify-content:center;font-family:'Inter',sans-serif;">
    <div style="background:#fff;padding:2.25rem 2.5rem 2rem 2.5rem;border-radius:16px;box-shadow:0 8px 32px rgba(49,130,206,0.13),0 2px 8px rgba(0,0,0,0.07);max-width:410px;width:95%;text-align:center;position:relative;">
        <h3 style="margin-bottom:1.1rem;font-size:1.35rem;font-weight:600;color:#2B4360;letter-spacing:-0.5px;margin-top:0;">Confirm Project Creation</h3>
        <div style="background:#FFF5F5;border-radius:8px;padding:0.75rem 1rem 0.75rem 1rem;color:#C53030;font-weight:500;margin-bottom:1.3rem;display:flex;align-items:center;justify-content:center;font-size:1rem;">
            <i class="fa-solid fa-triangle-exclamation" style="margin-right:10px;font-size:1.2rem;color:#C53030;"></i>
            <span style="text-align:center;"><strong>Warning:</strong> Adding a project will immediately reserve budget, notify relevant users, and cannot be undone.<br>Double-check all details before continuing.</span>
        </div>
        <div style="display:flex;gap:12px;justify-content:center;">
            <button id="add-confirm-no" style="background:#EDF2F7;color:#2B4360;padding:0.6rem 1.5rem;border:none;border-radius:7px;box-shadow:0 1px 4px rgba(0,0,0,0.04);font-weight:500;font-size:1rem;cursor:pointer;transition:background 0.15s;">Cancel</button>
            <button id="add-confirm-yes" style="background:#3182CE;color:#fff;padding:0.6rem 1.5rem;border:none;border-radius:7px;box-shadow:0 1px 4px rgba(49,130,206,0.09);font-weight:500;font-size:1rem;cursor:pointer;transition:background 0.15s;">Continue & Add Project</button>
        </div>
    </div>
</div>



<div id="custom-dropdown-container" class="custom-dropdown-container">
    <input type="text" id="custom-dropdown-filter" placeholder="Search..." autocomplete="off">
    <div id="custom-dropdown-options">
        </div>
</div>




<!-- SVG Referencing Section  -->
<svg style="display:none;" xmlns="http://www.w3.org/2000/svg">

    <symbol id="icon-add" viewBox="0 0 16 16" fill="currentColor">
        <path d="M6.80039 14.4004C6.80039 14.7187 6.92682 15.0239 7.15186 15.2489C7.37691 15.474 7.68213 15.6004 8.00039 15.6004C8.31865 15.6004 8.62388 15.474 8.84892 15.2489C9.07396 15.0239 9.20039 14.7187 9.20039 14.4004V9.20039H14.4004C14.7187 9.20039 15.0239 9.07396 15.2489 8.84892C15.474 8.62388 15.6004 8.31865 15.6004 8.00039C15.6004 7.68213 15.474 7.37691 15.2489 7.15186C15.0239 6.92682 14.7187 6.80039 14.4004 6.80039H9.20039V1.60039C9.20039 1.28213 9.07396 0.976906 8.84892 0.751863C8.62388 0.526819 8.31865 0.400391 8.00039 0.400391C7.68213 0.400391 7.37691 0.526819 7.15186 0.751863C6.92682 0.976906 6.80039 1.28213 6.80039 1.60039V6.80039H1.60039C1.28213 6.80039 0.976906 6.92682 0.751863 7.15186C0.526819 7.37691 0.400391 7.68213 0.400391 8.00039C0.400391 8.31865 0.526819 8.62388 0.751863 8.84892C0.976906 9.07396 1.28213 9.20039 1.60039 9.20039H6.80039V14.4004Z" fill="black"/>
    </symbol>

    <symbol id="icon-edit" viewBox="0 0 18 18" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
    <path d="M2 16H3.425L13.2 6.225L11.775 4.8L2 14.575V16ZM1 18C0.716667 18 0.479333 17.904 0.288 17.712C0.0966668 17.52 0.000666667 17.2827 0 17V14.575C0 14.3083 0.0500001 14.054 0.15 13.812C0.25 13.57 0.391667 13.3577 0.575 13.175L13.2 0.575C13.4 0.391667 13.621 0.25 13.863 0.15C14.105 0.0500001 14.359 0 14.625 0C14.891 0 15.1493 0.0500001 15.4 0.15C15.6507 0.25 15.8673 0.4 16.05 0.6L17.425 2C17.625 2.18333 17.7707 2.4 17.862 2.65C17.9533 2.9 17.9993 3.15 18 3.4C18 3.66667 17.954 3.921 17.862 4.163C17.77 4.405 17.6243 4.62567 17.425 4.825L4.825 17.425C4.64167 17.6083 4.429 17.75 4.187 17.85C3.945 17.95 3.691 18 3.425 18H1ZM12.475 5.525L11.775 4.8L13.2 6.225L12.475 5.525Z" fill="black"/>
    </symbol>

    <symbol id="icon-upload" viewBox="0 0 24 24" fill="currentColor">
        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
        <path d="M12,11L8,15H16L12,11Z" />
    </symbol>
</svg>


<script>
    // Global references to the custom dropdown elements
    const dropdownContainer = document.getElementById('custom-dropdown-container');
    const dropdownFilter = document.getElementById('custom-dropdown-filter');
    const dropdownOptionsDiv = document.getElementById('custom-dropdown-options');
    
    // Function to hide the custom dropdown
    function hideDropdown() {
        if (dropdownContainer) {
            dropdownContainer.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Budget validation state
        let budgetValid = true;

        // Function to filter options when user types
        dropdownFilter.addEventListener('keyup', function() {
            const filterText = dropdownFilter.value.toLowerCase();
            Array.from(dropdownOptionsDiv.children).forEach(optionEl => {
                const text = optionEl.textContent.toLowerCase();
                if (text.includes(filterText)) {
                    optionEl.style.display = 'block';
                } else {
                    optionEl.style.display = 'none';
                }
            });
        });

        // Hide dropdown when clicking outside
        document.addEventListener('mousedown', function(e) {
            if (dropdownContainer && dropdownContainer.style.display === 'block' && 
                !dropdownContainer.contains(e.target) && !e.target.closest('.add-college-btn')) {
                hideDropdown();
            }
        });
        

        // Budget validation function (omitted body for brevity, logic remains the same)
        function checkBudget() {
            // ... (Full checkBudget logic) ...
            
            // Get logistics type from select dropdown
            const logisticsSelect = document.querySelector('select[name="logistics_type"]');
            const logisticsType = logisticsSelect ? logisticsSelect.value : null;
            
            // Determine which status div and input to use
            let statusDiv = null;
            let budgetInput = null;
            
            if (logisticsType === 'BOTH') {
                statusDiv = document.getElementById('budget-status-both');
                budgetInput = document.getElementById('internal-budget-both');
                document.getElementById('budget-status-internal').innerHTML = '';
            } else if (logisticsType === 'INTERNAL') {
                statusDiv = document.getElementById('budget-status-internal');
                budgetInput = document.getElementById('internal-budget-internal');
                document.getElementById('budget-status-both').innerHTML = '';
            } else {
                document.getElementById('budget-status-both').innerHTML = '';
                document.getElementById('budget-status-internal').innerHTML = '';
                budgetValid = true;
                return;
            }
            
            // Get project leader from hidden input
            const leaderTagRow = document.getElementById('project-leader-tag-row');
            const leaderInput = leaderTagRow ? leaderTagRow.querySelector('input[name="project_leader"]') : null;
            const leaderId = leaderInput ? leaderInput.value : null;
            
            if (!leaderId) {
                statusDiv.innerHTML = '<span style="color:#E53E3E;font-weight:600;">⚠ Please select a Project Leader first</span>';
                budgetValid = false;
                return;
            }
            
            const internalBudget = budgetInput ? parseFloat(budgetInput.value) : null;
            
            if (!internalBudget || internalBudget <= 0) {
                const url = `/projects/check-budget/?project_leader_id=${leaderId}&internal_budget=0`;
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error && data.error.includes('does not have a college')) {
                            statusDiv.innerHTML = `<span style="color:#E53E3E;font-weight:600;">✗ ${data.error}</span>`;
                            budgetValid = false;
                        } else if (data.error && data.error.includes('No budget allocation')) {
                            statusDiv.innerHTML = `<span style="color:#E53E3E;font-weight:600;">✗ ${data.error}</span>`;
                            budgetValid = false;
                        } else if (data.college_name) {
                            statusDiv.innerHTML = `<span style="color:#3182CE;font-weight:600;">ℹ ${data.college_name} has ₱${parseFloat(data.uncommitted).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} available budget</span>`;
                            budgetValid = true;
                        }
                    });
                return;
            }

            const url = `/projects/check-budget/?project_leader_id=${leaderId}&internal_budget=${internalBudget}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.valid) {
                        budgetValid = true;
                        statusDiv.innerHTML = `<span style="color:#38A169;font-weight:600;">✓ ${data.college_name} has ₱${parseFloat(data.uncommitted).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} available. After this project: ₱${parseFloat(data.remaining).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} remaining</span>`;
                    } else {
                        budgetValid = false;
                        statusDiv.innerHTML = `<span style="color:#E53E3E;font-weight:600;">✗ ${data.error}</span>`;
                    }
                })
                .catch(error => {
                    budgetValid = true;
                    statusDiv.innerHTML = '<span style="color:#D69E2E;font-weight:600;">⚠ Could not verify budget. Please check manually.</span>';
                });
        }


        // Add event listeners for budget validation
        setTimeout(function() {
            // Listen to project leader changes
            const leaderTagRow = document.getElementById('project-leader-tag-row');
            if (leaderTagRow) {
                const observer = new MutationObserver(checkBudget);
                observer.observe(leaderTagRow, { childList: true, subtree: true });
            }

            // Listen to internal budget input changes
            const budgetInputs = document.querySelectorAll('.internal-budget-input');
            budgetInputs.forEach(input => {
                input.addEventListener('input', checkBudget);
                input.addEventListener('change', checkBudget);
                input.addEventListener('keyup', checkBudget);
            });

            // Listen to logistics type select dropdown changes
            const logisticsSelect = document.querySelector('select[name="logistics_type"]');
            if (logisticsSelect) {
                logisticsSelect.addEventListener('change', function() {
                    setTimeout(checkBudget, 100);
                });
            }
            
            // Run initial check in case leader is already selected
            checkBudget();
        }, 500);
    

        // Unified error catcher for form submission
        var form = document.getElementById('addProjectForm');
        var confirmModal = document.getElementById('add-confirm-modal');
        var confirmYes = document.getElementById('add-confirm-yes');
        var confirmNo = document.getElementById('add-confirm-no');
        var pendingSubmitEvent = null;

        if (form) {
            form.addEventListener('submit', function(e) {
                let valid = true;
                let firstError = null;
                let errorQueue = [];
                // Remove previous error states
                document.querySelectorAll('.field-validation-error').forEach(el => el.remove());
                document.querySelectorAll('.error-input').forEach(el => el.classList.remove('error-input'));

                // Validate all required fields (only if visible)
                document.querySelectorAll('#addProjectForm .user-details-value[required]').forEach(field => {
                    // Only validate if field is visible
                    const isVisible = field.offsetParent !== null;
                    if (isVisible && !field.value) {
                        valid = false;
                        field.classList.add('error-input');
                        const err = document.createElement('div');
                        err.className = 'field-validation-error';
                        // Find the label text
                        let labelText = field.parentNode.querySelector('.user-details-label');
                        if (!labelText) {
                            // Try previous sibling if not found
                            labelText = field.parentNode.previousElementSibling && field.parentNode.previousElementSibling.classList.contains('user-details-label')
                                ? field.parentNode.previousElementSibling
                                : null;
                        }
                        let prettyName = labelText ? labelText.textContent.replace(/\s*\*/g, '').trim() : field.name;
                        err.textContent = `${prettyName} is required.`;
                        err.style.color = '#E53E3E';
                        err.style.fontSize = '0.95rem';
                        err.style.marginTop = '0.25rem';
                        field.parentNode.appendChild(err);
                        if (!firstError) firstError = field;
                    } else {
                        field.classList.remove('error-input');
                    }
                });

                // Validate Project Leader (tag UI)
                const leaderTagRow = document.getElementById('project-leader-tag-row');
                const leaderInput = leaderTagRow ? leaderTagRow.querySelector('input[name="project_leader"]') : null;
                // Remove previous tag errors for leaderTagRow
                if (leaderTagRow) {
                    Array.from(leaderTagRow.querySelectorAll('.tag-error')).forEach(el => el.remove());
                }
                if (!leaderInput || !leaderInput.value) {
                    valid = false;
                    // Only add one error per submission
                    const err = document.createElement('div');
                    err.className = 'tag-error';
                    err.textContent = 'Project Leader is required.';
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    leaderTagRow.appendChild(err);
                    if (!firstError) firstError = leaderTagRow;
                }

                // Validate SDGs (tag UI)
                const sdgsTagRow = document.getElementById('sdgs-tag-row');
                const sdgsInputs = sdgsTagRow ? sdgsTagRow.querySelectorAll('input[name="sdgs[]"]') : [];
                // Remove previous tag errors for sdgsTagRow
                if (sdgsTagRow) {
                    Array.from(sdgsTagRow.querySelectorAll('.tag-error')).forEach(el => el.remove());
                }
                if (sdgsInputs.length === 0) {
                    valid = false;
                    // Only add one error per submission
                    const err = document.createElement('div');
                    err.className = 'tag-error';
                    err.textContent = 'At least one SDG must be selected.';
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    sdgsTagRow.appendChild(err);
                    if (!firstError) firstError = sdgsTagRow;
                }

                // Get logistics-related inputs
                document.querySelectorAll('#addProjectForm .user-details-value[data-logistics-required]').forEach(input => {
                    // Remove previous error states
                    input.classList.remove('error-input');
                    Array.from(input.parentNode.querySelectorAll('.field-validation-error')).forEach(errEl => errEl.remove());

                    // Only validate if field is visible
                    const isVisible = input.offsetParent !== null;
                    if (isVisible && !input.value) {
                        valid = false;
                        input.classList.add('error-input');
                        const err = document.createElement('div');
                        err.className = 'field-validation-error';
                        // Find the label text
                        let labelText = input.parentNode.querySelector('.user-details-label');
                        if (!labelText) {
                            // Try previous sibling if not found
                            labelText = input.parentNode.previousElementSibling && input.parentNode.previousElementSibling.classList.contains('user-details-label')
                                ? input.parentNode.previousElementSibling
                                : null;
                        }
                        let prettyName = labelText ? labelText.textContent.replace(/\s*\*/g, '').trim() : input.name;
                        err.textContent = `${prettyName} is required.`;
                        err.style.color = '#E53E3E';
                        err.style.fontSize = '0.95rem';
                        err.style.marginTop = '0.25rem';
                        input.parentNode.appendChild(err);
                        if (!firstError) firstError = input;
                    }
                });

                // Validate Proposal Document
                const proposalInput = document.getElementById('id_proposal_document');
                if (proposalInput && !proposalInput.files.length) {
                    valid = false;
                    proposalInput.classList.add('error-input');
                    errorQueue.push({field: proposalInput, message: 'Proposal document is required.', file: true});
                    if (!firstError) firstError = proposalInput;
                }

                // Validate Additional Documents
                const additionalInput = document.getElementById('id_additional_documents');
                if (additionalInput && !additionalInput.files.length) {
                    valid = false;
                    additionalInput.classList.add('error-input');
                    errorQueue.push({field: additionalInput, message: 'At least one additional document is required.', file: true});
                    if (!firstError) firstError = additionalInput;
                }

                // Budget validation state (do not block other errors)
                const logisticsSelect = document.querySelector('select[name="logistics_type"]');
                const logisticsType = logisticsSelect ? logisticsSelect.value : null;
                if (!budgetValid) {
                    valid = false;
                    let statusDiv = null;
                    if (logisticsType === 'BOTH') statusDiv = document.getElementById('budget-status-both');
                    else if (logisticsType === 'INTERNAL') statusDiv = document.getElementById('budget-status-internal');
                    if (statusDiv) {
                        errorQueue.push({field: statusDiv, message: 'Please fix the budget allocation issue.'});
                        if (!firstError) firstError = statusDiv;
                    }
                }

                // Expense breakdown validation
                const expenseRows = document.querySelectorAll('.expense-row');
                const expenseErrorDiv = document.getElementById('expense-error-message');
                expenseErrorDiv.style.display = 'none';
                expenseErrorDiv.textContent = '';
                
                // Remove previous expense field errors
                document.querySelectorAll('.expense-field-error').forEach(el => el.remove());
                
                if (expenseRows.length === 0) {
                    valid = false;
                    expenseErrorDiv.textContent = 'At least one expense item is required.';
                    expenseErrorDiv.style.display = 'block';
                    if (!firstError) firstError = document.getElementById('expenses-table');
                } else {
                    let hasExpenseError = false;
                    expenseRows.forEach((row, index) => {
                        const titleInput = row.querySelector('.expense-title');
                        const reasonInput = row.querySelector('.expense-reason');
                        const amountInput = row.querySelector('.expense-amount');
                        
                        // Remove previous error states
                        [titleInput, reasonInput, amountInput].forEach(input => {
                            input.classList.remove('error-input');
                        });
                        
                        // Validate title field
                        if (!titleInput.value.trim()) {
                            valid = false;
                            hasExpenseError = true;
                            titleInput.classList.add('error-input');
                            const err = document.createElement('div');
                            err.className = 'expense-field-error';
                            err.textContent = 'Expense title is required';
                            err.style.color = '#E53E3E';
                            err.style.fontSize = '0.875rem';
                            err.style.marginTop = '0.25rem';
                            titleInput.parentElement.appendChild(err);
                            if (!firstError) firstError = titleInput;
                        }
                        
                        // Validate reason field
                        if (!reasonInput.value.trim()) {
                            valid = false;
                            hasExpenseError = true;
                            reasonInput.classList.add('error-input');
                            const err = document.createElement('div');
                            err.className = 'expense-field-error';
                            err.textContent = 'Expense reason is required';
                            err.style.color = '#E53E3E';
                            err.style.fontSize = '0.875rem';
                            err.style.marginTop = '0.25rem';
                            reasonInput.parentElement.appendChild(err);
                            if (!firstError) firstError = reasonInput;
                        }
                        
                        // Validate amount field
                        if (!amountInput.value || parseFloat(amountInput.value) <= 0) {
                            valid = false;
                            hasExpenseError = true;
                            amountInput.classList.add('error-input');
                            const err = document.createElement('div');
                            err.className = 'expense-field-error';
                            err.textContent = !amountInput.value ? 'Expense amount is required' : 'Amount must be greater than 0';
                            err.style.color = '#E53E3E';
                            err.style.fontSize = '0.875rem';
                            err.style.marginTop = '0.25rem';
                            amountInput.parentElement.appendChild(err);
                            if (!firstError) firstError = amountInput;
                        }
                    });
                    
                    if (hasExpenseError) {
                        expenseErrorDiv.textContent = 'Please fix the errors in the expense breakdown above.';
                        expenseErrorDiv.style.display = 'block';
                    }
                }

                // Date validation
                const startDateInput = document.getElementById('id_start_date');
                const endDateInput = document.getElementById('id_estimated_end_date');
                if (startDateInput && startDateInput.value) {
                    const todayDate = new Date(new Date().toISOString().split('T')[0]);
                    const startDate = new Date(startDateInput.value);
                    if (startDate < todayDate) {
                        valid = false;
                        startDateInput.classList.add('error-input');
                        errorQueue.push({field: startDateInput, message: 'Start date cannot be in the past.'});
                        if (!firstError) firstError = startDateInput;
                    }
                }
                if (startDateInput && endDateInput && startDateInput.value && endDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(endDateInput.value);
                    if (endDate <= startDate) {
                        valid = false;
                        endDateInput.classList.add('error-input');
                        errorQueue.push({field: endDateInput, message: 'Estimated end date must be after the start date.'});
                        if (!firstError) firstError = endDateInput;
                    }
                }

                // Render all errors synchronously
                errorQueue.forEach(errObj => {
                    const err = document.createElement('div');
                    err.className = errObj.tag ? 'tag-error' : 'field-validation-error';
                    err.textContent = errObj.message;
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    if (errObj.file && errObj.field.closest('.form-group')) {
                        errObj.field.closest('.form-group').appendChild(err);
                    } else {
                        errObj.field.appendChild(err);
                    }
                });

                if (!valid) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (firstError && typeof firstError.focus === 'function') firstError.focus();
                    return false;
                }
                // If valid, show confirmation modal instead of submitting
                e.preventDefault();
                confirmModal.style.display = 'flex';
                pendingSubmitEvent = e;
            });
        }
        if (confirmYes) {
            confirmYes.addEventListener('click', function() {
                confirmModal.style.display = 'none';
                if (form) {
                    form.submit();
                }
            });
        }
        if (confirmNo) {
            confirmNo.addEventListener('click', function() {
                confirmModal.style.display = 'none';
                pendingSubmitEvent = null;
            });
        }
    });

    // ========== EXPENSE BREAKDOWN FUNCTIONALITY ==========
    
    let expenseRowCounter = 1; // Start from 1 since row 0 already exists

    function updateExpenseTotal() {
        let total = 0;
        document.querySelectorAll('.expense-amount').forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });
        document.getElementById('expense-total-amount').textContent = total.toFixed(2);
    }

    function updateRemoveButtons() {
        const rows = document.querySelectorAll('.expense-row');
        rows.forEach((row, index) => {
            const removeBtn = row.querySelector('.remove-expense-btn');
            if (rows.length > 1) {
                removeBtn.style.display = 'inline-block';
            } else {
                removeBtn.style.display = 'none';
            }
        });
    }

    function addExpenseRow() {
        const tbody = document.getElementById('expenses-tbody');
        const newRow = document.createElement('tr');
        newRow.className = 'expense-row';
        newRow.setAttribute('data-row-index', expenseRowCounter);
        
        newRow.innerHTML = `
            <td style="padding:8px;">
                <input type="text" name="expense_title_${expenseRowCounter}" class="expense-title user-details-value" placeholder="e.g., Venue Rental" required style="width:100%;">
            </td>
            <td style="padding:8px;">
                <input type="text" name="expense_reason_${expenseRowCounter}" class="expense-reason user-details-value" placeholder="e.g., For workshop event" required style="width:100%;">
            </td>
            <td style="padding:8px;">
                <input type="number" name="expense_amount_${expenseRowCounter}" class="expense-amount user-details-value" placeholder="0.00" min="0.01" step="0.01" required style="width:100%;">
            </td>
            <td style="padding:8px;text-align:center;">
                <button type="button" class="remove-expense-btn" style="background:#E53E3E;color:white;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:0.875rem;font-family:'Inter',sans-serif;">Remove</button>
            </td>
        `;
        
        tbody.appendChild(newRow);
        expenseRowCounter++;
        
        // Add event listeners to new inputs
        const amountInput = newRow.querySelector('.expense-amount');
        amountInput.addEventListener('input', updateExpenseTotal);
        
        const removeBtn = newRow.querySelector('.remove-expense-btn');
        removeBtn.addEventListener('click', function() {
            newRow.remove();
            updateRemoveButtons();
            updateExpenseTotal();
        });
        
        updateRemoveButtons();
    }

    // Event listeners for expense breakdown
    document.getElementById('add-expense-row-btn').addEventListener('click', addExpenseRow);
    
    // Add listener to initial amount input
    document.querySelector('.expense-amount').addEventListener('input', updateExpenseTotal);
    
    // Add listener to initial remove button
    document.querySelector('.remove-expense-btn').addEventListener('click', function() {
        const row = this.closest('.expense-row');
        row.remove();
        updateRemoveButtons();
        updateExpenseTotal();
    });

    // Initialize
    updateRemoveButtons();

    // ========== END EXPENSE BREAKDOWN FUNCTIONALITY ==========

    // File Input Change Handler
    const proposalInput = document.getElementById('id_proposal_document');
    const proposalPreview = document.getElementById('proposal-file-preview');
    const proposalNameSpan = document.getElementById('proposal-file-name');
    const removeProposalBtn = document.getElementById('remove-proposal-file');

    proposalInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            proposalNameSpan.textContent = file.name;
            if (proposalPreview) proposalPreview.style.display = 'flex';
            if (removeProposalBtn) removeProposalBtn.style.display = 'inline-block';
        } else {
            proposalNameSpan.textContent = '';
            if (proposalPreview) proposalPreview.style.display = 'none';
            if (removeProposalBtn) removeProposalBtn.style.display = 'none';
        }
    });

    removeProposalBtn.addEventListener('click', function() {
        proposalInput.value = '';
        proposalNameSpan.textContent = '';
    if (proposalPreview) proposalPreview.style.display = 'none';
    if (removeProposalBtn) removeProposalBtn.style.display = 'none';
    });

    // Additional Documents Preview (omitted body for brevity, logic remains the same)
    const additionalInput = document.getElementById('id_additional_documents');
    const additionalPreview = document.getElementById('additional-file-preview');
    const additionalFilesList = document.getElementById('additional-files-list');
    let additionalFiles = [];

    // Allow adding more files to the list, not replacing
    additionalInput.addEventListener('change', function(e) {
        const newFiles = Array.from(e.target.files);
        // Only add files that aren't already present (by name and size)
        newFiles.forEach(f => {
            if (!additionalFiles.some(existing => existing.name === f.name && existing.size === f.size)) {
                additionalFiles.push(f);
            }
        });
        updateAdditionalInput();
        renderAdditionalFiles();
    });

    function renderAdditionalFiles() {
        additionalFilesList.innerHTML = '';
        if (additionalFiles.length > 0) {
            additionalFiles.forEach((file, idx) => {
                // Create a separate file-preview block for each file
                const preview = document.createElement('div');
                preview.className = 'file-preview';
                if (preview) preview.style.display = 'flex';
                preview.style.alignItems = 'center';
                preview.style.justifyContent = 'space-between';
                preview.style.marginTop = '15px';
                const info = document.createElement('div');
                info.className = 'file-info';
                info.innerHTML = `<svg width="16" height="16"><use href="#icon-upload"></use></svg> <span>${file.name}</span>`;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '✕';

                removeBtn.type = 'button';
                removeBtn.className = 'remove-x';
                removeBtn.onclick = function() {
                    additionalFiles.splice(idx, 1);
                    updateAdditionalInput();
                    renderAdditionalFiles();
                };
                preview.appendChild(info);
                preview.appendChild(removeBtn);
                additionalFilesList.appendChild(preview);
            });
            if (additionalPreview) additionalPreview.style.display = 'block';
        } else {
            if (additionalPreview) additionalPreview.style.display = 'none';
        }
    }

    function updateAdditionalInput() {
        // Create a new DataTransfer to update the input's files
        const dt = new DataTransfer();
        additionalFiles.forEach(file => dt.items.add(file));
        additionalInput.files = dt.files;
    }

    // Enhanced Tag UI logic for Project Leader, Providers, SDGs
    function setupTagUI(rowId, optionsTemplateId, inputName, single=false, excludeIds=[]) {
        const tagRow = document.getElementById(rowId);
        const optionsTemplate = document.getElementById(optionsTemplateId);

        // Get options
        const options = Array.from(optionsTemplate.options)
            .filter(opt => opt.value)
            .map(opt => ({id: opt.value, name: opt.text}));

        let selected = [];
            function renderTags() {
                // Always update providers' exclude when rendering leader
                if (rowId === 'project-leader-tag-row' && typeof updateProvidersExclude === 'function') {
                    updateProvidersExclude(selected[0] || null);
                }
            tagRow.innerHTML = '';
            selected.forEach(id => {
                const obj = options.find(o => o.id === id);
                if (obj) {
                    const tag = document.createElement('span');
                    tag.className = 'college-tag';
                    if (single) {
                        // Show red x for removal only
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'remove-x';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.onclick = function() {
                            selected = [];
                            renderTags();
                            // If Project Leader is removed, check budget
                            if (rowId === 'project-leader-tag-row') checkBudget(); 
                        };
                        tag.appendChild(removeBtn);
                    } else {
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'remove-x';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.onclick = function() {
                            selected = selected.filter(cid => cid !== id);
                            renderTags();
                        };
                        tag.appendChild(removeBtn);
                    }
                    tag.appendChild(document.createTextNode(obj.name));
                    tagRow.appendChild(tag);
                }
            });

            // Logic to display ADD/EDIT buttons and populate the custom dropdown
            
            // --- Common function for button click ---
            const buttonClickHandler = function(e, isEdit = false) {
                e.preventDefault();
                hideDropdown(); // Hide any currently open dropdown
                
                const button = e.currentTarget;
                const btnRect = button.getBoundingClientRect();
                
                // Position dropdown relative to the document (accounts for scroll)
                dropdownContainer.style.display = 'block';
                dropdownContainer.style.left = (btnRect.left) + 'px';
                dropdownContainer.style.top = (btnRect.bottom + window.scrollY + 4) + 'px'; // FIX: Add scrollY for absolute positioning
                
                // Clear and populate dropdown options
                dropdownOptionsDiv.innerHTML = '';
                dropdownFilter.value = '';
                
                let exclude = excludeIds.slice();
                
                // --- Mutual Exclusion Logic ---
                if (rowId === 'project-leader-tag-row') {
                    const providerTagRow = document.getElementById('providers-tag-row');
                    if (providerTagRow) {
                        const providerInputs = providerTagRow.querySelectorAll('input[name="providers[]"]');
                        providerInputs.forEach(input => {
                            if (input.value && !exclude.includes(input.value)) exclude.push(input.value);
                        });
                    }
                } else if (rowId === 'providers-tag-row') {
                    const leaderTagRow = document.getElementById('project-leader-tag-row');
                    if (leaderTagRow) {
                        const leaderInput = leaderTagRow.querySelector('input[name="project_leader"]');
                        if (leaderInput && leaderInput.value && !exclude.includes(leaderInput.value)) {
                            exclude.push(leaderInput.value);
                        }
                    }
                }
                
                options.forEach(opt => {
                    if (!selected.includes(opt.id) && !exclude.includes(opt.id)) {
                        const optionEl = document.createElement('div');
                        optionEl.className = 'custom-dropdown-option';
                        optionEl.textContent = opt.name;
                        optionEl.setAttribute('data-id', opt.id);
                        
                        optionEl.onclick = function() {
                            const selectedId = this.getAttribute('data-id');
                            if (single) {
                                selected = [selectedId];
                            } else {
                                selected.push(selectedId);
                            }
                            renderTags();
                            if (rowId === 'project-leader-tag-row') checkBudget();
                            hideDropdown();
                        };
                        dropdownOptionsDiv.appendChild(optionEl);
                    }
                });

                dropdownFilter.focus(); // Focus the search box immediately
            };

            if (!single || selected.length === 0) {
                // ADD Button logic
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.id = rowId + '-add-btn';
                addBtn.className = 'add-college-btn';
                addBtn.style.marginLeft = '8px';
                addBtn.innerHTML = `<svg width="16" height="16"><use href="#icon-add" /></svg>`;
                
                addBtn.onclick = buttonClickHandler; // Use the combined handler
                tagRow.appendChild(addBtn);
            } else if (single && selected.length === 1) {
                // Show edit button outside the tag, same position as add (RESTORATION FIX)
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.id = rowId + '-edit-btn';
                editBtn.className = 'add-college-btn';
                editBtn.style.marginLeft = '8px';
                editBtn.innerHTML = `<svg width="16" height="16"><use href="#icon-edit" /></svg>`;
                editBtn.title = 'Change';
                
                editBtn.onclick = function(e) {
                    // Temporarily remove the current selection so the list includes all options 
                    // (which is what Edit implies: replacing the selection)
                    const currentSelection = selected.slice();
                    selected = [];
                    
                    // Call the standard handler
                    buttonClickHandler(e, true);

                    // If the user closes the dropdown without selecting, restore the old value.
                    // The selection logic inside optionEl.onclick handles the replacement.
                    
                    // NOTE: The handler logic above handles single replacement automatically.
                    // This function remains simple because the options generated in buttonClickHandler
                    // already exclude the current leader (since selected is temporarily cleared).
                    
                    // To handle closing without selection, we rely on the mousedown listener (which calls hideDropdown)
                    // and simply trust that if a new item is selected, 'selected' will be updated.
                };
                
                tagRow.appendChild(editBtn);
            }

            // Hidden input creation remains the same
            selected.forEach(cid => {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = inputName + (single ? '' : '[]');
                hidden.value = cid;
                tagRow.appendChild(hidden);
            });
        }
        renderTags();
        
        return {
            getSelected: () => selected.slice(),
            setExclude: (ids) => { excludeIds = ids; renderTags(); },
            setSelected: (ids) => { 
                selected = ids.slice(); 
                renderTags(); 
                if (rowId === 'project-leader-tag-row') checkBudget(); 
            },
        };
    }

    // Setup tag UIs
    var leaderTagUI = setupTagUI('project-leader-tag-row', 'project-leader-options-template', 'project_leader', true);
    var providersTagUI = setupTagUI('providers-tag-row', 'providers-options-template', 'providers');
    setupTagUI('sdgs-tag-row', 'sdgs-options-template', 'sdgs');

    // Load AI team selection from localStorage if available (omitted body for brevity, logic remains the same)
    try {
        const aiTeamData = localStorage.getItem('aiTeamSelection');
        if (aiTeamData) {
            const teamData = JSON.parse(aiTeamData);
            const fiveMinutes = 5 * 60 * 1000;
            if (Date.now() - teamData.timestamp < fiveMinutes) {
                if (teamData.leader) {
                    leaderTagUI.setSelected([teamData.leader.toString()]);
                }
                if (teamData.providers && teamData.providers.length > 0) {
                    providersTagUI.setSelected(teamData.providers.map(p => p.toString()));
                }
            }
            localStorage.removeItem('aiTeamSelection');
        }
    } catch (e) {
        console.error('Error loading AI team selection:', e);
    }

    // Update providers to exclude selected leader
    function updateProvidersExclude(leaderId) {
        if (providersTagUI) {
            providersTagUI.setExclude(leaderId ? [leaderId] : []);
        }
    }

    // Logistics Block Logic with custom required (omitted body for brevity, logic remains the same)
    document.addEventListener('DOMContentLoaded', function() {
        var logisticsSelects = document.querySelector('select[name="logistics_type"]');
        var logisticsBlock = {
            'BOTH': document.getElementById('logistics-both'),
            'INTERNAL': document.getElementById('logistics-internal'),
            'EXTERNAL': document.getElementById('logistics-external'),
        };
        function updateLogisticsBlocks() {
            if (!logisticsSelects) return;
            var selected = logisticsSelects.value;
            
            Object.keys(logisticsBlock).forEach(function(logistics_type) {
                var block = logisticsBlock[logistics_type];
                if (!block) return;

                if (logistics_type === selected) {
                    block.style.display = 'block';
                    Array.from(block.querySelectorAll('input,select,textarea')).forEach(function(el) {
                        el.disabled = false;
                        // No more data-logistics-required or required attributes
                    });
                } else {
                    block.style.display = 'none';
                    Array.from(block.querySelectorAll('input,select,textarea')).forEach(function(el) {
                        el.disabled = true;
                        // No more data-logistics-required or required attributes
                    });
                }
            });
        }
        if (logisticsSelects) {
            logisticsSelects.addEventListener('change', updateLogisticsBlocks);
            updateLogisticsBlocks();
        }

        // Date validation for Project (omitted body for brevity, logic remains the same)
        const startDateInput = document.getElementById('id_start_date');
        const endDateInput = document.getElementById('id_estimated_end_date');
        
        if (startDateInput && endDateInput) {
            const today = new Date().toISOString().split('T')[0];
            startDateInput.setAttribute('min', today);
            
            startDateInput.addEventListener('change', function() {
                if (this.value) {
                    endDateInput.setAttribute('min', this.value);
                    if (endDateInput.value && endDateInput.value < this.value) {
                        endDateInput.value = '';
                    }
                }
            });
            
            // Date validation is now handled in the unified submit handler above
        }
    });
</script>

{% endblock %}