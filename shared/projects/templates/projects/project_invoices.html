{% extends "projects/base_project_profile.html" %}
{% block profile_content %}
{% load static humanize %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/view.css' %}" rel="stylesheet">

<div class="search-container">
    <form class="search-bar" method="get" action="">
        <svg width="16" height="16"> <use href="#icon-search"></use> </svg>
        <input type="text" name="search" placeholder="Search Receipt" value="{{ request.GET.search|default:'' }}"/>
        <button type="button" id="filterBtn" class="bg-none border-none p-0 mr-1 cursor-pointer">
            <svg width="16" height="16"> <use href="#icon-filter"></use> </svg>
        </button>
        <div id="filterDropdown" class="filter-dropdown" style="top: 455px;">
            <div class="filter-grid" style="grid-template-columns: repeat(2, 1fr); grid-template-rows: auto; grid-gap: 24px;">
                <label>Sort By
                    <select name="sort_by">
                        <option value="date" {% if request.GET.sort_by == 'date' %}selected{% endif %}>Date</option>
                        <option value="title" {% if request.GET.sort_by == 'title' %}selected{% endif %}>Title</option>
                        <option value="amount" {% if request.GET.sort_by == 'amount' %}selected{% endif %}>Amount</option>
                    </select>
                </label>
                <label>Order By
                    <select name="order">
                        <option value="desc" {% if request.GET.order == 'desc' %}selected{% endif %}>Descending</option>
                        <option value="asc" {% if request.GET.order == 'asc' %}selected{% endif %}>Ascending</option>
                    </select>
                </label>
            </div>
            <div class="filter-actions">
                <button type="submit" class="filter-apply">Apply</button>
                <button type="button" id="closeFilter" class="filter-close">Clear Filters</button>
            </div>
        </div>
    </form>
</div>

<div class="card-header">
    <h3>Invoices</h3>
    {% if request.user.role in ADMIN_ROLES %}
        <button type="button" id="openExpense" class="admin-button edit">Add Expense</button>
    {% endif %}
</div>

<div style="margin-top:2rem;">
    <div class="files-grid">
  {% for expense in expenses %}
    {# Display file card for every expense, showing placeholder if receipt is missing #}
    <div class="file-card">
      <div class="file-thumb">
        {% if expense.receipt and expense.receipt.url %}
          {% if expense.receipt.name|lower|slice:"-4:" == ".pdf" %}
            <span style="font-size:.9rem;color:#374151">PDF Receipt</span>
          {% else %}
            <img src="{{ expense.receipt.url }}" alt="Receipt"/>
          {% endif %}
        {% else %}
            {# Placeholder if receipt is missing #}
            <span class="no-receipt-text">Receipt Not Available</span>
        {% endif %}
      </div>
      <div class="file-info">
        <div class="file-title">{{ expense.title|default:expense.reason }}</div>
        <div class="file-date">{{ expense.date_incurred|date:"m/d/Y" }}</div>
        
        {% if expense.receipt and expense.receipt.url %}
            <a href="{{ expense.receipt.url }}" target="_blank" class="file-link">View receipt</a>
        {% else %}
             <span class="file-date">Upload required</span>
        {% endif %}

      </div>
    </div>
  {% empty %}
    {# This only shows if the 'expenses' list is entirely empty #}
    <div class="expense-empty" style="grid-column:1/-1;text-align:center;">No expenses recorded yet.</div>
  {% endfor %}
  </div>
</div>

{# Expense form overlay #}
<div class="overlay-container" id="overlay">
  <div class="overlay-content-modal">
    <button type="button" class="close-x" id="closeX" aria-label="Close">&times;</button>
    <h2 class="modal-title">Add Expense</h2>
    <form class="expenseForm" id="expenseForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="form-group-grid">
        <div class="form-field-col">
          <label class="form-label-modal">Reason <span class="text-red-600">*</span></label>
          <input type="text" name="reason" placeholder="Meals" required aria-required="true" class="input-field">
        </div>
        <div class="form-field-col">
          <label class="form-label-modal">Total Expense (â‚±) <span class="text-red-600">*</span></label>
          <input type="number" name="amount" step="0.01" placeholder="100.00" required aria-required="true" class="input-field">
        </div>
      </div>
      <div class="form-field-col mt-4">
        <label class="form-label-modal">Upload Receipt <span class="text-red-600">*</span></label>
        <div id="uploadBox" class="upload-container">
          <input id="receipt" name="receipt" type="file" accept="image/*,.pdf" required aria-required="true" style="display:none" />
          <span id="uploadText" class="upload-text-modal">Click to upload</span>
        </div>
      </div>
      <div class="form-field-col mt-4">
        <label class="form-label-modal">Notes <span class="text-red-600">*</span></label>
        <textarea name="notes" rows="3" placeholder="(e.g. Bento box)" required aria-required="true" class="input-field"></textarea>
      </div>
      <div class="form-actions-row">
        <button type="submit" class="btn-save">Save</button>
        <button type="button" id="closeOverlay" class="btn-cancel">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Filter dropdown toggle
  (function(){
    const filterBtn = document.getElementById('filterBtn');
    const filterDropdown = document.getElementById('filterDropdown');
    const closeFilter = document.getElementById('closeFilter');
    if (filterBtn && filterDropdown) {
      filterBtn.addEventListener('click', function(e) {
        e.preventDefault();
        filterDropdown.style.display = filterDropdown.style.display === 'block' ? 'none' : 'block';
      });
      document.addEventListener('click', function(e) {
        if (!filterBtn.contains(e.target) && !filterDropdown.contains(e.target)) {
          filterDropdown.style.display = 'none';
        }
      });
    }
    if (closeFilter) {
      closeFilter.addEventListener('click', function() {
        window.location.href = window.location.pathname;
      });
    }
  })();

  // Overlay open/close (triggered by header button)
  (function(){
    const headerBtn = document.getElementById('openExpense');
    const overlay = document.getElementById('overlay');
    const closeBtn = document.getElementById('closeOverlay');
    const closeX = document.getElementById('closeX');
    if (headerBtn && overlay) headerBtn.addEventListener('click', ()=> overlay.style.display='flex');
    if (closeBtn && overlay) closeBtn.addEventListener('click', ()=> overlay.style.display='none');
    if (closeX && overlay) closeX.addEventListener('click', ()=> overlay.style.display='none');
    
    // Receipt upload logic
    const uploadBox = document.getElementById('uploadBox');
    const receiptInput = document.getElementById('receipt');
    const uploadText = document.getElementById('uploadText'); // Changed from 'uploadText' to 'uploadText-modal' in CSS, but keeping JS logic consistent with original HTML ID/class intent
    
    if (uploadBox && receiptInput){
      uploadBox.addEventListener('click', ()=> receiptInput.click());
      receiptInput.addEventListener('change', ()=>{
        const f = receiptInput.files && receiptInput.files[0];
        if (f && uploadText){ uploadText.textContent = f.name; uploadText.style.color = '#1a4a2e'; }
      });
    }
  })();
</script>

{% endblock %}