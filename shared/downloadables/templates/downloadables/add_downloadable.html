{% extends "base_internal.html" %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add Downloadable</title>
<link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/styles.css' %}" rel="stylesheet">
</head>
<body>
    <div class="main-container">
        <div class="user-details-title">
            <h2>Add Submission</h2> 
            <p>Input all fields correctly and upload new document.</p>
        </div>

        {% if success %}
            <div class="success-message">Downloadable added successfully!</div>
        {% endif %}
        {% if error %}
            <div class="error-message">{{ error }}</div>
        {% endif %}

        <form class="downloadable-form" method="post" enctype="multipart/form-data" id="downloadable-form" action="{% url 'add_downloadable' %}">
            {% csrf_token %} 
            <div class="user-details-section"> 
				<div class="user-details-category">  
					<i class="fa-regular fa-address-card subtitle-icon"></i>
					Details
				</div>
                <div class="form-group">
                    <label class="user-details-label" for="id_file">Attach File <span class="required">*</span></label>
                    <div class="upload-area" onclick="document.getElementById('id_file').click()">
                        <svg class="upload-icon"><use href="#icon-upload"></use></svg>
                        <span class="upload-text" id="upload-text">Click to upload</span>
                        <input class="file-input" type="file" name="file" id="id_file" style="display:none;" accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                    </div>
                </div>
                <div class="checkbox-row">
                    <input type="checkbox" id="id_available_for_non_users" name="available_for_non_users" style="width:18px;height:18px;">
                    <label for="id_available_for_non_users" style="font-size:1rem;color:#245F3E;cursor:pointer;">Available for the public</label> 
                </div>
                <div class="checkbox-row" id="submission-template-row" style="display:none;">
                    <input type="checkbox" id="id_is_submission_template" name="is_submission_template" style="width:18px;height:18px;">
                    <label for="id_is_submission_template" style="font-size:1rem;color:#245F3E;cursor:pointer;">Submission Template</label>
                </div>
                <div class="form-group" id="submission-type-row" style="display:none;">
                    <div style="margin-top: 1rem; margin-bottom: 0.4rem;">
                        <label class="user-details-label" for="id_submission_type">Submission Type</label>
                        <span class="info-icon">    
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
                            </svg>
                        <span class="info-tooltip">'Events' are submissions for extension activities. 'Files' are general submissions of the specific template. 'Final' is the submissions to be required at the end of a project's lifetime.</span>
                    </div>
                    <select id="id_submission_type" name="submission_type" class="user-details-value">
                        {% for value, label in submission_type_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div> 
            </div> 
            <div class="form-actions">
                <a href="{% url 'downloadable_dispatcher' %}" class="back btn">Back</a>
                <button type="submit" class="save btn" id="submit-btn">Submit</button>
            </div>
        </form>
    </div>

<!-- SVG Sprite Section -->
<svg style="display:none;">

    <!-- Upload Icon -->
    <symbol id="icon-upload" viewBox="0 0 24 24" fill="currentColor">
        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
        <path d="M12,11L8,15H16L12,11Z" />
    </symbol>

</svg>

<script>
    // File Input Change Handler
    document.getElementById('id_file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileInput = document.getElementById('id_file');
        const uploadText = document.getElementById('upload-text');
        fileInput.classList.remove('error-input');
        if (file) {
            uploadText.textContent = file.name;
        } else {
            uploadText.textContent = 'Click to upload';
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Dynamic show/hide logic for submission template and type
        var availableForNonUsers = document.getElementById('id_available_for_non_users');
        var submissionTemplateRow = document.getElementById('submission-template-row');
        var isSubmissionTemplate = document.getElementById('id_is_submission_template');
        var submissionTypeRow = document.getElementById('submission-type-row');

        function updateSubmissionTemplateVisibility() {
            if (availableForNonUsers.checked) {
                submissionTemplateRow.style.display = 'none';
                isSubmissionTemplate.checked = false;
                submissionTypeRow.style.display = 'none';
            } else {
                submissionTemplateRow.style.display = ''; 
                if (isSubmissionTemplate.checked) {
                    submissionTypeRow.style.display = '';
                } else {
                    submissionTypeRow.style.display = 'none';
                }
            }
        }
        availableForNonUsers.addEventListener('change', updateSubmissionTemplateVisibility);
        isSubmissionTemplate.addEventListener('change', updateSubmissionTemplateVisibility);
        updateSubmissionTemplateVisibility();

        // Global error catcher for form submission
        var form = document.getElementById('downloadable-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                let valid = true;
                const fields = Array.from(form.querySelectorAll('input'));
                fields.forEach(field => {
                    field.classList.remove('error-input');
                    let err = document.getElementById(field.name + '-error');
                    if (err) err.remove();
                });

                function removeError(tagRow, errorId) {
                    let err = document.getElementById(errorId);
                    if (err) err.remove();
                    if (tagRow) tagRow.classList.remove('error-input');
                }

                removeError(document.getElementById('file-error'), 'file-error');

                var fileInput = document.getElementById('id_file');
                var fileSelected = fileInput && fileInput.files && fileInput.files.length > 0;
                if (!fileSelected) {
                    valid = false;
                    fileInput.classList.add('error-input');
                    let err = document.createElement('div');
                    err.id = 'file-error';
                    err.textContent = 'File is required.';
                    err.style.color = '#E53E3E';
                    err.style.fontSize = '0.95rem';
                    err.style.marginTop = '0.25rem';
                    fileInput.parentNode.appendChild(err);
                }

                if (!valid) {
                    e.preventDefault();
                    return;
                }
            });
        }
    });
</script>

</body>
</html>

{% endblock %}