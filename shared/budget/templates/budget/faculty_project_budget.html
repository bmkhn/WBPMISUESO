{% extends 'base_public.html' %}
{% load static humanize %}

{% block title %}Project Budget{% if project %} - {{ project.title }}{% endif %}{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body, button, input, textarea, select {font-family:'Inter', Arial, sans-serif}
  .tags{display:flex;justify-content:space-between;width:100%;margin-bottom:2.25rem}
  .campus{background:#ff9f10;color:#372700;border:.08rem solid #ff9f10;font-weight:600;padding:.35rem .6rem;margin-right:.5rem;border-radius:.25rem}
  .agenda{background:linear-gradient(90deg,#fff,#00ff6e3d);color:#313131;border:.08rem solid #313131;font-weight:500;padding:.35rem .6rem;margin-right:.5rem;border-radius:.25rem}
  .status{background:whitesmoke;color:#1CB889;border:.08rem solid #1CB889;font-weight:500;padding:.35rem .6rem;margin-right:.5rem;border-radius:.25rem}
  .project-title{font-size:1.5rem;font-weight:500;margin:.25rem 0 1rem 0;color:#222;text-decoration:none}
  .project-date{font-size:.9rem;color:#666;margin:1rem 0 2rem 0;font-weight:300}
  .project-authors{display:flex;align-items:center;gap:1.5rem;margin:1rem 0 2rem 0;position:relative}
  .project-authors content{display:flex;align-items:center;gap:.75rem}
  .project-authors img{width:2.5rem;height:2.5rem;border-radius:50%;object-fit:cover;border:.08rem solid #ccc}
  .project-authors a{font-size:.9rem;color:#000;text-decoration:none}
  .project-authors a:hover{color:#007bff}
  .expense-add{position:absolute;right:0}
  .expense-add button{color:#fff;background:#245F3E;padding:.75rem 1.5rem;font-size:1rem;font-weight:500;border-radius:.75rem;border:none;cursor:pointer;transition:.2s;box-shadow:0 2px 4px rgba(0,0,0,.1)}
  .expense-add button:hover{background:#1a4a2e;transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
  .tabs{display:flex;gap:.5rem;border-bottom:1px solid #ddd;margin-top:1rem}
  .tab-btn{background:none;border:none;padding:.75rem 1rem;cursor:pointer;border-bottom:3px solid transparent;font-size:.95rem}
  .tab-btn.active{border-bottom-color:#245F3E;color:#245F3E;font-weight:500}
  .tab-content{display:none}
  .tab-content.active{display:block}
  .project-grid{display:flex;gap:1rem;align-items:flex-start}
  .chart-container{width:16rem;height:16rem}
  .expense-card{background:#fff;border:1px solid #e5e7eb;border-radius:.8rem;overflow:hidden;box-shadow:0 1px 2px rgba(0,0,0,.04);width:100%;font-size:.9rem}
  .expense-header,.expense-row{display:grid;grid-template-columns:minmax(240px,1fr) 150px 170px;column-gap:10px;align-items:center}
  .expense-header{background:#f7f8fa;color:#111;font-weight:600;padding:.6rem .8rem;border-bottom:1px solid #e5e7eb}
  .expense-row{padding:.6rem .8rem;border-bottom:1px solid #eef0f3}
  .expense-row:last-child{border-bottom:none}
  .expense-reason{word-break:break-word;white-space:normal}
  .expense-amount,.expense-date{text-align:right;white-space:nowrap}
  .expense-empty{padding:1rem;color:#6b7280}
  .files-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1rem}
  .file-card{background:#fff;border:1px solid #e5e7eb;border-radius:.75rem;padding:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.05);display:flex;flex-direction:column;gap:.5rem}
  .file-thumb{height:120px;display:flex;align-items:center;justify-content:center;background:#f9fafb;border:1px dashed #e5e7eb;border-radius:.5rem;overflow:hidden}
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5)}
  .overlay-content{background:#fff;border-radius:1rem;padding:1.25rem;width:45rem;max-width:95%;position:relative}
</style>

<section style="margin:0 5rem 0 5rem; padding: 3rem; background:#fff; border-radius:1rem; box-shadow:0 2px 4px rgba(0,0,0,.08);">
  <div class="tags">
    <content style="flex-grow:2;">
      {% if project.project_leader and project.project_leader.get_campus_display %}<button class="campus">{{ project.project_leader.get_campus_display }}</button>{% endif %}
      {% if project.agenda %}<button class="agenda">{{ project.agenda.name }}</button>{% endif %}
    </content>
    <content style="flex-grow:0;">
      <button class="status">{{ project.get_status_display }}</button>
    </content>
  </div>

  <div>
    <a href="#" class="project-title">{{ project.title }}</a>
    <h5 class="project-date">{{ project.start_date|date:'F d, Y' }} - {{ project.estimated_end_date|date:'F d, Y' }}</h5>
  </div>

  <div class="project-authors">
    {% if project.project_leader %}
    <content>
      <img src="{{ project.project_leader.profile_picture_or_initial }}" alt="">
      <a href="{% url 'user_profile' project.project_leader.id %}">{{ project.project_leader.get_full_name|default:project.project_leader.username }}</a>
    </content>
    {% endif %}
    {% for provider in project.providers.all %}
    <content>
      <img src="{{ provider.profile_picture_or_initial }}" alt="">
      <a href="{% url 'user_profile' provider.id %}">{{ provider.get_full_name|default:provider.username }}</a>
    </content>
    {% endfor %}
    <div class="expense-add">
      <button type="button" id="openExpense">Add Expense</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="overview">Overview</button>
    <button class="tab-btn" data-tab="files">Files</button>
  </div>

  <div id="overview" class="tab-content active" style="margin-top:2rem;">
    <div class="project-grid">
      <section>
        <div class="chart-container">
          <canvas id="goal1" width="256" height="256" data-remaining-total="{{ remaining_total|default:0 }}" data-spent-total="{{ spent_total|default:0 }}" data-percent="{{ percent_remaining|default:0 }}"></canvas>
        </div>
        <div class="cash-available" style="font-size:1.1rem;margin-top:.5rem;">
          Current Budget: <strong>₱ {{ remaining_total|floatformat:2|intcomma }}</strong>
        </div>
        <div id="goalText" style="margin-top:.5rem;color:#555"></div>
      </section>
      <section style="flex:1;">
        <div class="expense-card">
          <div class="expense-header">
            <div>Reason/s</div>
            <div class="expense-amount">Expense</div>
            <div class="expense-date">Date</div>
          </div>
          <div class="expense-body">
            {% for expense in expenses %}
            <div class="expense-row">
              <div class="expense-reason">{{ expense.title|default:expense.reason }}</div>
              <div class="expense-amount">₱ {{ expense.amount|floatformat:2|intcomma }}</div>
              <div class="expense-date">{{ expense.date_incurred|date:'m-d-Y' }}</div>
            </div>
            {% empty %}
            <div class="expense-empty">No expenses recorded yet.</div>
            {% endfor %}
          </div>
        </div>
      </section>
    </div>
  </div>

  <div id="files" class="tab-content" style="margin-top:2rem;">
    <div class="files-grid">
      {% for expense in expenses %}
        {% if expense.receipt %}
        <div class="file-card">
          <div class="file-thumb">
            {% if expense.receipt.name|lower|slice:'-4:' == '.pdf' %}
              <span style="font-size:.9rem;color:#374151">PDF Receipt</span>
            {% else %}
              <img src="{{ expense.receipt.url }}" alt="Receipt" style="max-width:100%;max-height:100%;object-fit:contain"/>
            {% endif %}
          </div>
          <div style="display:flex;flex-direction:column;gap:.25rem">
            <div style="font-weight:600;font-size:.95rem;color:#111;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{ expense.title|default:expense.reason }}</div>
            <div style="font-size:.85rem;color:#6b7280;">{{ expense.date_incurred|date:'m-d-Y' }}</div>
            <a href="{{ expense.receipt.url }}" target="_blank" style="margin-top:.25rem;text-decoration:none;color:#0f766e;font-weight:500">View receipt</a>
          </div>
        </div>
        {% endif %}
      {% empty %}
        <div class="expense-empty">No receipts uploaded yet.</div>
      {% endfor %}
    </div>
  </div>
</section>

<!-- Add Expense Overlay -->
<div class="overlay" id="overlay">
  <div class="overlay-content">
    <button type="button" id="closeX" aria-label="Close" style="position:absolute;right:1rem;top:1rem;background:none;border:none;font-size:1.5rem;cursor:pointer">&times;</button>
    <h2 style="margin:0 0 1rem 0;font-weight:500">Add Expense</h2>
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        <div style="display:flex;flex-direction:column">
          <label style="font-weight:500;margin-bottom:.25rem">Reason <span style="color:#dc2626">*</span></label>
          <input type="text" name="reason" required placeholder="Meals" style="padding:1rem .5rem;border:1px solid #868686;border-radius:.5rem;background:#e9e9e9">
        </div>
        <div style="display:flex;flex-direction:column">
          <label style="font-weight:500;margin-bottom:.25rem">Total Expense (₱) <span style="color:#dc2626">*</span></label>
          <input type="number" name="amount" step="0.01" required placeholder="100.00" style="padding:1rem .5rem;border:1px solid #868686;border-radius:.5rem;background:#e9e9e9">
        </div>
      </div>
      <div style="margin-top:1rem;display:flex;flex-direction:column">
        <label style="font-weight:500;margin-bottom:.25rem">Upload Receipt <span style="color:#dc2626">*</span></label>
        <div id="uploadBox" class="upload-container" style="background:#f8f9fa;border:2px dashed #245F3E;padding:1.25rem;display:flex;align-items:center;border-radius:.75rem;cursor:pointer">
          <input id="receipt" name="receipt" type="file" accept="image/*,.pdf" required style="display:none" />
          <span id="uploadText" style="font-weight:600;color:#245F3E">Click to upload</span>
        </div>
      </div>
      <div style="margin-top:1rem;display:flex;flex-direction:column">
        <label style="font-weight:500;margin-bottom:.25rem">Notes <span style="color:#dc2626">*</span></label>
        <textarea name="notes" rows="3" required placeholder="(e.g. Bento box)" style="padding:1rem .5rem;border:1px solid #868686;border-radius:.5rem;background:#e9e9e9"></textarea>
      </div>
      <div style="margin-top:1rem;display:flex;gap:.75rem">
        <button type="submit" class="btn" style="background:#245F3E;color:#fff;border:none;border-radius:.5rem;padding:.6rem 1rem;cursor:pointer">Save</button>
        <button type="button" id="closeOverlay" style="background:#6b7280;color:#fff;border:none;border-radius:.5rem;padding:.6rem 1rem;cursor:pointer">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Tabs
  (function(){
    const buttons=document.querySelectorAll('.tab-btn');
    const tabs={overview:document.getElementById('overview'),files:document.getElementById('files')};
    buttons.forEach(btn=>btn.addEventListener('click',()=>{
      const key=btn.getAttribute('data-tab');
      buttons.forEach(b=>b.classList.remove('active'));
      Object.values(tabs).forEach(el=>{el.classList.remove('active');el.style.display='none'});
      btn.classList.add('active');
      tabs[key].classList.add('active');
      tabs[key].style.display='block';
    }));
  })();

  // Overlay
  (function(){
    const openBtn=document.getElementById('openExpense');
    const overlay=document.getElementById('overlay');
    const closeBtn=document.getElementById('closeOverlay');
    const closeX=document.getElementById('closeX');
    if(openBtn&&overlay)openBtn.addEventListener('click',()=>overlay.style.display='flex');
    if(closeBtn&&overlay)closeBtn.addEventListener('click',()=>overlay.style.display='none');
    if(closeX&&overlay)closeX.addEventListener('click',()=>overlay.style.display='none');
    const uploadBox=document.getElementById('uploadBox');
    const receipt=document.getElementById('receipt');
    const uploadText=document.getElementById('uploadText');
    if(uploadBox&&receipt){
      uploadBox.addEventListener('click',()=>receipt.click());
      receipt.addEventListener('change',()=>{const f=receipt.files&&receipt.files[0];if(f&&uploadText){uploadText.textContent=f.name;uploadText.style.color='#1a4a2e'}});
    }
  })();

  // Donut chart
  (function(){
    const canvas=document.getElementById('goal1');
    if(!canvas||!window.Chart)return;
    const rt = parseFloat(canvas.getAttribute('data-remaining-total')||'0')||0;
    const st = parseFloat(canvas.getAttribute('data-spent-total')||'0')||0;
    const remainingPct = parseFloat(canvas.getAttribute('data-percent')||'0')||0;
    const data={labels:['Remaining','Spent'],data:[rt,st],colors:['#10b981','#111111']};
    const centerText={id:'centerText',afterDraw(chart){const {ctx,chartArea:{left,right,top,bottom}}=chart;const x=(left+right)/2,y=(top+bottom)/2;ctx.save();ctx.font='bold 18px Arial';ctx.fillStyle='#111';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(`${Math.round(remainingPct)}%`,x,y);ctx.restore();}};
    new Chart(canvas.getContext('2d'),{type:'doughnut',data:{labels:data.labels,datasets:[{data:data.data,backgroundColor:data.colors,borderWidth:0}]},options:{rotation:-90,circumference:360,responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{display:false},tooltip:{enabled:false}}},plugins:[centerText]});
    const gt=document.getElementById('goalText'); if(gt) gt.textContent=`Your project currently has ${Math.round(remainingPct)}% of its initial budget remaining.`;
  })();
</script>

{% endblock %}


