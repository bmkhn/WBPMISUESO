{% extends base_template %}
{% load humanize static %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<div class="main" style="padding: 24px; font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
    <div style="max-width: 1100px; margin: 0 auto;">
        <!-- Header / Breadcrumb -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <div>
                <div style="font-size:12px; color:#6b7280; margin-bottom:4px;">
                    <a href="{% url 'budget_dashboard' %}" style="color:#0f766e; text-decoration:none;">Budget Dashboard</a>
                    <span> / </span>
                    <span>Project Ledger</span>
                </div>
                <h1 style="font-size:20px; font-weight:700; color:#111827; margin:0;">
                    {{ project.title }}
                </h1>
                <p style="margin:4px 0 0 0; font-size:13px; color:#4b5563;">
                    Project ID: {{ project.id }} · Status: {{ project.get_status_display }}
                </p>
            </div>
            <div style="text-align:right;">
                <div style="font-size:12px; color:#6b7280; margin-bottom:4px;">Total Approved Budget</div>
                <div style="font-size:18px; font-weight:700; color:#111827;">
                    ₱{{ budget_total|floatformat:2|intcomma }}
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div style="display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:16px; margin-bottom:20px;">
            <div style="border-radius:12px; border:1px solid #e5e7eb; padding:14px; background:#f9fafb;">
                <div style="font-size:12px; color:#6b7280;">Total Spent</div>
                <div style="font-size:18px; font-weight:700; color:#b91c1c; margin-top:4px;">
                    ₱{{ spent_total|floatformat:2|intcomma }}
                </div>
            </div>
            <div style="border-radius:12px; border:1px solid #e5e7eb; padding:14px; background:#f9fafb;">
                <div style="font-size:12px; color:#6b7280;">Remaining Budget</div>
                <div style="font-size:18px; font-weight:700; color:#16a34a; margin-top:4px;">
                    ₱{{ remaining_total|floatformat:2|intcomma }}
                </div>
            </div>
            <div style="border-radius:12px; border:1px solid #e5e7eb; padding:14px; background:#f9fafb;">
                <div style="font-size:12px; color:#6b7280;">% of Budget Remaining</div>
                <div style="font-size:18px; font-weight:700; color:#111827; margin-top:4px;">
                    {{ percent_remaining }}%
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div style="border-radius:16px; border:1px solid #e5e7eb; padding:18px; margin-bottom:20px;">
            <h2 style="font-size:15px; font-weight:600; margin:0 0 12px 0; color:#111827;">
                Budget Utilization
            </h2>
            <div style="max-width:420px;">
                <canvas id="projectBudgetChart"
                        data-chart='{{ chart_data_json|escapejs }}'
                        width="400"
                        height="220"></canvas>
            </div>
        </div>

        <!-- Expense Table -->
        <div style="border-radius:16px; border:1px solid #e5e7eb; padding:18px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 style="font-size:15px; font-weight:600; margin:0; color:#111827;">Expense Ledger</h2>
                <span style="font-size:12px; color:#6b7280;">
                    {{ expenses|length }} record{{ expenses|length|pluralize }}
                </span>
            </div>
            {% if expenses %}
                <div style="overflow-x:auto;">
                    <table class="user-table" style="width:100%; font-size:13px;">
                        <thead>
                            <tr>
                                <th style="white-space:nowrap;">Date Incurred</th>
                                <th>Title</th>
                                <th>Reason / Notes</th>
                                <th style="white-space:nowrap;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in expenses %}
                            <tr>
                                <td style="white-space:nowrap;">
                                    {% if e.date_incurred %}
                                        {{ e.date_incurred|date:"Y-m-d" }}
                                    {% else %}
                                        {{ e.created_at|date:"Y-m-d" }}
                                    {% endif %}
                                </td>
                                <td>{{ e.title }}</td>
                                <td>{{ e.reason|default:"—" }}</td>
                                <td style="white-space:nowrap; font-weight:600;">
                                    ₱{{ e.amount|floatformat:2|intcomma }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p style="font-size:13px; color:#6b7280; margin:4px 0 0 0;">
                    No expenses have been recorded for this project.
                </p>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    (function() {
        const canvas = document.getElementById('projectBudgetChart');
        if (!canvas) return;

        let raw = canvas.getAttribute('data-chart') || '{}';
        try {
            const data = JSON.parse(raw);
            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels || ['Remaining', 'Spent'],
                    datasets: [{
                        data: data.data || [0, 0],
                        backgroundColor: data.colors || ['#16a34a', '#d1d5db'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 11 } }
                        }
                    },
                    cutout: '60%'
                }
            });
        } catch (e) {
            console.error('Failed to init project budget chart', e);
        }
    })();
</script>
{% endblock %}


