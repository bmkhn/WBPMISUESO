{% extends base_template %}
{% load static %}
{% load humanize %}
{% block title %}{{ title }}{% endblock %}

{% block content %}

<style>
    /* Basic table styling to match your other modules */
    .styled-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
        background-color: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .styled-table thead tr {
        background-color: #f9fafb; /* Lighter gray for header */
        color: #374151; /* Dark gray text */
        text-align: left;
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .styled-table th,
    .styled-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #e0e0e0;
    }
    .styled-table tbody tr {
        color: #1f2937; /* Darker text for body */
    }
    .styled-table tbody tr:hover {
        background-color: #f9fafb;
    }
    .styled-table td input[type="text"] {
        width: 100%;
        padding: 8px 12px 8px 28px; /* Added padding for '₱' sign */
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box; /* Ensures padding doesn't affect width */
    }
    .styled-table td .input-wrapper {
        position: relative;
    }
    .styled-table td .input-symbol {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
        font-size: 14px;
    }

    /* Form action buttons */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        padding-top: 24px;
        margin-top: 24px;
        border-top: 1px solid #e0e0e0;
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.2s ease;
    }
    .btn-primary {
        background-color: #2563eb; /* Blue */
        color: white;
    }
    .btn-primary:hover {
        background-color: #1d4ed8;
    }
    .btn-secondary {
        background-color: #e5e7eb; /* Light Gray */
        color: #374151;
        margin-right: 12px;
    }
    .btn-secondary:hover {
        background-color: #d1d5db;
    }
    .btn-save {
        background-color: #16a34a; /* Green */
        color: white;
    }
    .btn-save:hover {
        background-color: #15803d;
    }
</style>

<div class="user-details-container" style="max-width: 1200px; margin: auto; padding: 20px;">
    
    <div class="user-details-title" style="display: flex; justify-content: space-between; align-items: center; border-bottom: none; padding-bottom: 0;">
        <div>
            <h2 style="font-size: 28px; font-weight: 700; color: #1f2937; margin: 0;">{{ title }}</h2>
            <p style="font-size: 16px; color: #4b5563; margin-top: 4px;">Manage budget allocations and assignments.</p>
        </div>
        <a href="{% url 'budget_dashboard' %}" class="btn btn-secondary" style="font-size: 14px; padding: 8px 16px;">
            &larr; Back to Dashboard
        </a>
    </div>

    {% if user_role in "VP,DIRECTOR,UESO" %}
    <form method="POST" id="adminBudgetForm">
        {% csrf_token %}
        <div class="user-details-section" style="margin-top: 24px;">
            <div class="user-details-category" style="font-size: 18px; font-weight: 600; color: #111827; border-bottom: 1px solid #e0e0e0; padding-bottom: 12px; margin-bottom: 20px;">
                College Allocation Manager
            </div>
            
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>College</th>
                        <th>New Allocation (Initial)</th>
                        <th>Internal Budget (Committed)</th>
                        <th>Remaining (Uncommitted)</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for item in colleges_data %}
                    <tr data-college-name="{{ item.college_name }}" data-committed-funding="{{ item.committed_funding }}">
                        <td style="font-weight: 500;">{{ item.college_name }}</td>
                        <td>
                            <div class="input-wrapper">
                                <span class="input-symbol">₱</span>
                                <input type="text" 
                                       name="college_{{ item.college_id }}" 
                                       id="college-input-{{ item.college_id }}"
                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\\..*)\\./g, '$1');"
                                >
                            </div>
                        </td>
                        <td style="color: #4b5563;">₱{{ item.committed_funding|intcomma }}</td>
                        <td style="font-weight: 600;" id="remaining-{{ item.college_id }}">
                            ₱{{ item.uncommitted_remaining|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="form-actions">
                <button type="submit" name="assign_college_budget" class="btn btn-save">
                    Save Allocations
                </button>
            </div>
        </div>
    </form>
    {% endif %}

    {% if is_college_admin %}
    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px; margin-top: 24px;">
        
        <div style="display: flex; flex-direction: column; gap: 24px;">
            <form method="POST" class="user-details-section">
                {% csrf_token %}
                <div class="user-details-category" style="font-size: 18px; font-weight: 600; color: #111827; border-bottom: 1px solid #e0e0e0; padding-bottom: 12px; margin-bottom: 20px;">
                    Assign Project Budget
                </div>
                
                <div class="user-details-row cols-1">
                    <div>
                        <div class="user-details-label">Project</div>
                        {{ project_form.project }}
                        {% if project_form.project.errors %}
                            <p style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ project_form.project.errors|first }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="user-details-row cols-1" style="margin-top: 16px;">
                    <div>
                        <div class="user-details-label">New Internal Budget</div>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #6b7280; font-size: 14px;">₱</span>
                            {{ project_form.internal_budget }}
                        </div>
                        {% if project_form.internal_budget.errors %}
                            <p style="color: #ef4444; font-size: 12px; margin-top: 4px;">{{ project_form.internal_budget.errors|first }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-actions" style="border-top: none; margin-top: 16px; padding-top: 0;">
                    <button type="submit" name="assign_project_budget" class="btn btn-primary" style="width: 100%;">
                        Update Project Budget
                    </button>
                </div>
            </form>

            <div class="user-details-section">
                <h3 class="user-details-category" style="font-size: 18px; font-weight: 600; color: #111827; border-bottom: 1px solid #e0e0e0; padding-bottom: 12px; margin-bottom: 20px;">
                    {{ college_name }}
                </h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px;">
                        <span style="color: #4b5563;">Initial Budget:</span>
                        <span style="font-weight: 700; color: #2563eb;">₱{{ total_assigned_original_cut|intcomma }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px;">
                        <span style="color: #4b5563;">Internal Budget (Committed):</span>
                        <span style="font-weight: 700; color: #ca8a04;">₱{{ total_committed_to_projects|intcomma }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px;">
                        <span style="color: #4b5563;">Remaining (Uncommitted):</span>
                        <span style="font-weight: 700; color: {% if uncommitted_remaining < 0 %}#ef4444{% else %}#ca8a04{% endif %};">
                            ₱{{ uncommitted_remaining|intcomma }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="user-details-section">
            <div class="user-details-category" style="font-size: 18px; font-weight: 600; color: #111827; border-bottom: 1px solid #e0e0e0; padding-bottom: 12px; margin-bottom: 20px;">
                Current Project Budgets ({{ college_name }})
            </div>
            <table class="styled-table" style="margin-top: 0;">
                <thead>
                    <tr>
                        <th>Project Title</th>
                        <th>Status</th>
                        <th>Internal Funding</th>
                        <th>External Funding</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in dashboard_data %}
                    <tr>
                        <td>{{ item.title }}</td>
                        <td>{{ item.status }}</td>
                        <td style="font-weight: 500;">₱{{ item.internal_funding_committed|intcomma }}</td>
                        <td>₱{{ item.external_funding_committed|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" style="text-align: center; color: #6b7280; padding: 20px;">
                            No projects found for this fiscal year.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

</div>

{% if user_role in "VP,DIRECTOR,UESO" %}
{{ allocation_map|json_script:"allocation-data" }}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // 1. Get the allocation map data
    const allocationMap = JSON.parse(document.getElementById('allocation-data').textContent);

    // 2. Helper function to format numbers with commas
    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // 3. Helper to parse string to float, handling empty strings
    function parseFloatOrZero(str) {
        if (typeof str === 'string' && str.trim() === '') {
            return 0;
        }
        // Remove commas before parsing
        return parseFloat(str.toString().replace(/,/g, '')) || 0;
    }

    // 4. Get the form and all table rows
    const adminForm = document.getElementById('adminBudgetForm');
    if (adminForm) { // Only run this code if the admin form exists
        const collegeRows = adminForm.querySelectorAll('tbody tr');

        // 5. Function to update remaining total for a single row
        function updateRemaining(row) {
            const committedFunding = parseFloatOrZero(row.dataset.committedFunding);
            const input = row.querySelector('input[type="text"]');
            const newAllocation = parseFloatOrZero(input.value);
            
            const remaining = newAllocation - committedFunding;
            
            const remainingCell = row.querySelector(`#remaining-${input.id.split('-')[2]}`);
            
            // --- FIX: Round the final value to match |intcomma filter ---
            const roundedRemaining = Math.round(remaining);
            remainingCell.textContent = `₱${numberWithCommas(roundedRemaining)}`;
            
            // Update text color
            if (roundedRemaining < 0) {
                remainingCell.style.color = '#ef4444'; // Red
            } else {
                remainingCell.style.color = '#ca8a04'; // Yellow/Gold
            }
        }

        // 6. Loop through the map and set the initial input values
        for (const collegeId in allocationMap) {
            if (allocationMap.hasOwnProperty(collegeId)) {
                const value = allocationMap[collegeId];
                const inputElement = document.getElementById(`college-input-${collegeId}`);
                if (inputElement) {
                    
                    // --- FIX for Dashboard Mismatch ---
                    // Use parseFloatOrZero to get the precise decimal value
                    // Do NOT use Math.floor().
                    inputElement.value = parseFloatOrZero(value);
                    // --- End Fix ---

                    // Add event listener to update 'Remaining' on keyup
                    inputElement.addEventListener('keyup', function() {
                        updateRemaining(inputElement.closest('tr'));
                    });

                    // Also update remaining on page load
                    updateRemaining(inputElement.closest('tr'));
                }
            }
        }

        // 7. --- NEW VALIDATION ---
        // Add submit event listener to the form
        adminForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Stop the form from submitting
            
            let errorMessages = [];
            
            // Loop over each college row in the table
            collegeRows.forEach(row => {
                const collegeName = row.dataset.collegeName;
                const committedFunding = parseFloatOrZero(row.dataset.committedFunding);
                const input = row.querySelector('input[type="text"]');
                const newAllocation = parseFloatOrZero(input.value);

                // Check 1: Negative numbers
                if (newAllocation < 0) {
                    errorMessages.push(`- ${collegeName}: Allocation cannot be negative (₱${numberWithCommas(newAllocation)}).`);
                }
                
                // Check 2: Allocation less than committed budget
                if (newAllocation < committedFunding) {
                    errorMessages.push(`- ${collegeName}: New allocation (₱${numberWithCommas(newAllocation)}) is less than already committed budget (₱${numberWithCommas(committedFunding.toFixed(0))}).`);
                }
            });

            // 8. Show alert or submit form
            if (errorMessages.length > 0) {
                // If there are errors, show them in a popup
                alert("Please fix the following validation errors:\n\n" + errorMessages.join('\n'));
            } else {
                // If everything is valid, submit the form
                adminForm.submit();
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}