{% extends base_template %}
{% load static %}
{% load humanize %}
{% block title %}{{ title }}{% endblock %}

{% block content %}

<link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/budget/styles.css' %}" rel="stylesheet">

<div class="user-details-container" style="max-width: 1200px; margin: auto; padding: 20px;">
    
    <div class="user-details-title" style="display: flex; justify-content: space-between; align-items: center; border-bottom: none; padding-bottom: 0;">
        <div>
            <h2 style="font-size: 28px; font-weight: 700; color: #1f2937; margin: 0;">{{ title }}</h2>
            <p style="font-size: 16px; color: #4b5563; margin-top: 4px;">Manage budget allocations and assignments.</p>
        </div>
        <a href="{% url 'budget_dashboard' %}" class="btn btn-secondary" style="font-size: 14px; padding: 8px 16px;">
            &larr; Back to Dashboard
        </a>
    </div>

    {% if user_role in "VP,DIRECTOR,UESO" %}
    <form method="POST" id="adminBudgetForm">
        {% csrf_token %}
        <div class="user-details-section" style="margin-top: 24px;">
            <div class="user-details-category" style="font-size: 18px; font-weight: 600; color: #111827; border-bottom: 1px solid #e0e0e0; padding-bottom: 12px; margin-bottom: 20px;">
                College Allocation Manager
            </div>
            
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>College</th>
                        <th>New Allocation (Initial)</th>
                        <th>Internal Budget (Committed)</th>
                        <th>Remaining (Uncommitted)</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for item in colleges_data %}
                    <tr data-college-name="{{ item.college_name }}" data-committed-funding="{{ item.committed_funding }}">
                        <td style="font-weight: 500;">{{ item.college_name }}</td>
                        <td>
                            <div class="input-wrapper">
                                <input type="text" 
                                       name="college_{{ item.college_id }}" 
                                       id="college-input-{{ item.college_id }}"
                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\\..*)\\./g, '$1');"
                                >
                            </div>
                        </td>
                        <td style="color: #4b5563;">₱{{ item.committed_funding|intcomma }}</td>
                        <td style="font-weight: 600;" id="remaining-{{ item.college_id }}">
                            ₱{{ item.uncommitted_remaining|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="form-actions">
                <button type="submit" name="assign_college_budget" class="btn btn-save">
                    Save Allocations
                </button>
            </div>
        </div>
    </form>
    {% endif %}

</div>

{% if is_admin %}
<script>
    function parseFloatOrZero(value) {
        if (typeof value === 'number') return value;
        if (!value) return 0;
        const cleanValue = String(value).replace(/[^0-9.-]/g, '');
        return parseFloat(cleanValue) || 0;
    }

    function numberWithCommas(x) {
        const parts = x.toString().split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join('.');
    }

    // --- Main Logic ---
    document.addEventListener('DOMContentLoaded', function() {
        const adminForm = document.getElementById('adminAllocationForm');
        const collegeRows = document.querySelectorAll('.styled-table tbody tr');
        const totalProposedDisplay = document.getElementById('totalProposed');
        
        if (adminForm) {
            // Retrieve the allocation map sent by the Python view
            const initialAllocationMap = JSON.parse('{{ allocation_map|safe }}');
            let totalProposed = 0;

            // 1. Initial population of the form fields and initial total calculation
            collegeRows.forEach(row => {
                const collegeId = row.dataset.collegeId;
                const input = row.querySelector('input[type="text"]');
                
                if (initialAllocationMap.hasOwnProperty(collegeId)) {
                    const value = initialAllocationMap[collegeId];
                    
                    // FIX: Only set the input value if it's NOT an empty string (i.e., not a zero allocation)
                    if (value !== '') {
                        const numericValue = parseFloat(value);
                        if (!isNaN(numericValue)) {
                            // Set the input value from the context, formatted
                            input.value = numberWithCommas(numericValue.toFixed(2));
                            totalProposed += numericValue;
                        }
                    } else {
                        // If value is '', leave the input field visually blank
                        input.value = '';
                    }
                }
            });
            
            // Initial display of the proposed total
            totalProposedDisplay.textContent = '₱' + numberWithCommas(totalProposed.toFixed(2));
            updateTotalDisplay(totalProposed);

            // 2. Add real-time input formatting and total calculation listener
            collegeRows.forEach(row => {
                const input = row.querySelector('input[type="text"]');
                
                if (input) {
                    input.addEventListener('input', function() {
                        let cursorPosition = this.selectionStart;
                        let initialLength = this.value.length;
                        
                        // 1. Clean the input to get a raw number string
                        let cleanValue = this.value.replace(/[^0-9.]/g, '');
                        
                        // 2. Format the value
                        if (cleanValue.length > 0 && !isNaN(parseFloat(cleanValue))) {
                            let numericValue = parseFloat(cleanValue);
                            // Format the numeric value to two decimal places and add commas
                            this.value = numberWithCommas(numericValue.toFixed(2));
                        } else if (cleanValue === '') {
                            // Keep it blank if the user deletes all characters
                            this.value = ''; 
                        } else {
                             // Re-add commas if they were removed (e.g., if user pastes a number)
                            this.value = numberWithCommas(this.value.replace(/[^0-9.]/g, ''));
                        }

                        // Adjust cursor position
                        let newLength = this.value.length;
                        cursorPosition = cursorPosition + (newLength - initialLength);
                        this.setSelectionRange(cursorPosition, cursorPosition);

                        // 3. Recalculate and update the main total
                        updateTotal();
                    });
                }
            });
            
            // Helper to update the running total display and color status
            function updateTotal() {
                let runningTotal = 0;
                collegeRows.forEach(row => {
                    runningTotal += parseFloatOrZero(row.querySelector('input[type="text"]').value);
                });
                updateTotalDisplay(runningTotal);
            }

            function updateTotalDisplay(total) {
                let exceedsPool = false;
                const poolAvailable = parseFloatOrZero(document.getElementById('poolAvailable').dataset.value);

                totalProposedDisplay.textContent = '₱' + numberWithCommas(total.toFixed(2));
                
                if (total > poolAvailable) {
                    totalProposedDisplay.classList.add('text-red');
                    totalProposedDisplay.classList.remove('text-green');
                    exceedsPool = true;
                } else {
                    totalProposedDisplay.classList.add('text-green');
                    totalProposedDisplay.classList.remove('text-red');
                }
                
                // Show/hide alert banner based on excess
                const alertBanner = document.getElementById('allocationAlert');
                if (alertBanner) {
                     if (exceedsPool) {
                         alertBanner.style.display = 'block';
                         const difference = total - poolAvailable;
                         alertBanner.textContent = `Warning: Total proposed allocation exceeds annual pool by ₱${numberWithCommas(difference.toFixed(2))}.`;
                     } else {
                         alertBanner.style.display = 'none';
                     }
                }
            }


            // 3. Form Submission/Validation
            adminForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent default submission first

                let errorMessages = [];
                
                // Loop over each college row in the table
                collegeRows.forEach(row => {
                    const collegeName = row.dataset.collegeName;
                    // Ensure committedFunding is treated as a Decimal/Float for accurate comparison
                    const committedFunding = parseFloatOrZero(row.dataset.committedFunding); 
                    const input = row.querySelector('input[type="text"]');
                    const newAllocation = parseFloatOrZero(input.value);

                    // Check 1: Negative numbers
                    if (newAllocation < 0) {
                        errorMessages.push(`- ${collegeName}: Allocation cannot be negative (₱${numberWithCommas(newAllocation.toFixed(2))}).`);
                    }
                    
                    // Check 2: Allocation less than committed budget
                    // Use toFixed(2) for string comparison to avoid floating-point issues on committed funding
                    if (newAllocation.toFixed(2) < committedFunding.toFixed(2)) {
                        errorMessages.push(`- ${collegeName}: New allocation (₱${numberWithCommas(newAllocation.toFixed(2))}) is less than already committed budget (₱${numberWithCommas(committedFunding.toFixed(2))}).`);
                    }
                    
                    // Before submission, clean up the value in the input fields so Django receives raw numbers
                    // Send an empty string if the user left it blank (meaning 0)
                    input.value = newAllocation > 0 ? newAllocation.toFixed(2) : ''; 
                });

                // 8. Show alert or submit form
                if (errorMessages.length > 0) {
                    // If there are errors, show them in a popup
                    alert("Please fix the following validation errors:\n\n" + errorMessages.join('\n'));
                    
                    // If validation failed, re-format the input values for user visibility
                    collegeRows.forEach(row => {
                        const input = row.querySelector('input[type="text"]');
                        const rawValue = parseFloat(input.value);
                        if (!isNaN(rawValue) && rawValue > 0) {
                            input.value = numberWithCommas(rawValue.toFixed(2));
                        } else {
                             input.value = ''; // Keep it blank if 0 or invalid
                        }
                    });

                } else {
                    // Final client-side check against the pool limit (server will validate again)
                    const poolAvailable = parseFloatOrZero(document.getElementById('poolAvailable').dataset.value);
                    const runningTotal = parseFloatOrZero(totalProposedDisplay.textContent);
                    
                    if (runningTotal > poolAvailable) {
                         alert(`Warning: Total proposed allocation (₱${numberWithCommas(runningTotal.toFixed(2))}) exceeds the annual pool (₱${numberWithCommas(poolAvailable.toFixed(2))}). Please correct the values.`);
                    } else {
                        // If everything is valid, submit the form
                        adminForm.submit();
                    }
                }
            });
        }
    });
</script>

{% endif %}
{% endblock %}