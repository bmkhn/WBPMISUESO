{% extends base_template %}
{% load static %}
{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block content %}

<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<title>{{ title }}</title>
<link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/budget/styles.css' %}" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script> 
</head>
<body>
<div class="main-container">

    <div class="container-1">
        <div class="container-1A">
            <h1 class="welcome-text">{{ title }}</h1>
            </div>
        <div class="container-1B">
            {% if is_admin %}
            <a class="export-btn" id="exportProjectBtn" href="{% url 'budget_export' %}"> 
                <i class="fa-solid fa-download"></i>
                Export 
            </a>
            {% endif %}
        </div>
    </div>

    {% if user_role in "VP,DIRECTOR,UESO" %}
    <div class="another-header">
        <h2>Overview</h2>
    </div>
    <div class="card-group">
        <div class="new-budget-card combined-budget-card-gradient" style="overflow: hidden; position: relative; padding: 0;">
            <div style="display: flex; justify-content: space-between; align-items: stretch; width: 100%; height: 100%;">
                
                <div style="flex-grow: 0; flex-shrink: 0; width: 35%; position: relative; z-index: 2;">
                    <div class="card-description" style="padding-top: 20px; padding-left: 20px; padding-bottom: 5px;">
                        <p>Unallocated Funds Remaining</p>
                    </div>
                    <div class="card-metric-group" style="align-items: flex-start !important; padding-left: 20px; padding-bottom: 0;"> 
                        <h2 class="{% if pool_unallocated_remaining < 0 %}text-red{% else %}text-green{% endif %}">
                            ₱ {{ pool_unallocated_remaining|floatformat:0|intcomma }}
                        </h2>
                    </div>
                    <span class="sub-description" style="padding-top: 5px; padding-left: 20px; padding-bottom: 20px; display: block;">Annual Budget Pool: ₱ {{ pool_available|floatformat:0|intcomma }}</span>
                </div>
                
                <div style="flex-grow: 0; flex-shrink: 0; width: 65%; height: 100%; position: absolute; top: 0; right: 0; z-index: 0; margin-right: -9.5px;">
                    <canvas id="unallocatedChart" style="display: block; width: 100%; height: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="goal-card-container">
        
        <div class="goal-card color-pink">
            <div class="card-content-wrapper" style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                <div>
                    <h3 style="color: white;">Assigned to Colleges</h3>
                    <p class="amount" style="color: white; font-size: 24px;">₱ {{ total_assigned_to_colleges|floatformat:0|intcomma }}</p>
                </div>
                <div style="height: 80px; width: 130px; flex-shrink: 0; margin-top: -5px;">
                    <canvas id="assignedChart"></canvas>
                </div>
            </div>
            <span class="card-figure-subtext">Percentage of total pool assigned</span>
        </div>

                <div class="goal-card color-milky-white">
            <div class="card-content-wrapper" style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                <div>
                    <h3 style="color: #4b5563;">Committed (External)</h3>
                    <p class="amount" style="color: #111827;">₱ {{ total_external_to_projects_agg|floatformat:0|intcomma }}</p>
                </div>
                <div style="height: 80px; width: 130px; flex-shrink: 0; margin-top: -5px;">
                    <canvas id="externalCommittedChart"></canvas>
                </div>
            </div>
            <span class="card-figure-subtext">Funding secured from external sponsors</span>
        </div>
        
        <div class="goal-card color-dango-green">
            <div class="card-content-wrapper" style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                <div>
                    <h3 style="color: white;">Committed (Internal)</h3>
                    <p class="amount" style="color: white;">₱ {{ total_committed_to_projects_agg|floatformat:0|intcomma }}</p>
                </div>
                <div style="height: 80px; width: 130px; flex-shrink: 0; margin-top: -5px;">
                    <canvas id="internalCommittedChart"></canvas>
                </div>
            </div>
            <span class="card-figure-subtext">Funding committed from internal pool</span>
        </div>
        
    </div>

    <div class="another-header" style="justify-content: space-between; align-items: center;">
        
        <div style="display: flex; align-items: center; gap: 15px;">
            <h2 style="margin: 0;">College Budget Allocations</h2>
            <div class="dropdown-button">
                <select id="adminSortSelect">
                    <option value="college_id">Default</option>
                    <option value="college_name_asc">College Name (A-Z)</option>
                    <option value="college_name_desc">College Name (Z-A)</option>
                    <option value="original_cut_desc">Initial Budget (High to Low)</option>
                    <option value="original_cut_asc">Initial Budget (Low to High)</option>
                    <option value="committed_funding_desc">Committed Internal (High to Low)</option>
                    <option value="uncommitted_remaining_desc">Remaining (High to Low)</option>
                </select>
            </div>

        </div>
        
            {% if is_admin %}
            <a class="export-btn edit" href="{% url 'budget_edit' %}"> 
                <i class="fa-solid fa-pen"></i>
                Edit 
            </a>
            {% endif %}
    </div>
    <div class="table-container">
            <table class="user-table">
                <thead>
                    <tr>
                        <th>College</th>
                        <th>Initial Budget (Original Cut)</th>
                        <th>Internal Budget (Committed)</th>
                        <th>External Budget (Committed)</th>
                        <th>Remaining (Uncommitted)</th>
                    </tr>
                </thead>
                <tbody id="adminTableBody">
                    {% for item in dashboard_data %}
                    <tr class="clickable-row" data-college-id="{{ item.college_id }}">
                        <td class="font-bold">{{ item.college_name }}</td>
                        <td>₱{{ item.original_cut|intcomma }}</td>
                        <td>₱{{ item.committed_funding|intcomma }}</td>
                        <td>₱{{ item.external_funding|intcomma }}</td>
                        <td class="font-bold {% if item.uncommitted_remaining < 0 %}text-red{% else %}text-green{% endif %}">
                            ₱{{ item.uncommitted_remaining|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
    </div>
    {% endif %}

    {% if is_college_admin %}
    <div class="another-header">
        <h2>Overview</h2>
    </div>
    <div class="goal-card-container">
        <div class="goal-card color-pink">
            <div class="card-content-wrapper" style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                <div>
                    <h3 style="color: white;">Initial Budget</h3>
                    <p class="amount text-blue" style="color: white;">₱{{ total_assigned_original_cut|floatformat:0|intcomma }}</p>
                </div>
                <div style="height: 80px; width: 130px; flex-shrink: 0; margin-top: -5px;">
                    <canvas id="collegeAssignedChart"></canvas>
                </div>
            </div>
            <span class="card-figure-subtext">Total allocated to your college</span>
        </div>
        <div class="goal-card color-dango-green">
            <div class="card-content-wrapper" style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                <div>
                    <h3 style="color: white;">Committed (Internal)</h3>
                    <p class="amount text-yellow" style="color: white;">₱{{ total_committed_to_projects|floatformat:0|intcomma }}</p>
                </div>
                <div style="height: 80px; width: 130px; flex-shrink: 0; margin-top: -5px;">
                    <canvas id="collegeCommittedChart"></canvas>
                </div>
            </div>
            <span class="card-figure-subtext">Committed funding for projects</span>
        </div>
        <div class="goal-card color-milky-white">
            <div class="card-content-wrapper" style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                <div>
                    <h3>Remaining (Uncommitted)</h3>
                    <p class="amount {% if uncommitted_remaining < 0 %}text-red{% else %}text-green{% endif %}">
                        ₱{{ uncommitted_remaining|floatformat:0|intcomma }}
                    </p>
                </div>
                <div style="height: 80px; width: 130px; flex-shrink: 0; margin-top: -5px;">
                    <canvas id="collegeRemainingChart"></canvas>
                </div>
            </div>
            <span class="card-figure-subtext">Funds available for new projects</span>
        </div>
    </div>

    <div class="another-header" style="justify-content: space-between; align-items: center;">
        <h2 style="margin: 0;">College Project Budget Allocations</h2>
        <div class="dropdown-button">
                <select id="collegeProjectSortSelect">
                <option value="title_asc">Project Title (A-Z)</option>
                <option value="title_desc">Project Title (Z-A)</option>
                <option value="internal_funding_committed_desc">Internal Funding (High to Low)</option>
                <option value="external_funding_committed_desc">External Funding (High to Low)</option>
            </select>
        </div>
    </div>
    <div class="table-container">
        <div class="table-wrapper">
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Internal Budget (Committed)</th>
                        <th>External Budget (Committed)</th>
                    </tr>
                </thead>
                <tbody id="collegeTableBody">
                    {% for item in dashboard_data %}
                    <tr class="project-clickable-row" data-project-id="{{ item.id }}">
                        <td>{{ item.title }}</td>
                        <td>{{ item.status }}</td>
                        <td>₱{{ item.internal_funding_committed|intcomma }}</td>
                        <td>₱{{ item.external_funding_committed|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center" style="color: #6b7280; padding: 20px;">
                            No projects found for this fiscal year.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if user_role in "FACULTY,IMPLEMENTER" %}
    <div class="another-header">
        <h2>Overview</h2>
    </div>
     <div class="goal-card-container">
        <div class="goal-card color-pink">
            <div class="card-content-wrapper" style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                <div>
                    <h3 style="color: white;">Total Project Funding</h3>
                    <p class="amount text-blue" style="color: white;">₱{{ total_assigned|floatformat:0|intcomma }}</p>
                </div>
                <div style="height: 80px; width: 130px; flex-shrink: 0; margin-top: -5px;">
                    <canvas id="facultyTotalChart"></canvas>
                </div>
            </div>
            <span class="card-figure-subtext">Overall budget across all your projects</span>
        </div>

        <div class="goal-card color-milky-white">
            <div class="card-content-wrapper" style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                <div>
                    <h3 style="color: #4b5563;">Total External</h3>
                    <p class="amount text-yellow" style="color: #111827;">₱{{ total_external|floatformat:0|intcomma }}</p>
                </div>
                <div style="height: 80px; width: 130px; flex-shrink: 0; margin-top: -5px;">
                    <canvas id="facultyExternalChart"></canvas>
                </div>
            </div>
            <span class="card-figure-subtext">Funding secured from sponsors</span>
        </div>

        <div class="goal-card color-dango-green">
            <div class="card-content-wrapper" style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                <div>
                    <h3 style="color: white;">Total Internal</h3>
                    <p class="amount text-green" style="color: white;">₱{{ total_internal|floatformat:0|intcomma }}</p>
                </div>
                <div style="height: 80px; width: 130px; flex-shrink: 0; margin-top: -5px;">
                    <canvas id="facultyInternalChart"></canvas>
                </div>
            </div>
            <span class="card-figure-subtext">Funding from internal pool</span>
        </div>
    </div>
    
    <div class="another-header" style="justify-content: space-between; align-items: center;">
        <h2 style="margin: 0;">Project Budget Allocations</h2>
        <div class="dropdown-button">
                <select id="facultyProjectSortSelect">
                <option value="title_asc">Project Title (A-Z)</option>
                <option value="title_desc">Project Title (Z-A)</option>
                <option value="internal_funding_desc">Internal Funding (High to Low)</option>
                <option value="external_funding_desc">External Funding (High to Low)</option>
            </select>
        </div>
    </div>
    <div class="table-container">
        <div class="table-wrapper">
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Internal Budget (Committed)</th>
                        <th>External Budget (Committed)</th>
                    </tr>
                </thead>
                <tbody id="facultyTableBody">
                    {% for item in dashboard_data %}
                    <tr class="project-clickable-row" data-project-id="{{ item.id }}">
                        <td>{{ item.title }}</td>
                        <td>{{ item.status }}</td>
                        <td>₱{{ item.internal_funding|intcomma }}</td>
                        <td>₱{{ item.external_funding|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center" style="color: #6b7280; padding: 20px;">
                            You are not assigned to any projects.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}


    {% if is_admin %}   
    <div class="another-header">
        <h2>Snippets</h2>
    </div>
    <div class="bottom-grid">
        <div class="table-container"> <div class="list-card-header">
                <h2>Recent Budget History</h2>
                <a href="{% url 'budget_history' %}">View All</a>
            </div>
            <div>
                {% for item in latest_history %}
                <div class="list-item">
                    <p>{{ item.description }}</p>
                    <div class="meta">
                        <span>{{ item.timestamp|date:"M d, Y P" }}</span>
                    </div>
                </div>
                {% empty %}
                <div class="list-item text-center" style="color: #6b7280;">
                    No budget history found.
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif%}

        <div class="table-container"> 
            <div class="list-card-header">
                <h2>Projects with External Funding</h2>
                <a href="{% url 'budget_sponsors' %}">View All</a>
            </div>
            <div>
                {% for project in latest_external_projects %}
                <div class="list-item">
                    <div class="meta" style="margin-top: 0; margin-bottom: 4px;">
                        <p class="font-bold">{{ project.title }}</p>
                        <span class="font-bold text-purple">₱{{ project.external_budget|floatformat:0|intcomma }}</span>
                    </div>
                    <div class="meta">
                        <span>Sponsor: {{ project.sponsor_name|default:"N/A" }}</span>
                    </div>
                </div>
                {% empty %}
                <div class="list-item text-center" style="color: #6b7280;">
                    No projects with external funding found for this fiscal year.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
        // --- Data Variables Initialized from Django Context (as strings) ---
    const unallocRaw = '{{ unallocated_data_raw_json|safe }}';
    const unalloc = '{{ unallocated_data_json|safe }}';
    const assignedData = '{{ assigned_data_json|safe }}';
    const internalCommittedData = '{{ committed_internal_data_json|safe }}';
    const externalCommittedData = '{{ committed_external_data_json|safe }}';
    const rawAdminData = "{{ dashboard_data|safe }}"; 
    
    // College/Faculty Data: These must be global/available
    const collegeCommittedData = '{{ college_committed_data_json|safe }}';
    const collegeAssignedNorm = '{{ total_assigned_original_cut_norm|safe }}';
    const college_external_data_json = '{{ college_external_data_json|safe }}'; 
    const collegeRemainingData = '{{ college_remaining_data_json|safe }}'; 
    const rawCollegeData = "{{ dashboard_data|safe }}"; // Used for college projects
    
    const facultyInternalData = '{{ faculty_internal_data_json|safe }}';
    const facultyExternalData = '{{ faculty_external_data_json|safe }}';
    const faculty_total_data_json = '{{ faculty_total_data_json|safe }}';
    const rawFacultyData = "{{ dashboard_data|safe }}"; // Used for faculty projects
    
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    // --------------------------------------------------------
    
    const currentMonth = new Date().getMonth(); 
    let ADMIN_DATA = [];
    let COLLEGE_PROJECT_DATA = [];
    let FACULTY_PROJECT_DATA = [];

    // --- Chart Options ---
    const mainCardChartOptions = {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 3.7,
        plugins: { legend: { display: false } },
        scales: {
            x: {
                display: false,
                offset: false,
                grid: { color: 'rgba(255, 255, 255, 0.0)' },
                ticks: { color: '#fff', font: { size: 10 } }
            },
            y: {
                display: false,
                beginAtZero: true, 
                min: 0, 
                grace: '3%', 
                grid: { color: 'rgba(255, 255, 255, 0.0)' },
                ticks: { display: true, color: '#fff', font: { size: 10 } }
            }
        },
        elements: {
            point: { radius: 3, hoverRadius: 5 },
            line: { borderJoinStyle: 'round', capBezierPoints: true }
        },
        layout: { padding: { left: 0, right: 0, top: 0, bottom: 0 } }
    };

    const miniChartOptions = {
        responsive: true,
        maintainAspectRatio: false, 
        plugins: {
            legend: { display: false },
            tooltip: { enabled: false }, // Tooltips disabled by default for mini charts
        },
        scales: { x: { display: false }, y: { display: false } },
        elements: { point: { radius: 0 } },
        layout: { padding: 0 }
    };

    // --- Utility Functions ---

    function createGradientBackground(ctx, chartArea, isMainCard, isExternal) {
        if (!chartArea) return null;
        if (isMainCard) {
            const grad = ctx.createLinearGradient(chartArea.left, 0, chartArea.right, 0);
            // Note: Colors pulled directly from your provided JS styles
            grad.addColorStop(0, 'rgba(255, 96, 146, 0.7)'); 
            grad.addColorStop(1, 'rgba(138, 201, 38, 0.7)'); 
            return grad;
        } else {
            const grad = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
            if (isExternal) {
                grad.addColorStop(0, 'rgba(107, 114, 128, 0.5)');
                grad.addColorStop(1, 'rgba(107, 114, 128, 0.0)');
            } else {
                grad.addColorStop(0, 'rgba(255, 255, 255, 0.7)');
                grad.addColorStop(1, 'rgba(255, 255, 255, 0.0)');
            }
            return grad;
        }
    }
    
    /**
     * @function cleanPythonData
     * Converts Python's Decimal('...') and single quotes into valid JSON string.
     */
    function cleanPythonData(dataString) {
        if (typeof dataString !== 'string' || !dataString.trim()) return '[]';
        let clean = dataString.replace(/Decimal\((['"]?)(.*?)\1\)/g, (match, p1, p2) => p2);
        clean = clean.replace(/'/g, '"');
        clean = clean.replace(/None/g, 'null');
        return clean;
    }

    /**
     * @function formatCurrency
     * Formats a numeric string or number into Philippine Peso currency (₱).
     */
    function formatCurrency(amount) {
        return '₱' + parseFloat(amount || 0).toLocaleString('en-US', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
    }

    // --- Chart Initialization ---
    function initSparkline(canvasId, dataString, isExternal = false, isMainCard = false, labels = [], tooltipDataString = null, fillChart = true) {
        const ctxEl = document.getElementById(canvasId);
        if (!ctxEl) return;
        
        let data;
        let tooltipData = null;
        try {
            data = JSON.parse(dataString);
            if (tooltipDataString) tooltipData = JSON.parse(tooltipDataString);
        } catch (e) {
            console.error(`Error parsing data for ${canvasId}:`, e, dataString);
            return;
        }
        
        // --- FIX IS IN THIS BLOCK ---
        if (isMainCard && data.length > 0) {
            // Check if the first point is not already zero.
            if (data[0] !== 0) {
                // Prepend 0 to the numeric data array
                data.unshift(0); 
                
                // Prepend the formatted zero value to the tooltip data array
                if (tooltipData) {
                    tooltipData.unshift('0'); 
                }
                
                // CORRECTED: Prepend a blank label to account for the new '0' start point.
                // This prevents shifting the month labels.
                if (labels.length > 0) {
                    labels.unshift(''); 
                }
            }
        }
        // --- END OF FIX ---
        
        // The main card chart needs to show the new '0' point AND the current month's value.
        // If prepended, the current month is at index 'currentMonth + 1'.
        const sliceLimit = isMainCard ? currentMonth + 2 : currentMonth + 1;
        const dataForChart = data.slice(0, sliceLimit);

        
        if (!dataForChart || dataForChart.length === 0 || dataForChart.every(v => v === null || v === 0 || v === '0' )) {
                ctxEl.style.display = 'none'; 
                return;
        }

        try {
            const datasetColor = isExternal ? '#6b7280' : 'white';
            let options = JSON.parse(JSON.stringify(isMainCard ? mainCardChartOptions : miniChartOptions));
            
            if (canvasId.includes('RemainingChart') && options.scales && options.scales.y) {
                    options.scales.y.beginAtZero = false;
            }
            
            // If this is a mini-chart, re-enable tooltips if tooltipData is available
            if (!isMainCard && tooltipData) {
                options.plugins.tooltip = { enabled: true };
            }

            const labelsToUse = labels.length ? labels.slice(0, sliceLimit) : Array(dataForChart.length).fill('');
            const tooltipDataForChart = tooltipData ? tooltipData.slice(0, sliceLimit) : null;

            new Chart(ctxEl, {
                type: 'line',
                data: {
                    labels: labelsToUse,
                    datasets: [{
                        data: dataForChart,
                        borderColor: datasetColor,
                        borderWidth: 2,
                        fill: fillChart,
                        tension: 0.4, 
                        spanGaps: true,
                        backgroundColor: (context) => {
                            const chart = context.chart;
                            const area = chart.chartArea;
                            return createGradientBackground(chart.ctx, area, isMainCard, isExternal);
                        }
                    }]
                },
                options: {
                    ...options,
                    plugins: {
                        ...options.plugins,
                        tooltip: tooltipDataForChart ? {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                // The tooltip now uses the prepended 'Month 0' for the first point
                                title: t => 'Month: ' + (labelsToUse[t[0].dataIndex] || ''),
                                label: t => formatCurrency(tooltipDataForChart[t.dataIndex] || 0)
                            }
                        } : options.plugins.tooltip
                    }
                }
            });
        } catch (err) {
            console.error(`Chart ${canvasId} failed:`, err);
        }
    }


    // --- Table Rendering and Sorting Functions ---

    function renderAdminTable() {
        const body = document.getElementById('adminTableBody');
        if (!body) return;
        body.innerHTML = '';
        ADMIN_DATA.forEach(item => {
            const row = body.insertRow();
            row.classList.add('clickable-row');
            row.dataset.collegeId = item.college_id;
            
            row.addEventListener('click', () => {
                window.location.href = `/budget/college/${item.college_id}/projects/`; 
            });

            const nameCell = row.insertCell();
            nameCell.classList.add('font-bold');
            nameCell.textContent = item.college_name;

            row.insertCell().textContent = formatCurrency(item.original_cut);
            row.insertCell().textContent = formatCurrency(item.committed_funding);
            row.insertCell().textContent = formatCurrency(item.external_funding);

            const remaining = row.insertCell();
            const uncommitted = parseFloat(item.uncommitted_remaining) || 0;
            remaining.classList.add('font-bold');
            remaining.classList.add(uncommitted < 0 ? 'text-red' : 'text-green');
            remaining.textContent = formatCurrency(uncommitted);
        });
    }

    function sortAdminTable(sortKey) {
        if (!ADMIN_DATA.length) return;
        
        const key = sortKey.split('_')[0]; 
        const direction = sortKey.includes('desc') ? 'desc' : 'asc';
        const dir = direction === 'desc' ? -1 : 1;

        const keyMap = {
            college: 'college_name', 
            original: 'original_cut', 
            committed: 'committed_funding', 
            uncommitted: 'uncommitted_remaining',
            college_id: 'college_id'
        };
        
        const sortField = keyMap[key] || (sortKey === 'college_id' ? 'college_id' : null);
        if (!sortField) return;

        const isNum = sortField !== 'college_name' && sortField !== 'college_id';

        ADMIN_DATA.sort((a, b) => {
            let A = a[sortField] ?? (isNum ? 0 : '');
            let B = b[sortField] ?? (isNum ? 0 : '');
            
            if (sortField === 'college_id') return parseFloat(A) - parseFloat(B);

            if (isNum) return (parseFloat(A) - parseFloat(B)) * dir;
            return A.localeCompare(B) * dir;
        });

        renderAdminTable();
    }

    function attachProjectClickListeners(role) {
        const rows = document.getElementById(role + 'TableBody').querySelectorAll('.project-clickable-row');
        
        rows.forEach(row => {
            if (!row.dataset.hasClickListener) { 
                row.addEventListener('click', () => {
                    const projectId = row.dataset.projectId;
                    if (projectId) {
                        window.location.href = `/projects/${projectId}/`; 
                    }
                });
                row.dataset.hasClickListener = 'true';
            }
        });
    }
    
    function renderProjectTable(role) {
        const data = role === 'college' ? COLLEGE_PROJECT_DATA : FACULTY_PROJECT_DATA;
        const body = document.getElementById(role + 'TableBody');
        if (!body) return;
        body.innerHTML = '';

        if (data.length === 0) {
            const row = body.insertRow();
            const cell = row.insertCell();
            cell.setAttribute('colspan', '4');
            cell.classList.add('text-center');
            cell.style.cssText = 'color: #6b7280; padding: 20px;';
            cell.textContent = role === 'college' ? 'No projects found for this fiscal year.' : 'You are not assigned to any projects.';
            return;
        }

        data.forEach(item => {
            const row = body.insertRow();
            
            row.classList.add('project-clickable-row'); 
            row.dataset.projectId = item.id; 
            
            row.insertCell().textContent = item.title;
            row.insertCell().textContent = item.status;

            const intKey = role === 'college' ? 'internal_funding_committed' : 'internal_funding';
            const extKey = role === 'college' ? 'external_funding_committed' : 'external_funding';
            row.insertCell().textContent = formatCurrency(item[intKey]);
            row.insertCell().textContent = formatCurrency(item[extKey]);
        });
        
        attachProjectClickListeners(role);
    }

    function sortProjectTable(role, sortKey) {
        const arrayToSort = role === 'college' ? COLLEGE_PROJECT_DATA : FACULTY_PROJECT_DATA;
        if (!arrayToSort.length) return;
        
        const [key, direction] = sortKey.split('_');
        const dir = direction === 'desc' ? -1 : 1;

        const keyMap = {
            title: 'title',
            internal: role === 'college' ? 'internal_funding_committed' : 'internal_funding',
            external: role === 'college' ? 'external_funding_committed' : 'external_funding'
        };
        const sortField = keyMap[key];
        const isNum = sortField !== 'title';

        arrayToSort.sort((a, b) => {
            let A = a[sortField] ?? (isNum ? 0 : '');
            let B = b[sortField] ?? (isNum ? 0 : '');
            if (isNum) return (parseFloat(A) - parseFloat(B)) * dir;
            return A.localeCompare(B) * dir;
        });

        renderProjectTable(role);
    }

    // --- Main DOM Content Loaded Handler ---
    document.addEventListener('DOMContentLoaded', () => {
        const currentMonths = months.slice(0, currentMonth + 1);
        
        // --- ADMIN/VP/DIRECTOR Initialization ---
        {% if user_role in "VP,DIRECTOR,UESO" %}
        try {
            ADMIN_DATA = JSON.parse(cleanPythonData(rawAdminData));
            
            renderAdminTable(); 

            // Corrected call: Use unallocRaw for the tooltip data string
            initSparkline('unallocatedChart', unalloc, false, true, currentMonths, unalloc, true);
            initSparkline('assignedChart', assignedData);
            initSparkline('internalCommittedChart', internalCommittedData);
            initSparkline('externalCommittedChart', externalCommittedData, true);

            document.getElementById('adminSortSelect')?.addEventListener('change', e => {
                sortAdminTable(e.target.value);
            });

        } catch (err) { 
            console.error("Admin Dashboard Initialization Failed:", err); 
        }
        {% endif %}

        // --- COLLEGE ADMIN Initialization ---
        {% if is_college_admin %}
        try {
            COLLEGE_PROJECT_DATA = JSON.parse(cleanPythonData(rawCollegeData));
            
            initSparkline('collegeAssignedChart', collegeAssignedNorm); 
            initSparkline('collegeCommittedChart', collegeCommittedData);
            initSparkline('collegeRemainingChart', collegeRemainingData, true); 
            
            renderProjectTable('college'); 

            document.getElementById('collegeProjectSortSelect')?.addEventListener('change', e => {
                sortProjectTable('college', e.target.value);
            });

        } catch (err) { console.error("College init failed:", err); }
        {% endif %}
        
        // --- FACULTY/IMPLEMENTER Initialization ---
        {% if user_role in "FACULTY,IMPLEMENTER" %}
        try {
            FACULTY_PROJECT_DATA = JSON.parse(cleanPythonData(rawFacultyData));
            
            initSparkline('facultyTotalChart', faculty_total_data_json);
            initSparkline('facultyInternalChart', facultyInternalData);
            initSparkline('facultyExternalChart', facultyExternalData, true);
            
            renderProjectTable('faculty');

            document.getElementById('facultyProjectSortSelect')?.addEventListener('change', e => {
                sortProjectTable('faculty', e.target.value);
            });
        } catch (err) { console.error("Faculty init failed:", err); }
        {% endif %}
    });
</script>

</body>
</html>

{% endblock %}