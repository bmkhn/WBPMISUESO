{% extends 'base_public.html' %}
{% load humanize static %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
<link href="{% static 'shared/projects/u_module_styles.css' %}" rel="stylesheet">
<link href="{% static 'shared/projects/gridnlist.css' %}" rel="stylesheet">
<title>Budget</title>

<body>
    <div data-dashboard="1" class="main" style="flex-direction:column;">

        <div style="display: flex; flex-direction: column;">
            
            <div class="dashboard-top-grid">

                <div class="list limit">
                    <h2 class="headerr">Recent Expense Logs</h2>
                    <div class="logs-div">
                        {% if recent_expenses %}
                        {% for e in recent_expenses %}
                        <div class="log-item-row">
                            <div class="log-content">
                                <span class="log-amount-main">₱{{ e.amount|floatformat:2|intcomma }} accounted for
                                <a href="{% url 'project_expenses' e.project_id %}" class="log-project">{{ e.project.title }}</a></span>
                                <span class="log-creator">Recorded by: {{ e.created_by.get_full_name }}</span>
                            </div>
                            <div class="log-amount-date">
                                <span class="log-timestamp">{{ e.submitted_at|date:"F d, Y" }}</span>
                                <span class="log-timestamp">{{ e.submitted_at|date:"h:i A" }}</span>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="log-item-row">No expense logs yet.</div>
                        {% endif %}
                    </div>
                </div>
                
                {# LEFT div: PROJECT LIST (Corresponds to .list in faculty_project.html) #}
                <div class="list kinkk"> 
                    <div class="box" style="box-shadow:none; padding: 0;">
                        <div class="search-container">
                            <form class="search-bar" method="get" action="">
                                <svg width="16" height="16"> <use href="#icon-search"></use> </svg>
                                <input type="text" name="search" placeholder="Search Project Title" value="{{ request.GET.search|default:'' }}" class="flex-1"/>
                                <button type="button" id="filterBtn" class="mr-1">
                                    <svg width="16" height="16"> <use href="#icon-filter"></use> </svg>
                                </button>
                                
                                <div id="filterDropdown" class="filter-dropdown" style="display:none;">
                                    <div class="filter-grid" style="grid-template-columns:none">
                                        <label class="font-medium text-gray-700 flex flex-col">
                                            Sort By
                                            <select name="sort_by" class="mt-2">
                                                <option value="title" {% if request.GET.sort_by == 'title' %}selected{% endif %}>Title</option>
                                                <option value="last_updated" {% if request.GET.sort_by == 'last_updated' %}selected{% endif %}>Last Updated</option>
                                                <option value="budget_remaining" {% if request.GET.sort_by == 'budget_remaining' %}selected{% endif %}>Budget Remaining (Amount)</option>
                                                <option value="budget_percentage" {% if request.GET.sort_by == 'budget_percentage' %}selected{% endif %}>Budget Remaining (%)</option>
                                            </select>
                                        </label>
                                        <label class="font-medium text-gray-700 flex flex-col">
                                            Order
                                            <select name="order" class="mt-2">
                                                <option value="desc" {% if request.GET.order == 'desc' %}selected{% endif %}>Descending</option>
                                                <option value="asc" {% if request.GET.order == 'asc' %}selected{% endif %}>Ascending</option>
                                            </select>
                                        </label>
                                    </div>
                                    <div class="filter-actions">
                                        <button type="submit" class="filter-apply">Apply</button>
                                        <button type="button" id="closeFilter" class="filter-close">Clear Filters</button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="files-header">
                            <h2>Project Budget</h2>
                            <div class="flex gap-2">
                                <button id="cardViewBtn" class="view-toggle-btn active"><i class="ri-apps-2-line"></i></button>
                                <button id="listViewBtn" class="view-toggle-btn inactive"><i class="ri-list-unordered"></i></button>
                            </div>
                        </div>
                        {% if projects_overview %}
                        <div id="projectsCardView" class="projects-grid js-grid">
                            {% for p in projects_overview %}
                            <a href="{% url 'project_expenses' p.id %}" class="proj-card budget" data-card-item>
                                <div>
                                    {% if p.last_updated %}<p class="text-xs text-gray-500">Last updated {{ p.last_updated|date:"F j, Y" }}</p>{% endif %}
                                    <h3 class="proj-title">{{ p.title }}</h3>
                                </div>
                                <div class="proj-status">
                                    <canvas class="proj-donut" width="140" height="140" data-percent="{{ p.percent_remaining|default:0 }}"></canvas>
                                </div>
                                <p class="progress-done-message text-sm">{{ p.percent_remaining }}% of budget remaining</p>
                            </a>
                            {% endfor %}
                        </div>
                        <div id="cardPagination" class="pagination-container"></div>
                        
                        <div id="projectsListView" style="margin-top: 1rem;">
                            <table class="user-table js-hidden">
                                <thead><tr><th>Title</th><th>Updated</th><th>Remaining</th></tr></thead>
                                <tbody id="projectsListBody">
                                    {% for p in projects_overview %}
                                    <tr data-list-item>
                                        <td>{{ p.title }}</td>
                                        <td>{% if p.last_updated %}{{ p.last_updated|date:"M d, Y" }}{% else %}-{% endif %}</td>
                                        <td>{{ p.percent_remaining }}%</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div id="listPagination" class="pagination-container js-hidden"></div>
                        {% else %}
                        <div>No projects found.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {# BOTTOM div: LOGS (Full Width) #}
        
        <div class="list" style="margin-top: 1rem;">
            <h2 class="headerr">Charts</h2>
            {% if request.user.role == "FACULTY" %}        
            <div class="chart-box">
                <h3 class="chart-box-title">College Budget Remaining Over Time</h3>
                <div class="chart-container-large">
                    <canvas id="collegeTimeChart" data-chart-data="{{ college_remaining_data_json }}"></canvas>
                </div>
            </div>
            {% endif %}        
            <div class="chart-box">
                <h3 class="chart-box-title">Total Project Funding Over Time</h3>
                <div class="chart-container-large">
                    <canvas id="facultyTotalChart" data-chart-data="{{ faculty_total_data_json }}"></canvas>
                </div>
            </div>
        </div>
        

        {# SVG Icons #}
        <svg style="display: none;">
            <symbol id="icon-search" viewBox="0 0 21 21" fill="none">
                <path d="M8.89152 15.9057C9.75056 15.9057 10.6012 15.7365 11.3948 15.4077C12.1885 15.079 12.9096 14.5972 13.5171 13.9897C14.1245 13.3823 14.6064 12.6612 14.9351 11.8675C15.2638 11.0739 15.433 10.2232 15.433 9.36417C15.433 8.50513 15.2638 7.6545 14.9351 6.86084C14.6064 6.06719 14.1245 5.34606 13.5171 4.73862C12.9096 4.13119 12.1885 3.64934 11.3948 3.3206C10.6012 2.99186 9.75056 2.82266 8.89152 2.82266C7.1566 2.82266 5.49274 3.51185 4.26597 4.73862C3.03919 5.9654 2.35 7.62926 2.35 9.36417C2.35 11.0991 3.03919 12.763 4.26597 13.9897C5.49274 15.2165 7.1566 15.9057 8.89152 15.9057V15.9057ZM15.7819 14.713L19.685 18.6161C19.7891 18.7167 19.872 18.8371 19.9291 18.9701C19.9861 19.1032 20.0161 19.2463 20.0173 19.391C20.0184 19.5358 19.9907 19.6793 19.9358 19.8133C19.8809 19.9472 19.7999 20.0689 19.6974 20.1712C19.595 20.2735 19.4732 20.3544 19.3392 20.4091C19.2052 20.4638 19.0616 20.4913 18.9168 20.4899C18.772 20.4886 18.629 20.4584 18.496 20.4012C18.3631 20.3439 18.2428 20.2608 18.1423 20.1566L14.2392 16.2535C12.4866 17.614 10.2814 18.2554 8.07247 18.0472C5.86357 17.839 3.81705 16.7968 2.34951 15.1328C0.881971 13.4688 0.103735 11.308 0.173229 9.09044C0.242723 6.87284 1.15472 4.76508 2.72357 3.19623C4.29242 1.62738 6.40018 0.715379 8.61778 0.645885C10.8354 0.576391 12.9961 1.35463 14.6601 2.82217C16.3241 4.28971 17.3663 6.33623 17.5745 8.54513C17.7827 10.754 17.1413 12.9592 15.7808 14.7119L15.7819 14.713Z" fill="#5A5252"/>
            </symbol>
            <symbol id="icon-filter" viewBox="0 0 23 22" fill="none">
                <path opacity="0.9" d="M21.5399 1.92871H1.37988L9.44388 11.4644V18.0567L13.4759 20.0727V11.4644L21.5399 1.92871Z" stroke="#1E1E1E" stroke-width="2.016" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
        </svg>
    </div>
<script>
    const DASH_ROOT = document.querySelector('[data-dashboard]');
    const IS_DASH = !!(DASH_ROOT && DASH_ROOT.getAttribute('data-dashboard') === '1');
    const MONTH_LABELS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    // --- FIX: Define missing class constants ---
    const CLASS_HIDDEN = 'js-hidden';
    const CLASS_GRID = 'js-grid';
    const CLASS_TABLE = 'js-table'; // NOTE: This class is not explicitly defined in the HTML/CSS but is used for logical separation in JS.
    const CLASS_FLEX = 'flex'; // Assuming flex is a utility class for the pagination container

    // Filter dropdown logic
    const filterBtn = document.getElementById('filterBtn');
    const filterDropdown = document.getElementById('filterDropdown');
    const closeFilter = document.getElementById('closeFilter');
    
    // Set initial state for dropdown if it's supposed to be hidden by default but might have style attribute issue
    if (filterDropdown) {
        // Ensure the style attribute starts as hidden if no parameters are set (assuming Django logic handles visibility on filter search submit)
        if (!window.location.search.includes('search') && !window.location.search.includes('sort_by')) {
             filterDropdown.style.display = 'none'; 
        } else {
             filterDropdown.style.display = 'block'; 
        }
    }

    if (filterBtn && filterDropdown) {
        filterBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation(); 
            // Toggles visibility
            if (filterDropdown.style.display === 'none' || filterDropdown.style.display === '') {
                filterDropdown.style.display = 'block';
            } else {
                filterDropdown.style.display = 'none';
            }
        });
    }
    if (closeFilter && filterDropdown) {
        closeFilter.addEventListener('click', function(e) {
            e.preventDefault();
            // Clear filters by redirecting to base URL without query parameters
            window.location.href = window.location.pathname;
        });
    }
    // Hide dropdown when clicking outside
    document.addEventListener('mousedown', function(e) {
        if (filterDropdown && filterDropdown.style.display !== 'none' && e.target !== filterBtn && !filterBtn.contains(e.target) && !filterDropdown.contains(e.target)) {
            filterDropdown.style.display = 'none';
        }
    });

    // Dashboard view toggle (only when on dashboard)
    (function dashboardToggle(){
        if (!IS_DASH) return;
        const cardBtn = document.getElementById('cardViewBtn');
        const listBtn = document.getElementById('listViewBtn');
        const cardView = document.getElementById('projectsCardView');
        const listView = document.getElementById('projectsListView');
        const cardPagination = document.getElementById('cardPagination');
        const listPagination = document.getElementById('listPagination');

        // Get the actual table element inside the list view wrapper
        const innerTable = listView ? listView.querySelector('table') : null;
        
        if (cardBtn && listBtn && cardView && listView && innerTable){
            cardBtn.addEventListener('click', ()=>{ 
                cardBtn.classList.add('active'); 
                cardBtn.classList.remove('inactive');
                listBtn.classList.remove('active'); 
                listBtn.classList.add('inactive');
                
                // Card View ON
                if(cardView){cardView.classList.add(CLASS_GRID); cardView.classList.remove(CLASS_HIDDEN);} 
                if(listView){listView.classList.add(CLASS_HIDDEN); listView.classList.remove(CLASS_TABLE);} 
                if(innerTable){innerTable.classList.add(CLASS_HIDDEN);} 
                if(cardPagination){cardPagination.classList.add(CLASS_FLEX); cardPagination.classList.remove(CLASS_HIDDEN);}
                if(listPagination){listPagination.classList.add(CLASS_HIDDEN); listPagination.classList.remove(CLASS_FLEX);}
                initCardPagination();
            });
            listBtn.addEventListener('click', ()=>{ 
                listBtn.classList.add('active'); 
                listBtn.classList.remove('inactive'); 
                cardBtn.classList.remove('active'); 
                cardBtn.classList.add('inactive');
                
                // List View ON
                // FIX: Removed CLASS_GRID/CLASS_TABLE logic that was confusing. Focus on HIDDEN class.
                if(cardView){cardView.classList.add(CLASS_HIDDEN);} 
                if(listView){listView.classList.remove(CLASS_HIDDEN);}
                if(innerTable){innerTable.classList.remove(CLASS_HIDDEN);} // Ensure table is visible
                if(cardPagination){cardPagination.classList.add(CLASS_HIDDEN); cardPagination.classList.remove(CLASS_FLEX);}
                if(listPagination){listPagination.classList.add(CLASS_FLEX); listPagination.classList.remove(CLASS_HIDDEN);}
                initListPagination();
            });
        }
    })();

    // Time Series Charts
    (function initTimeCharts(){
        if (!IS_DASH) return;
        if (!window.Chart) return;
        
        // Chart 1: College Budget Remaining Over Time
        const collegeChartEl = document.getElementById('collegeTimeChart');
        const collegeChartDataRaw = collegeChartEl ? collegeChartEl.getAttribute('data-chart-data') : '[]';
        const collegeData = collegeChartDataRaw ? JSON.parse(collegeChartDataRaw) : [];

        if (collegeChartEl && collegeData.length > 0) {
            new Chart(collegeChartEl.getContext('2d'), {
                type: 'line',
                data: { 
                    labels: MONTH_LABELS, 
                    datasets: [{ 
                        label: 'College Budget Remaining', 
                        data: collegeData, 
                        borderColor: '#0f3ea3', 
                        backgroundColor: 'rgba(15, 62, 163, 0.1)', 
                        fill: true,
                        tension: 0.35 
                    }] 
                },
                options: { 
                    responsive:true, 
                    maintainAspectRatio:false, 
                    plugins:{ 
                        legend:{ display:false },
                        tooltip:{ enabled:false } // <--- FIX APPLIED HERE
                    }, 
                    scales:{ y:{ beginAtZero: false, title: { display: true, text: 'Percent (%)' } } } 
                }
            });
        }

        // Chart 2: User's Total Project Budget Over Time
        const facultyChartEl = document.getElementById('facultyTotalChart');
        const facultyChartDataRaw = facultyChartEl ? facultyChartEl.getAttribute('data-chart-data') : '[]';
        const facultyData = facultyChartDataRaw ? JSON.parse(facultyChartDataRaw) : [];

        if (facultyChartEl && facultyData.length > 0) {
            new Chart(facultyChartEl.getContext('2d'), {
                type: 'line',
                data: { 
                    labels: MONTH_LABELS, 
                    datasets: [{ 
                        label: 'Total Project Funding', 
                        data: facultyData, 
                        borderColor: '#10b981', 
                        backgroundColor: 'rgba(16, 185, 129, 0.1)', 
                        fill: true,
                        tension: 0.35 
                    }] 
                },
                options: { 
                    responsive:true, 
                    maintainAspectRatio:false, 
                    plugins:{ 
                        legend:{ display:false }, 
                        tooltip:{ enabled:false } // <--- FIX APPLIED HERE
                    }, 
                    scales:{ y:{ beginAtZero: true, title: { display: true, text: 'Amount (₱)' } } } 
                }
            });
        }
    })();


    // Small project donuts on dashboard cards with center percentage text
    (function projectDonuts(){
        if (!IS_DASH) return;
        if (!window.Chart) return;
        try {
            const centerText = pct => ({
                id: 'centerText',
                afterDraw(chart){
                    const {ctx, chartArea:{left,right,top,bottom}} = chart;
                    const x=(left+right)/2, y=(top+bottom)/2;
                    ctx.save();
                    ctx.font = '600 14px Inter, Arial, sans-serif';
                    ctx.fillStyle = '#111';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${pct}%`, x, y);
                    ctx.restore();
                }
            });
            document.querySelectorAll('.proj-donut').forEach((canvas)=>{
                const pct = Math.max(0, Math.min(100, Number(canvas.getAttribute('data-percent')) || 0));
                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: { datasets: [{ data: [pct, Math.max(0, 100 - pct)], backgroundColor: ['#16a34a', '#d1d5db'], borderWidth: 0 }] },
                    options: { 
                        responsive:false, 
                        animation:false, 
                        cutout: '70%', 
                        plugins:{ 
                            legend:{ display:false }, 
                            tooltip:{ enabled:false } // <--- FIX APPLIED HERE
                        } 
                    },
                    plugins: [centerText(pct)]
                });
            });
        } catch (err) { console.error('Project donuts error', err); }
    })();


    // Card View Pagination (4 items per page)
    function initCardPagination() {
        if (!IS_DASH) return;
        const cardView = document.getElementById('projectsCardView');
        const container = document.getElementById('cardPagination');
        if (!cardView || !container) return;
        
        const items = Array.from(cardView.querySelectorAll('[data-card-item]'));
        if (items.length === 0) { container.innerHTML = ''; return; }
        
        const pageSize = 4;
        let currentPage = 1;
        
        function renderPage(page) {
            const totalPages = Math.max(1, Math.ceil(items.length / pageSize));
            currentPage = Math.min(Math.max(1, page), totalPages);
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            
            items.forEach((item, i) => {
                item.style.display = (i >= start && i < end) ? '' : 'none';
            });
            
            renderControls(totalPages);
        }
        
        function renderControls(totalPages) {
            container.innerHTML = '';
            
            const firstBtn = document.createElement('button');
            firstBtn.className = 'pagination-button';
            firstBtn.textContent = 'First';
            firstBtn.disabled = currentPage === 1;
            if (currentPage !== 1) firstBtn.addEventListener('click', () => renderPage(1));
            container.appendChild(firstBtn);
            
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-button';
            prevBtn.textContent = 'Previous';
            prevBtn.disabled = currentPage === 1;
            if (currentPage !== 1) prevBtn.addEventListener('click', () => renderPage(currentPage - 1));
            container.appendChild(prevBtn);
            
            const pages = computePageNumbers(totalPages, currentPage);
            pages.forEach(p => {
                if (p === '…') {
                    const span = document.createElement('span');
                    span.textContent = '…';
                    span.style.padding = '0 0.5rem';
                    container.appendChild(span);
                } else {
                    const btn = document.createElement('button');
                    btn.className = 'pagination-button';
                    if (p === currentPage) btn.classList.add('active');
                    btn.textContent = p;
                    btn.disabled = p === currentPage;
                    if (p !== currentPage) btn.addEventListener('click', () => renderPage(p));
                    container.appendChild(btn);
                }
            });
            
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-button';
            nextBtn.textContent = 'Next';
            nextBtn.disabled = currentPage === totalPages;
            if (currentPage !== totalPages) nextBtn.addEventListener('click', () => renderPage(currentPage + 1));
            container.appendChild(nextBtn);
            
            const lastBtn = document.createElement('button');
            lastBtn.className = 'pagination-button';
            lastBtn.textContent = 'Last';
            lastBtn.disabled = currentPage === totalPages;
            if (currentPage !== totalPages) lastBtn.addEventListener('click', () => renderPage(totalPages));
            container.appendChild(lastBtn);
        }
        
        function computePageNumbers(total, current) {
            const windowSize = 1;
            const pages = [];
            const add = n => { if (!pages.includes(n)) pages.push(n); };
            
            add(1);
            add(total);
            for (let i = current - windowSize; i <= current + windowSize; i++) {
                if (i > 1 && i < total) add(i);
            }
            pages.sort((a, b) => a - b);
            
            const result = [];
            for (let i = 0; i < pages.length; i++) {
                result.push(pages[i]);
                if (i < pages.length - 1 && pages[i + 1] - pages[i] > 1) {
                    result.push('…');
                }
            }
            return result;
        }
        
        renderPage(1);
    }

    // List View Pagination (5 items per page)
    function initListPagination() {
        if (!IS_DASH) return;
        const tbody = document.getElementById('projectsListBody');
        const container = document.getElementById('listPagination');
        // The table element itself is the parent of tbody, so we also ensure the table is visible
        const tableWrapper = document.getElementById('projectsListView');
        if (!tbody || !container || !tableWrapper) return;
        
        // FIX: The list view needs the inner table to be visible (by removing js-hidden)
        const innerTable = tableWrapper.querySelector('table');
        if (innerTable) {
            innerTable.classList.remove('js-hidden'); 
        }

        const items = Array.from(tbody.querySelectorAll('[data-list-item]'));
        if (items.length === 0) { container.innerHTML = ''; return; }
        
        const pageSize = 5;
        let currentPage = 1;
        
        function renderPage(page) {
            const totalPages = Math.max(1, Math.ceil(items.length / pageSize));
            currentPage = Math.min(Math.max(1, page), totalPages);
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            
            items.forEach((item, i) => {
                item.style.display = (i >= start && i < end) ? '' : 'none';
            });
            
            renderControls(totalPages);
        }
        
        function renderControls(totalPages) {
            container.innerHTML = '';
            
            const firstBtn = document.createElement('button');
            firstBtn.className = 'pagination-button';
            firstBtn.textContent = 'First';
            firstBtn.disabled = currentPage === 1;
            if (currentPage !== 1) firstBtn.addEventListener('click', () => renderPage(1));
            container.appendChild(firstBtn);
            
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-button';
            prevBtn.textContent = 'Previous';
            prevBtn.disabled = currentPage === 1;
            if (currentPage !== 1) prevBtn.addEventListener('click', () => renderPage(currentPage - 1));
            container.appendChild(prevBtn);
            
            const pages = computePageNumbers(totalPages, currentPage);
            pages.forEach(p => {
                if (p === '…') {
                    const span = document.createElement('span');
                    span.textContent = '…';
                    span.style.padding = '0 0.5rem';
                    container.appendChild(span);
                } else {
                    const btn = document.createElement('button');
                    btn.className = 'pagination-button';
                    if (p === currentPage) btn.classList.add('active');
                    btn.textContent = p;
                    btn.disabled = p === currentPage;
                    if (p !== currentPage) btn.addEventListener('click', () => renderPage(p));
                    container.appendChild(btn);
                }
            });
            
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-button';
            nextBtn.textContent = 'Next';
            nextBtn.disabled = currentPage === totalPages;
            if (currentPage !== totalPages) nextBtn.addEventListener('click', () => renderPage(currentPage + 1));
            container.appendChild(nextBtn);
            
            const lastBtn = document.createElement('button');
            lastBtn.className = 'pagination-button';
            lastBtn.textContent = 'Last';
            lastBtn.disabled = currentPage === totalPages;
            if (currentPage !== totalPages) lastBtn.addEventListener('click', () => renderPage(totalPages));
            container.appendChild(lastBtn);
        }
        
        function computePageNumbers(total, current) {
            const windowSize = 1;
            const pages = [];
            const add = n => { if (!pages.includes(n)) pages.push(n); };
            
            add(1);
            add(total);
            for (let i = current - windowSize; i <= current + windowSize; i++) {
                if (i > 1 && i < total) add(i);
            }
            pages.sort((a, b) => a - b);
            
            const result = [];
            for (let i = 0; i < pages.length; i++) {
                result.push(pages[i]);
                if (i < pages.length - 1 && pages[i + 1] - pages[i] > 1) {
                    result.push('…');
                }
            }
            return result;
        }
        
        renderPage(1);
    }

    // Initialize card pagination on page load (default view)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCardPagination);
    } else {
        initCardPagination();
    }
</script>
</body>

{% endblock %}