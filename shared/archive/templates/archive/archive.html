{% extends base_template %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Archives</title>

<link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/archive/styles.css' %}" rel="stylesheet">

</head>
<body>
	<div class="main-container">

        <div class="search-container">
            <form class="search-bar" id="searchForm" method="get" action="#">
                <svg width="16" height="16" style="margin-right:10px;"> <use href="#icon-search"></use> </svg>
                <input type="text" name="search" placeholder="Search project title or leader name" />
                <button type="button" id="filterBtn" style="background:none;border:none;padding:0;margin-right:5px;cursor:pointer; display: none;">
                    <svg width="16" height="16"> <use href="#icon-filter"></use> </svg>
                </button>
                <div id="filterDropdown" class="filter-dropdown" style="display: none;">
                   <div class="filter-grid" style="grid-template-columns: repeat(2, 1fr); grid-template-rows: 1fr;">
                        <label>Sort By
                            <select name="sort_by">
                                <option value="title">Title</option>
                                <option value="start_date">Date Started</option>
                                <option value="project_leader__last_name">Project Leader</option>
                                <option value="status">Status</option>
                            </select>
                        </label>
                        <label>Order
                            <select name="order">
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                        </label>
                        <label>Status
                            <select name="status">
                                <option value="">All Statuses</option>
                                <option value="NOT_STARTED">Not Started</option>
                                <option value="IN_PROGRESS">In Progress</option>
                                <option value="COMPLETED">Completed</option>
                                <option value="ON_HOLD">On Hold</option>
                                <option value="CANCELLED">Cancelled</option>
                            </select>
                        </label>
                        <label>Date
                            <input type="date" name="date" style="width: 87%"/>
                        </label>
                    </div>
                    <div class="filter-actions">
                        <button type="submit" class="filter-apply">Apply</button>
                        <button type="button" id="closeFilter" class="filter-close">Clear Filters</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="container-a">
			<div class="container-a">
				<div class="project-text" id="archiveTitle" style="margin-right: 20px;">Archives</div>
                <div class="dropdown" id="categoryDropdownContainer">
					<button id="categoryDropdownBtn" class="dropdown-button">
						<span id="currentCategoryDisplay">Group By: {{ categories.0.1 }}</span>
						<svg width="15" height="10" style="margin-left: 10px;"> <use href="#dropdown-icon"></use> </svg>
					</button>
					<div id="categoryDropdownContent" class="dropdown-content">
						{% for category_slug, category_name in categories %}
							<a href="#" data-category-slug="{{ category_slug }}" data-category-name="{{ category_name }}">{{ category_name }}</a>
						{% endfor %}
					</div>
				</div>
			</div>

            {% if user.is_authenticated %}
                {% if user_role == "VP" or user_role == "DIRECTOR" or user_role == "UESO" or user_role == "PROGRAM_HEAD" or user_role == "DEAN" or user_role == "COORDINATOR" %}
                    <button class="export-btn" id="exportProjectBtn" type="button">
                        <i class="fa-solid fa-download"></i>
                        Export
                    </button>
                {% endif %}
            {% endif %}
        </div>

        <div id="card-view" class="content-section">
            <div class="archive-grid" id="cardGrid">
                <div style="grid-column: 1 / -1; text-align: center; padding: 50px;" id="loadingIndicator">Loading archives...</div>
            </div>
        </div>

        <div id="table-view" class="content-section">
            <div class="container-a">
                <div class="breadcrumb-nav" id="breadcrumbNav">
                    </div>
            </div>
            <div class="table-wrap">
                <div class="table-box">
                    <table id="projectsTable" class="user-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Project Leader (College)</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Progress</th>
                                <th>Trainees</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div id="tablePagination" class="pagination-container" style="padding-top: 20px; display: flex; justify-content: center;"></div>
        </div>
	</div>

<svg style="display:none;">
    <symbol id="dropdown-icon" viewBox="0 0 15 10" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.11427 6.46831L12.3293 1.25327C12.4265 1.15265 12.5427 1.07239 12.6713 1.01717C12.7998 0.961959 12.9381 0.932896 13.0779 0.93168C13.2178 0.930465 13.3566 0.957121 13.486 1.01009C13.6155 1.06307 13.7331 1.1413 13.8321 1.24022C13.931 1.33914 14.0092 1.45677 14.0622 1.58624C14.1152 1.71572 14.1418 1.85445 14.1406 1.99434C14.1394 2.13423 14.1103 2.27247 14.0551 2.40101C13.9999 2.52954 13.9196 2.6458 13.819 2.74298L7.85912 8.70287C7.66155 8.90038 7.39363 9.01133 7.11427 9.01133C6.83490 9.01133 6.56698 8.90038 6.36941 8.70287L0.409525 2.74298C0.308901 2.6458 0.228639 2.52954 0.173424 2.40101C0.118209 2.27247 0.089146 2.13423 0.0879304 1.99434C0.0867148 1.85445 0.113371 1.71572 0.166344 1.58624C0.219317 1.45677 0.297546 1.33914 0.396466 1.24022C0.495386 1.1413 0.613016 1.06307 0.742492 1.01009C0.871969 0.957121 1.0107 0.930465 1.15059 0.93168C1.29048 0.932896 1.42872 0.961959 1.55726 1.01717C1.68579 1.07239 1.80205 1.15265 1.89923 1.25327L7.11427 6.46831Z" fill="black"/>
    </symbol>
    <symbol id="icon-search" viewBox="0 0 21 21" fill="none">
        <path d="M8.89152 15.9057C9.75056 15.9057 10.6012 15.7365 11.3948 15.4077C12.1885 15.079 12.9096 14.5972 13.5171 13.9897C14.1245 13.3823 14.6064 12.6612 14.9351 11.8675C15.2638 11.0739 15.4330 10.2232 15.4330 9.36417C15.4330 8.50513 15.2638 7.65450 14.9351 6.86084C14.6064 6.06719 14.1245 5.34606 13.5171 4.73862C12.9096 4.13119 12.1885 3.64934 11.3948 3.32060C10.6012 2.99186 9.75056 2.82266 8.89152 2.82266C7.15660 2.82266 5.49274 3.51185 4.26597 4.73862C3.03919 5.96540 2.35000 7.62926 2.35000 9.36417C2.35000 11.0991 3.03919 12.7630 4.26597 13.9897C5.49274 15.2165 7.15660 15.9057 8.89152 15.9057V15.9057ZM15.7819 14.713L19.6850 18.6161C19.7891 18.7167 19.8720 18.8371 19.9291 18.9701C19.9861 19.1032 20.0161 19.2463 20.0173 19.391C20.0184 19.5358 19.9907 19.6793 19.9358 19.8133C19.8809 19.9472 19.7999 20.0689 19.6974 20.1712C19.5950 20.2735 19.4732 20.3544 19.3392 20.4091C19.2052 20.4638 19.0616 20.4913 18.9168 20.4899C18.7720 20.4886 18.6290 20.4584 18.4960 20.4012C18.3631 20.3439 18.2428 20.2608 18.1423 20.1566L14.2392 16.2535C12.4866 17.614 10.2814 18.2554 8.07247 18.0472C5.86357 17.8390 3.81705 16.7968 2.34951 15.1328C0.881971 13.4688 0.103735 11.3080 0.173229 9.09044C0.242723 6.87284 1.15472 4.76508 2.72357 3.19623C4.29242 1.62738 6.40018 0.715379 8.61778 0.645885C10.8354 0.576391 12.9961 1.35463 14.6601 2.82217C16.3241 4.28971 17.3663 6.33623 17.5745 8.54513C17.7827 10.7540 17.1413 12.9592 15.7808 14.7119L15.7819 14.713Z" fill="#5A5252"/>
    </symbol>
    <symbol id="icon-filter" viewBox="0 0 23 22" fill="none">
        <path opacity="0.9" d="M21.5399 1.92871H1.37988L9.44388 11.4644V18.0567L13.4759 20.0727V11.4644L21.5399 1.92871Z" stroke="#1E1E1E" stroke-width="2.016" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
</svg>

<script>
    const categoryDropdownBtn = document.getElementById('categoryDropdownBtn');
    const categoryDropdownContainer = document.getElementById('categoryDropdownContainer');
    const categoryDropdownContent = document.getElementById('categoryDropdownContent');
    const currentCategoryDisplay = document.getElementById('currentCategoryDisplay');
    const cardView = document.getElementById('card-view');
    const tableView = document.getElementById('table-view');
    const cardGrid = document.getElementById('cardGrid');
    const projectsTableBody = document.querySelector('#projectsTable tbody');
    const breadcrumbNav = document.getElementById('breadcrumbNav');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const filterBtn = document.getElementById('filterBtn');

    let currentCategorySlug = '{{ default_category }}';
    let currentFilterKey = null;
    let currentFilterName = 'Year Started';

    function showLoading() {
        cardGrid.innerHTML = '';
        loadingIndicator.style.display = 'block';
    }

    function hideLoading() {
        loadingIndicator.style.display = 'none';
    }

    function switchView(view) {
        const localFilterBtn = document.getElementById('filterBtn');
        const filterDropdown = document.getElementById('filterDropdown');

        if (view === 'cards') {
            cardView.style.display = 'block';
            tableView.style.display = 'none';
            if (localFilterBtn) localFilterBtn.style.display = 'none';
            document.getElementById('searchForm').style.display = 'flex';
            if (filterDropdown) filterDropdown.style.display = 'none';
            categoryDropdownContainer.style.display = 'block';
            breadcrumbNav.style.display = 'none';
        } else if (view === 'table') {
            cardView.style.display = 'none';
            tableView.style.display = 'block';
            if (localFilterBtn) localFilterBtn.style.display = 'inline-block';
            categoryDropdownContainer.style.display = 'none';
            breadcrumbNav.style.display = 'block';
        }
    }

    function adjustFontSize(titleElement) {
        const container = titleElement.parentElement;
        const maxAvailableHeight = container.clientHeight * 0.90; 

        titleElement.style.whiteSpace = 'normal';
        titleElement.style.wordBreak = 'break-word';

        let currentFontSize = 30; 
        const minFontSize = 20;

        const tempDiv = titleElement.cloneNode(true);
        tempDiv.style.position = 'absolute';
        tempDiv.style.visibility = 'hidden';
        tempDiv.style.left = '-9999px';
        tempDiv.style.top = '-9999px';
        tempDiv.style.width = titleElement.clientWidth + 'px';
        tempDiv.style.height = 'auto';
        tempDiv.style.fontSize = currentFontSize + 'px';
        tempDiv.style.lineHeight = 'normal';
        
        const titleComputedStyle = getComputedStyle(titleElement);
        tempDiv.style.padding = titleComputedStyle.padding;
        tempDiv.style.margin = titleComputedStyle.margin;
        tempDiv.style.textShadow = titleComputedStyle.textShadow; 
        
        document.body.appendChild(tempDiv);
        
        while (tempDiv.clientHeight > maxAvailableHeight && currentFontSize > minFontSize) {
            currentFontSize -= 1;
            tempDiv.style.fontSize = currentFontSize + 'px';
            if (currentFontSize <= minFontSize) break;
        }

        document.body.removeChild(tempDiv);
        titleElement.style.fontSize = currentFontSize + 'px';
    }

    const ANIMATION_STATE = new Map();

    function drawMoiréPattern(canvasId, cardElement) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const cardRect = cardElement.getBoundingClientRect();
        
        const grayColor = '#cccccc';
        const waveDensity = 15;
        const waveAmplitude = 10;
        const speed = 0.005;
        
        canvas.width = cardRect.width;
        canvas.height = cardRect.height;
        
        const lineCount = Math.floor(canvas.height / (waveDensity * 0.8)) + 5;

        function drawPattern(shift, isHovered) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.globalAlpha = 1.0;

            for (let i = 0; i < lineCount; i++) {
                ctx.beginPath();
                
                if (isHovered) {
                    const hue = (i * 15 + shift * 50) % 360;
                    ctx.strokeStyle = `hsl(${hue}, 80%, 65%)`;
                } else {
                    ctx.strokeStyle = grayColor;
                }
                ctx.lineWidth = 1;

                for (let x = 0; x <= canvas.width; x++) {
                    const y = i * waveDensity + waveAmplitude * Math.sin((x / 50 + shift * 0.5) + (i * 0.1));
                    if (x === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
            }
            ctx.restore();
        }
        
        let currentShift = 0;

        function animate(timestamp) {
            const state = ANIMATION_STATE.get(canvasId);
            if (!state) return;

            currentShift += speed * state.speedMultiplier; 
            
            drawPattern(currentShift, state.hovered);
            
            if (state.hovered || state.speedMultiplier > 0) {
                state.frame = requestAnimationFrame(animate);
                ANIMATION_STATE.set(canvasId, state);
            }
        }
        
        drawPattern(0, false);

        cardElement.addEventListener('mouseenter', () => {
            const currentState = ANIMATION_STATE.get(canvasId) || { hovered: false, speedMultiplier: 0, frame: null };
            ANIMATION_STATE.set(canvasId, { hovered: true, speedMultiplier: 5, frame: currentState.frame });
            if (!currentState.frame) requestAnimationFrame(animate);
        });

        cardElement.addEventListener('mouseleave', () => {
            const currentState = ANIMATION_STATE.get(canvasId);
            if (currentState) {
                ANIMATION_STATE.set(canvasId, { hovered: false, speedMultiplier: 1, frame: currentState.frame });
                setTimeout(() => {
                    const finalState = ANIMATION_STATE.get(canvasId);
                    if (finalState && !finalState.hovered) {
                         ANIMATION_STATE.set(canvasId, { hovered: false, speedMultiplier: 0, frame: null });
                         cancelAnimationFrame(finalState.frame);
                    }
                }, 1000);
            }
        });
    }


    function renderCards(data, categorySlug) {
        hideLoading();
        cardGrid.innerHTML = '';
        if (data.length === 0) {
            cardGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">No projects found for this grouping.</p>';
            return;
        }

        data.forEach(item => {
            const card = document.createElement('a');
            card.className = 'archive-card-v2';
            card.href = '#';
            card.setAttribute('data-filter-key', item.label);
            card.setAttribute('data-category', categorySlug);
            
            const labelString = String(item.label);
            const canvasId = `moiré-pattern-${labelString.replace(/\s+/g, '-').toLowerCase()}`;

            card.innerHTML = `
                <div class="inner-content">
                    <canvas id="${canvasId}" class="seigaiha-canvas"></canvas>
                    <div class="title-v2">${item.label}</div>
                    <div class="projects-info-v2">No. of Projects: <span class="count-v2">${item.count}</span></div>
                </div>
            `;

            card.addEventListener('click', (e) => {
                e.preventDefault();
                const filterKey = e.currentTarget.getAttribute('data-filter-key');
                const categoryName = e.currentTarget.querySelector('.title-v2').textContent; 
                loadProjectTable(categorySlug, filterKey, categoryName);
            });
            cardGrid.appendChild(card);
            
            const titleDiv = card.querySelector('.title-v2');
            requestAnimationFrame(() => {
                adjustFontSize(titleDiv);
                drawMoiréPattern(canvasId, card);
            });
        });
    }

    function renderProjectTable(data) {
        projectsTableBody.innerHTML = '';
        if (data.length === 0) {
            projectsTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">No projects found for this filter.</td></tr>`;
            return;
        }

        data.forEach(project => {
            const row = projectsTableBody.insertRow();
            const leaderName = project.project_leader ? project.project_leader.full_name : 'N/A';
            const collegeName = (project.project_leader && project.project_leader.college) ? ` (${project.project_leader.college.name})` : '';
            const progressDisplay = project.progress_display || '0/0 (0%)';
            const projectDetailUrl = `/projects/${project.id}/`;

            row.innerHTML = `
                <td><a href="${projectDetailUrl}" class="link">${project.title}</a></td>
                <td>${leaderName} ${collegeName}</td>
                <td>${project.start_date || 'N/A'}</td>
                <td>${project.estimated_end_date || 'N/A'}</td>
                <td>${progressDisplay}</td>
                <td class="center">${project.estimated_trainees || 0}</td>
                <td>${project.status}</td>
            `;
        });
    }

    async function loadAggregationData(categorySlug) {
        switchView('cards');
        showLoading();
        try {
            const apiURL = `/archives/api/aggregate/${categorySlug}/`;
            const response = await fetch(apiURL);
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`API Error Status: ${response.status}`, errorText);
                throw new Error(`API returned status ${response.status}`);
            }
            const data = await response.json();
            renderCards(data, categorySlug);
            currentCategorySlug = categorySlug;
        } catch (error) {
            console.error("Error fetching aggregation data:", error);
            cardGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: red;">Failed to load data. Please check the API endpoint and server console for details.</p>';
        }
    }

    async function loadProjectTable(category, filterValue, titleName) {
        currentFilterKey = filterValue;
        currentFilterName = titleName;
        switchView('table');

        breadcrumbNav.innerHTML = `
            <span class="breadcrumb-item"><a href="#" id="breadcrumbAll">ALL</a></span>
            <span class="breadcrumb-separator">&gt;</span>
            <span class="breadcrumb-item active">${titleName}</span>
        `;
        breadcrumbNav.querySelector('#breadcrumbAll').addEventListener('click', (e) => {
            e.preventDefault();
            loadAggregationData(currentCategorySlug);
        });

        projectsTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">Loading projects...</td></tr>`;
        const formData = new FormData(document.getElementById('searchForm'));
        const searchParams = new URLSearchParams(formData).toString();
        const apiURL = `/archives/api/projects/${category}/${encodeURIComponent(filterValue)}/?${searchParams}`;

        try {
            const response = await fetch(apiURL);
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`API Error Status: ${response.status}`, errorText);
                throw new Error(`API returned status ${response.status}`);
            }
            const jsonResponse = await response.json();
            renderProjectTable(jsonResponse.results || jsonResponse);

            const paginationContainer = document.getElementById('tablePagination');
            paginationContainer.innerHTML = '';
            if (jsonResponse.previous) {
                const prevUrl = new URL(jsonResponse.previous, window.location.origin);
                paginationContainer.innerHTML += `<a class="pagination-button" href="#" onclick="event.preventDefault(); loadProjectTablePage('${prevUrl.search}');">Previous</a>`;
            }
            if (jsonResponse.next) {
                const nextUrl = new URL(jsonResponse.next, window.location.origin);
                paginationContainer.innerHTML += `<a class="pagination-button" href="#" onclick="event.preventDefault(); loadProjectTablePage('${nextUrl.search}');">Next</a>`;
            }
        } catch (error) {
            console.error("Error fetching project list:", error);
            projectsTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: red;">Failed to load project list.</td></tr>`;
        }
    }

    async function loadProjectTablePage(queryString) {
        const apiURL = `/archives/api/projects/${currentCategorySlug}/${encodeURIComponent(currentFilterKey)}/${queryString}`;
        projectsTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">Loading page...</td></tr>`;
        try {
            const response = await fetch(apiURL);
            if (!response.ok) {
                throw new Error(`API returned status ${response.status}`);
            }
            const jsonResponse = await response.json();
            renderProjectTable(jsonResponse.results || jsonResponse);

            const paginationContainer = document.getElementById('tablePagination');
            paginationContainer.innerHTML = '';
            if (jsonResponse.previous) {
                const prevUrl = new URL(jsonResponse.previous, window.location.origin);
                paginationContainer.innerHTML += `<a class="pagination-button" href="#" onclick="event.preventDefault(); loadProjectTablePage('${prevUrl.search}');">Previous</a>`;
            }
            if (jsonResponse.next) {
                const nextUrl = new URL(jsonResponse.next, window.location.origin);
                paginationContainer.innerHTML += `<a class="pagination-button" href="#" onclick="event.preventDefault(); loadProjectTablePage('${nextUrl.search}');">Next</a>`;
            }
        } catch (error) {
            console.error("Error fetching paginated list:", error);
            projectsTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: red;">Failed to load page.</td></tr>`;
        }
    }


    categoryDropdownBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        categoryDropdownContent.style.display = categoryDropdownContent.style.display === 'block' ? 'none' : 'block';
    });

    categoryDropdownContent.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const slug = e.currentTarget.getAttribute('data-category-slug');
            const name = e.currentTarget.getAttribute('data-category-name');
            currentCategoryDisplay.textContent = `Group By: ${name}`;
            categoryDropdownContent.style.display = 'none';
            loadAggregationData(slug);
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        currentCategoryDisplay.textContent = `Group By: {{ categories.0.1 }}`;
        loadAggregationData(currentCategorySlug);
    });

    document.addEventListener('click', function(e) {
        if (e.target !== categoryDropdownBtn && !categoryDropdownBtn.contains(e.target)) {
            categoryDropdownContent.style.display = 'none';
        }
    });

    if (filterBtn && document.getElementById('filterDropdown')) {
        filterBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const filterDropdown = document.getElementById('filterDropdown');
            filterDropdown.style.display = filterDropdown.style.display === 'block' ? 'none' : 'block';
        });
    }

    if (document.getElementById('closeFilter') && document.getElementById('filterDropdown')) {
        document.getElementById('closeFilter').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = window.location.pathname;
        });
    }

    if (document.getElementById('searchForm')) {
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const filterDropdown = document.getElementById('filterDropdown');
            
            if (tableView.style.display === 'block' && currentFilterKey !== null) {
                loadProjectTable(currentCategorySlug, currentFilterKey, currentFilterName);
            } else {
                loadAggregationData(currentCategorySlug);
            }
            if (filterDropdown) filterDropdown.style.display = 'none';
        });
    }
</script>

</body>
</html>

{% endblock %}