{% load static %}
<!DOCTYPE html>
<html>
<head>
<title>Implementer Registration</title>
<meta charset="UTF-8">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'users/regis_style.css' %}" rel="stylesheet">
</head>

<body>
    <!-- Step 1 - [Implementer Personal Details] -->
    <form id="form-step1" autocomplete="off" style="display:block;" onsubmit="event.preventDefault(); nextStep(1);">
        {% csrf_token %}
        <div class="card" id="step1">
            <h2>Create Implementer Account</h2> 
            <hr>
            <p class="subtitle"> 
                <i class="fa-regular fa-id-card subtitle-icon" aria-hidden="true"></i>
                Input your Contact and Personal Details.
            </p> 
            <div class="form-grid">
                <div class="form-group">
                    <div class="form-label">Given Name:<span class="required"> *</span></div> 
                    <input class="form-input" type="text" name="given_name" id="id_given_name" value="{{ form.given_name.value|default:'' }}">
                </div>
                <div class="form-group">
                    <div class="form-label">Email:<span class="required"> *</span></div>
                    <input class="form-input" type="email" name="email" id="id_email" value="{{ form.email.value|default:'' }}">
                    <div id="email-error" class="email-error"></div>
                </div>
                <div class="form-group">
                    <div style="display: flex; flex-direction: row; gap: 12px;">
                        <div>
                            <div class="form-label">Middle Initial:</div>
                            <input class="form-input" type="text" name="middle_initial" id="id_middle_initial" value="{{ form.middle_initial.value|default:'' }}">
                        </div>
                        <div>
                            <div class="form-label">Suffix:</div>
                            <input class="form-input" type="text" name="suffix" id="id_suffix" value="{{ form.suffix.value|default:'' }}">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">Contact Number:<span class="required"> *</span></div>
                    <input class="form-input" type="text" name="contact_no" id="id_contact_no" value="{{ form.contact_no.value|default:'' }}">
                </div>
                <div class="form-group">
                    <div class="form-label">Last Name:<span class="required"> *</span></div>
                    <input class="form-input" type="text" name="last_name" id="id_last_name" value="{{ form.last_name.value|default:'' }}">
                </div>
                <div class="form-group">
                    <div class="form-label">Sex:<span class="required"> *</span></div>
                    <select class="form-input" name="sex" id="id_sex">
                        <option value="">Select Sex</option>
                        <option value="MALE" {% if form.sex.value == "MALE" %}selected{% endif %}>Male</option>
                        <option value="FEMALE" {% if form.sex.value == "FEMALE" %}selected{% endif %}>Female</option>
                    </select>
                </div>
            </div>
            <div class="actions">
                <a href="{% url 'register' %}" class="back-btn"> 
                    <svg width="18" height="19" viewBox="0 0 18 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <use xlink:href="#icon-arrow-left" />
                    </svg>
                    <span class="back-btn-text">Back to Sign In</span>
                </a>
                <button class="proceed-btn" type="submit"> 
                    <span class="back-btn-text">Proceed</span>
                    <svg width="18" height="19" viewBox="0 0 18 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <use xlink:href="#icon-arrow-right" />
                    </svg>
                </button>
            </div>
        </div>
    </form>

    <!-- Step 2 - [Implementer Professional Details] -->
    <form id="form-step2" autocomplete="off" style="display:none;" onsubmit="event.preventDefault(); nextStep(2);">
        {% csrf_token %}
        <div class="card" id="step2">
            <h2>Create Implementer Account</h2> 
            <hr>
            <p class="subtitle">  
                <i class="fa-solid fa-briefcase subtitle-icon"></i>
                Input your Professional Details.
            </p>
            <div class="form-grid">
                <div class="form-group">
                    <div class="form-label">Degree:<span class="required"> *</span></div>
                    <input class="form-input" type="text" name="degree" id="id_degree" value="{{ form.degree.value|default:'' }}">
                </div>

                <div class="form-group">
                    <div class="form-label">Expertise:<span class="required"> *</span></div>
                    <input class="form-input" type="text" name="expertise" id="id_expertise" value="{{ form.expertise.value|default:'' }}">
                </div>

                <div class="form-group">
                    <div class="form-label">Password:<span class="required"> *</span></div>
                    <input class="form-input" type="password" name="password" id="id_password">
                </div>

                <div class="form-group">
                    <div class="form-label">Confirm Password:<span class="required"> *</span></div>
                    <input class="form-input" type="password" name="confirm_password" id="id_confirm_password">
                </div>
                
                <div></div>
                
                <div class="checkbox" id="terms-checkbox-row">
                    <div style="display: flex; flex-direction: column;">
                        <div style="display: flex; flex-direction: row; align-items: center;">
                            <input type="checkbox" id="terms_checkbox">
                            <div>I have read & agree with the <a href="#">Terms and Conditions</a> and the <a href="#">Privacy Policy</a>.</div>
                        </div>
                        <div id="terms-error-container"></div>
                    </div>
                </div>
            </div>
            <div class="actions">
                <a class="back-btn" onclick="prevStep(2)"> 
                    <svg width="18" height="19" viewBox="0 0 18 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <use xlink:href="#icon-arrow-left" />
                    </svg>
                    <span class="back-btn-text">Back</span>
                </a>
                <button class="proceed-btn" type="submit"> 
                    <span class="back-btn-text">Proceed</span>
                    <svg width="18" height="19" viewBox="0 0 18 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <use xlink:href="#icon-arrow-right" />
                    </svg>
                </button>
            </div>
        </div>
    </form>

    <!-- Step 3+4 - [Select and Upload ID] -->
    <form method="post" autocomplete="off" enctype="multipart/form-data" id="form-step3" style="display:none;">
        {% csrf_token %}
        <div class="card" id="step3">
            <h2>Upload Your ID</h2> 
            <hr>
            <p class="subtitle">  
                <i class="fa-regular fa-address-card subtitle-icon"></i>
                Select your ID type and upload your valid ID for verification. 
            </p>
            <div style="margin-bottom: 1.5rem;">
                <div class="form-label">Preferred ID <span class="required">*</span></div>
                <select class="form-input" name="preferred_id" id="preferred_id">
                    {% for value, label in form.fields.preferred_id.choices %}
                        <option value="{{ value }}" {% if form.preferred_id.value == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
                <div id="preferred-id-error-container"></div>
            </div>
            <div style="margin: 20px 0; text-align: center;">
                <div style="font-size: 18px; color: #888; margin-bottom: 10px;">
                    <div class="form-group">
                        <div class="upload-area" onclick="document.getElementById('id_valid_id').click()">
                            <svg class="upload-icon"><use href="#icon-upload"></use></svg>
                            <span class="upload-text">Click to upload</span>
                            <input class="file-input" type="file" name="valid_id" id="id_valid_id" style="display:none;" accept="image/jpeg,image/png,image/jpg,image/gif,image/webp,application/pdf">
                        </div>
                    </div>

                    <div class="file-preview" id="file-preview" style="display:none;">
                        <div class="file-info">
                            <svg width="16" height="16"><use href="#icon-upload"></use></svg>
                            <span id="file-name"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="actions">
                <a class="back-btn" onclick="prevStep(3)">
                    <svg width="18" height="19" viewBox="0 0 18 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <use xlink:href="#icon-arrow-left" />
                    </svg>
                    <span class="back-btn-text">Back</span>
                </a>
                <button class="proceed-btn" type="submit"> 
                    <span class="back-btn-text">Proceed</span>
                    <svg width="18" height="19" viewBox="0 0 18 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <use xlink:href="#icon-arrow-right" />
                    </svg>
                </button>
            </div>
        </div>
    </form>

<!-- SVG Sprite Section -->
<svg style="display:none;">
	
    <symbol id="icon-arrow-right" viewBox="0 0 18 19">  
        <path d="M13.3925 10.4L7.2325 16.56L8.8 18.1L17.6 9.3L8.8 0.5L7.2325 2.04L13.3925 8.2H0V10.4H13.3925Z" fill="#0099FF"/>
    </symbol> 
    
	<symbol id="icon-arrow-left" viewBox="0 0 18 19">
        <path d="M4.60755 10.4L10.7675 16.56L9.20005 18.1L0.400047 9.3L9.20005 0.5L10.7675 2.04L4.60755 8.2H18V10.4H4.60755Z" fill="#0099FF"/>
    </symbol>
    
	<symbol id="icon-upload" viewBox="0 0 24 24" fill="currentColor">
		<path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
		<path d="M12,11L8,15H16L12,11Z" />
	</symbol>
	
</svg>


<script>
    // Email uniqueness check
    document.addEventListener('DOMContentLoaded', function() {
        var emailInput = document.getElementById('id_email');
        var emailError = document.getElementById('email-error');
        if (emailInput) {
            emailInput.addEventListener('blur', function() {
                var email = emailInput.value.trim();
                if (!email) return;
                fetch('/check-email/?email=' + encodeURIComponent(email))
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            emailError.textContent = 'This email is already registered.';
                            emailError.style.display = 'block';
                        } else {
                            emailError.textContent = '';
                            emailError.style.display = 'none';
                        }
                    })
                    .catch(() => {
                        emailError.textContent = 'Error checking email.';
                        emailError.style.display = 'block';
                    });
            });
        }
    });

   // File Input Change Handler
    document.getElementById('id_valid_id').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileInput = document.getElementById('id_valid_id');
        const fileError = document.getElementById('file-error');
        fileInput.classList.remove('error-input');
        if (file) {
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-preview').style.display = 'block';
            fileError.style.display = 'none';
        } else {
            document.getElementById('file-preview').style.display = 'none';
        }
    });

    function validateRequiredFields(fields) {
        let valid = true;
        fields.forEach(function(fieldId) {
            const field = document.getElementById(fieldId);
            if (field && !field.value.trim()) {
                valid = false;
                field.style.borderColor = "red";
            } else if (field) {
                field.style.borderColor = "#ddd";
            }
        });
        return valid;
    }

    // Custom Popup Modal
    function showPopup(message) {
        let modal = document.getElementById('custom-modal');
        let modalMsg = document.getElementById('custom-modal-message');
        modalMsg.textContent = message;
        modal.style.display = 'flex';
    }
    function closePopup() {
        document.getElementById('custom-modal').style.display = 'none';
    }

    // Custom Validation For Fields
    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        if (!field) return;
        if (field.tagName === 'SELECT') {
            field.classList.add('error-select');
        } else {
            field.classList.add('error-input');
        }
        let err = document.createElement('div');
        err.className = 'field-error';
        err.textContent = message;
        err.style.color = '#E53E3E';
        err.style.fontSize = '0.75rem';
        err.style.marginTop = '0.25rem';
        field.parentNode.appendChild(err);
    }

    // Clear All Field Errors
    function clearFieldErrors() {
        document.querySelectorAll('.error-input').forEach(e => e.classList.remove('error-input'));
        document.querySelectorAll('.error-select').forEach(e => e.classList.remove('error-select'));
        document.querySelectorAll('.field-error').forEach(e => e.remove());
        let termsErr = document.getElementById('terms-error');
        if (termsErr) termsErr.remove();
    }

    // Next Step
    function nextStep(current) {
        clearFieldErrors();
        let valid = true;
        // Step 1 Validation
        if (current === 1) {
            const requiredFields = ['id_given_name', 'id_email', 'id_last_name', 'id_contact_no', 'id_sex'];
            requiredFields.forEach(function(fieldId) {
                const field = document.getElementById(fieldId);
                if (field && !field.value.trim()) {
                    valid = false;
                    showFieldError(fieldId, 'This field is required.');
                }
            });
            if (!valid) {
                showPopup("Please fill out all required fields.");
                return;
            }
        }
        // Step 2 Validation
        if (current === 2) {
            const requiredFields = ['id_degree', 'id_expertise', 'id_password', 'id_confirm_password'];
            requiredFields.forEach(function(fieldId) {
                const field = document.getElementById(fieldId);
                if (field && !field.value.trim()) {
                    valid = false;
                    showFieldError(fieldId, 'This field is required.');
                }
            });
            const password = document.getElementById('id_password').value;
            const confirmPassword = document.getElementById('id_confirm_password').value;
            if (password !== confirmPassword) {
                valid = false;
                showFieldError('id_confirm_password', 'Passwords do not match.');
            }
            const termsCheckbox = document.getElementById('terms_checkbox');
            if (!termsCheckbox.checked) {
                valid = false;

                let err = document.getElementById('terms-error');
                if (err) err.remove();
                let errDiv = document.createElement('div');
                errDiv.id = 'terms-error';
                errDiv.className = 'field-error';
                errDiv.textContent = 'You must agree to the Terms and Conditions and Privacy Policy.';
                errDiv.style.color = '#E53E3E';
                errDiv.style.fontSize = '0.7rem';
                errDiv.style.marginTop = '0.25rem';
                document.getElementById('terms-error-container').appendChild(errDiv);
            }
            if (!valid) {
                showPopup("Please correct the errors before proceeding.");
                return;
            }
        }

        if (current === 2) {
            const fieldMap = {
                'id_given_name': 'given_name',
                'id_middle_initial': 'middle_initial',
                'id_last_name': 'last_name',
                'id_suffix': 'suffix',
                'id_sex': 'sex',
                'id_email': 'email',
                'id_contact_no': 'contact_no',
                'id_degree': 'degree',
                'id_expertise': 'expertise',
                'id_password': 'password',
                'id_confirm_password': 'confirm_password'
            };
            const form3 = document.getElementById('form-step3');

            Array.from(form3.querySelectorAll('.step-hidden')).forEach(e => e.remove());
            Object.entries(fieldMap).forEach(([fieldId, fieldName]) => {
                let field = document.getElementById(fieldId);
                if (field) {
                    let input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = fieldName;
                    input.value = field.value;
                    input.className = 'step-hidden';
                    form3.appendChild(input);
                }
            });
        }

        document.getElementById("form-step" + current).style.display = "none";
        document.getElementById("form-step" + (current + 1)).style.display = "block";
    }

    // Previous Step
    function prevStep(current) {
        document.getElementById("form-step" + current).style.display = "none";
        document.getElementById("form-step" + (current - 1)).style.display = "block";
    }

    // Valid ID and Preferred ID Validation
    document.addEventListener('DOMContentLoaded', function() {
        var form = document.getElementById('form-step3');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Always copy all required fields from steps 1 and 2 to step 3 as hidden inputs
                const fieldMap = {
                    'id_given_name': 'given_name',
                    'id_middle_initial': 'middle_initial',
                    'id_last_name': 'last_name',
                    'id_suffix': 'suffix',
                    'id_sex': 'sex',
                    'id_email': 'email',
                    'id_contact_no': 'contact_no',
                    'id_degree': 'degree',
                    'id_expertise': 'expertise',
                    'id_password': 'password',
                    'id_confirm_password': 'confirm_password'
                };
                // Remove old hidden fields
                Array.from(form.querySelectorAll('.step-hidden')).forEach(e => e.remove());
                Object.entries(fieldMap).forEach(([fieldId, fieldName]) => {
                    let field = document.getElementById(fieldId);
                    if (field) {
                        let input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = fieldName;
                        input.value = field.value;
                        input.className = 'step-hidden';
                        form.appendChild(input);
                    }
                });
                let valid = true;
                const fileInput = document.getElementById('id_valid_id');
                const preferredIdSelect = document.getElementById('preferred_id');

                fileInput.classList.remove('error-input');
                let err = document.getElementById('file-error');
                if (err) err.remove();
                preferredIdSelect.classList.remove('error-select');
                let pidErr = document.getElementById('preferred-id-error');
                if (pidErr) pidErr.remove();

                var fileSelected = fileInput && fileInput.files && fileInput.files.length > 0;
                var preferredIdValue = preferredIdSelect && preferredIdSelect.value;
                if (!preferredIdValue) {
                    valid = false;
                    preferredIdSelect.classList.add('error-select');
                    let errDiv = document.createElement('div');
                    errDiv.id = 'preferred-id-error';
                    errDiv.className = 'field-error';
                    errDiv.textContent = 'Preferred ID is required.';
                    errDiv.style.color = '#E53E3E';
                    errDiv.style.fontSize = '0.95rem';
                    errDiv.style.marginTop = '0.25rem';
                    document.getElementById('preferred-id-error-container').appendChild(errDiv);
                }
                if (!fileSelected) {
                    valid = false;
                    fileInput.classList.add('error-input');
                    let errDiv = document.createElement('div');
                    errDiv.id = 'file-error';
                    errDiv.textContent = 'Valid ID file is required.';
                    errDiv.style.color = '#E53E3E';
                    errDiv.style.fontSize = '0.95rem';
                    errDiv.style.marginTop = '0.25rem';
                    fileInput.parentNode.appendChild(errDiv);
                }
                if (!valid) {
                    e.preventDefault();
                    showPopup("Please select a preferred ID and upload your image to proceed.");
                    return;
                }
            });
        }
    });
</script>
    
    <!-- Custom Modal Popup -->
    <div id="custom-modal">
        <div class="modal-container">
            <div class="modal-title">Notice</div>
            <div id="custom-modal-message"></div>
            <button onclick="closePopup()" class="modal-btn">OK</button>
        </div>
    </div>
</body>
</html>