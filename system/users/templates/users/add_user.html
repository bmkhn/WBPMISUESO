{% extends "base_internal.html" %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add User</title>

<link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'shared/projects/styles.css' %}" rel="stylesheet">

</head>

<body>
<div class="content-wrapper-fix"> <form method="post" enctype="multipart/form-data" id="addUserForm" novalidate>
    {% csrf_token %}
    <div class="user-details-container">
        <div class="user-details-title">
            <h2>Create New User</h2> 
            <p>Input all fields appropriately and create a user.</p>
        </div>

        <div class="user-details-section">
            <div class="user-details-category">  
                <i class="fa-regular fa-user"></i>
                User Profile              
            </div>
            
            <div class="profile-picture-circle-container">
                <label for="profile_picture_input" class="profile-picture-upload-area" id="upload-label-pp">
                    <img id="profile-picture-preview-img" class="profile-picture-preview" alt="Profile Preview">
                    <i id="profile-picture-icon" class="fa-solid fa-camera profile-picture-icon"></i>
                </label>
                <div class="file-upload-info">Click to upload (JPG, PNG)</div>
                <input 
                    class="hidden" 
                    type="file" 
                    name="profile_picture" 
                    id="profile_picture_input" 
                    accept="image/jpeg,image/png"
                    data-optional 
                    onchange="displayProfilePicture(this)">
            </div>
            <div class="user-details-row cols-4">
                <div>
                    <div class="user-details-label">Last Name <span class="required">*</span></div>
                    <input type="text" name="last_name" class="form-input" value="" required>
                </div>
                <div>
                    <div class="user-details-label">Given Name <span class="required">*</span></div>
                    <input type="text" name="given_name" class="form-input" value="" required>
                </div>
                <div>
                    <div class="user-details-label">M.I.</div>
                    <input type="text" name="middle_initial" class="form-input" value="" data-optional>
                </div>
                <div>
                    <div class="user-details-label">Suffix</div>
                    <input type="text" name="suffix" class="form-input" value="" data-optional>
                </div>
            </div>
            <div class="user-details-row cols-3">
                <div>
                    <div class="user-details-label">Sex <span class="required">*</span></div>
                    <select name="sex" class="user-details-value" style="transition: none;" required>
                        <option value="" selected disabled>Select Sex</option>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                    </select>
                </div>
                <div>
                    <div class="user-details-label">Email <span class="required">*</span></div>
                    <input type="email" name="email" class="form-input" value="" id="email-input" required>
                    <div id="email-error" class="error-message"></div>
                </div>
                <div>
                    <div class="user-details-label">Contact Number <span class="required">*</span></div>
                    <input type="text" name="contact_no" class="form-input" value="" id="id_contact_no" required>
                </div>
            </div>
        </div>

        <div class="user-details-section">
            <div class="user-details-category">  
                <i class="fa-solid fa-key"></i>
                Account Info 
            </div>
            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Role <span class="required">*</span></div>
                    <select name="role" class="user-details-value" style="transition: none;" required>
                        <option value="" selected disabled>Select Role</option>
                        {% for r in roles %}
                        <option value="{{ r.0 }}">{{ r.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <div class="user-details-label">Password <span class="required">*</span></div>
                    <div class="input-group">
                        <input class="form-input" type="password" name="password" id="id_password" onkeyup="checkPasswordStrength();" required>
                        <span class="input-group-text toggle-password" id="togglePassword">
                            <i class="fa-solid fa-eye-slash" style="cursor: pointer;"></i>
                        </span>
                    </div>
                    <div class="progress mt-1" style="height: 5px;">
                        <div id="password-strength-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small id="passwordHelpBlock" class="form-text text-muted" style="font-size: 0.75rem; color: #718096 !important; margin-top: 0.25rem;">
                        Password must be at least 8 characters long, and include uppercase, lowercase, and a number.
                    </small>
                </div>
            </div>
        </div>

        <div class="user-details-section" id="role-specific-section">
            <div class="user-details-category">Role Specific Information</div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">College <span class="required">*</span></div>
                    <select name="college" class="user-details-value" data-role-required style="transition: none;">
                        <option value="">Select College</option>
                        {% for college in colleges %}
                            <option value="{{ college.id }}" {% if user.college.id == college.id %}selected{% endif %}>{{ college.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <div class="user-details-label">Campus (from College)</div>
                    <input type="text" name="campus_display" class="form-input" value="Will be determined by College selection" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                </div>
            </div>
            
            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Degree <span class="required">*</span></div>
                    <input type="text" name="degree" class="form-input" value="" data-role-required>
                </div>
                <div>
                    <div class="user-details-label">Expertise <span class="required">*</span></div>
                    <input type="text" name="expertise" class="form-input" value="" data-role-required>
                </div>
            </div>

            <div class="user-details-row cols-2">
                <div>
                    <div class="user-details-label">Company <span class="required">*</span></div>
                    <input type="text" name="company" class="form-input" value="" data-role-required>
                </div>
                <div>
                    <div class="user-details-label">Industry <span class="required">*</span></div>
                    <input type="text" name="industry" class="form-input" value="" data-role-required>
                </div>
            </div> 
        </div>

        <div class="form-actions">
            <a href="{% url 'manage_user' %}" class="back btn">Back</a>
            <button type="submit" class="save btn">Add User</button>
        </div>
    </div>    
</form>
</div> <svg style="display:none;">
    <symbol id="icon-upload" viewBox="0 0 24 24" fill="currentColor">
        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
        <path d="M12,11L8,15H16L12,11Z" />
    </symbol>
</svg>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
    // --- Data Mapping for Campus Display ---
    // NOTE: This data must be accurate and available in your Django context
    const COLLEGES_DATA = {
        {% for college in colleges %}
            "{{ college.id }}": {
                "id": "{{ college.id }}",
                "name": "{{ college.name }}",
                "campus_name": "{{ college.campus.name|default:'N/A' }}" 
            },
        {% endfor %}
    };
    
    // --- Profile Picture Functions (Circular UI) ---

    function displayProfilePicture(input) {
        const previewImg = document.getElementById('profile-picture-preview-img');
        const icon = document.getElementById('profile-picture-icon');
        
        if (input.files.length > 0) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(evt) {
                previewImg.src = evt.target.result;
                previewImg.style.display = 'block';
                icon.style.display = 'none';
            };
            reader.readAsDataURL(file);
        } else {
            previewImg.src = '';
            previewImg.style.display = 'none';
            icon.style.display = 'block';
        }
    }

    // --- Password Strength and Toggle Functions ---

    function checkPasswordStrength() {
        const password = document.getElementById('id_password').value;
        const bar = document.getElementById('password-strength-bar');
        let score = 0;
        
        if (password.length >= 8) score += 25;
        if (/[A-Z]/.test(password)) score += 25;
        if (/[a-z]/.test(password)) score += 25;
        if (/[0-9!@#$%^&*()]/.test(password)) score += 25;

        bar.style.width = score + '%';
        bar.setAttribute('aria-valuenow', score);
        
        bar.className = 'progress-bar'; 
        if (score <= 25) {
            bar.classList.add('bg-danger');
        } else if (score <= 75) {
            bar.classList.add('bg-warning');
        } else {
            bar.classList.add('bg-success');
        }
    }

    // --- Validation and Role Logic ---
    
    // Helper to show/hide field errors dynamically
    function showFieldError(field, message) {
        let err = document.createElement('div');
        err.className = 'field-error';
        err.textContent = message;
        err.style.color = '#E53E3E';
        err.style.fontSize = '0.75rem';
        err.style.marginTop = '0.25rem';
        err.style.alignSelf = 'center';
        
        const inputGroup = field.closest('.input-group');

        if (inputGroup) {
            // Insert error message after the input group
            inputGroup.parentNode.insertBefore(err, inputGroup.nextSibling);
            field.classList.add('error-input');
        } else if (field.tagName === 'SELECT') {
            field.parentNode.appendChild(err);
            field.classList.add('error-select');
        } else {
            field.parentNode.appendChild(err);
            field.classList.add('error-input');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const roleSelect = document.querySelector('select[name="role"]');
        const collegeSelect = document.querySelector('select[name="college"]');
        const campusDisplayInput = document.querySelector('input[name="campus_display"]');
        
        // Find all rows containing a field that *might* be required based on role
        const allRoleRows = Array.from(document.querySelectorAll('[data-role-required]'))
                                .map(f => f.closest('.user-details-row'))
                                .filter((row, i, self) => row && self.indexOf(row) === i); 
        
        const roleSection = document.getElementById('role-specific-section');
        const emailInput = document.getElementById('email-input');
        const emailError = document.getElementById('email-error');
        
        // Map of role to required field names
        const roleFieldMap = {
            'FACULTY': ['college', 'degree', 'expertise'],
            'COORDINATOR': ['college'],
            'DEAN': ['college'],
            'PROGRAM_HEAD': ['college'],
            'IMPLEMENTER': ['degree', 'expertise'],
            'CLIENT': ['company', 'industry'],
        };
        
        function showRoleFields(role) {
            // 1. Hide all role field rows and remove 'required' attribute
            allRoleRows.forEach(row => {
                row.style.display = 'none';
                Array.from(row.querySelectorAll('[data-role-required]')).forEach(f => {
                    f.removeAttribute('required');
                    // Reset value for hidden fields to prevent accidental submission of old data
                    if (f.tagName === 'INPUT') f.value = '';
                    if (f.tagName === 'SELECT' && f.options.length > 0) f.value = f.options[0].value;
                });
            });

            if (!role || !roleFieldMap[role]) {
                roleSection.style.display = 'none';
                // Also hide the college/campus fields if they don't belong to the new role
                if (collegeSelect) collegeSelect.removeAttribute('required');
                if (collegeSelect) collegeSelect.value = '';
                if (campusDisplayInput) campusDisplayInput.value = 'Will be determined by College selection';
                return;
            }
            
            // 2. Show section
            roleSection.style.display = '';

            // 3. Show only relevant fields and set 'required' attribute
            const fields = roleFieldMap[role];
            if (!fields) return;

            fields.forEach(fieldName => {
                const field = document.querySelector(`[name="${fieldName}"]`);
                if (field) {
                    const row = field.closest('.user-details-row');
                    if (row) {
                        row.style.display = '';
                        field.setAttribute('required', 'required');
                    }
                }
            });
            
            // 4. Handle College/Campus dependencies (if College is required)
            if (fields.includes('college')) {
                // Manually trigger campus update if a college is already selected
                updateCampusDisplay();
            } else {
                // If college is not required for the new role, hide and reset the campus display
                if (collegeSelect) collegeSelect.removeAttribute('required');
                if (collegeSelect) collegeSelect.value = '';
                if (campusDisplayInput) campusDisplayInput.value = 'N/A';
            }
        }
        
        function updateCampusDisplay() {
            const collegeId = collegeSelect.value;
            if (collegeId && COLLEGES_DATA[collegeId]) {
                campusDisplayInput.value = COLLEGES_DATA[collegeId].campus_name || 'N/A';
            } else {
                campusDisplayInput.value = 'Will be determined by College selection';
            }
        }

        // Initial setup
        allRoleRows.forEach(row => row.style.display = 'none');
        if (roleSection) roleSection.style.display = 'none';

        // On change listeners
        if (roleSelect) {
            roleSelect.addEventListener('change', function() {
                showRoleFields(this.value);
            });
            if (roleSelect.value) showRoleFields(roleSelect.value);
        }
        
        if (collegeSelect) {
            collegeSelect.addEventListener('change', updateCampusDisplay);
        }

        // Password Toggle
        document.querySelectorAll('.toggle-password').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const input = this.closest('.input-group').querySelector('input');
                const icon = this.querySelector('i');
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });
        });
        
        // Initial password strength check if form is reloaded with values
        const passwordInput = document.getElementById('id_password');
        if (passwordInput) {
            passwordInput.addEventListener('keyup', checkPasswordStrength);
            if (passwordInput.value) checkPasswordStrength();
        }

        // --- AJAX email uniqueness check ---
        var emailTimer;

        function checkEmailAjax() {
            clearTimeout(emailTimer);
            emailTimer = setTimeout(() => {
                var email = emailInput.value.trim();
                emailError.textContent = '';
                emailError.style.display = 'none';
                emailInput.classList.remove('error-input');

                if (!email) return;
                
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    emailError.textContent = 'Invalid email format (e.g., user@example.com).';
                    emailError.style.color = '#E53E3E';
                    emailError.style.fontSize = '0.75rem';
                    emailError.style.marginTop = '0.25rem';
                    emailError.style.display = 'block';
                    emailInput.classList.add('error-input');
                    return;
                }

                fetch('/check-email/?email=' + encodeURIComponent(email))
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            emailError.textContent = 'This email is already registered.'; 
                            emailError.style.color = '#E53E3E';
                            emailError.style.fontSize = '0.75rem';
                            emailError.style.marginTop = '0.25rem';
                            emailError.style.display = 'block';
                            emailInput.classList.add('error-input');
                        }
                    });
            }, 500); 
        }

        if (emailInput) {
            emailInput.addEventListener('blur', checkEmailAjax);
            emailInput.addEventListener('input', checkEmailAjax);
        }

        // --- Unified Form validation on submit ---
        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            let valid = true;
            let firstError = null;
            let errorQueue = [];


            // 1. Remove previous error states/messages
            const fields = Array.from(document.getElementById('addUserForm').querySelectorAll('input, select, textarea'));
            fields.forEach(field => {
                field.classList.remove('error-input', 'error-select');
                let err = field.parentNode.querySelector('.field-error');
                if (err) err.remove();
                if (field.closest('.input-group')) {
                    let nextSiblingErr = field.closest('.input-group').nextElementSibling;
                    if (nextSiblingErr && nextSiblingErr.classList.contains('field-error')) nextSiblingErr.remove();
                }
            });

            // 2. Validate all required fields (only if visible)
            fields.forEach(field => {
                // Only validate if field is visible
                const row = field.closest('.user-details-row');
                const isVisible = (!row || window.getComputedStyle(row).display !== 'none') && field.offsetParent !== null;
                const isRequired = field.hasAttribute('required');
                if (isRequired && isVisible) {
                    if (!field.value || (field.tagName === 'INPUT' && field.type !== 'file' && !field.value.trim())) {
                        valid = false;
                        field.classList.add(field.tagName === 'SELECT' ? 'error-select' : 'error-input');
                        // Find the label text
                        let labelText = field.parentNode.querySelector('.user-details-label');
                        if (!labelText) {
                            labelText = field.parentNode.previousElementSibling && field.parentNode.previousElementSibling.classList.contains('user-details-label')
                                ? field.parentNode.previousElementSibling
                                : null;
                        }
                        let prettyName = labelText ? labelText.textContent.replace(/\s*\*/g, '').trim() : (field.name || field.id || 'Field');
                        const err = document.createElement('div');
                        err.className = 'field-error';
                        err.textContent = `${prettyName} is required.`;
                        err.style.color = '#E53E3E';
                        err.style.fontSize = '0.75rem';
                        err.style.marginTop = '0.25rem';
                        err.style.alignSelf = 'center';
                        if (prettyName == "Password") {
                            err.style.alignSelf = 'flex-start';
                            err.style.display = 'flex';
                            err.style.marginBottom = '0';
                        }
                            
                        if (field.closest('.input-group')) {
                            field.closest('.input-group').parentNode.insertBefore(err, field.closest('.input-group').nextSibling);
                        } else {
                            field.parentNode.appendChild(err);
                        }
                        if (!firstError) firstError = field;
                    }
                }
            });

            // 3. Specific Format Checks (only if visible)
            fields.forEach(field => {
                const row = field.closest('.user-details-row');
                const isVisible = (!row || window.getComputedStyle(row).display !== 'none') && field.offsetParent !== null;
                if (isVisible && field.name === 'email' && field.value.trim()) {
                    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(field.value.trim())) {
                        valid = false;
                        field.classList.add('error-input');
                        showFieldError(field, 'Invalid email format (e.g., user@example.com).');
                        if (!firstError) firstError = field;
                    }
                }
                if (isVisible && field.name === 'contact_no' && field.value.trim()) {
                    if (!/^\+?[\d\s-]{7,}$/.test(field.value.trim())) {
                        valid = false;
                        field.classList.add('error-input');
                        showFieldError(field, 'Invalid contact number format.');
                        if (!firstError) firstError = field;
                    }
                }
            });
            
            // 3. Email uniqueness error check
            var emailInput = document.getElementById('email-input');
            if (emailInput && emailInput.value.trim() && emailError.style.display === 'block') {
                valid = false;
                if (!firstError) firstError = emailInput;
                errorQueue.push({field: emailInput, message: 'This email is already registered.'});
                emailInput.classList.add('error-input');
            }

            // Render all errors
            errorQueue.forEach(errObj => {
                showFieldError(errObj.field, errObj.message);
            });

            if (!valid) {
                e.preventDefault();
                e.stopPropagation();
                if (firstError && typeof firstError.focus === 'function') firstError.focus();
                return false;
            }
        });
        
        // Initial call to update campus display if a college is already selected (on error reload)
        if (collegeSelect && collegeSelect.value) {
            updateCampusDisplay();
        }
    });
</script>

</body>
</html>

{% endblock %}