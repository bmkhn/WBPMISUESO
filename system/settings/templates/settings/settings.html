{% extends base_template %}
{% load static %}
{% load humanize %}

<title>System Settings</title>

{% block content %}
<link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link href="{% static 'system/settings/styles.css' %}" rel="stylesheet">

<div class="main-container">

    <h1 class="project-text">System Settings</h1>

    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'warning' %}alert-warning{% else %}alert-success{% endif %}" role="alert">
                {{ message|safe }}
                <button type="button" class="close" onclick="this.parentElement.style.display='none'" style="background:none; border:none; float:right; font-size: 1.5rem; line-height: 1; opacity: 0.7;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">

        <div class="col-lg-4">

            <div class="card" id="account-settings">
                <div class="card-header">
                    <h6 class="accordion-title m-0">Account Settings</h6>
                </div>
                <div class="card-body">
                    <p>Manage your personal account details and security. You can edit your profile to reflect changes in real time, rest assured external links will not be affected by these changes.</p>
                        <a href="{% url 'profile' %}" class="btn btn-secondary btn-block mb-2" style="align-self: flex-end;">Edit Profile</a>
                </div>
            </div>

        </div>

        {% if admin %}

        <div class="col-lg-8">
            <div class="card" id="api-settings">
                <div class="section-header non-collapsible">
                    <div class="section-header-content">
                        <h5 class="accordion-title mb-0">
                            <i class="fas fa-key fa-fw mr-2"></i>
                            API Key Management
                        </h5>
                        <p class="accordion-desc">Manage API keys for external system integrations.</p>
                        {% if not api_unlocked %}
                        <p>This section is restricted. Please enter your administrator password to manage API keys.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="accordion-content" style="border-top: 1px solid #EAEAEA;">
                    {% if api_unlocked %}
                        <div class="table-responsive">
                            <table class="table" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>System Name</th>
                                        <th>Key Prefix</th>
                                        <th>Created</th>
                                        <th>Status</th>
                                        <th class="cell-actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for key in keys %}
                                    <tr {% if key.revoked %}class="table-danger-row"{% endif %}>
                                        <td>{{ key.name }}</td>
                                        <td><code>{{ key.prefix }}...</code></td>
                                        <td>{{ key.created|naturaltime }}</td>
                                        <td>
                                            {% if key.revoked %}
                                                <span class="badge badge-danger">REVOKED</span>
                                            {% else %}
                                                <span class="badge badge-success">ACTIVE</span>
                                            {% endif %}
                                        </td>
                                        <td class="cell-actions">
                                            {% if not key.revoked %}
                                            <a href="{% url 'system_settings:revoke_api_key' key.pk %}" class="btn btn-outline-danger btn-sm" title="Revoke">
                                                <i class="fas fa-ban"></i>
                                            </a>
                                            {% else %}
                                            <span class="text-muted">--</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center">No API keys have been generated yet.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    <div class="table-controls" style="margin-bottom: 0.5rem; margin-top: 1rem;">
                        <a href="{% url 'system_settings:add_api_key' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i>Generate New API Key
                        </a>
                    </div>

                    {% else %}
                        <form method="POST" action="{% url 'system_settings:settings' %}" class="api-password-form">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="api_password" class="form-label">Your Password</label>
                                <div class="formone">
                                    <input type="password" name="api_password" class="form-control" id="api_password" required>
                                    <button type="submit" name="unlock_api" class="btn btn-primary">Unlock API Section</button>
                                </div>
                            </div>
                        </form>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="section-header accordion-toggle">
                    <div class="section-header-content">
                        <h5 class="accordion-title mb-0">
                            <i class="fas fa-hand-holding-usd fa-fw mr-2"></i>
                            Annual Budget Pool
                        </h5>
                        <p class="accordion-desc">Set the total available budget for the current fiscal year.</p>
                        <p class="accordion-intro">
                            This defines the <strong>total available budget pool</strong> (â‚±{{ budget_pool.total_available|floatformat:2|intcomma }}) for the current <strong>Fiscal Year {{ budget_pool.fiscal_year }}</strong>. This value is used as the ceiling for all College Budget allocations.
                        </p>
                    </div>
                    <i class="accordion-chevron fas fa-chevron-down"></i>
                </div>
                <div class="accordion-content" style="display: none; position: relative;">
                    <form method="POST" action="{% url 'system_settings:settings' %}" style="display: flex; flex-direction: column; gap: 0.8rem;">
                        {% csrf_token %}
                        
                        <div class="form-group row mb-3">
                            <div class="col-sm-4">
                                <label for="{{ budget_form.fiscal_year.id_for_label }}" class="form-row-label">
                                    Fiscal Year
                                </label>
                                <div class="form-row-desc">
                                    The current year for which the budget is allocated.
                                </div>
                            </div>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" name="{{ budget_form.fiscal_year.name }}" id="{{ budget_form.fiscal_year.id_for_label }}" value="{{ budget_form.fiscal_year.value|default_if_none:'' }}" readonly>
                            </div>
                        </div>
                        <div class="form-group row mb-3">
                            <div class="col-sm-4">
                                <label for="{{ budget_form.annual_total.id_for_label }}" class="form-row-label">
                                    Total Annual Budget
                                </label>
                                <div class="form-row-desc">
                                    The maximum total budget pool available (must be non-negative).
                                </div>
                            </div>
                            <div class="col-sm-8">
                                <input 
                                    type="number" 
                                    step="0.01" 
                                    min="0" 
                                    class="form-control" 
                                    name="{{ budget_form.annual_total.name }}" 
                                    id="{{ budget_form.annual_total.id_for_label }}" 
                                    value="{{ budget_form.annual_total.value|default_if_none:'0.00' }}" 
                                    required>
                                
                                {% if budget_form.annual_total.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in budget_form.annual_total.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="d-flex justify-content-end" style="justify-self: center; align-self: center;">
                            <button type="submit" name="save_annual_budget" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Annual Budget
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="section-header accordion-toggle">
                    <div class="section-header-content">
                        <h5 class="accordion-title mb-0">
                            <i class="fas fa-school fa-fw mr-2"></i>
                            Manage Colleges
                        </h5>
                        <p class="accordion-desc">Add, edit, or remove university colleges and their details.</p>
                        <p class="accordion-intro">This section lists all colleges and units recognized by the system. You can add, edit, or delete entries for institutions like the College of Sciences, College of Arts and Humanities, or satellite campuses.</p>
                    </div>
                    <i class="accordion-chevron fas fa-chevron-down"></i>
                </div>
                <div class="accordion-content" style="display: none;">
                    <div class="table-responsive">
                        <table class="table" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Logo</th>
                                    <th>Name</th>
                                    <th>Campus</th>
                                    <th class="cell-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for college in colleges %}
                                <tr>
                                    <td class="cell-logo">
                                        {% if college.logo %}
                                            <img src="{{ college.logo.url }}" alt="{{ college.name }} logo">
                                        {% else %}
                                            <span class="cell-no-logo">No Logo</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ college.name }}</td>
                                    <td>{{ college.get_campus_display }}</td>
                                    <td class="cell-actions">
                                        <a href="{% url 'system_settings:edit_college' college.pk %}" class="btn btn-outline-warning btn-sm" title="Edit">
                                            <i class="fas fa-pen"></i>
                                        </a>
                                        <a href="{% url 'system_settings:delete_college' college.pk %}" class="btn btn-outline-danger btn-sm" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">No colleges found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="table-controls">
                        <a href="{% url 'system_settings:add_college' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i>Add New College
                        </a>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="section-header accordion-toggle">
                    <div class="section-header-content">
                        <h5 class="accordion-title mb-0">
                            <i class="fas fa-building fa-fw mr-2"></i>
                            Manage Campuses
                        </h5>
                        <p class="accordion-desc">Define the different university campuses.</p>
                        <p class="accordion-intro">Manage the different university campuses. Each college or unit created must be associated with one of these campuses.</p>
                    </div>
                    <i class="accordion-chevron fas fa-chevron-down"></i>
                </div>
                <div class="accordion-content" style="display: none;">
                    <div class="table-responsive">
                        <table class="table" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th class="cell-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for campus in campuses %}
                                <tr>
                                    <td>{{ campus.name }}</td>
                                    <td class="cell-actions">
                                        <a href="{% url 'system_settings:edit_campus' campus.pk %}" class="btn btn-outline-warning btn-sm" title="Edit">
                                            <i class="fas fa-pen"></i>
                                        </a>
                                        <a href="{% url 'system_settings:delete_campus' campus.pk %}" class="btn btn-outline-danger btn-sm" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center">No campuses found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="table-controls">
                        <a href="{% url 'system_settings:add_campus' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i>Add New Campus
                        </a>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="section-header accordion-toggle">
                    <div class="section-header-content">
                        <h5 class="accordion-title mb-0">
                            <i class="fas fa-leaf fa-fw mr-2"></i>
                            Manage SDGs
                        </h5>
                        <p class="accordion-desc">Configure the Sustainable Development Goals for project tagging.</p>
                        <p class="accordion-intro">Configure the 17 Sustainable Development Goals (SDGs) used for tagging projects. The SDGs are a collection of interlinked global goals designed to be a "blueprint to achieve a better and more sustainable future for all".</p>
                    </div>
                    <i class="accordion-chevron fas fa-chevron-down"></i>
                </div>
                <div class="accordion-content" style="display: none;">
                    <div class="table-responsive">
                        <table class="table" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Goal Number</th>
                                    <th>Name</th>
                                    <th class="cell-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sdg in sdgs %}
                                <tr>
                                    <td><strong>SDG {{ sdg.goal_number }}</strong></td>
                                    <td>{{ sdg.name }}</td>
                                    <td class="cell-actions">
                                        <a href="{% url 'system_settings:edit_sdg' sdg.pk %}" class="btn btn-outline-warning btn-sm" title="Edit">
                                            <i class="fas fa-pen"></i>
                                        </a>
                                        <a href="{% url 'system_settings:delete_sdg' sdg.pk %}" class="btn btn-outline-danger btn-sm" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center">No SDGs found.</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                        </table>
                    </div>
                    <div class="table-controls">
                        <a href="{% url 'system_settings:add_sdg' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i>Add New SDG
                        </a>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="section-header accordion-toggle">
                    <div class="section-header-content">
                        <h5 class="accordion-title mb-0">
                            <i class="fas fa-cog fa-fw mr-2"></i>
                            General System Settings
                        </h5>
                        <p class="accordion-desc">Manage site-wide settings like the website name and maintenance mode.</p>
                        <p class="accordion-intro">Manage site-wide variables, such as the public website name and system maintenance mode. These settings control key parts of the application.</p>
                    </div>
                    <i class="accordion-chevron fas fa-chevron-down"></i>
                </div>
                <div class="accordion-content" style="display: none; position: relative;">
                    <form method="POST" action="{% url 'system_settings:settings' %}" style="display: flex; flex-direction: column; gap: 0.8rem;">
                        {% csrf_token %}
                        
                        {% for setting, form in settings_with_forms %}
                        <div class="form-group row mb-3">
                            <div class="col-sm-4">
                                <label for="{{ form.value.id_for_label }}" class="form-row-label">
                                    {{ setting.description }}
                                </label>
                                <div class="form-row-desc">
                                    (<code>{{ setting.key }}</code>)
                                </div>
                            </div>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" name="{{ form.prefix }}-value" id="{{ form.value.id_for_label }}" value="{{ form.value.value|default_if_none:'' }}">
                                
                                {% if form.value.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.value.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}

                        <div class="d-flex justify-content-end" style="align-self: center;">
                            <button type="submit" name="save_general_settings" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save All Settings
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            {% endif %}
            <div class="card" id="danger-zone">
                <div class="card-header">
                    <h6 class="accordion-title">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        Danger Zone
                    </h6>
                </div>
                <div class="card-body">
                    <p>Be careful. This action is permanent and cannot be undone.</p>
                    <a href="{% url 'system_settings:delete_account' %}" class="btn btn-danger btn-block" style="align-self: flex-end;">Delete My Account</a>
                </div>
            </div>

        </div>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggles = document.querySelectorAll('.accordion-toggle');

    toggles.forEach(function(toggle) {
        toggle.addEventListener('click', function() {
            const content = this.nextElementSibling;
            
            if (content && content.classList.contains('accordion-content')) {
                const isShown = content.style.display === 'block';

                this.classList.toggle('active', !isShown);

                if (isShown) {
                    content.style.display = 'none';
                } else {
                    content.style.display = 'block';
                }
            }
        });
    });
});
</script>

{% endblock %}